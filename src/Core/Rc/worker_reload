#!/bin/sh

#
# MikoPBX - free phone system for small business
# Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with this program.
# If not, see <https://www.gnu.org/licenses/>.
#

# Приоритет запуска процесса.
PRIORITY=0
# Путь и базовые параметры для запускаемого приложения.
# Имя сервиса.
NAMESAFE=$(basename "$0");
PATHTOBIN=$(which "$(echo "$NAMESAFE" | sed 's/safe-//g')");
NAME=$(basename "$(echo "$PATHTOBIN" | tr ' ' '-')");
MYPID="$$";
ARGS=$@;
# Длительно ожидание перед новым запуском.
SLEEPSECS=1

/bin/busybox ps | /bin/busybox grep "$NAMESAFE" | /bin/busybox grep -v "$MYPID"  | /bin/busybox grep -v grep > /dev/null;
resultGrep="$?";
if [ "${resultGrep}" = '0' ]; then
  echo "Another process is already running" ;
  exit 0;
fi;
echo "Starting $NAMESAFE..." ;

pidOld=$(/bin/busybox ps | /bin/busybox grep "$(basename "$PATHTOBIN")" | /bin/busybox grep -v "$NAMESAFE" | /bin/busybox grep -v grep | /bin/busybox awk '{ print $1}');
if [ -n "$pidOld" ]; then
  /bin/busybox kill "$pidOld";
fi;

message() {
	echo "$1" >&2
	logger -t "$NAME" "$1"
}

run_bin()
{
	while :; do
	  nice -n "$PRIORITY" $PATHTOBIN $ARGS;
		EXITSTATUS="$?"
		message "$NAME ended with exit status $EXITSTATUS"
		if test "x$EXITSTATUS" = "x0" ; then
			message "Bin $NAME shutdown normally."
			sleep 30
		else
			message "$NAME died with code $EXITSTATUS."
		fi
		message "Automatically restarting $NAME."
		sleep $SLEEPSECS

	done
}

run_bin &