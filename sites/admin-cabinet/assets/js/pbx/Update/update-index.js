"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalPBXVersion, globalTranslate,
globalWebAdminLanguage, showdown, UserMessage, upgradeStatusLoopWorker, Config */

/**
 * Object for managing PBX firmware updates.
 *
 * @module updatePBX
 */
var updatePBX = {
  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#upgrade-form'),
  $submitButton: $('#submitbutton'),
  $progressBar: $('#upload-progress-bar'),
  $progressBarLabel: $('#upload-progress-bar-label'),
  currentVersion: globalPBXVersion,
  $upgradeModalForm: $('#update-modal-form'),
  upgradeInProgress: false,
  converter: new showdown.Converter(),

  /**
   * Initializes the update PBX firmware functionality.
   */
  initialize: function initialize() {
    // Open the upgrade modal form
    updatePBX.$upgradeModalForm.modal(); // Add 'disabled' class to submit button

    updatePBX.$submitButton.addClass('disabled'); // Trigger file input click when clicking on text input or button

    $('input:text, .ui.button', '.ui.action.input').on('click', function (e) {
      $('input:file', $(e.target).parents()).click();
    }); // Update text input value when selecting a file

    $('input:file', '.ui.action.input').on('change', function (e) {
      if (e.target.files[0] !== undefined) {
        var filename = e.target.files[0].name;
        $('input:text', $(e.target).parent()).val(filename);
        updatePBX.$submitButton.removeClass('disabled');
      }
    }); // Handle submit button click

    updatePBX.$submitButton.on('click', function (e) {
      e.preventDefault();
      if (updatePBX.$submitButton.hasClass('loading') || updatePBX.upgradeInProgress) return; // Validate the form and show the upgrade modal form on success

      updatePBX.$formObj.form({
        on: 'blur',
        fields: updatePBX.validateRules,
        onSuccess: function onSuccess() {
          updatePBX.$upgradeModalForm.modal({
            closable: false,
            onDeny: function onDeny() {
              return true;
            },
            onApprove: function onApprove() {
              // Start the file upload process
              updatePBX.$submitButton.addClass('loading');
              updatePBX.upgradeInProgress = true;
              var data = $('input:file')[0].files[0];
              PbxApi.FilesUploadFile(data, updatePBX.cbResumableUploadFile);
              return true;
            }
          }).modal('show');
        }
      }); // Validate the form

      updatePBX.$formObj.form('validate form');
    }); // Prepare the request data

    var requestData = {
      PBXVER: globalPBXVersion,
      LANGUAGE: globalWebAdminLanguage
    }; // Send an API request to check for new firmware

    $.api({
      url: "".concat(Config.updateUrl, "checkNewFirmware"),
      on: 'now',
      method: 'POST',
      data: requestData,
      successTest: function successTest(response) {
        // Test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0 && response.result === 'SUCCESS';
      },
      onSuccess: function onSuccess(response) {
        // Iterate through firmware objects and add version information
        var currentVerison = updatePBX.currentVersion.replace('-dev', '');
        response.firmware.forEach(function (obj) {
          var version = obj.version.replace('-dev', '');

          if (versionCompare(version, currentVerison) > 0) {
            updatePBX.addNewVersionInformation(obj);
          }
        }); // Handle redo button click

        $('a.redo').on('click', function (e) {
          e.preventDefault();
          if (updatePBX.$submitButton.hasClass('loading') || updatePBX.upgradeInProgress) return;
          updatePBX.$upgradeModalForm.modal({
            closable: false,
            onDeny: function onDeny() {
              return true;
            },
            onApprove: function onApprove() {
              // Prepare parameters for firmware download
              var params = [];
              var $aLink = $(e.target).closest('a');
              params.updateLink = $aLink.attr('href');
              params.md5 = $aLink.attr('data-md5');
              params.version = $aLink.attr('data-version');
              params.size = $aLink.attr('data-size');
              $aLink.find('i').addClass('loading');
              updatePBX.upgradeInProgress = true;
              PbxApi.FilesDownloadNewFirmware(params, updatePBX.cbAfterStartDownloadFirmware);
              return true;
            }
          }).modal('show');
        });
      }
    });
  },

  /**
   * Callback function for resumable file upload.
   * @param {string} action - The action of the upload.
   * @param {object} params - Additional parameters for the upload.
   */
  cbResumableUploadFile: function cbResumableUploadFile(action, params) {
    switch (action) {
      case 'fileSuccess':
        updatePBX.checkStatusFileMerging(params.response);
        break;

      case 'uploadStart':
        updatePBX.$submitButton.addClass('loading');
        updatePBX.$progressBar.show();
        updatePBX.$progressBarLabel.text(globalTranslate.upd_UploadInProgress);
        break;

      case 'progress':
        updatePBX.$progressBar.progress({
          percent: parseInt(params.percent, 10)
        });
        break;

      case 'error':
        updatePBX.$progressBarLabel.text(globalTranslate.upd_UploadError);
        updatePBX.$submitButton.removeClass('loading');
        UserMessage.showMultiString(globalTranslate.upd_UploadError);
        break;

      default:
    }
  },

  /**
   * Checks the status of the file merging process.
   * @param {string} response - The response from the /pbxcore/api/upload/status function.
   */
  checkStatusFileMerging: function checkStatusFileMerging(response) {
    if (response === undefined || PbxApi.tryParseJSON(response) === false) {
      UserMessage.showMultiString("".concat(globalTranslate.upd_UploadError));
      return;
    }

    var json = JSON.parse(response);

    if (json === undefined || json.data === undefined) {
      UserMessage.showMultiString("".concat(globalTranslate.upd_UploadError));
      return;
    }

    var fileID = json.data.upload_id;
    var filePath = json.data.filename; // Wait until system glued all parts of file

    mergingCheckWorker.initialize(fileID, filePath);
  },

  /**
   * Callback after start PBX upgrading
   * @param response
   */
  cbAfterStartUpdate: function cbAfterStartUpdate(response) {
    if (response.length === 0 || response === false) {
      UserMessage.showMultiString(globalTranslate.upd_UpgradeError);
      updatePBX.$submitButton.removeClass('loading');
    }
  },

  /**
   * After start online upgrade we have to wait an answer,
   * and then start status check worker
   */
  cbAfterStartDownloadFirmware: function cbAfterStartDownloadFirmware(response) {
    if (response.filename !== undefined) {
      upgradeStatusLoopWorker.initialize(response.filename);
    } else {
      updatePBX.upgradeInProgress = false;
      $('i.loading.redo').removeClass('loading');
    }
  },

  /**
   * Add new block of update information on page
   */
  addNewVersionInformation: function addNewVersionInformation(obj) {
    $('#online-updates-block').show();
    var markdownText = decodeURIComponent(obj.description);
    markdownText = markdownText.replace(/<br>/g, '\r');
    markdownText = markdownText.replace(/<br >/g, '\r');
    markdownText = markdownText.replace(/\* \*/g, '*');
    markdownText = markdownText.replace(/\*\*/g, '*');
    var html = updatePBX.converter.makeHtml(markdownText);
    var dymanicRow = "\n\t\t\t<tr class=\"update-row\">\n\t\t\t<td class=\"center aligned\">".concat(obj.version, "</td>\n\t\t\t<td>").concat(html, "</td>\n\t\t\t<td class=\"right aligned collapsing\">\n    \t\t<div class=\"ui small basic icon buttons action-buttons\">\n    \t\t\t<a href=\"").concat(obj.href, "\" class=\"ui button redo popuped\" \n    \t\t\t\tdata-content = \"").concat(globalTranslate.bt_ToolTipUpgradeOnline, "\"\n\t\t\t\t\tdata-md5 =\"").concat(obj.md5, "\" data-size =\"").concat(obj.size, "\"\n\t\t\t\t\tdata-version = \"").concat(obj.version, "\" >\n\t\t\t\t\t<i class=\"icon redo blue\"></i>\n\t\t\t\t\t<span class=\"percent\"></span>\n\t\t\t\t</a>\n\t\t\t\t<a href=\"").concat(obj.href, "\" class=\"ui button download popuped\" \n\t\t\t\t\tdata-content = \"").concat(globalTranslate.bt_ToolTipDownload, "\"\n\t\t\t\t\tdata-md5 =\"").concat(obj.md5, "\" data-size =\"").concat(obj.size, "\">\n\t\t\t\t\t<i class=\"icon download blue\"></i>\n\t\t\t\t</a>\n    \t\t</div>   \n\t</tr>");
    $('#updates-table tbody').append(dymanicRow);
    $('a.popuped').popup();
  }
}; // When the document is ready, initialize the update pbx firmware from image page

$(document).ready(function () {
  updatePBX.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9VcGRhdGUvdXBkYXRlLWluZGV4LmpzIl0sIm5hbWVzIjpbInVwZGF0ZVBCWCIsIiRmb3JtT2JqIiwiJCIsIiRzdWJtaXRCdXR0b24iLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsImN1cnJlbnRWZXJzaW9uIiwiZ2xvYmFsUEJYVmVyc2lvbiIsIiR1cGdyYWRlTW9kYWxGb3JtIiwidXBncmFkZUluUHJvZ3Jlc3MiLCJjb252ZXJ0ZXIiLCJzaG93ZG93biIsIkNvbnZlcnRlciIsImluaXRpYWxpemUiLCJtb2RhbCIsImFkZENsYXNzIiwib24iLCJlIiwidGFyZ2V0IiwicGFyZW50cyIsImNsaWNrIiwiZmlsZXMiLCJ1bmRlZmluZWQiLCJmaWxlbmFtZSIsIm5hbWUiLCJwYXJlbnQiLCJ2YWwiLCJyZW1vdmVDbGFzcyIsInByZXZlbnREZWZhdWx0IiwiaGFzQ2xhc3MiLCJmb3JtIiwiZmllbGRzIiwidmFsaWRhdGVSdWxlcyIsIm9uU3VjY2VzcyIsImNsb3NhYmxlIiwib25EZW55Iiwib25BcHByb3ZlIiwiZGF0YSIsIlBieEFwaSIsIkZpbGVzVXBsb2FkRmlsZSIsImNiUmVzdW1hYmxlVXBsb2FkRmlsZSIsInJlcXVlc3REYXRhIiwiUEJYVkVSIiwiTEFOR1VBR0UiLCJnbG9iYWxXZWJBZG1pbkxhbmd1YWdlIiwiYXBpIiwidXJsIiwiQ29uZmlnIiwidXBkYXRlVXJsIiwibWV0aG9kIiwic3VjY2Vzc1Rlc3QiLCJyZXNwb25zZSIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJyZXN1bHQiLCJjdXJyZW50VmVyaXNvbiIsInJlcGxhY2UiLCJmaXJtd2FyZSIsImZvckVhY2giLCJvYmoiLCJ2ZXJzaW9uIiwidmVyc2lvbkNvbXBhcmUiLCJhZGROZXdWZXJzaW9uSW5mb3JtYXRpb24iLCJwYXJhbXMiLCIkYUxpbmsiLCJjbG9zZXN0IiwidXBkYXRlTGluayIsImF0dHIiLCJtZDUiLCJzaXplIiwiZmluZCIsIkZpbGVzRG93bmxvYWROZXdGaXJtd2FyZSIsImNiQWZ0ZXJTdGFydERvd25sb2FkRmlybXdhcmUiLCJhY3Rpb24iLCJjaGVja1N0YXR1c0ZpbGVNZXJnaW5nIiwic2hvdyIsInRleHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJ1cGRfVXBsb2FkSW5Qcm9ncmVzcyIsInByb2dyZXNzIiwicGVyY2VudCIsInBhcnNlSW50IiwidXBkX1VwbG9hZEVycm9yIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJ0cnlQYXJzZUpTT04iLCJqc29uIiwiSlNPTiIsInBhcnNlIiwiZmlsZUlEIiwidXBsb2FkX2lkIiwiZmlsZVBhdGgiLCJtZXJnaW5nQ2hlY2tXb3JrZXIiLCJjYkFmdGVyU3RhcnRVcGRhdGUiLCJ1cGRfVXBncmFkZUVycm9yIiwidXBncmFkZVN0YXR1c0xvb3BXb3JrZXIiLCJtYXJrZG93blRleHQiLCJkZWNvZGVVUklDb21wb25lbnQiLCJkZXNjcmlwdGlvbiIsImh0bWwiLCJtYWtlSHRtbCIsImR5bWFuaWNSb3ciLCJocmVmIiwiYnRfVG9vbFRpcFVwZ3JhZGVPbmxpbmUiLCJidF9Ub29sVGlwRG93bmxvYWQiLCJhcHBlbmQiLCJwb3B1cCIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxTQUFTLEdBQUc7QUFDZDtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFRLEVBQUVDLENBQUMsQ0FBQyxlQUFELENBTEc7QUFPZEMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsZUFBRCxDQVBGO0FBUWRFLEVBQUFBLFlBQVksRUFBRUYsQ0FBQyxDQUFDLHNCQUFELENBUkQ7QUFTZEcsRUFBQUEsaUJBQWlCLEVBQUVILENBQUMsQ0FBQyw0QkFBRCxDQVRO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QzJDLElBYkssa0ZBY0R6QixlQUFlLENBQUMyQixrQkFkZix1Q0FlTjdDLEdBQUcsQ0FBQ1MsR0FmRSw2QkFla0JULEdBQUcsQ0FBQ1UsSUFmdEIsa0dBQWhCO0FBb0JBcEUsSUFBQUEsQ0FBQyxDQUFDLHNCQUFELENBQUQsQ0FBMEJ3RyxNQUExQixDQUFpQ0osVUFBakM7QUFDQXBHLElBQUFBLENBQUMsQ0FBQyxXQUFELENBQUQsQ0FBZXlHLEtBQWY7QUFDSDtBQTFPYSxDQUFsQixDLENBNk9BOztBQUNBekcsQ0FBQyxDQUFDMEcsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQjdHLEVBQUFBLFNBQVMsQ0FBQ2EsVUFBVjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgUGJ4QXBpLCBnbG9iYWxQQlhWZXJzaW9uLCBnbG9iYWxUcmFuc2xhdGUsXG5nbG9iYWxXZWJBZG1pbkxhbmd1YWdlLCBzaG93ZG93biwgVXNlck1lc3NhZ2UsIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLCBDb25maWcgKi9cblxuLyoqXG4gKiBPYmplY3QgZm9yIG1hbmFnaW5nIFBCWCBmaXJtd2FyZSB1cGRhdGVzLlxuICpcbiAqIEBtb2R1bGUgdXBkYXRlUEJYXG4gKi9cbmNvbnN0IHVwZGF0ZVBCWCA9IHtcbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjdXBncmFkZS1mb3JtJyksXG5cbiAgICAkc3VibWl0QnV0dG9uOiAkKCcjc3VibWl0YnV0dG9uJyksXG4gICAgJHByb2dyZXNzQmFyOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhcicpLFxuICAgICRwcm9ncmVzc0JhckxhYmVsOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhci1sYWJlbCcpLFxuICAgIGN1cnJlbnRWZXJzaW9uOiBnbG9iYWxQQlhWZXJzaW9uLFxuICAgICR1cGdyYWRlTW9kYWxGb3JtOiAkKCcjdXBkYXRlLW1vZGFsLWZvcm0nKSxcbiAgICB1cGdyYWRlSW5Qcm9ncmVzczogZmFsc2UsXG4gICAgY29udmVydGVyOiBuZXcgc2hvd2Rvd24uQ29udmVydGVyKCksXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgdXBkYXRlIFBCWCBmaXJtd2FyZSBmdW5jdGlvbmFsaXR5LlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG5cbiAgICAgICAgLy8gT3BlbiB0aGUgdXBncmFkZSBtb2RhbCBmb3JtXG4gICAgICAgIHVwZGF0ZVBCWC4kdXBncmFkZU1vZGFsRm9ybS5tb2RhbCgpO1xuXG4gICAgICAgIC8vIEFkZCAnZGlzYWJsZWQnIGNsYXNzIHRvIHN1Ym1pdCBidXR0b25cbiAgICAgICAgdXBkYXRlUEJYLiRzdWJtaXRCdXR0b24uYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cbiAgICAgICAgLy8gVHJpZ2dlciBmaWxlIGlucHV0IGNsaWNrIHdoZW4gY2xpY2tpbmcgb24gdGV4dCBpbnB1dCBvciBidXR0b25cbiAgICAgICAgJCgnaW5wdXQ6dGV4dCwgLnVpLmJ1dHRvbicsICcudWkuYWN0aW9uLmlucHV0Jykub24oJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgICQoJ2lucHV0OmZpbGUnLCAkKGUudGFyZ2V0KS5wYXJlbnRzKCkpLmNsaWNrKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFVwZGF0ZSB0ZXh0IGlucHV0IHZhbHVlIHdoZW4gc2VsZWN0aW5nIGEgZmlsZVxuICAgICAgICAkKCdpbnB1dDpmaWxlJywgJy51aS5hY3Rpb24uaW5wdXQnKS5vbignY2hhbmdlJywgKGUpID0+IHtcbiAgICAgICAgICAgIGlmIChlLnRhcmdldC5maWxlc1swXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBlLnRhcmdldC5maWxlc1swXS5uYW1lO1xuICAgICAgICAgICAgICAgICQoJ2lucHV0OnRleHQnLCAkKGUudGFyZ2V0KS5wYXJlbnQoKSkudmFsKGZpbGVuYW1lKTtcbiAgICAgICAgICAgICAgICB1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gSGFuZGxlIHN1Ym1pdCBidXR0b24gY2xpY2tcbiAgICAgICAgdXBkYXRlUEJYLiRzdWJtaXRCdXR0b24ub24oJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGlmICh1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5oYXNDbGFzcygnbG9hZGluZycpIHx8IHVwZGF0ZVBCWC51cGdyYWRlSW5Qcm9ncmVzcykgcmV0dXJuO1xuXG4gICAgICAgICAgICAvLyBWYWxpZGF0ZSB0aGUgZm9ybSBhbmQgc2hvdyB0aGUgdXBncmFkZSBtb2RhbCBmb3JtIG9uIHN1Y2Nlc3NcbiAgICAgICAgICAgIHVwZGF0ZVBCWC4kZm9ybU9ialxuICAgICAgICAgICAgICAgIC5mb3JtKHtcbiAgICAgICAgICAgICAgICAgICAgb246ICdibHVyJyxcbiAgICAgICAgICAgICAgICAgICAgZmllbGRzOiB1cGRhdGVQQlgudmFsaWRhdGVSdWxlcyxcbiAgICAgICAgICAgICAgICAgICAgb25TdWNjZXNzKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlUEJYLiR1cGdyYWRlTW9kYWxGb3JtXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1vZGFsKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2FibGU6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkRlbnk6ICgpID0+IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQXBwcm92ZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RhcnQgdGhlIGZpbGUgdXBsb2FkIHByb2Nlc3NcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9ICQoJ2lucHV0OmZpbGUnKVswXS5maWxlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBieEFwaS5GaWxlc1VwbG9hZEZpbGUoZGF0YSwgdXBkYXRlUEJYLmNiUmVzdW1hYmxlVXBsb2FkRmlsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tb2RhbCgnc2hvdycpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBWYWxpZGF0ZSB0aGUgZm9ybVxuICAgICAgICAgICAgdXBkYXRlUEJYLiRmb3JtT2JqLmZvcm0oJ3ZhbGlkYXRlIGZvcm0nKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gUHJlcGFyZSB0aGUgcmVxdWVzdCBkYXRhXG4gICAgICAgIGNvbnN0IHJlcXVlc3REYXRhID0ge1xuICAgICAgICAgICAgUEJYVkVSOiBnbG9iYWxQQlhWZXJzaW9uLFxuICAgICAgICAgICAgTEFOR1VBR0U6IGdsb2JhbFdlYkFkbWluTGFuZ3VhZ2UsXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gU2VuZCBhbiBBUEkgcmVxdWVzdCB0byBjaGVjayBmb3IgbmV3IGZpcm13YXJlXG4gICAgICAgICQuYXBpKHtcbiAgICAgICAgICAgIHVybDogYCR7Q29uZmlnLnVwZGF0ZVVybH1jaGVja05ld0Zpcm13YXJlYCxcbiAgICAgICAgICAgIG9uOiAnbm93JyxcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgZGF0YTogcmVxdWVzdERhdGEsXG4gICAgICAgICAgICBzdWNjZXNzVGVzdChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIC8vIFRlc3Qgd2hldGhlciBhIEpTT04gcmVzcG9uc2UgaXMgdmFsaWRcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICAmJiBPYmplY3Qua2V5cyhyZXNwb25zZSkubGVuZ3RoID4gMFxuICAgICAgICAgICAgICAgICAgICAmJiByZXNwb25zZS5yZXN1bHQgPT09ICdTVUNDRVNTJztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvblN1Y2Nlc3MocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAvLyBJdGVyYXRlIHRocm91Z2ggZmlybXdhcmUgb2JqZWN0cyBhbmQgYWRkIHZlcnNpb24gaW5mb3JtYXRpb25cbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VmVyaXNvbiA9IHVwZGF0ZVBCWC5jdXJyZW50VmVyc2lvbi5yZXBsYWNlKCctZGV2JywgJycpO1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlLmZpcm13YXJlLmZvckVhY2goKG9iaikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB2ZXJzaW9uID0gb2JqLnZlcnNpb24ucmVwbGFjZSgnLWRldicsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZlcnNpb25Db21wYXJlKHZlcnNpb24sIGN1cnJlbnRWZXJpc29uKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZVBCWC5hZGROZXdWZXJzaW9uSW5mb3JtYXRpb24ob2JqKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgLy8gSGFuZGxlIHJlZG8gYnV0dG9uIGNsaWNrXG4gICAgICAgICAgICAgICAgJCgnYS5yZWRvJykub24oJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlUEJYLiRzdWJtaXRCdXR0b24uaGFzQ2xhc3MoJ2xvYWRpbmcnKSB8fCB1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUEJYLiR1cGdyYWRlTW9kYWxGb3JtXG4gICAgICAgICAgICAgICAgICAgICAgICAubW9kYWwoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkRlbnk6ICgpID0+IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25BcHByb3ZlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFByZXBhcmUgcGFyYW1ldGVycyBmb3IgZmlybXdhcmUgZG93bmxvYWRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyYW1zID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0ICRhTGluayA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJ2EnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zLnVwZGF0ZUxpbmsgPSAkYUxpbmsuYXR0cignaHJlZicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMubWQ1ID0gJGFMaW5rLmF0dHIoJ2RhdGEtbWQ1Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtcy52ZXJzaW9uID0gJGFMaW5rLmF0dHIoJ2RhdGEtdmVyc2lvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMuc2l6ZSA9ICRhTGluay5hdHRyKCdkYXRhLXNpemUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFMaW5rLmZpbmQoJ2knKS5hZGRDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQYnhBcGkuRmlsZXNEb3dubG9hZE5ld0Zpcm13YXJlKHBhcmFtcywgdXBkYXRlUEJYLmNiQWZ0ZXJTdGFydERvd25sb2FkRmlybXdhcmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tb2RhbCgnc2hvdycpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGZvciByZXN1bWFibGUgZmlsZSB1cGxvYWQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGFjdGlvbiAtIFRoZSBhY3Rpb24gb2YgdGhlIHVwbG9hZC5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcGFyYW1zIC0gQWRkaXRpb25hbCBwYXJhbWV0ZXJzIGZvciB0aGUgdXBsb2FkLlxuICAgICAqL1xuICAgIGNiUmVzdW1hYmxlVXBsb2FkRmlsZShhY3Rpb24sIHBhcmFtcykge1xuICAgICAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgICAgICAgY2FzZSAnZmlsZVN1Y2Nlc3MnOlxuICAgICAgICAgICAgICAgIHVwZGF0ZVBCWC5jaGVja1N0YXR1c0ZpbGVNZXJnaW5nKHBhcmFtcy5yZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICd1cGxvYWRTdGFydCc6XG4gICAgICAgICAgICAgICAgdXBkYXRlUEJYLiRzdWJtaXRCdXR0b24uYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICB1cGRhdGVQQlguJHByb2dyZXNzQmFyLnNob3coKTtcbiAgICAgICAgICAgICAgICB1cGRhdGVQQlguJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEluUHJvZ3Jlc3MpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAncHJvZ3Jlc3MnOlxuICAgICAgICAgICAgICAgIHVwZGF0ZVBCWC4kcHJvZ3Jlc3NCYXIucHJvZ3Jlc3Moe1xuICAgICAgICAgICAgICAgICAgICBwZXJjZW50OiBwYXJzZUludChwYXJhbXMucGVyY2VudCwgMTApLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICAgICAgICAgIHVwZGF0ZVBCWC4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS51cGRfVXBsb2FkRXJyb3IpO1xuICAgICAgICAgICAgICAgIHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGdsb2JhbFRyYW5zbGF0ZS51cGRfVXBsb2FkRXJyb3IpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDaGVja3MgdGhlIHN0YXR1cyBvZiB0aGUgZmlsZSBtZXJnaW5nIHByb2Nlc3MuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIGZyb20gdGhlIC9wYnhjb3JlL2FwaS91cGxvYWQvc3RhdHVzIGZ1bmN0aW9uLlxuICAgICAqL1xuICAgIGNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocmVzcG9uc2UpIHtcbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSB1bmRlZmluZWQgfHwgUGJ4QXBpLnRyeVBhcnNlSlNPTihyZXNwb25zZSkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoYCR7Z2xvYmFsVHJhbnNsYXRlLnVwZF9VcGxvYWRFcnJvcn1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBqc29uID0gSlNPTi5wYXJzZShyZXNwb25zZSk7XG4gICAgICAgIGlmIChqc29uID09PSB1bmRlZmluZWQgfHwganNvbi5kYXRhID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhgJHtnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEVycm9yfWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZpbGVJRCA9IGpzb24uZGF0YS51cGxvYWRfaWQ7XG4gICAgICAgIGNvbnN0IGZpbGVQYXRoID0ganNvbi5kYXRhLmZpbGVuYW1lO1xuICAgICAgICAvLyBXYWl0IHVudGlsIHN5c3RlbSBnbHVlZCBhbGwgcGFydHMgb2YgZmlsZVxuICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuaW5pdGlhbGl6ZShmaWxlSUQsIGZpbGVQYXRoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgYWZ0ZXIgc3RhcnQgUEJYIHVwZ3JhZGluZ1xuICAgICAqIEBwYXJhbSByZXNwb25zZVxuICAgICAqL1xuICAgIGNiQWZ0ZXJTdGFydFVwZGF0ZShyZXNwb25zZSkge1xuICAgICAgICBpZiAocmVzcG9uc2UubGVuZ3RoID09PSAwIHx8IHJlc3BvbnNlID09PSBmYWxzZSkge1xuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGdsb2JhbFRyYW5zbGF0ZS51cGRfVXBncmFkZUVycm9yKTtcbiAgICAgICAgICAgIHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQWZ0ZXIgc3RhcnQgb25saW5lIHVwZ3JhZGUgd2UgaGF2ZSB0byB3YWl0IGFuIGFuc3dlcixcbiAgICAgKiBhbmQgdGhlbiBzdGFydCBzdGF0dXMgY2hlY2sgd29ya2VyXG4gICAgICovXG4gICAgY2JBZnRlclN0YXJ0RG93bmxvYWRGaXJtd2FyZShyZXNwb25zZSkge1xuICAgICAgICBpZiAocmVzcG9uc2UuZmlsZW5hbWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaW5pdGlhbGl6ZShyZXNwb25zZS5maWxlbmFtZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICAgICAgICAgICQoJ2kubG9hZGluZy5yZWRvJykucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBBZGQgbmV3IGJsb2NrIG9mIHVwZGF0ZSBpbmZvcm1hdGlvbiBvbiBwYWdlXG4gICAgICovXG4gICAgYWRkTmV3VmVyc2lvbkluZm9ybWF0aW9uKG9iaikge1xuICAgICAgICAkKCcjb25saW5lLXVwZGF0ZXMtYmxvY2snKS5zaG93KCk7XG4gICAgICAgIGxldCBtYXJrZG93blRleHQgPSBkZWNvZGVVUklDb21wb25lbnQob2JqLmRlc2NyaXB0aW9uKTtcbiAgICAgICAgbWFya2Rvd25UZXh0ID0gbWFya2Rvd25UZXh0LnJlcGxhY2UoLzxicj4vZywgJ1xccicpO1xuICAgICAgICBtYXJrZG93blRleHQgPSBtYXJrZG93blRleHQucmVwbGFjZSgvPGJyID4vZywgJ1xccicpO1xuICAgICAgICBtYXJrZG93blRleHQgPSBtYXJrZG93blRleHQucmVwbGFjZSgvXFwqIFxcKi9nLCAnKicpO1xuICAgICAgICBtYXJrZG93blRleHQgPSBtYXJrZG93blRleHQucmVwbGFjZSgvXFwqXFwqL2csICcqJyk7XG4gICAgICAgIGNvbnN0IGh0bWwgPSB1cGRhdGVQQlguY29udmVydGVyLm1ha2VIdG1sKG1hcmtkb3duVGV4dCk7XG4gICAgICAgIGNvbnN0IGR5bWFuaWNSb3cgPSBgXG5cdFx0XHQ8dHIgY2xhc3M9XCJ1cGRhdGUtcm93XCI+XG5cdFx0XHQ8dGQgY2xhc3M9XCJjZW50ZXIgYWxpZ25lZFwiPiR7b2JqLnZlcnNpb259PC90ZD5cblx0XHRcdDx0ZD4ke2h0bWx9PC90ZD5cblx0XHRcdDx0ZCBjbGFzcz1cInJpZ2h0IGFsaWduZWQgY29sbGFwc2luZ1wiPlxuICAgIFx0XHQ8ZGl2IGNsYXNzPVwidWkgc21hbGwgYmFzaWMgaWNvbiBidXR0b25zIGFjdGlvbi1idXR0b25zXCI+XG4gICAgXHRcdFx0PGEgaHJlZj1cIiR7b2JqLmhyZWZ9XCIgY2xhc3M9XCJ1aSBidXR0b24gcmVkbyBwb3B1cGVkXCIgXG4gICAgXHRcdFx0XHRkYXRhLWNvbnRlbnQgPSBcIiR7Z2xvYmFsVHJhbnNsYXRlLmJ0X1Rvb2xUaXBVcGdyYWRlT25saW5lfVwiXG5cdFx0XHRcdFx0ZGF0YS1tZDUgPVwiJHtvYmoubWQ1fVwiIGRhdGEtc2l6ZSA9XCIke29iai5zaXplfVwiXG5cdFx0XHRcdFx0ZGF0YS12ZXJzaW9uID0gXCIke29iai52ZXJzaW9ufVwiID5cblx0XHRcdFx0XHQ8aSBjbGFzcz1cImljb24gcmVkbyBibHVlXCI+PC9pPlxuXHRcdFx0XHRcdDxzcGFuIGNsYXNzPVwicGVyY2VudFwiPjwvc3Bhbj5cblx0XHRcdFx0PC9hPlxuXHRcdFx0XHQ8YSBocmVmPVwiJHtvYmouaHJlZn1cIiBjbGFzcz1cInVpIGJ1dHRvbiBkb3dubG9hZCBwb3B1cGVkXCIgXG5cdFx0XHRcdFx0ZGF0YS1jb250ZW50ID0gXCIke2dsb2JhbFRyYW5zbGF0ZS5idF9Ub29sVGlwRG93bmxvYWR9XCJcblx0XHRcdFx0XHRkYXRhLW1kNSA9XCIke29iai5tZDV9XCIgZGF0YS1zaXplID1cIiR7b2JqLnNpemV9XCI+XG5cdFx0XHRcdFx0PGkgY2xhc3M9XCJpY29uIGRvd25sb2FkIGJsdWVcIj48L2k+XG5cdFx0XHRcdDwvYT5cbiAgICBcdFx0PC9kaXY+ICAgXG5cdDwvdHI+YDtcbiAgICAgICAgJCgnI3VwZGF0ZXMtdGFibGUgdGJvZHknKS5hcHBlbmQoZHltYW5pY1Jvdyk7XG4gICAgICAgICQoJ2EucG9wdXBlZCcpLnBvcHVwKCk7XG4gICAgfSxcbn07XG5cbi8vIFdoZW4gdGhlIGRvY3VtZW50IGlzIHJlYWR5LCBpbml0aWFsaXplIHRoZSB1cGRhdGUgcGJ4IGZpcm13YXJlIGZyb20gaW1hZ2UgcGFnZVxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIHVwZGF0ZVBCWC5pbml0aWFsaXplKCk7XG59KTtcblxuIl19