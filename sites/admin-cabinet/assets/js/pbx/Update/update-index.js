"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalPBXVersion, globalTranslate,
globalWebAdminLanguage, showdown, UserMessage, upgradeStatusLoopWorker, Config */
var updatePBX = {
  $formObj: $('#upgrade-form'),
  $submitButton: $('#submitbutton'),
  $progressBar: $('#upload-progress-bar'),
  $progressBarLabel: $('#upload-progress-bar').find('.label'),
  currentVersion: globalPBXVersion,
  $restoreModalForm: $('#update-modal-form'),
  upgradeInProgress: false,
  converter: new showdown.Converter(),
  initialize: function initialize() {
    updatePBX.$restoreModalForm.modal();
    updatePBX.$submitButton.addClass('disabled');
    $('input:text, .ui.button', '.ui.action.input').on('click', function (e) {
      $('input:file', $(e.target).parents()).click();
    });
    $('input:file', '.ui.action.input').on('change', function (e) {
      if (e.target.files[0] !== undefined) {
        var filename = e.target.files[0].name;
        $('input:text', $(e.target).parent()).val(filename);
        updatePBX.$submitButton.removeClass('disabled');
      }
    });
    updatePBX.$submitButton.on('click', function (e) {
      e.preventDefault();
      if (updatePBX.$submitButton.hasClass('loading') || updatePBX.upgradeInProgress) return;
      updatePBX.$formObj.form({
        on: 'blur',
        fields: updatePBX.validateRules,
        onSuccess: function onSuccess() {
          updatePBX.$restoreModalForm.modal({
            closable: false,
            onDeny: function onDeny() {
              return true;
            },
            onApprove: function onApprove() {
              updatePBX.$submitButton.addClass('loading');
              updatePBX.upgradeInProgress = true;
              var data = $('input:file')[0].files[0];
              PbxApi.FilesUploadFile(data, updatePBX.cbResumableUploadFile);
              return true;
            }
          }).modal('show');
        }
      });
      updatePBX.$formObj.form('validate form');
    });
    var requestData = {
      PBXVER: globalPBXVersion,
      LANGUAGE: globalWebAdminLanguage
    };
    $.api({
      url: "".concat(Config.updateUrl, "checkNewFirmware"),
      on: 'now',
      method: 'POST',
      data: requestData,
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0 && response.result === 'SUCCESS';
      },
      onSuccess: function onSuccess(response) {
        var currentVerison = updatePBX.currentVersion.replace('-dev', '');
        response.firmware.forEach(function (obj) {
          var version = obj.version.replace('-dev', '');

          if (versionCompare(version, currentVerison) > 0) {
            updatePBX.addNewVersionInformation(obj);
          }
        });
        $('a.redo').on('click', function (e) {
          e.preventDefault();
          if (updatePBX.$submitButton.hasClass('loading') || updatePBX.upgradeInProgress) return;
          updatePBX.$restoreModalForm.modal({
            closable: false,
            onDeny: function onDeny() {
              return true;
            },
            onApprove: function onApprove() {
              var params = [];
              var $aLink = $(e.target).closest('a');
              params.updateLink = $aLink.attr('href');
              params.md5 = $aLink.attr('data-md5');
              params.version = $aLink.attr('data-version');
              params.size = $aLink.attr('data-size');
              $aLink.find('i').addClass('loading');
              updatePBX.upgradeInProgress = true;
              PbxApi.FilesDownloadNewFirmware(params, updatePBX.cbAfterStartDownloadFirmware);
              return true;
            }
          }).modal('show');
        });
      }
    });
  },

  /**
   * Upload file by chunks
   * @param action
   * @param params
   */
  cbResumableUploadFile: function cbResumableUploadFile(action, params) {
    switch (action) {
      case 'fileSuccess':
        updatePBX.checkStatusFileMerging(params.response);
        break;

      case 'uploadStart':
        updatePBX.$submitButton.addClass('loading');
        updatePBX.$progressBar.show();
        updatePBX.$progressBarLabel.text(globalTranslate.upd_UploadInProgress);
        break;

      case 'progress':
        updatePBX.$progressBar.progress({
          percent: parseInt(params.percent, 10)
        });
        break;

      case 'error':
        updatePBX.$progressBarLabel.text(globalTranslate.upd_UploadError);
        updatePBX.$submitButton.removeClass('loading');
        UserMessage.showMultiString(globalTranslate.upd_UploadError);
        break;

      default:
    }
  },

  /**
   * Wait for file ready to use
   *
   * @param response ответ функции /pbxcore/api/upload/status
   */
  checkStatusFileMerging: function checkStatusFileMerging(response) {
    if (response === undefined || PbxApi.tryParseJSON(response) === false) {
      UserMessage.showMultiString("".concat(globalTranslate.upd_UploadError));
      return;
    }

    var json = JSON.parse(response);

    if (json === undefined || json.data === undefined) {
      UserMessage.showMultiString("".concat(globalTranslate.upd_UploadError));
      return;
    }

    var fileID = json.data.upload_id;
    var filePath = json.data.filename; // Wait until system glued all parts of file

    mergingCheckWorker.initialize(fileID, filePath);
  },

  /**
   * Callback after start PBX upgrading
   * @param response
   */
  cbAfterStartUpdate: function cbAfterStartUpdate(response) {
    if (response.length === 0 || response === false) {
      UserMessage.showMultiString(globalTranslate.upd_UpgradeError);
      updatePBX.$submitButton.removeClass('loading');
    }
  },

  /**
   * After start online upgrade we have to wait an answer,
   * and then start status check worker
   */
  cbAfterStartDownloadFirmware: function cbAfterStartDownloadFirmware(response) {
    if (response.filename !== undefined) {
      upgradeStatusLoopWorker.initialize(response.filename);
    } else {
      updatePBX.upgradeInProgress = false;
      $('i.loading.redo').removeClass('loading');
    }
  },

  /**
   * Add new block of update information on page
   */
  addNewVersionInformation: function addNewVersionInformation(obj) {
    $('#online-updates-block').show();
    var markdownText = decodeURIComponent(obj.description);
    markdownText = markdownText.replace(/<br>/g, '\r');
    markdownText = markdownText.replace(/<br >/g, '\r');
    markdownText = markdownText.replace(/\* \*/g, '*');
    markdownText = markdownText.replace(/\*\*/g, '*');
    var html = updatePBX.converter.makeHtml(markdownText);
    var dymanicRow = "\n\t\t\t<tr class=\"update-row\">\n\t\t\t<td class=\"center aligned\">".concat(obj.version, "</td>\n\t\t\t<td>").concat(html, "</td>\n\t\t\t<td class=\"right aligned collapsing\">\n    \t\t<div class=\"ui small basic icon buttons action-buttons\">\n    \t\t\t<a href=\"").concat(obj.href, "\" class=\"ui button redo popuped\" \n    \t\t\t\tdata-content = \"").concat(globalTranslate.bt_ToolTipUpgradeOnline, "\"\n\t\t\t\t\tdata-md5 =\"").concat(obj.md5, "\" data-size =\"").concat(obj.size, "\"\n\t\t\t\t\tdata-version = \"").concat(obj.version, "\" >\n\t\t\t\t\t<i class=\"icon redo blue\"></i>\n\t\t\t\t\t<span class=\"percent\"></span>\n\t\t\t\t</a>\n\t\t\t\t<a href=\"").concat(obj.href, "\" class=\"ui button download popuped\" \n\t\t\t\t\tdata-content = \"").concat(globalTranslate.bt_ToolTipDownload, "\"\n\t\t\t\t\tdata-md5 =\"").concat(obj.md5, "\" data-size =\"").concat(obj.size, "\">\n\t\t\t\t\t<i class=\"icon download blue\"></i>\n\t\t\t\t</a>\n    \t\t</div>   \n\t</tr>");
    $('#updates-table tbody').append(dymanicRow);
    $('a.popuped').popup();
  }
};
$(document).ready(function () {
  updatePBX.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9VcGRhdGUvdXBkYXRlLWluZGV4LmpzIl0sIm5hbWVzIjpbInVwZGF0ZVBCWCIsIiRmb3JtT2JqIiwiJCIsIiRzdWJtaXRCdXR0b24iLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsImZpbmQiLCJjdXJyZW50VmVyc2lvbiIsImdsb2JhbFBCWFZlcnNpb24iLCIkcmVzdG9yZU1vZGFsRm9ybSIsInVwZ3JhZGVJblByb2dyZXNzIiwiY29udmVydGVyIiwic2hvd2Rvd24iLCJDb252ZXJ0ZXIiLCJpbml0aWFsaXplIiwibW9kYWwiLCJhZGRDbGFzcyIsIm9uIiwiZSIsInRhcmdldCIsInBhcmVudHMiLCJjbGljayIsImZpbGVzIiwidW5kZWZpbmVkIiwiZmlsZW5hbWUiLCJuYW1lIiwicGFyZW50IiwidmFsIiwicmVtb3ZlQ2xhc3MiLCJwcmV2ZW50RGVmYXVsdCIsImhhc0NsYXNzIiwiZm9ybSIsImZpZWxkcyIsInZhbGlkYXRlUnVsZXMiLCJvblN1Y2Nlc3MiLCJjbG9zYWJsZSIsIm9uRGVueSIsIm9uQXBwcm92ZSIsImRhdGEiLCJQYnhBcGkiLCJGaWxlc1VwbG9hZEZpbGUiLCJjYlJlc3VtYWJsZVVwbG9hZEZpbGUiLCJyZXF1ZXN0RGF0YSIsIlBCWFZFUiIsIkxBTkdVQUdFIiwiZ2xvYmFsV2ViQWRtaW5MYW5ndWFnZSIsImFwaSIsInVybCIsIkNvbmZpZyIsInVwZGF0ZVVybCIsIm1ldGhvZCIsInN1Y2Nlc3NUZXN0IiwicmVzcG9uc2UiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwicmVzdWx0IiwiY3VycmVudFZlcmlzb24iLCJyZXBsYWNlIiwiZmlybXdhcmUiLCJmb3JFYWNoIiwib2JqIiwidmVyc2lvbiIsInZlcnNpb25Db21wYXJlIiwiYWRkTmV3VmVyc2lvbkluZm9ybWF0aW9uIiwicGFyYW1zIiwiJGFMaW5rIiwiY2xvc2VzdCIsInVwZGF0ZUxpbmsiLCJhdHRyIiwibWQ1Iiwic2l6ZSIsIkZpbGVzRG93bmxvYWROZXdGaXJtd2FyZSIsImNiQWZ0ZXJTdGFydERvd25sb2FkRmlybXdhcmUiLCJhY3Rpb24iLCJjaGVja1N0YXR1c0ZpbGVNZXJnaW5nIiwic2hvdyIsInRleHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJ1cGRfVXBsb2FkSW5Qcm9ncmVzcyIsInByb2dyZXNzIiwicGVyY2VudCIsInBhcnNlSW50IiwidXBkX1VwbG9hZEVycm9yIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJ0cnlQYXJzZUpTT04iLCJqc29uIiwiSlNPTiIsInBhcnNlIiwiZmlsZUlEIiwidXBsb2FkX2lkIiwiZmlsZVBhdGgiLCJtZXJnaW5nQ2hlY2tXb3JrZXIiLCJjYkFmdGVyU3RhcnRVcGRhdGUiLCJ1cGRfVXBncmFkZUVycm9yIiwidXBncmFkZVN0YXR1c0xvb3BXb3JrZXIiLCJtYXJrZG93blRleHQiLCJkZWNvZGVVUklDb21wb25lbnQiLCJkZXNjcmlwdGlvbiIsImh0bWwiLCJtYWtlSHRtbCIsImR5bWFuaWNSb3ciLCJocmVmIiwiYnRfVG9vbFRpcFVwZ3JhZGVPbmxpbmUiLCJidF9Ub29sVGlwRG93bmxvYWQiLCJhcHBlbmQiLCJwb3B1cCIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBRUEsSUFBTUEsU0FBUyxHQUFHO0FBQ2pCQyxFQUFBQSxRQUFRLEVBQUVDLENBQUMsQ0FBQyxlQUFELENBRE07QUFFakJDLEVBQUFBLGFBQWEsRUFBRUQsQ0FBQyxDQUFDLGVBQUQsQ0FGQztBQUdqQkUsRUFBQUEsWUFBWSxFQUFFRixDQUFDLENBQUMsc0JBQUQsQ0FIRTtBQUlqQkcsRUFBQUEsaUJBQWlCLEVBQUVILENBQUMsQ0FBQyxzQkFBRCxDQUFELENBQTBCSSxJQUExQixDQUErQixRQUEvQixDQUpGO0FBS2pCQyxFQUFB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Q0FBMEJ3RyxNQUExQixDQUFpQ0osVUFBakM7QUFDQXBHLElBQUFBLENBQUMsQ0FBQyxXQUFELENBQUQsQ0FBZXlHLEtBQWY7QUFDQTtBQTVNZ0IsQ0FBbEI7QUFnTkF6RyxDQUFDLENBQUMwRyxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCN0csRUFBQUEsU0FBUyxDQUFDYyxVQUFWO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBQYnhBcGksIGdsb2JhbFBCWFZlcnNpb24sIGdsb2JhbFRyYW5zbGF0ZSxcbmdsb2JhbFdlYkFkbWluTGFuZ3VhZ2UsIHNob3dkb3duLCBVc2VyTWVzc2FnZSwgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIsIENvbmZpZyAqL1xuXG5jb25zdCB1cGRhdGVQQlggPSB7XG5cdCRmb3JtT2JqOiAkKCcjdXBncmFkZS1mb3JtJyksXG5cdCRzdWJtaXRCdXR0b246ICQoJyNzdWJtaXRidXR0b24nKSxcblx0JHByb2dyZXNzQmFyOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhcicpLFxuXHQkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKS5maW5kKCcubGFiZWwnKSxcblx0Y3VycmVudFZlcnNpb246IGdsb2JhbFBCWFZlcnNpb24sXG5cdCRyZXN0b3JlTW9kYWxGb3JtOiAkKCcjdXBkYXRlLW1vZGFsLWZvcm0nKSxcblx0dXBncmFkZUluUHJvZ3Jlc3M6IGZhbHNlLFxuXHRjb252ZXJ0ZXI6IG5ldyBzaG93ZG93bi5Db252ZXJ0ZXIoKSxcblx0aW5pdGlhbGl6ZSgpIHtcblx0XHR1cGRhdGVQQlguJHJlc3RvcmVNb2RhbEZvcm0ubW9kYWwoKTtcblx0XHR1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblx0XHQkKCdpbnB1dDp0ZXh0LCAudWkuYnV0dG9uJywgJy51aS5hY3Rpb24uaW5wdXQnKS5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0JCgnaW5wdXQ6ZmlsZScsICQoZS50YXJnZXQpLnBhcmVudHMoKSkuY2xpY2soKTtcblx0XHR9KTtcblxuXHRcdCQoJ2lucHV0OmZpbGUnLCAnLnVpLmFjdGlvbi5pbnB1dCcpLm9uKCdjaGFuZ2UnLCAoZSkgPT4ge1xuXHRcdFx0aWYgKGUudGFyZ2V0LmZpbGVzWzBdICE9PSB1bmRlZmluZWQpIHtcblx0XHRcdFx0Y29uc3QgZmlsZW5hbWUgPSBlLnRhcmdldC5maWxlc1swXS5uYW1lO1xuXHRcdFx0XHQkKCdpbnB1dDp0ZXh0JywgJChlLnRhcmdldCkucGFyZW50KCkpLnZhbChmaWxlbmFtZSk7XG5cdFx0XHRcdHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRpZiAodXBkYXRlUEJYLiRzdWJtaXRCdXR0b24uaGFzQ2xhc3MoJ2xvYWRpbmcnKSB8fCB1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MpIHJldHVybjtcblxuXHRcdFx0dXBkYXRlUEJYLiRmb3JtT2JqXG5cdFx0XHRcdC5mb3JtKHtcblx0XHRcdFx0XHRvbjogJ2JsdXInLFxuXHRcdFx0XHRcdGZpZWxkczogdXBkYXRlUEJYLnZhbGlkYXRlUnVsZXMsXG5cdFx0XHRcdFx0b25TdWNjZXNzKCkge1xuXHRcdFx0XHRcdFx0dXBkYXRlUEJYLiRyZXN0b3JlTW9kYWxGb3JtXG5cdFx0XHRcdFx0XHRcdC5tb2RhbCh7XG5cdFx0XHRcdFx0XHRcdFx0Y2xvc2FibGU6IGZhbHNlLFxuXHRcdFx0XHRcdFx0XHRcdG9uRGVueTogKCkgPT4gdHJ1ZSxcblx0XHRcdFx0XHRcdFx0XHRvbkFwcHJvdmU6ICgpID0+IHtcblx0XHRcdFx0XHRcdFx0XHRcdHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdFx0XHRcdFx0XHR1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdFx0Y29uc3QgZGF0YSA9ICQoJ2lucHV0OmZpbGUnKVswXS5maWxlc1swXTtcblx0XHRcdFx0XHRcdFx0XHRcdFBieEFwaS5GaWxlc1VwbG9hZEZpbGUoZGF0YSwgdXBkYXRlUEJYLmNiUmVzdW1hYmxlVXBsb2FkRmlsZSk7XG5cdFx0XHRcdFx0XHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0XHQubW9kYWwoJ3Nob3cnKTtcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHR9KTtcblx0XHRcdHVwZGF0ZVBCWC4kZm9ybU9iai5mb3JtKCd2YWxpZGF0ZSBmb3JtJyk7XG5cdFx0fSk7XG5cdFx0Y29uc3QgcmVxdWVzdERhdGEgPSB7XG5cdFx0XHRQQlhWRVI6IGdsb2JhbFBCWFZlcnNpb24sXG5cdFx0XHRMQU5HVUFHRTogZ2xvYmFsV2ViQWRtaW5MYW5ndWFnZSxcblx0XHR9O1xuXHRcdCQuYXBpKHtcblx0XHRcdHVybDogYCR7Q29uZmlnLnVwZGF0ZVVybH1jaGVja05ld0Zpcm13YXJlYCxcblx0XHRcdG9uOiAnbm93Jyxcblx0XHRcdG1ldGhvZDogJ1BPU1QnLFxuXHRcdFx0ZGF0YTogcmVxdWVzdERhdGEsXG5cdFx0XHRzdWNjZXNzVGVzdChyZXNwb25zZSkge1xuXHRcdFx0XHQvLyB0ZXN0IHdoZXRoZXIgYSBKU09OIHJlc3BvbnNlIGlzIHZhbGlkXG5cdFx0XHRcdHJldHVybiByZXNwb25zZSAhPT0gdW5kZWZpbmVkXG5cdFx0XHRcdFx0JiYgT2JqZWN0LmtleXMocmVzcG9uc2UpLmxlbmd0aCA+IDBcblx0XHRcdFx0XHQmJiByZXNwb25zZS5yZXN1bHQgPT09ICdTVUNDRVNTJztcblx0XHRcdH0sXG5cdFx0XHRvblN1Y2Nlc3MocmVzcG9uc2UpIHtcblx0XHRcdFx0Y29uc3QgY3VycmVudFZlcmlzb24gPSB1cGRhdGVQQlguY3VycmVudFZlcnNpb24ucmVwbGFjZSgnLWRldicsICcnKTtcblx0XHRcdFx0cmVzcG9uc2UuZmlybXdhcmUuZm9yRWFjaCgob2JqKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgdmVyc2lvbiA9IG9iai52ZXJzaW9uLnJlcGxhY2UoJy1kZXYnLCAnJyk7XG5cdFx0XHRcdFx0aWYgKHZlcnNpb25Db21wYXJlKHZlcnNpb24sIGN1cnJlbnRWZXJpc29uKSA+IDApIHtcblx0XHRcdFx0XHRcdHVwZGF0ZVBCWC5hZGROZXdWZXJzaW9uSW5mb3JtYXRpb24ob2JqKTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXG5cdFx0XHRcdCQoJ2EucmVkbycpLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRcdGlmICh1cGRhdGVQQlguJHN1Ym1pdEJ1dHRvbi5oYXNDbGFzcygnbG9hZGluZycpIHx8IHVwZGF0ZVBCWC51cGdyYWRlSW5Qcm9ncmVzcykgcmV0dXJuO1xuXHRcdFx0XHRcdHVwZGF0ZVBCWC4kcmVzdG9yZU1vZGFsRm9ybVxuXHRcdFx0XHRcdFx0Lm1vZGFsKHtcblx0XHRcdFx0XHRcdFx0Y2xvc2FibGU6IGZhbHNlLFxuXHRcdFx0XHRcdFx0XHRvbkRlbnk6ICgpID0+IHRydWUsXG5cdFx0XHRcdFx0XHRcdG9uQXBwcm92ZTogKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0IHBhcmFtcyA9IFtdO1xuXHRcdFx0XHRcdFx0XHRcdGNvbnN0ICRhTGluayA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJ2EnKTtcblx0XHRcdFx0XHRcdFx0XHRwYXJhbXMudXBkYXRlTGluayA9ICRhTGluay5hdHRyKCdocmVmJyk7XG5cdFx0XHRcdFx0XHRcdFx0cGFyYW1zLm1kNSA9ICRhTGluay5hdHRyKCdkYXRhLW1kNScpO1xuXHRcdFx0XHRcdFx0XHRcdHBhcmFtcy52ZXJzaW9uID0gJGFMaW5rLmF0dHIoJ2RhdGEtdmVyc2lvbicpO1xuXHRcdFx0XHRcdFx0XHRcdHBhcmFtcy5zaXplID0gJGFMaW5rLmF0dHIoJ2RhdGEtc2l6ZScpO1xuXHRcdFx0XHRcdFx0XHRcdCRhTGluay5maW5kKCdpJykuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0XHRcdFx0XHR1cGRhdGVQQlgudXBncmFkZUluUHJvZ3Jlc3MgPSB0cnVlO1xuXHRcdFx0XHRcdFx0XHRcdFBieEFwaS5GaWxlc0Rvd25sb2FkTmV3RmlybXdhcmUocGFyYW1zLCB1cGRhdGVQQlguY2JBZnRlclN0YXJ0RG93bmxvYWRGaXJtd2FyZSk7XG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0Lm1vZGFsKCdzaG93Jyk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblx0XHR9KTtcblx0fSxcblx0LyoqXG5cdCAqIFVwbG9hZCBmaWxlIGJ5IGNodW5rc1xuXHQgKiBAcGFyYW0gYWN0aW9uXG5cdCAqIEBwYXJhbSBwYXJhbXNcblx0ICovXG5cdGNiUmVzdW1hYmxlVXBsb2FkRmlsZShhY3Rpb24sIHBhcmFtcyl7XG5cdFx0c3dpdGNoIChhY3Rpb24pIHtcblx0XHRcdGNhc2UgJ2ZpbGVTdWNjZXNzJzpcblx0XHRcdFx0dXBkYXRlUEJYLmNoZWNrU3RhdHVzRmlsZU1lcmdpbmcocGFyYW1zLnJlc3BvbnNlKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlICd1cGxvYWRTdGFydCc6XG5cdFx0XHRcdHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdHVwZGF0ZVBCWC4kcHJvZ3Jlc3NCYXIuc2hvdygpO1xuXHRcdFx0XHR1cGRhdGVQQlguJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEluUHJvZ3Jlc3MpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgJ3Byb2dyZXNzJzpcblx0XHRcdFx0dXBkYXRlUEJYLiRwcm9ncmVzc0Jhci5wcm9ncmVzcyh7XG5cdFx0XHRcdFx0cGVyY2VudDogcGFyc2VJbnQocGFyYW1zLnBlcmNlbnQsIDEwKSxcblx0XHRcdFx0fSk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSAnZXJyb3InOlxuXHRcdFx0XHR1cGRhdGVQQlguJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEVycm9yKTtcblx0XHRcdFx0dXBkYXRlUEJYLiRzdWJtaXRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0VXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGdsb2JhbFRyYW5zbGF0ZS51cGRfVXBsb2FkRXJyb3IpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGRlZmF1bHQ6XG5cblxuXHRcdH1cblx0fSxcblx0LyoqXG5cdCAqIFdhaXQgZm9yIGZpbGUgcmVhZHkgdG8gdXNlXG5cdCAqXG5cdCAqIEBwYXJhbSByZXNwb25zZSDQvtGC0LLQtdGCINGE0YPQvdC60YbQuNC4IC9wYnhjb3JlL2FwaS91cGxvYWQvc3RhdHVzXG5cdCAqL1xuXHRjaGVja1N0YXR1c0ZpbGVNZXJnaW5nKHJlc3BvbnNlKSB7XG5cdFx0aWYgKHJlc3BvbnNlID09PSB1bmRlZmluZWQgfHwgUGJ4QXBpLnRyeVBhcnNlSlNPTihyZXNwb25zZSkgPT09IGZhbHNlKSB7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoYCR7Z2xvYmFsVHJhbnNsYXRlLnVwZF9VcGxvYWRFcnJvcn1gKTtcblx0XHRcdHJldHVybjtcblx0XHR9XG5cdFx0Y29uc3QganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2UpO1xuXHRcdGlmIChqc29uID09PSB1bmRlZmluZWQgfHwganNvbi5kYXRhID09PSB1bmRlZmluZWQpIHtcblx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhgJHtnbG9iYWxUcmFuc2xhdGUudXBkX1VwbG9hZEVycm9yfWApO1xuXHRcdFx0cmV0dXJuO1xuXHRcdH1cblx0XHRjb25zdCBmaWxlSUQgPSBqc29uLmRhdGEudXBsb2FkX2lkO1xuXHRcdGNvbnN0IGZpbGVQYXRoID0ganNvbi5kYXRhLmZpbGVuYW1lO1xuXHRcdC8vIFdhaXQgdW50aWwgc3lzdGVtIGdsdWVkIGFsbCBwYXJ0cyBvZiBmaWxlXG5cdFx0bWVyZ2luZ0NoZWNrV29ya2VyLmluaXRpYWxpemUoZmlsZUlELCBmaWxlUGF0aCk7XG5cdH0sXG5cblx0LyoqXG5cdCAqIENhbGxiYWNrIGFmdGVyIHN0YXJ0IFBCWCB1cGdyYWRpbmdcblx0ICogQHBhcmFtIHJlc3BvbnNlXG5cdCAqL1xuXHRjYkFmdGVyU3RhcnRVcGRhdGUocmVzcG9uc2UpIHtcblx0XHRpZiAocmVzcG9uc2UubGVuZ3RoID09PSAwIHx8IHJlc3BvbnNlID09PSBmYWxzZSkge1xuXHRcdFx0VXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGdsb2JhbFRyYW5zbGF0ZS51cGRfVXBncmFkZUVycm9yKTtcblx0XHRcdHVwZGF0ZVBCWC4kc3VibWl0QnV0dG9uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0fVxuXHR9LFxuXHQvKipcblx0ICogQWZ0ZXIgc3RhcnQgb25saW5lIHVwZ3JhZGUgd2UgaGF2ZSB0byB3YWl0IGFuIGFuc3dlcixcblx0ICogYW5kIHRoZW4gc3RhcnQgc3RhdHVzIGNoZWNrIHdvcmtlclxuXHQgKi9cblx0Y2JBZnRlclN0YXJ0RG93bmxvYWRGaXJtd2FyZShyZXNwb25zZSkge1xuXHRcdGlmIChyZXNwb25zZS5maWxlbmFtZSAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHR1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5pbml0aWFsaXplKHJlc3BvbnNlLmZpbGVuYW1lKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dXBkYXRlUEJYLnVwZ3JhZGVJblByb2dyZXNzID0gZmFsc2U7XG5cdFx0XHQkKCdpLmxvYWRpbmcucmVkbycpLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG5cdFx0fVxuXHR9LFxuXHQvKipcblx0ICogQWRkIG5ldyBibG9jayBvZiB1cGRhdGUgaW5mb3JtYXRpb24gb24gcGFnZVxuXHQgKi9cblx0YWRkTmV3VmVyc2lvbkluZm9ybWF0aW9uKG9iaikge1xuXHRcdCQoJyNvbmxpbmUtdXBkYXRlcy1ibG9jaycpLnNob3coKTtcblx0XHRsZXQgbWFya2Rvd25UZXh0ID0gZGVjb2RlVVJJQ29tcG9uZW50KG9iai5kZXNjcmlwdGlvbik7XG5cdFx0bWFya2Rvd25UZXh0ID0gbWFya2Rvd25UZXh0LnJlcGxhY2UoLzxicj4vZywgJ1xccicpO1xuXHRcdG1hcmtkb3duVGV4dCA9IG1hcmtkb3duVGV4dC5yZXBsYWNlKC88YnIgPi9nLCAnXFxyJyk7XG5cdFx0bWFya2Rvd25UZXh0ID0gbWFya2Rvd25UZXh0LnJlcGxhY2UoL1xcKiBcXCovZywgJyonKTtcblx0XHRtYXJrZG93blRleHQgPSBtYXJrZG93blRleHQucmVwbGFjZSgvXFwqXFwqL2csICcqJyk7XG5cdFx0Y29uc3QgaHRtbCA9IHVwZGF0ZVBCWC5jb252ZXJ0ZXIubWFrZUh0bWwobWFya2Rvd25UZXh0KTtcblx0XHRjb25zdCBkeW1hbmljUm93ID0gYFxuXHRcdFx0PHRyIGNsYXNzPVwidXBkYXRlLXJvd1wiPlxuXHRcdFx0PHRkIGNsYXNzPVwiY2VudGVyIGFsaWduZWRcIj4ke29iai52ZXJzaW9ufTwvdGQ+XG5cdFx0XHQ8dGQ+JHtodG1sfTwvdGQ+XG5cdFx0XHQ8dGQgY2xhc3M9XCJyaWdodCBhbGlnbmVkIGNvbGxhcHNpbmdcIj5cbiAgICBcdFx0PGRpdiBjbGFzcz1cInVpIHNtYWxsIGJhc2ljIGljb24gYnV0dG9ucyBhY3Rpb24tYnV0dG9uc1wiPlxuICAgIFx0XHRcdDxhIGhyZWY9XCIke29iai5ocmVmfVwiIGNsYXNzPVwidWkgYnV0dG9uIHJlZG8gcG9wdXBlZFwiIFxuICAgIFx0XHRcdFx0ZGF0YS1jb250ZW50ID0gXCIke2dsb2JhbFRyYW5zbGF0ZS5idF9Ub29sVGlwVXBncmFkZU9ubGluZX1cIlxuXHRcdFx0XHRcdGRhdGEtbWQ1ID1cIiR7b2JqLm1kNX1cIiBkYXRhLXNpemUgPVwiJHtvYmouc2l6ZX1cIlxuXHRcdFx0XHRcdGRhdGEtdmVyc2lvbiA9IFwiJHtvYmoudmVyc2lvbn1cIiA+XG5cdFx0XHRcdFx0PGkgY2xhc3M9XCJpY29uIHJlZG8gYmx1ZVwiPjwvaT5cblx0XHRcdFx0XHQ8c3BhbiBjbGFzcz1cInBlcmNlbnRcIj48L3NwYW4+XG5cdFx0XHRcdDwvYT5cblx0XHRcdFx0PGEgaHJlZj1cIiR7b2JqLmhyZWZ9XCIgY2xhc3M9XCJ1aSBidXR0b24gZG93bmxvYWQgcG9wdXBlZFwiIFxuXHRcdFx0XHRcdGRhdGEtY29udGVudCA9IFwiJHtnbG9iYWxUcmFuc2xhdGUuYnRfVG9vbFRpcERvd25sb2FkfVwiXG5cdFx0XHRcdFx0ZGF0YS1tZDUgPVwiJHtvYmoubWQ1fVwiIGRhdGEtc2l6ZSA9XCIke29iai5zaXplfVwiPlxuXHRcdFx0XHRcdDxpIGNsYXNzPVwiaWNvbiBkb3dubG9hZCBibHVlXCI+PC9pPlxuXHRcdFx0XHQ8L2E+XG4gICAgXHRcdDwvZGl2PiAgIFxuXHQ8L3RyPmA7XG5cdFx0JCgnI3VwZGF0ZXMtdGFibGUgdGJvZHknKS5hcHBlbmQoZHltYW5pY1Jvdyk7XG5cdFx0JCgnYS5wb3B1cGVkJykucG9wdXAoKTtcblx0fSxcbn07XG5cblxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuXHR1cGRhdGVQQlguaW5pdGlhbGl6ZSgpO1xufSk7XG5cbiJdfQ==