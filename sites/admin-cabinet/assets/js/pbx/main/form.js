"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright © 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalTranslate */
var Form = {
  $formObj: '',
  validateRules: {},
  url: '',
  cbBeforeSendForm: '',
  cbAfterSendForm: '',
  $submitButton: $('#submitbutton'),
  $dropdownSubmit: $('#dropdownSubmit'),
  $submitModeInput: $('input[name="submitMode"]'),
  processData: true,
  contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
  keyboardShortcuts: true,
  enableDirrity: true,
  afterSubmitIndexUrl: '',
  afterSubmitModifyUrl: '',
  oldFormValues: [],
  initialize: function initialize() {
    Form.$formObj.form.settings.rules.notRegExp = Form.notRegExpValidateRule;
    Form.$formObj.form.settings.rules.specialCharactersExist = Form.specialCharactersExistValidateRule;
    if (Form.enableDirrity) Form.initializeDirrity();
    Form.$submitButton.on('click', function (e) {
      e.preventDefault();
      if (Form.$submitButton.hasClass('loading')) return;
      if (Form.$submitButton.hasClass('disabled')) return;
      Form.$formObj.form({
        on: 'blur',
        fields: Form.validateRules,
        onSuccess: function onSuccess() {
          Form.submitForm();
        },
        onFailure: function onFailure() {
          Form.$formObj.removeClass('error').addClass('error');
        }
      });
      Form.$formObj.form('validate form');
    });

    if (Form.$dropdownSubmit.length > 0) {
      Form.$dropdownSubmit.dropdown({
        onChange: function onChange(value) {
          var translateKey = "bt_".concat(value);
          Form.$submitModeInput.val(value);
          Form.$submitButton.html("<i class=\"save icon\"></i> ".concat(globalTranslate[translateKey])).click();
        }
      });
    }

    Form.$formObj.on('submit', function (e) {
      e.preventDefault();
    });
  },

  /**
   * Инициализация отслеживания изменений формы
   */
  initializeDirrity: function initializeDirrity() {
    Form.saveInitialValues();
    Form.setEvents();
    Form.$submitButton.addClass('disabled');
    Form.$dropdownSubmit.addClass('disabled');
  },

  /**
   * Сохраняет первоначальные значения для проверки на изменения формы
   */
  saveInitialValues: function saveInitialValues() {
    Form.oldFormValues = Form.$formObj.form('get values');
  },

  /**
   * Запускает обработчики изменения объектов формы
   */
  setEvents: function setEvents() {
    Form.$formObj.find('input, select').change(function () {
      Form.checkValues();
    });
    Form.$formObj.find('input, textarea').on('keyup keydown blur', function () {
      Form.checkValues();
    });
    Form.$formObj.find('.ui.checkbox').on('click', function () {
      Form.checkValues();
    });
  },

  /**
   * Сверяет изменения старых и новых значений формы
   */
  checkValues: function checkValues() {
    var newFormValues = Form.$formObj.form('get values');

    if (JSON.stringify(Form.oldFormValues) === JSON.stringify(newFormValues)) {
      Form.$submitButton.addClass('disabled');
      Form.$dropdownSubmit.addClass('disabled');
    } else {
      Form.$submitButton.removeClass('disabled');
      Form.$dropdownSubmit.removeClass('disabled');
    }
  },

  /**
   * Отправка формы на сервер
   */
  submitForm: function submitForm() {
    $.api({
      url: Form.url,
      on: 'now',
      method: 'POST',
      processData: Form.processData,
      contentType: Form.contentType,
      keyboardShortcuts: Form.keyboardShortcuts,
      beforeSend: function beforeSend(settings) {
        Form.$submitButton.addClass('loading');
        var cbBeforeSendResult = Form.cbBeforeSendForm(settings);

        if (cbBeforeSendResult === false) {
          Form.$submitButton.transition('shake').removeClass('loading');
        } else {
          $.each(cbBeforeSendResult.data, function (index, value) {
            if (index.indexOf('ecret') > -1 || index.indexOf('assword') > -1) return;
            if (typeof value === 'string') cbBeforeSendResult.data[index] = value.trim();
          });
        }

        return cbBeforeSendResult;
      },
      onSuccess: function onSuccess(response) {
        $('.ui.message.ajax').remove();
        $.each(response.message, function (index, value) {
          if (index === 'error') {
            Form.$submitButton.transition('shake').removeClass('loading');
            Form.$formObj.after("<div class=\"ui ".concat(index, " message ajax\">").concat(value, "</div>"));
          }
        });
        var event = document.createEvent('Event');
        event.initEvent('ConfigDataChanged', false, true);
        window.dispatchEvent(event);
        Form.cbAfterSendForm(response);

        if (response.success && response.reload.length > 0 && Form.$submitModeInput.val() === 'SaveSettings') {
          window.location = globalRootUrl + response.reload;
        } else if (response.success && Form.$submitModeInput.val() === 'SaveSettingsAndAddNew') {
          if (Form.afterSubmitModifyUrl.length > 1) {
            window.location = Form.afterSubmitModifyUrl;
          } else {
            var emptyUrl = window.location.href.split('modify');
            var action = 'modify';
            var prefixData = emptyUrl[1].split('/');

            if (prefixData.length > 0) {
              action = action + prefixData[0];
            }

            if (emptyUrl.length > 1) {
              window.location = "".concat(emptyUrl[0]).concat(action, "/");
            }
          }
        } else if (response.success && Form.$submitModeInput.val() === 'SaveSettingsAndExit') {
          if (Form.afterSubmitIndexUrl.length > 1) {
            window.location = Form.afterSubmitIndexUrl;
          } else {
            var _emptyUrl = window.location.href.split('modify');

            if (_emptyUrl.length > 1) {
              window.location = "".concat(_emptyUrl[0], "index/");
            }
          }
        } else if (response.success && response.reload.length > 0) {
          window.location = globalRootUrl + response.reload;
        } else if (response.success && Form.enableDirrity) {
          Form.initializeDirrity();
        }

        Form.$submitButton.removeClass('loading');
      },
      onFailure: function onFailure(response) {
        Form.$formObj.after(response);
        Form.$submitButton.transition('shake').removeClass('loading');
      }
    });
  },

  /**
   * Возвращщает ИСТИНА, если значение НЕ соответствует Regex.
   * @param value
   * @param regex
   * @returns {boolean}
   */
  notRegExpValidateRule: function notRegExpValidateRule(value, regex) {
    return value.match(regex) !== null;
  },

  /**
   * Возвращщает ИСТИНА, если значение содержит спецсимволы.
   * @param value
   * @returns {boolean}
   */
  specialCharactersExistValidateRule: function specialCharactersExistValidateRule(value) {
    return value.match(/[()$^;#"><,.%№@!+=_]/) === null;
  }
}; // export default Form;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWluL2Zvcm0uanMiXSwibmFtZXMiOlsiRm9ybSIsIiRmb3JtT2JqIiwidmFsaWRhdGVSdWxlcyIsInVybCIsImNiQmVmb3JlU2VuZEZvcm0iLCJjYkFmdGVyU2VuZEZvcm0iLCIkc3VibWl0QnV0dG9uIiwiJCIsIiRkcm9wZG93blN1Ym1pdCIsIiRzdWJtaXRNb2RlSW5wdXQiLCJwcm9jZXNzRGF0YSIsImNvbnRlbnRUeXBlIiwia2V5Ym9hcmRTaG9ydGN1dHMiLCJlbmFibGVEaXJyaXR5IiwiYWZ0ZXJTdWJtaXRJbmRleFVybCIsImFmdGVyU3VibWl0TW9kaWZ5VXJsIiwib2xkRm9ybVZhbHVlcyIsImluaXRpYWxpemUiLCJmb3JtIiwic2V0dGluZ3MiLCJydWxlcyIsIm5vdFJlZ0V4cCIsIm5vdFJlZ0V4cFZhbGlkYXRlUnVsZSIsInNwZWNpYWxDaGFyYWN0ZXJzRXhpc3QiLCJzcGVjaWFsQ2hhcmFjdGVyc0V4aXN0VmFsaWRhdGVSdWxlIiwiaW5pdGlhbGl6ZURpcnJpdHkiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImhhc0NsYXNzIiwiZmllbGRzIiwib25TdWNjZXNzIiwic3VibWl0Rm9ybSIsIm9uRmFpbHVyZSIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJsZW5ndGgiLCJkcm9wZG93biIsIm9uQ2hhbmdlIiwidmFsdWUiLCJ0cmFuc2xhdGVLZXkiLCJ2YWwiLCJodG1sIiwiZ2xvYmFsVHJhbnNsYXRlIiwiY2xpY2siLCJzYXZlSW5pdGlhbFZhbHVlcyIsInNldEV2ZW50cyIsImZpbmQiLCJjaGFuZ2UiLCJjaGVja1ZhbHVlcyIsIm5ld0Zvcm1WYWx1ZXMiLCJKU09OIiwic3RyaW5naWZ5IiwiYXBpIiwibWV0aG9kIiwiYmVmb3JlU2VuZCIsImNiQmVmb3JlU2VuZFJlc3VsdCIsInRyYW5zaXRpb24iLCJlYWNoIiwiZGF0YSIsImluZGV4IiwiaW5kZXhPZiIsInRyaW0iLCJyZXNwb25zZSIsInJlbW92ZSIsIm1lc3NhZ2UiLCJhZnRlciIsImV2ZW50IiwiZG9jdW1lbnQiLCJjcmVhdGVFdmVudCIsImluaXRFdmVudCIsIndpbmRvdyIsImRpc3BhdGNoRXZlbnQiLCJzdWNjZXNzIiwicmVsb2FkIiwibG9jYXRpb24iLCJnbG9iYWxSb290VXJsIiwiZW1wdHlVcmwiLCJocmVmIiwic3BsaXQiLCJhY3Rpb24iLCJwcmVmaXhEYXRhIiwicmVnZXgiLCJtYXRjaCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBRUEsSUFBTUEsSUFBSSxHQUFHO0FBQ1pDLEVBQUFBLFFBQVEsRUFBRSxFQURFO0FBRVpDLEVBQUFBLGFBQWEsRUFBRSxFQUZIO0FBR1pDLEVBQUFBLEdBQUcsRUFBRSxFQUhPO0FBSVpDLEVBQUFBLGdCQUFnQixFQUFFLEVBSk47QUFLWkMsRUFBQUEsZUFBZSxFQUFFLEVBTEw7QUFNWkMsRUFBQUEsYUFBYSxFQUFFQyxDQUFDLENBQUMsZUFBRCxDQU5KO0FBT1pDLEVBQUFBLGVBQWUsRUFBRUQsQ0FBQyxDQUFDLGlCQUFELENBUE47QUFRWkUsRUFBQUEsZ0JBQWdCLEVBQUVGLENBQUMsQ0FBQywwQkFBRCxDQVJQO0FBU1pHLEVBQUFBLFdBQVcsRUFBRSxJQVREO0FBVVpDLEVBQUFBLFdBQVcsRUFBRSxrREFWRDtBQVdaQyxFQUFBQSxpQkFBaUIsRUFBRSxJQVhQO0FBWVpDLEVBQUFBLGFBQWEsRUFBRSxJQVpIO0FBYVpDLEVBQUFBLG1CQUFtQixFQUFFLEVBYlQ7QUFjWkMsRUFBQUEsb0JBQW9CLEVBQUUsRUFkVjtBQWVaQyxFQUFBQSxhQUFhLEVBQUUsRUFmSDtBQWdCWkMsRUFBQUEsVUFoQlksd0JBZ0JDO0FBQ1pqQixJQUFBQSxJQUFJLENBQUNDLFFBQUwsQ0FBY2lCLElBQWQsQ0FBbUJDLFFBQW5CLENBQTRCQyxLQUE1QixDQUFrQ0MsU0FBbEMsR0FBa0RyQixJ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Q21DLFVBQUFBLE1BQU0sQ0FBQ0ksUUFBUCxHQUFrQkMsYUFBYSxHQUFHYixRQUFRLENBQUNXLE1BQTNDO0FBQ0EsU0FITSxNQUdBLElBQUlYLFFBQVEsQ0FBQ1UsT0FBVCxJQUFvQnpFLElBQUksQ0FBQ2EsYUFBN0IsRUFBNEM7QUFDbERiLFVBQUFBLElBQUksQ0FBQ3lCLGlCQUFMO0FBQ0E7O0FBQ0R6QixRQUFBQSxJQUFJLENBQUNNLGFBQUwsQ0FBbUI0QixXQUFuQixDQUErQixTQUEvQjtBQUNBLE9BcEVJO0FBcUVMRCxNQUFBQSxTQXJFSyxxQkFxRUs4QixRQXJFTCxFQXFFZTtBQUNuQi9ELFFBQUFBLElBQUksQ0FBQ0MsUUFBTCxDQUFjaUUsS0FBZCxDQUFvQkgsUUFBcEI7QUFDQS9ELFFBQUFBLElBQUksQ0FBQ00sYUFBTCxDQUNFbUQsVUFERixDQUNhLE9BRGIsRUFFRXZCLFdBRkYsQ0FFYyxTQUZkO0FBR0E7QUExRUksS0FBTjtBQTZFQSxHQWhMVzs7QUFrTFo7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0NaLEVBQUFBLHFCQXhMWSxpQ0F3TFVpQixLQXhMVixFQXdMaUIyQyxLQXhMakIsRUF3THVCO0FBQ2xDLFdBQU8zQyxLQUFLLENBQUM0QyxLQUFOLENBQVlELEtBQVosTUFBdUIsSUFBOUI7QUFDQSxHQTFMVzs7QUE0TFo7QUFDRDtBQUNBO0FBQ0E7QUFDQTtBQUNDMUQsRUFBQUEsa0NBak1ZLDhDQWlNdUJlLEtBak12QixFQWlNNkI7QUFDeEMsV0FBT0EsS0FBSyxDQUFDNEMsS0FBTixDQUFZLHNCQUFaLE1BQXdDLElBQS9DO0FBQ0E7QUFuTVcsQ0FBYixDLENBc01BIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIGdsb2JhbFRyYW5zbGF0ZSAqL1xuXG5jb25zdCBGb3JtID0ge1xuXHQkZm9ybU9iajogJycsXG5cdHZhbGlkYXRlUnVsZXM6IHt9LFxuXHR1cmw6ICcnLFxuXHRjYkJlZm9yZVNlbmRGb3JtOiAnJyxcblx0Y2JBZnRlclNlbmRGb3JtOiAnJyxcblx0JHN1Ym1pdEJ1dHRvbjogJCgnI3N1Ym1pdGJ1dHRvbicpLFxuXHQkZHJvcGRvd25TdWJtaXQ6ICQoJyNkcm9wZG93blN1Ym1pdCcpLFxuXHQkc3VibWl0TW9kZUlucHV0OiAkKCdpbnB1dFtuYW1lPVwic3VibWl0TW9kZVwiXScpLFxuXHRwcm9jZXNzRGF0YTogdHJ1ZSxcblx0Y29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgnLFxuXHRrZXlib2FyZFNob3J0Y3V0czogdHJ1ZSxcblx0ZW5hYmxlRGlycml0eTogdHJ1ZSxcblx0YWZ0ZXJTdWJtaXRJbmRleFVybDogJycsXG5cdGFmdGVyU3VibWl0TW9kaWZ5VXJsOiAnJyxcblx0b2xkRm9ybVZhbHVlczogW10sXG5cdGluaXRpYWxpemUoKSB7XG5cdFx0Rm9ybS4kZm9ybU9iai5mb3JtLnNldHRpbmdzLnJ1bGVzLm5vdFJlZ0V4cCBcdFx0XHQgPSBGb3JtLm5vdFJlZ0V4cFZhbGlkYXRlUnVsZTtcblx0XHRGb3JtLiRmb3JtT2JqLmZvcm0uc2V0dGluZ3MucnVsZXMuc3BlY2lhbENoYXJhY3RlcnNFeGlzdCA9IEZvcm0uc3BlY2lhbENoYXJhY3RlcnNFeGlzdFZhbGlkYXRlUnVsZTtcblx0XHRpZiAoRm9ybS5lbmFibGVEaXJyaXR5KSBGb3JtLmluaXRpYWxpemVEaXJyaXR5KCk7XG5cblx0XHRGb3JtLiRzdWJtaXRCdXR0b24ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdGlmIChGb3JtLiRzdWJtaXRCdXR0b24uaGFzQ2xhc3MoJ2xvYWRpbmcnKSkgcmV0dXJuO1xuXHRcdFx0aWYgKEZvcm0uJHN1Ym1pdEJ1dHRvbi5oYXNDbGFzcygnZGlzYWJsZWQnKSkgcmV0dXJuO1xuXHRcdFx0Rm9ybS4kZm9ybU9ialxuXHRcdFx0XHQuZm9ybSh7XG5cdFx0XHRcdFx0b246ICdibHVyJyxcblx0XHRcdFx0XHRmaWVsZHM6IEZvcm0udmFsaWRhdGVSdWxlcyxcblx0XHRcdFx0XHRvblN1Y2Nlc3MoKSB7XG5cdFx0XHRcdFx0XHRGb3JtLnN1Ym1pdEZvcm0oKTtcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdG9uRmFpbHVyZSgpIHtcblx0XHRcdFx0XHRcdEZvcm0uJGZvcm1PYmoucmVtb3ZlQ2xhc3MoJ2Vycm9yJykuYWRkQ2xhc3MoJ2Vycm9yJyk7XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0fSk7XG5cdFx0XHRGb3JtLiRmb3JtT2JqLmZvcm0oJ3ZhbGlkYXRlIGZvcm0nKTtcblx0XHR9KTtcblx0XHRpZiAoRm9ybS4kZHJvcGRvd25TdWJtaXQubGVuZ3RoID4gMCkge1xuXHRcdFx0Rm9ybS4kZHJvcGRvd25TdWJtaXQuZHJvcGRvd24oe1xuXHRcdFx0XHRvbkNoYW5nZTogKHZhbHVlKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgdHJhbnNsYXRlS2V5ID0gYGJ0XyR7dmFsdWV9YDtcblx0XHRcdFx0XHRGb3JtLiRzdWJtaXRNb2RlSW5wdXQudmFsKHZhbHVlKTtcblx0XHRcdFx0XHRGb3JtLiRzdWJtaXRCdXR0b25cblx0XHRcdFx0XHRcdC5odG1sKGA8aSBjbGFzcz1cInNhdmUgaWNvblwiPjwvaT4gJHtnbG9iYWxUcmFuc2xhdGVbdHJhbnNsYXRlS2V5XX1gKVxuXHRcdFx0XHRcdFx0LmNsaWNrKCk7XG5cdFx0XHRcdH0sXG5cdFx0XHR9KTtcblx0XHR9XG5cdFx0Rm9ybS4kZm9ybU9iai5vbignc3VibWl0JywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHR9KTtcblx0fSxcblx0LyoqXG5cdCAqINCY0L3QuNGG0LjQsNC70LjQt9Cw0YbQuNGPINC+0YLRgdC70LXQttC40LLQsNC90LjRjyDQuNC30LzQtdC90LXQvdC40Lkg0YTQvtGA0LzRi1xuXHQgKi9cblx0aW5pdGlhbGl6ZURpcnJpdHkoKSB7XG5cdFx0Rm9ybS5zYXZlSW5pdGlhbFZhbHVlcygpO1xuXHRcdEZvcm0uc2V0RXZlbnRzKCk7XG5cdFx0Rm9ybS4kc3VibWl0QnV0dG9uLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdEZvcm0uJGRyb3Bkb3duU3VibWl0LmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHR9LFxuXHQvKipcblx0ICog0KHQvtGF0YDQsNC90Y/QtdGCINC/0LXRgNCy0L7QvdCw0YfQsNC70YzQvdGL0LUg0LfQvdCw0YfQtdC90LjRjyDQtNC70Y8g0L/RgNC+0LLQtdGA0LrQuCDQvdCwINC40LfQvNC10L3QtdC90LjRjyDRhNC+0YDQvNGLXG5cdCAqL1xuXHRzYXZlSW5pdGlhbFZhbHVlcygpIHtcblx0XHRGb3JtLm9sZEZvcm1WYWx1ZXMgPSBGb3JtLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcblx0fSxcblx0LyoqXG5cdCAqINCX0LDQv9GD0YHQutCw0LXRgiDQvtCx0YDQsNCx0L7RgtGH0LjQutC4INC40LfQvNC10L3QtdC90LjRjyDQvtCx0YrQtdC60YLQvtCyINGE0L7RgNC80Ytcblx0ICovXG5cdHNldEV2ZW50cygpIHtcblx0XHRGb3JtLiRmb3JtT2JqLmZpbmQoJ2lucHV0LCBzZWxlY3QnKS5jaGFuZ2UoKCkgPT4ge1xuXHRcdFx0Rm9ybS5jaGVja1ZhbHVlcygpO1xuXHRcdH0pO1xuXHRcdEZvcm0uJGZvcm1PYmouZmluZCgnaW5wdXQsIHRleHRhcmVhJykub24oJ2tleXVwIGtleWRvd24gYmx1cicsICgpID0+IHtcblx0XHRcdEZvcm0uY2hlY2tWYWx1ZXMoKTtcblx0XHR9KTtcblx0XHRGb3JtLiRmb3JtT2JqLmZpbmQoJy51aS5jaGVja2JveCcpLm9uKCdjbGljaycsICgpID0+IHtcblx0XHRcdEZvcm0uY2hlY2tWYWx1ZXMoKTtcblx0XHR9KTtcblx0fSxcblx0LyoqXG5cdCAqINCh0LLQtdGA0Y/QtdGCINC40LfQvNC10L3QtdC90LjRjyDRgdGC0LDRgNGL0YUg0Lgg0L3QvtCy0YvRhSDQt9C90LDRh9C10L3QuNC5INGE0L7RgNC80Ytcblx0ICovXG5cdGNoZWNrVmFsdWVzKCkge1xuXHRcdGNvbnN0IG5ld0Zvcm1WYWx1ZXMgPSBGb3JtLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcblx0XHRpZiAoSlNPTi5zdHJpbmdpZnkoRm9ybS5vbGRGb3JtVmFsdWVzKSA9PT0gSlNPTi5zdHJpbmdpZnkobmV3Rm9ybVZhbHVlcykpIHtcblx0XHRcdEZvcm0uJHN1Ym1pdEJ1dHRvbi5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblx0XHRcdEZvcm0uJGRyb3Bkb3duU3VibWl0LmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRGb3JtLiRzdWJtaXRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0XHRGb3JtLiRkcm9wZG93blN1Ym1pdC5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcblx0XHR9XG5cdH0sXG5cdC8qKlxuXHQgKiDQntGC0L/RgNCw0LLQutCwINGE0L7RgNC80Ysg0L3QsCDRgdC10YDQstC10YBcblx0ICovXG5cdHN1Ym1pdEZvcm0oKSB7XG5cdFx0JC5hcGkoe1xuXHRcdFx0dXJsOiBGb3JtLnVybCxcblx0XHRcdG9uOiAnbm93Jyxcblx0XHRcdG1ldGhvZDogJ1BPU1QnLFxuXHRcdFx0cHJvY2Vzc0RhdGE6IEZvcm0ucHJvY2Vzc0RhdGEsXG5cdFx0XHRjb250ZW50VHlwZTogRm9ybS5jb250ZW50VHlwZSxcblx0XHRcdGtleWJvYXJkU2hvcnRjdXRzOiBGb3JtLmtleWJvYXJkU2hvcnRjdXRzLFxuXHRcdFx0YmVmb3JlU2VuZChzZXR0aW5ncykge1xuXHRcdFx0XHRGb3JtLiRzdWJtaXRCdXR0b24uYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0Y29uc3QgY2JCZWZvcmVTZW5kUmVzdWx0ID0gRm9ybS5jYkJlZm9yZVNlbmRGb3JtKHNldHRpbmdzKTtcblx0XHRcdFx0aWYgKGNiQmVmb3JlU2VuZFJlc3VsdCA9PT0gZmFsc2UpIHtcblx0XHRcdFx0XHRGb3JtLiRzdWJtaXRCdXR0b25cblx0XHRcdFx0XHRcdC50cmFuc2l0aW9uKCdzaGFrZScpXG5cdFx0XHRcdFx0XHQucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHQkLmVhY2goY2JCZWZvcmVTZW5kUmVzdWx0LmRhdGEsIChpbmRleCwgdmFsdWUpID0+IHtcblx0XHRcdFx0XHRcdGlmIChpbmRleC5pbmRleE9mKCdlY3JldCcpID4gLTEgfHwgaW5kZXguaW5kZXhPZignYXNzd29yZCcpID4gLTEpIHJldHVybjtcblx0XHRcdFx0XHRcdGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSBjYkJlZm9yZVNlbmRSZXN1bHQuZGF0YVtpbmRleF0gPSB2YWx1ZS50cmltKCk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0cmV0dXJuIGNiQmVmb3JlU2VuZFJlc3VsdDtcblx0XHRcdH0sXG5cdFx0XHRvblN1Y2Nlc3MocmVzcG9uc2UpIHtcblx0XHRcdFx0JCgnLnVpLm1lc3NhZ2UuYWpheCcpLnJlbW92ZSgpO1xuXHRcdFx0XHQkLmVhY2gocmVzcG9uc2UubWVzc2FnZSwgKGluZGV4LCB2YWx1ZSkgPT4ge1xuXHRcdFx0XHRcdGlmIChpbmRleCA9PT0gJ2Vycm9yJykge1xuXHRcdFx0XHRcdFx0Rm9ybS4kc3VibWl0QnV0dG9uLnRyYW5zaXRpb24oJ3NoYWtlJykucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdFx0XHRcdEZvcm0uJGZvcm1PYmouYWZ0ZXIoYDxkaXYgY2xhc3M9XCJ1aSAke2luZGV4fSBtZXNzYWdlIGFqYXhcIj4ke3ZhbHVlfTwvZGl2PmApO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSk7XG5cdFx0XHRcdGNvbnN0IGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7XG5cdFx0XHRcdGV2ZW50LmluaXRFdmVudCgnQ29uZmlnRGF0YUNoYW5nZWQnLCBmYWxzZSwgdHJ1ZSk7XG5cdFx0XHRcdHdpbmRvdy5kaXNwYXRjaEV2ZW50KGV2ZW50KTtcblx0XHRcdFx0Rm9ybS5jYkFmdGVyU2VuZEZvcm0ocmVzcG9uc2UpO1xuXHRcdFx0XHRpZiAocmVzcG9uc2Uuc3VjY2Vzc1xuXHRcdFx0XHRcdCYmIHJlc3BvbnNlLnJlbG9hZC5sZW5ndGggPiAwXG5cdFx0XHRcdFx0JiYgRm9ybS4kc3VibWl0TW9kZUlucHV0LnZhbCgpID09PSAnU2F2ZVNldHRpbmdzJykge1xuXHRcdFx0XHRcdHdpbmRvdy5sb2NhdGlvbiA9IGdsb2JhbFJvb3RVcmwgKyByZXNwb25zZS5yZWxvYWQ7XG5cdFx0XHRcdH0gZWxzZSBpZiAocmVzcG9uc2Uuc3VjY2VzcyAmJiBGb3JtLiRzdWJtaXRNb2RlSW5wdXQudmFsKCkgPT09ICdTYXZlU2V0dGluZ3NBbmRBZGROZXcnKSB7XG5cdFx0XHRcdFx0aWYgKEZvcm0uYWZ0ZXJTdWJtaXRNb2RpZnlVcmwubGVuZ3RoID4gMSl7XG5cdFx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBGb3JtLmFmdGVyU3VibWl0TW9kaWZ5VXJsO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zdCBlbXB0eVVybCA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnNwbGl0KCdtb2RpZnknKTtcblx0XHRcdFx0XHRcdGxldCBhY3Rpb24gPSAnbW9kaWZ5Jztcblx0XHRcdFx0XHRcdGxldCBwcmVmaXhEYXRhID0gZW1wdHlVcmxbMV0uc3BsaXQoJy8nKTtcblx0XHRcdFx0XHRcdGlmKHByZWZpeERhdGEubGVuZ3RoID4gMCl7XG5cdFx0XHRcdFx0XHRcdGFjdGlvbiA9IGFjdGlvbiArIHByZWZpeERhdGFbMF07XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRpZiAoZW1wdHlVcmwubGVuZ3RoID4gMSkge1xuXHRcdFx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBgJHtlbXB0eVVybFswXX0ke2FjdGlvbn0vYDtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gZWxzZSBpZiAocmVzcG9uc2Uuc3VjY2VzcyAmJiBGb3JtLiRzdWJtaXRNb2RlSW5wdXQudmFsKCkgPT09ICdTYXZlU2V0dGluZ3NBbmRFeGl0Jykge1xuXHRcdFx0XHRcdGlmIChGb3JtLmFmdGVyU3VibWl0SW5kZXhVcmwubGVuZ3RoID4gMSl7XG5cdFx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBGb3JtLmFmdGVyU3VibWl0SW5kZXhVcmw7XG5cdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdGNvbnN0IGVtcHR5VXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWYuc3BsaXQoJ21vZGlmeScpO1xuXHRcdFx0XHRcdFx0aWYgKGVtcHR5VXJsLmxlbmd0aCA+IDEpIHtcblx0XHRcdFx0XHRcdFx0d2luZG93LmxvY2F0aW9uID0gYCR7ZW1wdHlVcmxbMF19aW5kZXgvYDtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0gZWxzZSBpZiAocmVzcG9uc2Uuc3VjY2Vzc1xuXHRcdFx0XHRcdFx0JiYgcmVzcG9uc2UucmVsb2FkLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBnbG9iYWxSb290VXJsICsgcmVzcG9uc2UucmVsb2FkO1xuXHRcdFx0XHR9IGVsc2UgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgJiYgRm9ybS5lbmFibGVEaXJyaXR5KSB7XG5cdFx0XHRcdFx0Rm9ybS5pbml0aWFsaXplRGlycml0eSgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdEZvcm0uJHN1Ym1pdEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0fSxcblx0XHRcdG9uRmFpbHVyZShyZXNwb25zZSkge1xuXHRcdFx0XHRGb3JtLiRmb3JtT2JqLmFmdGVyKHJlc3BvbnNlKTtcblx0XHRcdFx0Rm9ybS4kc3VibWl0QnV0dG9uXG5cdFx0XHRcdFx0LnRyYW5zaXRpb24oJ3NoYWtlJylcblx0XHRcdFx0XHQucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcblx0XHRcdH0sXG5cblx0XHR9KTtcblx0fSxcblxuXHQvKipcblx0ICog0JLQvtC30LLRgNCw0YnRidCw0LXRgiDQmNCh0KLQmNCd0JAsINC10YHQu9C4INC30L3QsNGH0LXQvdC40LUg0J3QlSDRgdC+0L7RgtCy0LXRgtGB0YLQstGD0LXRgiBSZWdleC5cblx0ICogQHBhcmFtIHZhbHVlXG5cdCAqIEBwYXJhbSByZWdleFxuXHQgKiBAcmV0dXJucyB7Ym9vbGVhbn1cblx0ICovXG5cdG5vdFJlZ0V4cFZhbGlkYXRlUnVsZSh2YWx1ZSwgcmVnZXgpe1xuXHRcdHJldHVybiB2YWx1ZS5tYXRjaChyZWdleCkgIT09IG51bGw7XG5cdH0sXG5cblx0LyoqXG5cdCAqINCS0L7Qt9Cy0YDQsNGJ0YnQsNC10YIg0JjQodCi0JjQndCQLCDQtdGB0LvQuCDQt9C90LDRh9C10L3QuNC1INGB0L7QtNC10YDQttC40YIg0YHQv9C10YbRgdC40LzQstC+0LvRiy5cblx0ICogQHBhcmFtIHZhbHVlXG5cdCAqIEByZXR1cm5zIHtib29sZWFufVxuXHQgKi9cblx0c3BlY2lhbENoYXJhY3RlcnNFeGlzdFZhbGlkYXRlUnVsZSh2YWx1ZSl7XG5cdFx0cmV0dXJuIHZhbHVlLm1hdGNoKC9bKCkkXjsjXCI+PCwuJeKElkAhKz1fXS8pID09PSBudWxsO1xuXHR9XG59O1xuXG4vLyBleHBvcnQgZGVmYXVsdCBGb3JtO1xuIl19