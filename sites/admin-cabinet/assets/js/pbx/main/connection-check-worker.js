"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalDebugMode */

/**
 * The connectionCheckWorker object is responsible for periodically checking
 * the connection status with back end by pinging the PBX API
 *
 * @module connectionCheckWorker
 */
var connectionCheckWorker = {
  /**
   * Time in milliseconds before fetching new connection request.
   * @type {number}
   */
  timeOut: 1000,

  /**
   * The id of the timer function for the worker.
   * @type {number}
   */
  timeOutHandle: 0,
  // Counter for error counts
  errorCounts: 0,

  /**
   * jQuery object for the connection dimmer element
   * @type {jQuery}
   */
  $connectionDimmer: $('#connection-dimmer'),

  /**
   * Initialize the connection check worker.
   *
   */
  initialize: function initialize() {
    connectionCheckWorker.restartWorker();
  },

  /**
   * Restart the connection check worker.
   * Clears the previous timeout and starts the worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(connectionCheckWorker.timeoutHandle);
    connectionCheckWorker.worker();
  },

  /**
   * Worker function that pings the PBX API and executes the callback.
   */
  worker: function worker() {
    PbxApi.SystemPingPBX(connectionCheckWorker.cbAfterResponse);
    connectionCheckWorker.timeoutHandle = window.setTimeout(connectionCheckWorker.worker, connectionCheckWorker.timeOut);
  },

  /**
   * Callback function after receiving the response from the PBX API.
   * @param {boolean} result - The result of the connection check.
   */
  cbAfterResponse: function cbAfterResponse(result) {
    if (result === true) {
      // If the connection is successful, hide the connection dimmer
      connectionCheckWorker.$connectionDimmer.dimmer('hide'); // Set a longer timeout for the next check

      connectionCheckWorker.timeOut = 3000; // Reload the page if the error count exceeds a certain threshold

      if (connectionCheckWorker.errorCounts > 5) {
        window.location.reload();
      } // Reset the error count


      connectionCheckWorker.errorCounts = 0;
    } else if (connectionCheckWorker.errorCounts > 3) {
      // If the connection is unsuccessful and error count exceeds a threshold, show the connection dimmer
      connectionCheckWorker.$connectionDimmer.dimmer('show'); // Set a shorter timeout for the next check

      connectionCheckWorker.timeOut = 1000; // Increment the error count

      connectionCheckWorker.errorCounts += 1;
    } else {
      // If the connection is unsuccessful but error count is within the threshold, set a default timeout
      connectionCheckWorker.timeOut = 1000; // Increment the error count

      connectionCheckWorker.errorCounts += 1;
    }
  }
}; // When the document is ready, initialize the connection check worker

$(document).ready(function () {
  if (!globalDebugMode) {
    connectionCheckWorker.initialize();
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWluL2Nvbm5lY3Rpb24tY2hlY2std29ya2VyLmpzIl0sIm5hbWVzIjpbImNvbm5lY3Rpb25DaGVja1dvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZXJyb3JDb3VudHMiLCIkY29ubmVjdGlvbkRpbW1lciIsIiQiLCJpbml0aWFsaXplIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJQYnhBcGkiLCJTeXN0ZW1QaW5nUEJYIiwiY2JBZnRlclJlc3BvbnNlIiwic2V0VGltZW91dCIsInJlc3VsdCIsImRpbW1lciIsImxvY2F0aW9uIiwicmVsb2FkIiwiZG9jdW1lbnQiLCJyZWFkeSIsImdsb2JhbERlYnVnTW9kZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHFCQUFxQixHQUFHO0FBRTFCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLE9BQU8sRUFBRSxJQU5pQjs7QUFRMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFLENBWlc7QUFjMUI7QUFDQUMsRUFBQUEsV0FBVyxFQUFFLENBZmE7O0FBaUIxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxpQkFBaUIsRUFBRUMsQ0FBQyxDQUFDLG9CQUFELENBckJNOztBQXVCMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsVUEzQjBCLHdCQTJCYjtBQUNUTixJQUFBQSxxQkFBcUIsQ0FBQ08sYUFBdEI7QUFDSCxHQTdCeUI7O0FBK0IxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQSxFQUFBQSxhQW5DMEIsMkJBbUNWO0FBQ1pDLElBQUFBLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQlQscUJBQXFCLENBQUNVLGFBQTFDO0FBQ0FWLElBQUFBLHFCQUFxQixDQUFDVyxNQUF0QjtBQUNILEdBdEN5Qjs7QUF3QzFCO0FBQ0o7QUFDQTtBQUNJQSxFQUFBQSxNQTNDMEIsb0JBMkNqQjtBQUNMQyxJQUFBQSxNQUFNLENBQUNDLGFBQVAsQ0FBcUJiLHFCQUFxQixDQUFDYyxlQUEzQztBQUNBZCxJQUFBQSxxQkFBcUIsQ0FBQ1UsYUFBdEIsR0FBc0NGLE1BQU0sQ0FBQ08sVUFBUCxDQUNsQ2YscUJBQXFCLENBQUNXLE1BRFksRUFFbENYLHFCQUFxQixDQUFDQyxPQUZZLENBQXRDO0FBSUgsR0FqRHlCOztBQW1EMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSWEsRUFBQUEsZUF2RDBCLDJCQXVEVkUsTUF2RFUsRUF1REY7QUFDcEIsUUFBSUEsTUFBTSxLQUFLLElBQWYsRUFBcUI7QUFDakI7QUFDQWhCLE1BQUFBLHFCQUFxQixDQUFDSSxpQkFBdEIsQ0FBd0NhLE1BQXhDLENBQStDLE1BQS9DLEVBRmlCLENBSWpCOztBQUNBakIsTUFBQUEscUJBQXFCLENBQUNDLE9BQXRCLEdBQWdDLElBQWhDLENBTGlCLENBT2pCOztBQUNBLFVBQUlELHFCQUFxQixDQUFDRyxXQUF0QixHQUFvQyxDQUF4QyxFQUEyQztBQUN2Q0ssUUFBQUEsTUFBTSxDQUFDVSxRQUFQLENBQWdCQyxNQUFoQjtBQUNILE9BVmdCLENBWWpCOzs7QUFDQW5CLE1BQUFBLHFCQUFxQixDQUFDRyxXQUF0QixHQUFvQyxDQUFwQztBQUNILEtBZEQsTUFjTyxJQUFJSCxxQkFBcUIsQ0FBQ0csV0FBdEIsR0FBb0MsQ0FBeEMsRUFBMkM7QUFDOUM7QUFDQUgsTUFBQUEscUJBQXFCLENBQUNJLGlCQUF0QixDQUF3Q2EsTUFBeEMsQ0FBK0MsTUFBL0MsRUFGOEMsQ0FJOUM7O0FBQ0FqQixNQUFBQSxxQkFBcUIsQ0FBQ0MsT0FBdEIsR0FBZ0MsSUFBaEMsQ0FMOEMsQ0FPOUM7O0FBQ0FELE1BQUFBLHFCQUFxQixDQUFDRyxXQUF0QixJQUFxQyxDQUFyQztBQUNILEtBVE0sTUFTQTtBQUVIO0FBQ0FILE1BQUFBLHFCQUFxQixDQUFDQyxPQUF0QixHQUFnQyxJQUFoQyxDQUhHLENBS0g7O0FBQ0FELE1BQUFBLHFCQUFxQixDQUFDRyxXQUF0QixJQUFxQyxDQUFyQztBQUNIO0FBQ0o7QUF2RnlCLENBQTlCLEMsQ0EwRkE7O0FBQ0FFLENBQUMsQ0FBQ2UsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQixNQUFJLENBQUNDLGVBQUwsRUFBc0I7QUFDbEJ0QixJQUFBQSxxQkFBcUIsQ0FBQ00sVUFBdEI7QUFDSDtBQUNKLENBSkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgUGJ4QXBpLCBnbG9iYWxEZWJ1Z01vZGUgKi9cblxuLyoqXG4gKiBUaGUgY29ubmVjdGlvbkNoZWNrV29ya2VyIG9iamVjdCBpcyByZXNwb25zaWJsZSBmb3IgcGVyaW9kaWNhbGx5IGNoZWNraW5nXG4gKiB0aGUgY29ubmVjdGlvbiBzdGF0dXMgd2l0aCBiYWNrIGVuZCBieSBwaW5naW5nIHRoZSBQQlggQVBJXG4gKlxuICogQG1vZHVsZSBjb25uZWN0aW9uQ2hlY2tXb3JrZXJcbiAqL1xuY29uc3QgY29ubmVjdGlvbkNoZWNrV29ya2VyID0ge1xuXG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGZldGNoaW5nIG5ldyBjb25uZWN0aW9uIHJlcXVlc3QuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0OiAxMDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3IgdGhlIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG5cbiAgICAvLyBDb3VudGVyIGZvciBlcnJvciBjb3VudHNcbiAgICBlcnJvckNvdW50czogMCxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBjb25uZWN0aW9uIGRpbW1lciBlbGVtZW50XG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkY29ubmVjdGlvbkRpbW1lcjogJCgnI2Nvbm5lY3Rpb24tZGltbWVyJyksXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplIHRoZSBjb25uZWN0aW9uIGNoZWNrIHdvcmtlci5cbiAgICAgKlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnQgdGhlIGNvbm5lY3Rpb24gY2hlY2sgd29ya2VyLlxuICAgICAqIENsZWFycyB0aGUgcHJldmlvdXMgdGltZW91dCBhbmQgc3RhcnRzIHRoZSB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChjb25uZWN0aW9uQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci53b3JrZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogV29ya2VyIGZ1bmN0aW9uIHRoYXQgcGluZ3MgdGhlIFBCWCBBUEkgYW5kIGV4ZWN1dGVzIHRoZSBjYWxsYmFjay5cbiAgICAgKi9cbiAgICB3b3JrZXIoKSB7XG4gICAgICAgIFBieEFwaS5TeXN0ZW1QaW5nUEJYKGNvbm5lY3Rpb25DaGVja1dvcmtlci5jYkFmdGVyUmVzcG9uc2UpO1xuICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLndvcmtlcixcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci50aW1lT3V0LFxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBhZnRlciByZWNlaXZpbmcgdGhlIHJlc3BvbnNlIGZyb20gdGhlIFBCWCBBUEkuXG4gICAgICogQHBhcmFtIHtib29sZWFufSByZXN1bHQgLSBUaGUgcmVzdWx0IG9mIHRoZSBjb25uZWN0aW9uIGNoZWNrLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZXNwb25zZShyZXN1bHQpIHtcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgLy8gSWYgdGhlIGNvbm5lY3Rpb24gaXMgc3VjY2Vzc2Z1bCwgaGlkZSB0aGUgY29ubmVjdGlvbiBkaW1tZXJcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci4kY29ubmVjdGlvbkRpbW1lci5kaW1tZXIoJ2hpZGUnKTtcblxuICAgICAgICAgICAgLy8gU2V0IGEgbG9uZ2VyIHRpbWVvdXQgZm9yIHRoZSBuZXh0IGNoZWNrXG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIudGltZU91dCA9IDMwMDA7XG5cbiAgICAgICAgICAgIC8vIFJlbG9hZCB0aGUgcGFnZSBpZiB0aGUgZXJyb3IgY291bnQgZXhjZWVkcyBhIGNlcnRhaW4gdGhyZXNob2xkXG4gICAgICAgICAgICBpZiAoY29ubmVjdGlvbkNoZWNrV29ya2VyLmVycm9yQ291bnRzID4gNSkge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5yZWxvYWQoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gUmVzZXQgdGhlIGVycm9yIGNvdW50XG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgPSAwO1xuICAgICAgICB9IGVsc2UgaWYgKGNvbm5lY3Rpb25DaGVja1dvcmtlci5lcnJvckNvdW50cyA+IDMpIHtcbiAgICAgICAgICAgIC8vIElmIHRoZSBjb25uZWN0aW9uIGlzIHVuc3VjY2Vzc2Z1bCBhbmQgZXJyb3IgY291bnQgZXhjZWVkcyBhIHRocmVzaG9sZCwgc2hvdyB0aGUgY29ubmVjdGlvbiBkaW1tZXJcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci4kY29ubmVjdGlvbkRpbW1lci5kaW1tZXIoJ3Nob3cnKTtcblxuICAgICAgICAgICAgLy8gU2V0IGEgc2hvcnRlciB0aW1lb3V0IGZvciB0aGUgbmV4dCBjaGVja1xuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLnRpbWVPdXQgPSAxMDAwO1xuXG4gICAgICAgICAgICAvLyBJbmNyZW1lbnQgdGhlIGVycm9yIGNvdW50XG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgKz0gMTtcbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgLy8gSWYgdGhlIGNvbm5lY3Rpb24gaXMgdW5zdWNjZXNzZnVsIGJ1dCBlcnJvciBjb3VudCBpcyB3aXRoaW4gdGhlIHRocmVzaG9sZCwgc2V0IGEgZGVmYXVsdCB0aW1lb3V0XG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIudGltZU91dCA9IDEwMDA7XG5cbiAgICAgICAgICAgIC8vIEluY3JlbWVudCB0aGUgZXJyb3IgY291bnRcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci5lcnJvckNvdW50cyArPSAxO1xuICAgICAgICB9XG4gICAgfSxcbn07XG5cbi8vIFdoZW4gdGhlIGRvY3VtZW50IGlzIHJlYWR5LCBpbml0aWFsaXplIHRoZSBjb25uZWN0aW9uIGNoZWNrIHdvcmtlclxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIGlmICghZ2xvYmFsRGVidWdNb2RlKSB7XG4gICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci5pbml0aWFsaXplKCk7XG4gICAgfVxufSk7XG4iXX0=