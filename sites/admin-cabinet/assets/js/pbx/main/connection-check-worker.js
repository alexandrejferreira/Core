"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalDebugMode */

/**
 * The connectionCheckWorker object is responsible for checking
 * the connection status with backend
 *
 * @module connectionCheckWorker
 */
var connectionCheckWorker = {
  // Counter for error counts
  errorCounts: 0,

  /**
   * jQuery object for the no connection dimmer element.
   * @type {jQuery}
   */
  $connectionDimmer: $('#connection-dimmer'),

  /**
   * EventSource object for the connection check.
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * Initialize the connection check worker.
   */
  initialize: function initialize() {
    connectionCheckWorker.eventSource = new EventSource('/connection-check');
    connectionCheckWorker.eventSource.addEventListener('error', function (event) {
      connectionCheckWorker.cbAfterResponse(false);
    });
    connectionCheckWorker.eventSource.addEventListener('open', function (event) {
      connectionCheckWorker.cbAfterResponse(true);
    });
  },

  /**
   * Callback function after receiving the response from the connection check.
   * @param {boolean} result - The result of the connection check.
   */
  cbAfterResponse: function cbAfterResponse(result) {
    if (result === true) {
      // If the connection is successful, hide the connection dimmer
      connectionCheckWorker.$connectionDimmer.dimmer('hide'); // Reload the page if the error count exceeds a certain threshold

      if (connectionCheckWorker.errorCounts > 5) {
        window.location.reload();
      } // Reset the error count


      connectionCheckWorker.errorCounts = 0;
    } else if (connectionCheckWorker.errorCounts > 3) {
      // If the connection is unsuccessful and error count exceeds a threshold, show the connection dimmer
      connectionCheckWorker.$connectionDimmer.dimmer('show'); // Increment the error count

      connectionCheckWorker.errorCounts += 1;
    } else {
      // Increment the error count
      connectionCheckWorker.errorCounts += 1;
    }
  }
}; // When the document is ready, initialize the connection check worker

$(document).ready(function () {
  if (!globalDebugMode) {
    connectionCheckWorker.initialize();
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWluL2Nvbm5lY3Rpb24tY2hlY2std29ya2VyLmpzIl0sIm5hbWVzIjpbImNvbm5lY3Rpb25DaGVja1dvcmtlciIsImVycm9yQ291bnRzIiwiJGNvbm5lY3Rpb25EaW1tZXIiLCIkIiwiZXZlbnRTb3VyY2UiLCJpbml0aWFsaXplIiwiRXZlbnRTb3VyY2UiLCJhZGRFdmVudExpc3RlbmVyIiwiZXZlbnQiLCJjYkFmdGVyUmVzcG9uc2UiLCJyZXN1bHQiLCJkaW1tZXIiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInJlbG9hZCIsImRvY3VtZW50IiwicmVhZHkiLCJnbG9iYWxEZWJ1Z01vZGUiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxxQkFBcUIsR0FBRztBQUUxQjtBQUNBQyxFQUFBQSxXQUFXLEVBQUUsQ0FIYTs7QUFLMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsaUJBQWlCLEVBQUVDLENBQUMsQ0FBQyxvQkFBRCxDQVRNOztBQVcxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxXQUFXLEVBQUUsSUFmYTs7QUFpQjFCO0FBQ0o7QUFDQTtBQUNJQyxFQUFBQSxVQXBCMEIsd0JBb0JiO0FBQ1RMLElBQUFBLHFCQUFxQixDQUFDSSxXQUF0QixHQUFvQyxJQUFJRSxXQUFKLENBQWdCLG1CQUFoQixDQUFwQztBQUVBTixJQUFBQSxxQkFBcUIsQ0FBQ0ksV0FBdEIsQ0FBa0NHLGdCQUFsQyxDQUFtRCxPQUFuRCxFQUE0RCxVQUFTQyxLQUFULEVBQWdCO0FBQ3hFUixNQUFBQSxxQkFBcUIsQ0FBQ1MsZUFBdEIsQ0FBc0MsS0FBdEM7QUFDSCxLQUZEO0FBSUFULElBQUFBLHFCQUFxQixDQUFDSSxXQUF0QixDQUFrQ0csZ0JBQWxDLENBQW1ELE1BQW5ELEVBQTJELFVBQVNDLEtBQVQsRUFBZ0I7QUFDdkVSLE1BQUFBLHFCQUFxQixDQUFDUyxlQUF0QixDQUFzQyxJQUF0QztBQUNILEtBRkQ7QUFHSCxHQTlCeUI7O0FBZ0MxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQSxFQUFBQSxlQXBDMEIsMkJBb0NWQyxNQXBDVSxFQW9DRjtBQUNwQixRQUFJQSxNQUFNLEtBQUssSUFBZixFQUFxQjtBQUNqQjtBQUNBVixNQUFBQSxxQkFBcUIsQ0FBQ0UsaUJBQXRCLENBQXdDUyxNQUF4QyxDQUErQyxNQUEvQyxFQUZpQixDQUlqQjs7QUFDQSxVQUFJWCxxQkFBcUIsQ0FBQ0MsV0FBdEIsR0FBb0MsQ0FBeEMsRUFBMkM7QUFDdkNXLFFBQUFBLE1BQU0sQ0FBQ0MsUUFBUCxDQUFnQkMsTUFBaEI7QUFDSCxPQVBnQixDQVNqQjs7O0FBQ0FkLE1BQUFBLHFCQUFxQixDQUFDQyxXQUF0QixHQUFvQyxDQUFwQztBQUVILEtBWkQsTUFZTyxJQUFJRCxxQkFBcUIsQ0FBQ0MsV0FBdEIsR0FBb0MsQ0FBeEMsRUFBMkM7QUFFOUM7QUFDQUQsTUFBQUEscUJBQXFCLENBQUNFLGlCQUF0QixDQUF3Q1MsTUFBeEMsQ0FBK0MsTUFBL0MsRUFIOEMsQ0FLOUM7O0FBQ0FYLE1BQUFBLHFCQUFxQixDQUFDQyxXQUF0QixJQUFxQyxDQUFyQztBQUNILEtBUE0sTUFPQTtBQUVIO0FBQ0FELE1BQUFBLHFCQUFxQixDQUFDQyxXQUF0QixJQUFxQyxDQUFyQztBQUNIO0FBQ0o7QUE3RHlCLENBQTlCLEMsQ0FnRUE7O0FBQ0FFLENBQUMsQ0FBQ1ksUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQixNQUFJLENBQUNDLGVBQUwsRUFBc0I7QUFDbEJqQixJQUFBQSxxQkFBcUIsQ0FBQ0ssVUFBdEI7QUFDSDtBQUNKLENBSkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsRGVidWdNb2RlICovXG5cbi8qKlxuICogVGhlIGNvbm5lY3Rpb25DaGVja1dvcmtlciBvYmplY3QgaXMgcmVzcG9uc2libGUgZm9yIGNoZWNraW5nXG4gKiB0aGUgY29ubmVjdGlvbiBzdGF0dXMgd2l0aCBiYWNrZW5kXG4gKlxuICogQG1vZHVsZSBjb25uZWN0aW9uQ2hlY2tXb3JrZXJcbiAqL1xuY29uc3QgY29ubmVjdGlvbkNoZWNrV29ya2VyID0ge1xuXG4gICAgLy8gQ291bnRlciBmb3IgZXJyb3IgY291bnRzXG4gICAgZXJyb3JDb3VudHM6IDAsXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgbm8gY29ubmVjdGlvbiBkaW1tZXIgZWxlbWVudC5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRjb25uZWN0aW9uRGltbWVyOiAkKCcjY29ubmVjdGlvbi1kaW1tZXInKSxcblxuICAgIC8qKlxuICAgICAqIEV2ZW50U291cmNlIG9iamVjdCBmb3IgdGhlIGNvbm5lY3Rpb24gY2hlY2suXG4gICAgICogQHR5cGUge0V2ZW50U291cmNlfVxuICAgICAqL1xuICAgIGV2ZW50U291cmNlOiBudWxsLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgY29ubmVjdGlvbiBjaGVjayB3b3JrZXIuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmV2ZW50U291cmNlID0gbmV3IEV2ZW50U291cmNlKCcvY29ubmVjdGlvbi1jaGVjaycpO1xuXG4gICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci5ldmVudFNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIuY2JBZnRlclJlc3BvbnNlKGZhbHNlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmV2ZW50U291cmNlLmFkZEV2ZW50TGlzdGVuZXIoJ29wZW4nLCBmdW5jdGlvbihldmVudCkge1xuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmNiQWZ0ZXJSZXNwb25zZSh0cnVlKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIHJlY2VpdmluZyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgY29ubmVjdGlvbiBjaGVjay5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJlc3VsdCAtIFRoZSByZXN1bHQgb2YgdGhlIGNvbm5lY3Rpb24gY2hlY2suXG4gICAgICovXG4gICAgY2JBZnRlclJlc3BvbnNlKHJlc3VsdCkge1xuICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7XG4gICAgICAgICAgICAvLyBJZiB0aGUgY29ubmVjdGlvbiBpcyBzdWNjZXNzZnVsLCBoaWRlIHRoZSBjb25uZWN0aW9uIGRpbW1lclxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLiRjb25uZWN0aW9uRGltbWVyLmRpbW1lcignaGlkZScpO1xuXG4gICAgICAgICAgICAvLyBSZWxvYWQgdGhlIHBhZ2UgaWYgdGhlIGVycm9yIGNvdW50IGV4Y2VlZHMgYSBjZXJ0YWluIHRocmVzaG9sZFxuICAgICAgICAgICAgaWYgKGNvbm5lY3Rpb25DaGVja1dvcmtlci5lcnJvckNvdW50cyA+IDUpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24ucmVsb2FkKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFJlc2V0IHRoZSBlcnJvciBjb3VudFxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmVycm9yQ291bnRzID0gMDtcblxuICAgICAgICB9IGVsc2UgaWYgKGNvbm5lY3Rpb25DaGVja1dvcmtlci5lcnJvckNvdW50cyA+IDMpIHtcblxuICAgICAgICAgICAgLy8gSWYgdGhlIGNvbm5lY3Rpb24gaXMgdW5zdWNjZXNzZnVsIGFuZCBlcnJvciBjb3VudCBleGNlZWRzIGEgdGhyZXNob2xkLCBzaG93IHRoZSBjb25uZWN0aW9uIGRpbW1lclxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLiRjb25uZWN0aW9uRGltbWVyLmRpbW1lcignc2hvdycpO1xuXG4gICAgICAgICAgICAvLyBJbmNyZW1lbnQgdGhlIGVycm9yIGNvdW50XG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgKz0gMTtcbiAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgLy8gSW5jcmVtZW50IHRoZSBlcnJvciBjb3VudFxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmVycm9yQ291bnRzICs9IDE7XG4gICAgICAgIH1cbiAgICB9LFxufTtcblxuLy8gV2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHksIGluaXRpYWxpemUgdGhlIGNvbm5lY3Rpb24gY2hlY2sgd29ya2VyXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgaWYgKCFnbG9iYWxEZWJ1Z01vZGUpIHtcbiAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmluaXRpYWxpemUoKTtcbiAgICB9XG59KTtcbiJdfQ==