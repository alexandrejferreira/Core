"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalDebugMode */

/**
 * The connectionCheckWorker object is responsible for periodically checking
 * the connection status with back end by pinging the PBX API
 *
 * @module connectionCheckWorker
 */
var connectionCheckWorker = {
  /**
   * Time in milliseconds before fetching new connection request.
   * @type {number}
   */
  timeOut: 1000,

  /**
   * The id of the timer function for the worker.
   * @type {number}
   */
  timeOutHandle: 0,
  // Counter for error counts
  errorCounts: 0,

  /**
   * jQuery object for the connection dimmer element
   * @type {jQuery}
   */
  $connectionDimmer: $('#connection-dimmer'),

  /**
   * Initialize the connection check worker.
   *
   */
  initialize: function initialize() {
    connectionCheckWorker.restartWorker();
  },

  /**
   * Restart the connection check worker.
   * Clears the previous timeout and starts the worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(connectionCheckWorker.timeoutHandle);
    connectionCheckWorker.worker();
  },

  /**
   * Worker function that pings the PBX API and executes the callback.
   */
  worker: function worker() {
    PbxApi.PingPBX(connectionCheckWorker.cbAfterResponse);
    connectionCheckWorker.timeoutHandle = window.setTimeout(connectionCheckWorker.worker, connectionCheckWorker.timeOut);
  },

  /**
   * Callback function after receiving the response from the PBX API.
   * @param {boolean} result - The result of the connection check.
   */
  cbAfterResponse: function cbAfterResponse(result) {
    if (result === true) {
      // If the connection is successful, hide the connection dimmer
      connectionCheckWorker.$connectionDimmer.dimmer('hide'); // Set a longer timeout for the next check

      connectionCheckWorker.timeOut = 3000; // Reload the page if the error count exceeds a certain threshold

      if (connectionCheckWorker.errorCounts > 5) {
        window.location.reload();
      } // Reset the error count


      connectionCheckWorker.errorCounts = 0;
    } else if (connectionCheckWorker.errorCounts > 3) {
      // If the connection is unsuccessful and error count exceeds a threshold, show the connection dimmer
      connectionCheckWorker.$connectionDimmer.dimmer('show'); // Set a shorter timeout for the next check

      connectionCheckWorker.timeOut = 1000; // Increment the error count

      connectionCheckWorker.errorCounts += 1;
    } else {
      // If the connection is unsuccessful but error count is within the threshold, set a default timeout
      connectionCheckWorker.timeOut = 1000; // Increment the error count

      connectionCheckWorker.errorCounts += 1;
    }
  }
}; // When the document is ready, initialize the connection check worker

$(document).ready(function () {
  if (!globalDebugMode) {
    connectionCheckWorker.initialize();
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYWluL2Nvbm5lY3Rpb24tY2hlY2std29ya2VyLmpzIl0sIm5hbWVzIjpbImNvbm5lY3Rpb25DaGVja1dvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZXJyb3JDb3VudHMiLCIkY29ubmVjdGlvbkRpbW1lciIsIiQiLCJpbml0aWFsaXplIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJQYnhBcGkiLCJQaW5nUEJYIiwiY2JBZnRlclJlc3BvbnNlIiwic2V0VGltZW91dCIsInJlc3VsdCIsImRpbW1lciIsImxvY2F0aW9uIiwicmVsb2FkIiwiZG9jdW1lbnQiLCJyZWFkeSIsImdsb2JhbERlYnVnTW9kZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHFCQUFxQixHQUFHO0FBRTFCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLE9BQU8sRUFBRSxJQU5pQjs7QUFRMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFLENBWlc7QUFjMUI7QUFDQUMsRUFBQUEsV0FBVyxFQUFFLENBZmE7O0FBaUIxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxpQkFBaUIsRUFBRUMsQ0FBQyxDQUFDLG9CQUFELENBckJNOztBQXVCMUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsVUEzQjBCLHdCQTJCYjtBQUNUTixJQUFBQSxxQkFBcUIsQ0FBQ08sYUFBdEI7QUFDSCxHQTdCeUI7O0FBK0IxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQSxFQUFBQSxhQW5DMEIsMkJBbUNWO0FBQ1pDLElBQUFBLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQlQscUJBQXFCLENBQUNVLGFBQTFDO0FBQ0FWLElBQUFBLHFCQUFxQixDQUFDVyxNQUF0QjtBQUNILEdBdEN5Qjs7QUF3QzFCO0FBQ0o7QUFDQTtBQUNJQSxFQUFBQSxNQTNDMEIsb0JBMkNqQjtBQUNMQyxJQUFBQSxNQUFNLENBQUNDLE9BQVAsQ0FBZWIscUJBQXFCLENBQUNjLGVBQXJDO0FBQ0FkLElBQUFBLHFCQUFxQixDQUFDVSxhQUF0QixHQUFzQ0YsTUFBTSxDQUFDTyxVQUFQLENBQ2xDZixxQkFBcUIsQ0FBQ1csTUFEWSxFQUVsQ1gscUJBQXFCLENBQUNDLE9BRlksQ0FBdEM7QUFJSCxHQWpEeUI7O0FBbUQxQjtBQUNKO0FBQ0E7QUFDQTtBQUNJYSxFQUFBQSxlQXZEMEIsMkJBdURWRSxNQXZEVSxFQXVERjtBQUNwQixRQUFJQSxNQUFNLEtBQUssSUFBZixFQUFxQjtBQUNqQjtBQUNBaEIsTUFBQUEscUJBQXFCLENBQUNJLGlCQUF0QixDQUF3Q2EsTUFBeEMsQ0FBK0MsTUFBL0MsRUFGaUIsQ0FJakI7O0FBQ0FqQixNQUFBQSxxQkFBcUIsQ0FBQ0MsT0FBdEIsR0FBZ0MsSUFBaEMsQ0FMaUIsQ0FPakI7O0FBQ0EsVUFBSUQscUJBQXFCLENBQUNHLFdBQXRCLEdBQW9DLENBQXhDLEVBQTJDO0FBQ3ZDSyxRQUFBQSxNQUFNLENBQUNVLFFBQVAsQ0FBZ0JDLE1BQWhCO0FBQ0gsT0FWZ0IsQ0FZakI7OztBQUNBbkIsTUFBQUEscUJBQXFCLENBQUNHLFdBQXRCLEdBQW9DLENBQXBDO0FBQ0gsS0FkRCxNQWNPLElBQUlILHFCQUFxQixDQUFDRyxXQUF0QixHQUFvQyxDQUF4QyxFQUEyQztBQUM5QztBQUNBSCxNQUFBQSxxQkFBcUIsQ0FBQ0ksaUJBQXRCLENBQXdDYSxNQUF4QyxDQUErQyxNQUEvQyxFQUY4QyxDQUk5Qzs7QUFDQWpCLE1BQUFBLHFCQUFxQixDQUFDQyxPQUF0QixHQUFnQyxJQUFoQyxDQUw4QyxDQU85Qzs7QUFDQUQsTUFBQUEscUJBQXFCLENBQUNHLFdBQXRCLElBQXFDLENBQXJDO0FBQ0gsS0FUTSxNQVNBO0FBRUg7QUFDQUgsTUFBQUEscUJBQXFCLENBQUNDLE9BQXRCLEdBQWdDLElBQWhDLENBSEcsQ0FLSDs7QUFDQUQsTUFBQUEscUJBQXFCLENBQUNHLFdBQXRCLElBQXFDLENBQXJDO0FBQ0g7QUFDSjtBQXZGeUIsQ0FBOUIsQyxDQTBGQTs7QUFDQUUsQ0FBQyxDQUFDZSxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCLE1BQUksQ0FBQ0MsZUFBTCxFQUFzQjtBQUNsQnRCLElBQUFBLHFCQUFxQixDQUFDTSxVQUF0QjtBQUNIO0FBQ0osQ0FKRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBQYnhBcGksIGdsb2JhbERlYnVnTW9kZSAqL1xuXG4vKipcbiAqIFRoZSBjb25uZWN0aW9uQ2hlY2tXb3JrZXIgb2JqZWN0IGlzIHJlc3BvbnNpYmxlIGZvciBwZXJpb2RpY2FsbHkgY2hlY2tpbmdcbiAqIHRoZSBjb25uZWN0aW9uIHN0YXR1cyB3aXRoIGJhY2sgZW5kIGJ5IHBpbmdpbmcgdGhlIFBCWCBBUElcbiAqXG4gKiBAbW9kdWxlIGNvbm5lY3Rpb25DaGVja1dvcmtlclxuICovXG5jb25zdCBjb25uZWN0aW9uQ2hlY2tXb3JrZXIgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgZmV0Y2hpbmcgbmV3IGNvbm5lY3Rpb24gcmVxdWVzdC5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXQ6IDEwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciB0aGUgd29ya2VyLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dEhhbmRsZTogMCxcblxuICAgIC8vIENvdW50ZXIgZm9yIGVycm9yIGNvdW50c1xuICAgIGVycm9yQ291bnRzOiAwLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGNvbm5lY3Rpb24gZGltbWVyIGVsZW1lbnRcbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRjb25uZWN0aW9uRGltbWVyOiAkKCcjY29ubmVjdGlvbi1kaW1tZXInKSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgdGhlIGNvbm5lY3Rpb24gY2hlY2sgd29ya2VyLlxuICAgICAqXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLnJlc3RhcnRXb3JrZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVzdGFydCB0aGUgY29ubmVjdGlvbiBjaGVjayB3b3JrZXIuXG4gICAgICogQ2xlYXJzIHRoZSBwcmV2aW91cyB0aW1lb3V0IGFuZCBzdGFydHMgdGhlIHdvcmtlci5cbiAgICAgKi9cbiAgICByZXN0YXJ0V29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGNvbm5lY3Rpb25DaGVja1dvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBXb3JrZXIgZnVuY3Rpb24gdGhhdCBwaW5ncyB0aGUgUEJYIEFQSSBhbmQgZXhlY3V0ZXMgdGhlIGNhbGxiYWNrLlxuICAgICAqL1xuICAgIHdvcmtlcigpIHtcbiAgICAgICAgUGJ4QXBpLlBpbmdQQlgoY29ubmVjdGlvbkNoZWNrV29ya2VyLmNiQWZ0ZXJSZXNwb25zZSk7XG4gICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci50aW1lb3V0SGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIud29ya2VyLFxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLnRpbWVPdXQsXG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIHJlY2VpdmluZyB0aGUgcmVzcG9uc2UgZnJvbSB0aGUgUEJYIEFQSS5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJlc3VsdCAtIFRoZSByZXN1bHQgb2YgdGhlIGNvbm5lY3Rpb24gY2hlY2suXG4gICAgICovXG4gICAgY2JBZnRlclJlc3BvbnNlKHJlc3VsdCkge1xuICAgICAgICBpZiAocmVzdWx0ID09PSB0cnVlKSB7XG4gICAgICAgICAgICAvLyBJZiB0aGUgY29ubmVjdGlvbiBpcyBzdWNjZXNzZnVsLCBoaWRlIHRoZSBjb25uZWN0aW9uIGRpbW1lclxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLiRjb25uZWN0aW9uRGltbWVyLmRpbW1lcignaGlkZScpO1xuXG4gICAgICAgICAgICAvLyBTZXQgYSBsb25nZXIgdGltZW91dCBmb3IgdGhlIG5leHQgY2hlY2tcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci50aW1lT3V0ID0gMzAwMDtcblxuICAgICAgICAgICAgLy8gUmVsb2FkIHRoZSBwYWdlIGlmIHRoZSBlcnJvciBjb3VudCBleGNlZWRzIGEgY2VydGFpbiB0aHJlc2hvbGRcbiAgICAgICAgICAgIGlmIChjb25uZWN0aW9uQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgPiA1KSB7XG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnJlbG9hZCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBSZXNldCB0aGUgZXJyb3IgY291bnRcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci5lcnJvckNvdW50cyA9IDA7XG4gICAgICAgIH0gZWxzZSBpZiAoY29ubmVjdGlvbkNoZWNrV29ya2VyLmVycm9yQ291bnRzID4gMykge1xuICAgICAgICAgICAgLy8gSWYgdGhlIGNvbm5lY3Rpb24gaXMgdW5zdWNjZXNzZnVsIGFuZCBlcnJvciBjb3VudCBleGNlZWRzIGEgdGhyZXNob2xkLCBzaG93IHRoZSBjb25uZWN0aW9uIGRpbW1lclxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLiRjb25uZWN0aW9uRGltbWVyLmRpbW1lcignc2hvdycpO1xuXG4gICAgICAgICAgICAvLyBTZXQgYSBzaG9ydGVyIHRpbWVvdXQgZm9yIHRoZSBuZXh0IGNoZWNrXG4gICAgICAgICAgICBjb25uZWN0aW9uQ2hlY2tXb3JrZXIudGltZU91dCA9IDEwMDA7XG5cbiAgICAgICAgICAgIC8vIEluY3JlbWVudCB0aGUgZXJyb3IgY291bnRcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci5lcnJvckNvdW50cyArPSAxO1xuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICAvLyBJZiB0aGUgY29ubmVjdGlvbiBpcyB1bnN1Y2Nlc3NmdWwgYnV0IGVycm9yIGNvdW50IGlzIHdpdGhpbiB0aGUgdGhyZXNob2xkLCBzZXQgYSBkZWZhdWx0IHRpbWVvdXRcbiAgICAgICAgICAgIGNvbm5lY3Rpb25DaGVja1dvcmtlci50aW1lT3V0ID0gMTAwMDtcblxuICAgICAgICAgICAgLy8gSW5jcmVtZW50IHRoZSBlcnJvciBjb3VudFxuICAgICAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmVycm9yQ291bnRzICs9IDE7XG4gICAgICAgIH1cbiAgICB9LFxufTtcblxuLy8gV2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHksIGluaXRpYWxpemUgdGhlIGNvbm5lY3Rpb24gY2hlY2sgd29ya2VyXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgaWYgKCFnbG9iYWxEZWJ1Z01vZGUpIHtcbiAgICAgICAgY29ubmVjdGlvbkNoZWNrV29ya2VyLmluaXRpYWxpemUoKTtcbiAgICB9XG59KTtcbiJdfQ==