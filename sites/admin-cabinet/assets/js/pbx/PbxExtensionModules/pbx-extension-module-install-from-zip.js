"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global UserMessage, globalTranslate, PbxApi, installStatusLoopWorker */

/**
 * Handles the process of installing new PBX extensions from a ZIP file.
 * This includes managing file uploads, displaying upload progress, and initiating the installation process.
 *
 * @module addNewExtension
 */
var installationFromZip = {
  /**
   * The jQuery object representing the upload button element in the DOM.
   * Users interact with this button to select and upload ZIP files containing new extensions.
   * @type {jQuery}
   */
  $uploadButton: $('#add-new-button'),

  /**
   * The jQuery object for the block element that contains the progress bar.
   * This element is shown during the file upload process to provide visual feedback to the user.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * The jQuery object for the actual progress bar element.
   * It visually represents the progress of the file upload operation to the user.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * The jQuery object for the label element associated with the progress bar.
   * This label provides textual feedback about the upload status (e.g., percentage completed, errors).
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * A flag indicating whether a file upload is currently in progress.
   * This helps manage the UI state and prevent multiple concurrent uploads.
   * @type {boolean}
   */
  uploadInProgress: false,

  /**
   * A unique identifier for the PUB/SUB channel used to monitor the installation process.
   * This allows the system to receive updates about the installation status.
   */
  channelId: 'install-module',

  /**
   * Initializes the installationFromZip module by setting up the necessary UI elements
   * and attaching event listeners for file uploads.
   */
  initialize: function initialize() {
    installationFromZip.$progressBar.hide();
    PbxApi.SystemUploadFileAttachToBtn('add-new-button', ['zip'], installationFromZip.cbResumableUploadFile);
  },

  /**
   * Handles the various stages of the file upload process, including starting the upload,
   * tracking progress, and handling success or error events.
   *
   * @param {string} action - The current action or stage of the file upload process.
   * @param {object} params - Additional parameters related to the current upload action,
   *                          such as progress percentage or response data on completion.
   */
  cbResumableUploadFile: function cbResumableUploadFile(action, params) {
    switch (action) {
      case 'fileSuccess':
        installationFromZip.checkStatusFileMerging(params.response);
        break;

      case 'uploadStart':
        installationFromZip.uploadInProgress = true;
        installationFromZip.$uploadButton.addClass('loading');
        installationFromZip.$progressBar.show();
        installationFromZip.$progressBarBlock.show();
        installationFromZip.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
        break;

      case 'progress':
        installationFromZip.$progressBar.progress({
          percent: Math.max(Math.round(parseInt(params.percent, 10) / 2) - 2, 1)
        });
        break;

      case 'error':
        installationFromZip.$progressBarLabel.text(globalTranslate.ext_UploadError);
        installationFromZip.$uploadButton.removeClass('loading');
        UserMessage.showMultiString(globalTranslate.ext_UploadError);
        break;

      default:
    }
  },

  /**
   * Checks the status of the file merging process on the server after a successful upload.
   * This step is necessary to ensure that the uploaded ZIP file is properly processed
   * and ready for installation.
   *
   * @param {string} response - The server's response from the file upload process,
   *                            containing information necessary to proceed with the installation.
   */
  checkStatusFileMerging: function checkStatusFileMerging(response) {
    if (response === undefined || PbxApi.tryParseJSON(response) === false) {
      UserMessage.showMultiString("".concat(globalTranslate.ext_UploadError));
      return;
    }

    var json = JSON.parse(response);

    if (json === undefined || json.data === undefined) {
      UserMessage.showMultiString("".concat(globalTranslate.ext_UploadError));
      return;
    }

    var params = {
      fileId: json.data.upload_id,
      filePath: json.data.filename,
      channelId: installationFromZip.channelId
    };
    PbxApi.ModulesInstallFromPackage(params, function (response) {
      console.debug(response);
    });
  }
}; // Initializes the installationFromZip module when the DOM is fully loaded,
// allowing users to upload and install extensions from ZIP files.

$(document).ready(function () {
  installationFromZip.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtZnJvbS16aXAuanMiXSwibmFtZXMiOlsiaW5zdGFsbGF0aW9uRnJvbVppcCIsIiR1cGxvYWRCdXR0b24iLCIkIiwiJHByb2dyZXNzQmFyQmxvY2siLCIkcHJvZ3Jlc3NCYXIiLCIkcHJvZ3Jlc3NCYXJMYWJlbCIsInVwbG9hZEluUHJvZ3Jlc3MiLCJjaGFubmVsSWQiLCJpbml0aWFsaXplIiwiaGlkZSIsIlBieEFwaSIsIlN5c3RlbVVwbG9hZEZpbGVBdHRhY2hUb0J0biIsImNiUmVzdW1hYmxlVXBsb2FkRmlsZSIsImFjdGlvbiIsInBhcmFtcyIsImNoZWNrU3RhdHVzRmlsZU1lcmdpbmciLCJyZXNwb25zZSIsImFkZENsYXNzIiwic2hvdyIsInRleHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfVXBsb2FkSW5Qcm9ncmVzcyIsInByb2dyZXNzIiwicGVyY2VudCIsIk1hdGgiLCJtYXgiLCJyb3VuZCIsInBhcnNlSW50IiwiZXh0X1VwbG9hZEVycm9yIiwicmVtb3ZlQ2xhc3MiLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsInVuZGVmaW5lZCIsInRyeVBhcnNlSlNPTiIsImpzb24iLCJKU09OIiwicGFyc2UiLCJkYXRhIiwiZmlsZUlkIiwidXBsb2FkX2lkIiwiZmlsZVBhdGgiLCJmaWxlbmFtZSIsIk1vZHVsZXNJbnN0YWxsRnJvbVBhY2thZ2UiLCJjb25zb2xlIiwiZGVidWciLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsbUJBQW1CLEdBQUc7QUFDeEI7QUFDSjtBQUNBO0FBQ0E7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Q0EsUUFBSWtCLElBQUksS0FBS0YsU0FBVCxJQUFzQkUsSUFBSSxDQUFDRyxJQUFMLEtBQWNMLFNBQXhDLEVBQW1EO0FBQy9DRixNQUFBQSxXQUFXLENBQUNDLGVBQVosV0FBK0JYLGVBQWUsQ0FBQ1EsZUFBL0M7QUFDQTtBQUNIOztBQUNELFFBQU1kLE1BQU0sR0FBRztBQUNYd0IsTUFBQUEsTUFBTSxFQUFFSixJQUFJLENBQUNHLElBQUwsQ0FBVUUsU0FEUDtBQUVYQyxNQUFBQSxRQUFRLEVBQUVOLElBQUksQ0FBQ0csSUFBTCxDQUFVSSxRQUZUO0FBR1hsQyxNQUFBQSxTQUFTLEVBQUVQLG1CQUFtQixDQUFDTztBQUhwQixLQUFmO0FBS0FHLElBQUFBLE1BQU0sQ0FBQ2dDLHlCQUFQLENBQWlDNUIsTUFBakMsRUFBMEMsVUFBQ0UsUUFBRCxFQUFjO0FBQ3BEMkIsTUFBQUEsT0FBTyxDQUFDQyxLQUFSLENBQWM1QixRQUFkO0FBQ0gsS0FGRDtBQUdIO0FBaEh1QixDQUE1QixDLENBb0hBO0FBQ0E7O0FBQ0FkLENBQUMsQ0FBQzJDLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDcEI5QyxFQUFBQSxtQkFBbUIsQ0FBQ1EsVUFBcEI7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIFVzZXJNZXNzYWdlLCBnbG9iYWxUcmFuc2xhdGUsIFBieEFwaSwgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgKi9cblxuLyoqXG4gKiBIYW5kbGVzIHRoZSBwcm9jZXNzIG9mIGluc3RhbGxpbmcgbmV3IFBCWCBleHRlbnNpb25zIGZyb20gYSBaSVAgZmlsZS5cbiAqIFRoaXMgaW5jbHVkZXMgbWFuYWdpbmcgZmlsZSB1cGxvYWRzLCBkaXNwbGF5aW5nIHVwbG9hZCBwcm9ncmVzcywgYW5kIGluaXRpYXRpbmcgdGhlIGluc3RhbGxhdGlvbiBwcm9jZXNzLlxuICpcbiAqIEBtb2R1bGUgYWRkTmV3RXh0ZW5zaW9uXG4gKi9cbmNvbnN0IGluc3RhbGxhdGlvbkZyb21aaXAgPSB7XG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSB1cGxvYWQgYnV0dG9uIGVsZW1lbnQgaW4gdGhlIERPTS5cbiAgICAgKiBVc2VycyBpbnRlcmFjdCB3aXRoIHRoaXMgYnV0dG9uIHRvIHNlbGVjdCBhbmQgdXBsb2FkIFpJUCBmaWxlcyBjb250YWluaW5nIG5ldyBleHRlbnNpb25zLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHVwbG9hZEJ1dHRvbjogJCgnI2FkZC1uZXctYnV0dG9uJyksXG5cblxuICAgIC8qKlxuICAgICAqIFRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgYmxvY2sgZWxlbWVudCB0aGF0IGNvbnRhaW5zIHRoZSBwcm9ncmVzcyBiYXIuXG4gICAgICogVGhpcyBlbGVtZW50IGlzIHNob3duIGR1cmluZyB0aGUgZmlsZSB1cGxvYWQgcHJvY2VzcyB0byBwcm92aWRlIHZpc3VhbCBmZWVkYmFjayB0byB0aGUgdXNlci5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhckJsb2NrOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhci1ibG9jaycpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBhY3R1YWwgcHJvZ3Jlc3MgYmFyIGVsZW1lbnQuXG4gICAgICogSXQgdmlzdWFsbHkgcmVwcmVzZW50cyB0aGUgcHJvZ3Jlc3Mgb2YgdGhlIGZpbGUgdXBsb2FkIG9wZXJhdGlvbiB0byB0aGUgdXNlci5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgbGFiZWwgZWxlbWVudCBhc3NvY2lhdGVkIHdpdGggdGhlIHByb2dyZXNzIGJhci5cbiAgICAgKiBUaGlzIGxhYmVsIHByb3ZpZGVzIHRleHR1YWwgZmVlZGJhY2sgYWJvdXQgdGhlIHVwbG9hZCBzdGF0dXMgKGUuZy4sIHBlcmNlbnRhZ2UgY29tcGxldGVkLCBlcnJvcnMpLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyTGFiZWw6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyLWxhYmVsJyksXG5cbiAgICAvKipcbiAgICAgKiBBIGZsYWcgaW5kaWNhdGluZyB3aGV0aGVyIGEgZmlsZSB1cGxvYWQgaXMgY3VycmVudGx5IGluIHByb2dyZXNzLlxuICAgICAqIFRoaXMgaGVscHMgbWFuYWdlIHRoZSBVSSBzdGF0ZSBhbmQgcHJldmVudCBtdWx0aXBsZSBjb25jdXJyZW50IHVwbG9hZHMuXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgdXBsb2FkSW5Qcm9ncmVzczogZmFsc2UsXG5cbiAgICAvKipcbiAgICAgKiBBIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgUFVCL1NVQiBjaGFubmVsIHVzZWQgdG8gbW9uaXRvciB0aGUgaW5zdGFsbGF0aW9uIHByb2Nlc3MuXG4gICAgICogVGhpcyBhbGxvd3MgdGhlIHN5c3RlbSB0byByZWNlaXZlIHVwZGF0ZXMgYWJvdXQgdGhlIGluc3RhbGxhdGlvbiBzdGF0dXMuXG4gICAgICovXG4gICAgY2hhbm5lbElkOiAnaW5zdGFsbC1tb2R1bGUnLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIGluc3RhbGxhdGlvbkZyb21aaXAgbW9kdWxlIGJ5IHNldHRpbmcgdXAgdGhlIG5lY2Vzc2FyeSBVSSBlbGVtZW50c1xuICAgICAqIGFuZCBhdHRhY2hpbmcgZXZlbnQgbGlzdGVuZXJzIGZvciBmaWxlIHVwbG9hZHMuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgaW5zdGFsbGF0aW9uRnJvbVppcC4kcHJvZ3Jlc3NCYXIuaGlkZSgpO1xuICAgICAgICBQYnhBcGkuU3lzdGVtVXBsb2FkRmlsZUF0dGFjaFRvQnRuKCdhZGQtbmV3LWJ1dHRvbicsIFsnemlwJ10sIGluc3RhbGxhdGlvbkZyb21aaXAuY2JSZXN1bWFibGVVcGxvYWRGaWxlKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyB0aGUgdmFyaW91cyBzdGFnZXMgb2YgdGhlIGZpbGUgdXBsb2FkIHByb2Nlc3MsIGluY2x1ZGluZyBzdGFydGluZyB0aGUgdXBsb2FkLFxuICAgICAqIHRyYWNraW5nIHByb2dyZXNzLCBhbmQgaGFuZGxpbmcgc3VjY2VzcyBvciBlcnJvciBldmVudHMuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gYWN0aW9uIC0gVGhlIGN1cnJlbnQgYWN0aW9uIG9yIHN0YWdlIG9mIHRoZSBmaWxlIHVwbG9hZCBwcm9jZXNzLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgcmVsYXRlZCB0byB0aGUgY3VycmVudCB1cGxvYWQgYWN0aW9uLFxuICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNoIGFzIHByb2dyZXNzIHBlcmNlbnRhZ2Ugb3IgcmVzcG9uc2UgZGF0YSBvbiBjb21wbGV0aW9uLlxuICAgICAqL1xuICAgIGNiUmVzdW1hYmxlVXBsb2FkRmlsZShhY3Rpb24sIHBhcmFtcykge1xuICAgICAgICBzd2l0Y2ggKGFjdGlvbikge1xuICAgICAgICAgICAgY2FzZSAnZmlsZVN1Y2Nlc3MnOlxuICAgICAgICAgICAgICAgIGluc3RhbGxhdGlvbkZyb21aaXAuY2hlY2tTdGF0dXNGaWxlTWVyZ2luZyhwYXJhbXMucmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAndXBsb2FkU3RhcnQnOlxuICAgICAgICAgICAgICAgIGluc3RhbGxhdGlvbkZyb21aaXAudXBsb2FkSW5Qcm9ncmVzcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgaW5zdGFsbGF0aW9uRnJvbVppcC4kdXBsb2FkQnV0dG9uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgaW5zdGFsbGF0aW9uRnJvbVppcC4kcHJvZ3Jlc3NCYXIuc2hvdygpO1xuICAgICAgICAgICAgICAgIGluc3RhbGxhdGlvbkZyb21aaXAuJHByb2dyZXNzQmFyQmxvY2suc2hvdygpO1xuICAgICAgICAgICAgICAgIGluc3RhbGxhdGlvbkZyb21aaXAuJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEluUHJvZ3Jlc3MpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAncHJvZ3Jlc3MnOlxuICAgICAgICAgICAgICAgIGluc3RhbGxhdGlvbkZyb21aaXAuJHByb2dyZXNzQmFyLnByb2dyZXNzKHtcbiAgICAgICAgICAgICAgICAgICAgcGVyY2VudDogTWF0aC5tYXgoTWF0aC5yb3VuZChwYXJzZUludChwYXJhbXMucGVyY2VudCwgMTApLzIpLTIsIDEpLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICAgICAgICAgIGluc3RhbGxhdGlvbkZyb21aaXAuJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEVycm9yKTtcbiAgICAgICAgICAgICAgICBpbnN0YWxsYXRpb25Gcm9tWmlwLiR1cGxvYWRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcik7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENoZWNrcyB0aGUgc3RhdHVzIG9mIHRoZSBmaWxlIG1lcmdpbmcgcHJvY2VzcyBvbiB0aGUgc2VydmVyIGFmdGVyIGEgc3VjY2Vzc2Z1bCB1cGxvYWQuXG4gICAgICogVGhpcyBzdGVwIGlzIG5lY2Vzc2FyeSB0byBlbnN1cmUgdGhhdCB0aGUgdXBsb2FkZWQgWklQIGZpbGUgaXMgcHJvcGVybHkgcHJvY2Vzc2VkXG4gICAgICogYW5kIHJlYWR5IGZvciBpbnN0YWxsYXRpb24uXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcmVzcG9uc2UgLSBUaGUgc2VydmVyJ3MgcmVzcG9uc2UgZnJvbSB0aGUgZmlsZSB1cGxvYWQgcHJvY2VzcyxcbiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluaW5nIGluZm9ybWF0aW9uIG5lY2Vzc2FyeSB0byBwcm9jZWVkIHdpdGggdGhlIGluc3RhbGxhdGlvbi5cbiAgICAgKi9cbiAgICBjaGVja1N0YXR1c0ZpbGVNZXJnaW5nKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZSA9PT0gdW5kZWZpbmVkIHx8IFBieEFwaS50cnlQYXJzZUpTT04ocmVzcG9uc2UpID09PSBmYWxzZSkge1xuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKGAke2dsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkRXJyb3J9YCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QganNvbiA9IEpTT04ucGFyc2UocmVzcG9uc2UpO1xuICAgICAgICBpZiAoanNvbiA9PT0gdW5kZWZpbmVkIHx8IGpzb24uZGF0YSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoYCR7Z2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcn1gKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwYXJhbXMgPSB7XG4gICAgICAgICAgICBmaWxlSWQ6IGpzb24uZGF0YS51cGxvYWRfaWQsXG4gICAgICAgICAgICBmaWxlUGF0aDoganNvbi5kYXRhLmZpbGVuYW1lLFxuICAgICAgICAgICAgY2hhbm5lbElkOiBpbnN0YWxsYXRpb25Gcm9tWmlwLmNoYW5uZWxJZFxuICAgICAgICB9O1xuICAgICAgICBQYnhBcGkuTW9kdWxlc0luc3RhbGxGcm9tUGFja2FnZShwYXJhbXMsICAocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcocmVzcG9uc2UpO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG59O1xuXG4vLyBJbml0aWFsaXplcyB0aGUgaW5zdGFsbGF0aW9uRnJvbVppcCBtb2R1bGUgd2hlbiB0aGUgRE9NIGlzIGZ1bGx5IGxvYWRlZCxcbi8vIGFsbG93aW5nIHVzZXJzIHRvIHVwbG9hZCBhbmQgaW5zdGFsbCBleHRlbnNpb25zIGZyb20gWklQIGZpbGVzLlxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIGluc3RhbGxhdGlvbkZyb21aaXAuaW5pdGlhbGl6ZSgpO1xufSk7XG4iXX0=