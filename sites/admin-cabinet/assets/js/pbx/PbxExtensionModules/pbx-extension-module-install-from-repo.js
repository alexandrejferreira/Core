"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2024 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalPBXLicense, globalTranslate, UserMessage, globalPBXVersion, installStatusLoopWorker */

/**
 * Manages the installation and updating of PBX extension modules from a repository.
 * It provides functionality to update individual modules or all modules at once,
 * and displays progress information to the user.
 *
 * @class installationFromRepo
 * @memberof module:PbxExtensionModules
 */
var installationFromRepo = {
  /**
   * The current version of the PBX system, with development version identifiers removed.
   * @type {string}
   */
  pbxVersion: globalPBXVersion.replace(/-dev/i, ''),

  /**
   * The license key for the PBX system, trimmed of any leading or trailing whitespace.
   * @type {string}
   */
  pbxLicense: globalPBXLicense.trim(),

  /**
   * jQuery object for the button responsible for updating all installed modules.
   * @type {jQuery}
   */
  $btnUpdateAllModules: $('#update-all-modules-button'),

  /**
   * jQuery object for the block that contains the progress bar, used to indicate
   * the progress of module installation or updating processes.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * Initializes the installationFromRepo module. Sets up event handlers for UI interactions
   * and hides UI elements that are not immediately needed.
   */
  initialize: function initialize() {
    installationFromRepo.initializeButtonEvents();
    installationFromRepo.$progressBarBlock.hide();
    installationFromRepo.$btnUpdateAllModules.hide(); // Until at least one update available
  },

  /**
   * Sets up event handlers for button clicks within the module.
   * This includes handling the installation and update of individual
   * modules as well as the bulk update functionality.
   */
  initializeButtonEvents: function initializeButtonEvents() {
    /**
     * Event handler for the download link click event.
     * @param {Event} e - The click event object.
     */
    $(document).on('click', 'a.download, a.update', function (e) {
      e.preventDefault();
      $('a.button').addClass('disabled');
      var $currentButton = $(e.target).closest('a.button');
      var params = {
        uniqid: $currentButton.data('uniqid'),
        releaseId: $currentButton.data('releaseid'),
        channelId: installStatusLoopWorker.channelId
      };
      $("#modal-".concat(params.uniqid)).modal('hide');
      var $moduleButtons = $("a[data-uniqid=".concat(params.uniqid));
      $moduleButtons.removeClass('disabled');
      $moduleButtons.find('i').removeClass('download').removeClass('redo').addClass('spinner loading');
      installStatusLoopWorker.updateProgressBar(params.uniqid, globalTranslate.ext_GetReleaseInProgress, 0);
      $('tr.table-error-messages').remove();
      $('tr.error').removeClass('error');

      if (installationFromRepo.pbxLicense === '') {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index#/licensing");
      } else {
        PbxApi.ModulesInstallFromRepo(params, function (response) {
          if (response.result === true) {
            installStatusLoopWorker.initialize();
          }
        });
      }
    });
    installationFromRepo.$btnUpdateAllModules.on('click', installationFromRepo.updateAllModules);
  },

  /**
   * Handles the process of updating all installed modules.
   * Triggered when the 'Update All' button is clicked.
   * It disables UI elements to prevent additional user actions during the update process and initiates
   * the update via the PBX API.
   *
   * @param {Event} e - The click event object associated with the 'Update All' button click.
   */
  updateAllModules: function updateAllModules(e) {
    e.preventDefault();
    $('a.button').addClass('disabled');
    var $currentButton = $(e.target).closest('a');
    $currentButton.removeClass('disabled');
    $currentButton.closest('i.icon').removeClass('redo').addClass('spinner loading');
    var params = {
      channelId: installStatusLoopWorker.channelId
    };
    PbxApi.ModulesUpdateAll(params, function (response) {
      if (response.result === true) {
        installStatusLoopWorker.initialize();
      }
    });
  }
}; // Initializes the installationFromRepo module when the document is ready,
// preparing the extension modules management UI.

$(document).ready(function () {
  installationFromRepo.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtZnJvbS1yZXBvLmpzIl0sIm5hbWVzIjpbImluc3RhbGxhdGlvbkZyb21SZXBvIiwicGJ4VmVyc2lvbiIsImdsb2JhbFBCWFZlcnNpb24iLCJyZXBsYWNlIiwicGJ4TGljZW5zZSIsImdsb2JhbFBCWExpY2Vuc2UiLCJ0cmltIiwiJGJ0blVwZGF0ZUFsbE1vZHVsZXMiLCIkIiwiJHByb2dyZXNzQmFyQmxvY2siLCJpbml0aWFsaXplIiwiaW5pdGlhbGl6ZUJ1dHRvbkV2ZW50cyIsImhpZGUiLCJkb2N1bWVudCIsIm9uIiwiZSIsInByZXZlbnREZWZhdWx0IiwiYWRkQ2xhc3MiLCIkY3VycmVudEJ1dHRvbiIsInRhcmdldCIsImNsb3Nlc3QiLCJwYXJhbXMiLCJ1bmlxaWQiLCJkYXRhIiwicmVsZWFzZUlkIiwiY2hhbm5lbElkIiwiaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIiLCJtb2RhbCIsIiRtb2R1bGVCdXR0b25zIiwicmVtb3ZlQ2xhc3MiLCJmaW5kIiwidXBkYXRlUHJvZ3Jlc3NCYXIiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfR2V0UmVsZWFzZUluUHJvZ3Jlc3MiLCJyZW1vdmUiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsImdsb2JhbFJvb3RVcmwiLCJQYnhBcGkiLCJNb2R1bGVzSW5zdGFsbEZyb21SZXBvIiwicmVzcG9uc2UiLCJyZXN1bHQiLCJ1cGRhdGVBbGxNb2R1bGVzIiwiTW9kdWxlc1VwZGF0ZUFsbCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLG9CQUFvQixHQUFHO0FBRXpCO0FBQ0o7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TyxFQUExQyxDQUE2QyxPQUE3QyxFQUFzRGQsb0JBQW9CLENBQUMwQyxnQkFBM0U7QUFDSCxHQW5Gd0I7O0FBcUZ6QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0lBLEVBQUFBLGdCQTdGeUIsNEJBNkZSM0IsQ0E3RlEsRUE2Rk47QUFDZkEsSUFBQUEsQ0FBQyxDQUFDQyxjQUFGO0FBQ0FSLElBQUFBLENBQUMsQ0FBQyxVQUFELENBQUQsQ0FBY1MsUUFBZCxDQUF1QixVQUF2QjtBQUNBLFFBQU1DLGNBQWMsR0FBR1YsQ0FBQyxDQUFDTyxDQUFDLENBQUNJLE1BQUgsQ0FBRCxDQUFZQyxPQUFaLENBQW9CLEdBQXBCLENBQXZCO0FBQ0FGLElBQUFBLGNBQWMsQ0FBQ1csV0FBZixDQUEyQixVQUEzQjtBQUNBWCxJQUFBQSxjQUFjLENBQUNFLE9BQWYsQ0FBdUIsUUFBdkIsRUFDS1MsV0FETCxDQUNpQixNQURqQixFQUVLWixRQUZMLENBRWMsaUJBRmQ7QUFHQSxRQUFNSSxNQUFNLEdBQUc7QUFDWEksTUFBQUEsU0FBUyxFQUFFQyx1QkFBdUIsQ0FBQ0Q7QUFEeEIsS0FBZjtBQUdBYSxJQUFBQSxNQUFNLENBQUNLLGdCQUFQLENBQXdCdEIsTUFBeEIsRUFBZ0MsVUFBQ21CLFFBQUQsRUFBYztBQUMxQyxVQUFJQSxRQUFRLENBQUNDLE1BQVQsS0FBb0IsSUFBeEIsRUFBOEI7QUFDMUJmLFFBQUFBLHVCQUF1QixDQUFDaEIsVUFBeEI7QUFDSDtBQUNKLEtBSkQ7QUFLSDtBQTdHd0IsQ0FBN0IsQyxDQWlIQTtBQUNBOztBQUNBRixDQUFDLENBQUNLLFFBQUQsQ0FBRCxDQUFZK0IsS0FBWixDQUFrQixZQUFNO0FBQ3BCNUMsRUFBQUEsb0JBQW9CLENBQUNVLFVBQXJCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDI0IEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFBCWExpY2Vuc2UsIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UsIGdsb2JhbFBCWFZlcnNpb24sIGluc3RhbGxTdGF0dXNMb29wV29ya2VyICovXG5cbi8qKlxuICogTWFuYWdlcyB0aGUgaW5zdGFsbGF0aW9uIGFuZCB1cGRhdGluZyBvZiBQQlggZXh0ZW5zaW9uIG1vZHVsZXMgZnJvbSBhIHJlcG9zaXRvcnkuXG4gKiBJdCBwcm92aWRlcyBmdW5jdGlvbmFsaXR5IHRvIHVwZGF0ZSBpbmRpdmlkdWFsIG1vZHVsZXMgb3IgYWxsIG1vZHVsZXMgYXQgb25jZSxcbiAqIGFuZCBkaXNwbGF5cyBwcm9ncmVzcyBpbmZvcm1hdGlvbiB0byB0aGUgdXNlci5cbiAqXG4gKiBAY2xhc3MgaW5zdGFsbGF0aW9uRnJvbVJlcG9cbiAqIEBtZW1iZXJvZiBtb2R1bGU6UGJ4RXh0ZW5zaW9uTW9kdWxlc1xuICovXG5jb25zdCBpbnN0YWxsYXRpb25Gcm9tUmVwbyA9IHtcblxuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50IHZlcnNpb24gb2YgdGhlIFBCWCBzeXN0ZW0sIHdpdGggZGV2ZWxvcG1lbnQgdmVyc2lvbiBpZGVudGlmaWVycyByZW1vdmVkLlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgcGJ4VmVyc2lvbjogZ2xvYmFsUEJYVmVyc2lvbi5yZXBsYWNlKC8tZGV2L2ksICcnKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBsaWNlbnNlIGtleSBmb3IgdGhlIFBCWCBzeXN0ZW0sIHRyaW1tZWQgb2YgYW55IGxlYWRpbmcgb3IgdHJhaWxpbmcgd2hpdGVzcGFjZS5cbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIHBieExpY2Vuc2U6IGdsb2JhbFBCWExpY2Vuc2UudHJpbSgpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGJ1dHRvbiByZXNwb25zaWJsZSBmb3IgdXBkYXRpbmcgYWxsIGluc3RhbGxlZCBtb2R1bGVzLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGJ0blVwZGF0ZUFsbE1vZHVsZXM6ICQoJyN1cGRhdGUtYWxsLW1vZHVsZXMtYnV0dG9uJyksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgYmxvY2sgdGhhdCBjb250YWlucyB0aGUgcHJvZ3Jlc3MgYmFyLCB1c2VkIHRvIGluZGljYXRlXG4gICAgICogdGhlIHByb2dyZXNzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRpbmcgcHJvY2Vzc2VzLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyQmxvY2s6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyLWJsb2NrJyksXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgaW5zdGFsbGF0aW9uRnJvbVJlcG8gbW9kdWxlLiBTZXRzIHVwIGV2ZW50IGhhbmRsZXJzIGZvciBVSSBpbnRlcmFjdGlvbnNcbiAgICAgKiBhbmQgaGlkZXMgVUkgZWxlbWVudHMgdGhhdCBhcmUgbm90IGltbWVkaWF0ZWx5IG5lZWRlZC5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBpbnN0YWxsYXRpb25Gcm9tUmVwby5pbml0aWFsaXplQnV0dG9uRXZlbnRzKCk7XG5cbiAgICAgICAgaW5zdGFsbGF0aW9uRnJvbVJlcG8uJHByb2dyZXNzQmFyQmxvY2suaGlkZSgpO1xuICAgICAgICBpbnN0YWxsYXRpb25Gcm9tUmVwby4kYnRuVXBkYXRlQWxsTW9kdWxlcy5oaWRlKCk7IC8vIFVudGlsIGF0IGxlYXN0IG9uZSB1cGRhdGUgYXZhaWxhYmxlXG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFNldHMgdXAgZXZlbnQgaGFuZGxlcnMgZm9yIGJ1dHRvbiBjbGlja3Mgd2l0aGluIHRoZSBtb2R1bGUuXG4gICAgICogVGhpcyBpbmNsdWRlcyBoYW5kbGluZyB0aGUgaW5zdGFsbGF0aW9uIGFuZCB1cGRhdGUgb2YgaW5kaXZpZHVhbFxuICAgICAqIG1vZHVsZXMgYXMgd2VsbCBhcyB0aGUgYnVsayB1cGRhdGUgZnVuY3Rpb25hbGl0eS5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplQnV0dG9uRXZlbnRzKCl7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFdmVudCBoYW5kbGVyIGZvciB0aGUgZG93bmxvYWQgbGluayBjbGljayBldmVudC5cbiAgICAgICAgICogQHBhcmFtIHtFdmVudH0gZSAtIFRoZSBjbGljayBldmVudCBvYmplY3QuXG4gICAgICAgICAqL1xuICAgICAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCdhLmRvd25sb2FkLCBhLnVwZGF0ZScsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAkKCdhLmJ1dHRvbicpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgY29uc3QgJGN1cnJlbnRCdXR0b24gPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCdhLmJ1dHRvbicpO1xuICAgICAgICAgICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgICAgICAgICAgIHVuaXFpZDogJGN1cnJlbnRCdXR0b24uZGF0YSgndW5pcWlkJyksXG4gICAgICAgICAgICAgICAgcmVsZWFzZUlkOiAkY3VycmVudEJ1dHRvbi5kYXRhKCdyZWxlYXNlaWQnKSxcbiAgICAgICAgICAgICAgICBjaGFubmVsSWQ6IGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmNoYW5uZWxJZFxuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgJChgI21vZGFsLSR7cGFyYW1zLnVuaXFpZH1gKS5tb2RhbCgnaGlkZScpO1xuICAgICAgICAgICAgY29uc3QgJG1vZHVsZUJ1dHRvbnMgPSAkKGBhW2RhdGEtdW5pcWlkPSR7cGFyYW1zLnVuaXFpZH1gKTtcblxuICAgICAgICAgICAgJG1vZHVsZUJ1dHRvbnMucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAkbW9kdWxlQnV0dG9ucy5maW5kKCdpJylcbiAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ2Rvd25sb2FkJylcbiAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3JlZG8nKVxuICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnc3Bpbm5lciBsb2FkaW5nJyk7XG5cbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKHBhcmFtcy51bmlxaWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfR2V0UmVsZWFzZUluUHJvZ3Jlc3MsIDApO1xuXG4gICAgICAgICAgICAkKCd0ci50YWJsZS1lcnJvci1tZXNzYWdlcycpLnJlbW92ZSgpO1xuICAgICAgICAgICAgJCgndHIuZXJyb3InKS5yZW1vdmVDbGFzcygnZXJyb3InKTtcbiAgICAgICAgICAgIGlmIChpbnN0YWxsYXRpb25Gcm9tUmVwby5wYnhMaWNlbnNlID09PSAnJykge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9cGJ4LWV4dGVuc2lvbi1tb2R1bGVzL2luZGV4Iy9saWNlbnNpbmdgO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBQYnhBcGkuTW9kdWxlc0luc3RhbGxGcm9tUmVwbyhwYXJhbXMsIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5yZXN1bHQgPT09IHRydWUpe1xuICAgICAgICAgICAgICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pbml0aWFsaXplKCk7XG4gICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBpbnN0YWxsYXRpb25Gcm9tUmVwby4kYnRuVXBkYXRlQWxsTW9kdWxlcy5vbignY2xpY2snLCBpbnN0YWxsYXRpb25Gcm9tUmVwby51cGRhdGVBbGxNb2R1bGVzKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyB0aGUgcHJvY2VzcyBvZiB1cGRhdGluZyBhbGwgaW5zdGFsbGVkIG1vZHVsZXMuXG4gICAgICogVHJpZ2dlcmVkIHdoZW4gdGhlICdVcGRhdGUgQWxsJyBidXR0b24gaXMgY2xpY2tlZC5cbiAgICAgKiBJdCBkaXNhYmxlcyBVSSBlbGVtZW50cyB0byBwcmV2ZW50IGFkZGl0aW9uYWwgdXNlciBhY3Rpb25zIGR1cmluZyB0aGUgdXBkYXRlIHByb2Nlc3MgYW5kIGluaXRpYXRlc1xuICAgICAqIHRoZSB1cGRhdGUgdmlhIHRoZSBQQlggQVBJLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtFdmVudH0gZSAtIFRoZSBjbGljayBldmVudCBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoZSAnVXBkYXRlIEFsbCcgYnV0dG9uIGNsaWNrLlxuICAgICAqL1xuICAgIHVwZGF0ZUFsbE1vZHVsZXMoZSl7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgJCgnYS5idXR0b24nKS5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgY29uc3QgJGN1cnJlbnRCdXR0b24gPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCdhJyk7XG4gICAgICAgICRjdXJyZW50QnV0dG9uLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAkY3VycmVudEJ1dHRvbi5jbG9zZXN0KCdpLmljb24nKVxuICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdyZWRvJylcbiAgICAgICAgICAgIC5hZGRDbGFzcygnc3Bpbm5lciBsb2FkaW5nJyk7XG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgICAgICAgIGNoYW5uZWxJZDogaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkXG4gICAgICAgIH07XG4gICAgICAgIFBieEFwaS5Nb2R1bGVzVXBkYXRlQWxsKHBhcmFtcywgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UucmVzdWx0ID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaW5pdGlhbGl6ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9LFxuXG59O1xuXG4vLyBJbml0aWFsaXplcyB0aGUgaW5zdGFsbGF0aW9uRnJvbVJlcG8gbW9kdWxlIHdoZW4gdGhlIGRvY3VtZW50IGlzIHJlYWR5LFxuLy8gcHJlcGFyaW5nIHRoZSBleHRlbnNpb24gbW9kdWxlcyBtYW5hZ2VtZW50IFVJLlxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIGluc3RhbGxhdGlvbkZyb21SZXBvLmluaXRpYWxpemUoKTtcbn0pO1xuIl19