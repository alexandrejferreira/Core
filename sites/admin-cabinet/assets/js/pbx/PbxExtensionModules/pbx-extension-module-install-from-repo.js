"use strict";

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && iter[Symbol.iterator] != null || iter["@@iterator"] != null) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2024 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalPBXLicense, globalTranslate, UserMessage, globalPBXVersion, installStatusLoopWorker, marketplace */

/**
 * Manages the installation and updating of PBX extension modules from a repository.
 * It provides functionality to update individual modules or all modules at once,
 * and displays progress information to the user.
 *
 * @class installationFromRepo
 * @memberof module:PbxExtensionModules
 */
var installationFromRepo = {
  /**
   * The current version of the PBX system, with development version identifiers removed.
   * @type {string}
   */
  pbxVersion: globalPBXVersion.replace(/-dev/i, ''),

  /**
   * The license key for the PBX system, trimmed of any leading or trailing whitespace.
   * @type {string}
   */
  pbxLicense: globalPBXLicense.trim(),

  /**
   * jQuery object for the button responsible for updating all installed modules.
   * @type {jQuery}
   */
  $btnUpdateAllModules: $('#update-all-modules-button'),

  /**
   * jQuery object for the block that contains the progress bar, used to indicate
   * the progress of module installation or updating processes.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * jQuery object for the installation module modal form.
   * @type {jQuery}
   */
  $installModuleModalForm: $('#install-modal-form'),

  /**
   * Initializes the installationFromRepo module. Sets up event handlers for UI interactions
   * and hides UI elements that are not immediately needed.
   */
  initialize: function initialize() {
    installationFromRepo.initializeButtonEvents();
    installationFromRepo.$progressBarBlock.hide();
    installationFromRepo.$btnUpdateAllModules.hide(); // Until at least one update available
  },

  /**
   * Sets up event handlers for button clicks within the module.
   * This includes handling the installation and update of individual
   * modules as well as the bulk update functionality.
   */
  initializeButtonEvents: function initializeButtonEvents() {
    /**
     * Event handler for the download link click event.
     * @param {Event} e - The click event object.
     */
    $(document).on('click', 'a.download, a.update', function (e) {
      e.preventDefault();
      var $currentButton = $(e.target).closest('a.button');

      if (installationFromRepo.pbxLicense === '') {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index#/licensing");
      } else {
        installationFromRepo.openInstallModuleModal($currentButton);
      }
    });
    installationFromRepo.$btnUpdateAllModules.on('click', installationFromRepo.updateAllModules);
  },

  /**
   * Opens the modal form for installing a module. This modal provides the user with information
   * about the module they are about to install, and confirms their action.
   *
   * @param {jQuery} $currentButton - The jQuery object of the button that was clicked to trigger this modal.
   */
  openInstallModuleModal: function openInstallModuleModal($currentButton) {
    var moduleUniqueId = $currentButton.data('uniqid');
    var releaseId = $currentButton.data('releaseid');
    installationFromRepo.$installModuleModalForm.modal({
      closable: false,
      onShow: function onShow() {
        var moduleName = $currentButton.closest('tr').data('name');
        var theForm = installationFromRepo.$installModuleModalForm;
        theForm.find('span.module-name').text(moduleName);
        var $installedModuleRow = $("tr.module-row[data-id=".concat(moduleUniqueId, "]"));

        if ($installedModuleRow.length > 0) {
          var _$currentButton$data;

          var installedVersion = $installedModuleRow.data('version');
          var newVersion = (_$currentButton$data = $currentButton.data('version')) !== null && _$currentButton$data !== void 0 ? _$currentButton$data : installedVersion;

          if (marketplace.versionCompare(newVersion, installedVersion) > 0) {
            theForm.find('span.action').text(globalTranslate.ext_UpdateModuleTitle);
            theForm.find('div.description').html(globalTranslate.ext_ModuleUpdateDescription);
          } else {
            theForm.find('span.action').text(globalTranslate.ext_DowngradeModuleTitle);
            theForm.find('div.description').html(globalTranslate.ext_ModuleDowngradeDescription);
          }
        } else {
          theForm.find('span.action').text(globalTranslate.ext_InstallModuleTitle);
          theForm.find('div.description').html(globalTranslate.ext_ModuleInstallDescription);
        }
      },
      onDeny: function onDeny() {
        $('a.button').removeClass('disabled');
        return true;
      },
      onApprove: function onApprove() {
        $('a.button').addClass('disabled');
        var params = {
          uniqid: moduleUniqueId,
          releaseId: releaseId,
          channelId: installStatusLoopWorker.channelId
        };
        $("#modal-".concat(params.uniqid)).modal('hide');
        var $moduleButtons = $("a[data-uniqid=".concat(params.uniqid));
        $moduleButtons.removeClass('disabled');
        $moduleButtons.find('i').removeClass('download').removeClass('redo').addClass('spinner loading');
        $('tr.table-error-messages').remove();
        $('tr.error').removeClass('error');
        PbxApi.ModulesInstallFromRepo(params, function (response) {
          console.debug(response);
        });
        return true;
      }
    }).modal('show');
  },

  /**
   * Initiates the process of updating all installed modules. This function is triggered by the user
   * clicking the 'Update All' button. It first disables UI elements to prevent further user actions
   * and then calls the API to start the update process.
   *
   * @param {Event} e - The click event object associated with the 'Update All' button click.
   */
  updateAllModules: function updateAllModules(e) {
    e.preventDefault();
    $('a.button').addClass('disabled');
    var $currentButton = $(e.target).closest('a');
    installationFromRepo.openUpdateAllModulesModal($currentButton);
  },

  /**
   * Opens a modal confirmation dialog when updating all modules. This dialog informs the user about
   * the update process and asks for confirmation to proceed with updating all installed modules.
   *
   * @param {jQuery} $currentButton - The jQuery object of the button that was clicked to trigger this modal.
   */
  openUpdateAllModulesModal: function openUpdateAllModulesModal($currentButton) {
    installationFromRepo.$installModuleModalForm.modal({
      closable: false,
      onShow: function onShow() {
        var theForm = installationFromRepo.$installModuleModalForm;
        theForm.find('span.action').text(globalTranslate.ext_UpdateAllModulesTitle);
        theForm.find('span.module-name').text('');
        theForm.find('div.description').html(globalTranslate.ext_UpdateAllModulesDescription);
      },
      onDeny: function onDeny() {
        $('a.button').removeClass('disabled');
        return true;
      },
      onApprove: function onApprove() {
        $('a.button').addClass('disabled');
        $currentButton.removeClass('disabled');
        $currentButton.closest('i.icon').removeClass('redo').addClass('spinner loading');
        var uniqueModulesForUpdate = new Set();
        $('a.update').each(function (index, $button) {
          uniqueModulesForUpdate.add($($button).data('uniqid'));
        });
        var params = {
          channelId: installStatusLoopWorker.channelId,
          modulesForUpdate: _toConsumableArray(uniqueModulesForUpdate)
        };
        PbxApi.ModulesUpdateAll(params, function (response) {
          console.debug(response);
        });
        $('tr.table-error-messages').remove();
        $('tr.error').removeClass('error');
        return true;
      }
    }).modal('show');
  }
}; // Initializes the installationFromRepo module when the document is ready,
// preparing the extension modules management UI.

$(document).ready(function () {
  installationFromRepo.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtZnJvbS1yZXBvLmpzIl0sIm5hbWVzIjpbImluc3RhbGxhdGlvbkZyb21SZXBvIiwicGJ4VmVyc2lvbiIsImdsb2JhbFBCWFZlcnNpb24iLCJyZXBsYWNlIiwicGJ4TGljZW5zZSIsImdsb2JhbFBCWExpY2Vuc2UiLCJ0cmltIiwiJGJ0blVwZGF0ZUFsbE1vZHVsZXMiLCIkIiwiJHByb2dyZXNzQmFyQmxvY2siLCIkaW5zdGFsbE1vZHVsZU1vZGFsRm9ybSIsImluaXRpYWxpemUiLCJpbml0aWFsaXplQnV0dG9uRXZlbnRzIiwiaGlkZSIsImRvY3VtZW50Iiwib24iLCJlIiwicHJldmVudERlZmF1bHQiLCIkY3VycmVudEJ1dHRvbiIsInRhcmdldCIsImNsb3Nlc3QiLCJ3aW5kb3ciLCJsb2NhdGlvbiIsImdsb2JhbFJvb3RVcmwiLCJvcGVuSW5zdGFsbE1vZHVsZU1vZGFsIiwidXBkYXRlQWxsTW9kdWxlcyIsIm1vZHVsZVVuaXF1ZUlkIiwiZGF0YSIsInJlbGVhc2VJZCIsIm1vZGFsIiwiY2xvc2FibGUiLCJvblNob3ciLCJtb2R1bGVOYW1lIiwidGhlRm9ybSIsImZpbmQiLCJ0ZXh0IiwiJGluc3RhbGxlZE1vZHVsZVJvdyIsImxlbmd0aCIsImluc3RhbGxlZFZlcnNpb24iLCJuZXdWZXJzaW9uIiwibWFya2V0cGxhY2UiLCJ2ZXJzaW9uQ29tcGFyZSIsImdsb2JhbFRyYW5zbGF0ZSIsImV4dF9VcGRhdGVNb2R1bGVUaXRsZSIsImh0bWwiLCJleHRfTW9kdWxlVXBkYXRlRGVzY3JpcHRpb24iLCJleHRfRG93bmdyYWRlTW9kdWxlVGl0bGUiLCJleHRfTW9kdWxlRG93bmdyYWRlRGVzY3JpcHRpb24iLCJleHRfSW5zdGFsbE1vZHVsZVRpdGxlIiwiZXh0X01vZHVsZUluc3RhbGxEZXNjcmlwdGlvbiIsIm9uRGVueSIsInJlbW92ZUNsYXNzIiwib25BcHByb3ZlIiwiYWRkQ2xhc3MiLCJwYXJhbXMiLCJ1bmlxaWQiLCJjaGFubmVsSWQiLCJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsIiRtb2R1bGVCdXR0b25zIiwicmVtb3ZlIiwiUGJ4QXBpIiwiTW9kdWxlc0luc3RhbGxGcm9tUmVwbyIsInJlc3BvbnNlIiwiY29uc29sZSIsImRlYnVnIiwib3BlblVwZGF0ZUFsbE1vZHVsZXNNb2RhbCIsImV4dF9VcGRhdGVBbGxNb2R1bGVzVGl0bGUiLCJleHRfVXBkYXRlQWxsTW9kdWxlc0Rlc2NyaXB0aW9uIiwidW5pcXVlTW9kdWxlc0ZvclVwZGF0ZSIsIlNldCIsImVhY2giLCJpbmRleCIsIiRidXR0b24iLCJhZGQiLCJtb2R1bGVzRm9yVXBkYXRlIiwiTW9kdWxlc1VwZGF0ZUFsbCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLG9CQUFvQixHQUFHO0FBRXpCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFVBQVUsRUFBRUMsZ0JBQWdCLENBQUNDLE9BQWpCLENBQXlCLE9BQXpCLEVBQWtDLEVBQWxDLENBTmE7O0FBUXpCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFVBQVUsRUFBRUMsZ0JBQWdCLENBQUNDLElBQWpCLEVBWmE7O0FBY3pCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLG9CQUFvQixFQUFFQyxDQUFDLENBQUMsNEJBQUQsQ0FsQkU7O0FBb0J6QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGlCQUFpQixFQUFFRCxDQUFDLENBQUMsNEJBQUQsQ0F6Qks7O0FBMkJ6QjtBQUNKO0FBQ0E7QUFDQTtBQUNJRSxFQUFBQSx1QkFBdUIsRUFBRUYsQ0FB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UUFBQUEsQ0FBQyxDQUFDLHlCQUFELENBQUQsQ0FBNkJtRCxNQUE3QjtBQUNBbkQsUUFBQUEsQ0FBQyxDQUFDLFVBQUQsQ0FBRCxDQUFjMkMsV0FBZCxDQUEwQixPQUExQjtBQUVBLGVBQU8sSUFBUDtBQUNIO0FBcENFLEtBRFgsRUF1Q0t0QixLQXZDTCxDQXVDVyxNQXZDWDtBQXdDSDtBQXBNd0IsQ0FBN0IsQyxDQXdNQTtBQUNBOztBQUNBckIsQ0FBQyxDQUFDTSxRQUFELENBQUQsQ0FBWThELEtBQVosQ0FBa0IsWUFBTTtBQUNwQjVFLEVBQUFBLG9CQUFvQixDQUFDVyxVQUFyQjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyNCBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgUGJ4QXBpLCBnbG9iYWxQQlhMaWNlbnNlLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlLCBnbG9iYWxQQlhWZXJzaW9uLCBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciwgbWFya2V0cGxhY2UgKi9cblxuLyoqXG4gKiBNYW5hZ2VzIHRoZSBpbnN0YWxsYXRpb24gYW5kIHVwZGF0aW5nIG9mIFBCWCBleHRlbnNpb24gbW9kdWxlcyBmcm9tIGEgcmVwb3NpdG9yeS5cbiAqIEl0IHByb3ZpZGVzIGZ1bmN0aW9uYWxpdHkgdG8gdXBkYXRlIGluZGl2aWR1YWwgbW9kdWxlcyBvciBhbGwgbW9kdWxlcyBhdCBvbmNlLFxuICogYW5kIGRpc3BsYXlzIHByb2dyZXNzIGluZm9ybWF0aW9uIHRvIHRoZSB1c2VyLlxuICpcbiAqIEBjbGFzcyBpbnN0YWxsYXRpb25Gcm9tUmVwb1xuICogQG1lbWJlcm9mIG1vZHVsZTpQYnhFeHRlbnNpb25Nb2R1bGVzXG4gKi9cbmNvbnN0IGluc3RhbGxhdGlvbkZyb21SZXBvID0ge1xuXG4gICAgLyoqXG4gICAgICogVGhlIGN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgUEJYIHN5c3RlbSwgd2l0aCBkZXZlbG9wbWVudCB2ZXJzaW9uIGlkZW50aWZpZXJzIHJlbW92ZWQuXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBwYnhWZXJzaW9uOiBnbG9iYWxQQlhWZXJzaW9uLnJlcGxhY2UoLy1kZXYvaSwgJycpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGxpY2Vuc2Uga2V5IGZvciB0aGUgUEJYIHN5c3RlbSwgdHJpbW1lZCBvZiBhbnkgbGVhZGluZyBvciB0cmFpbGluZyB3aGl0ZXNwYWNlLlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgcGJ4TGljZW5zZTogZ2xvYmFsUEJYTGljZW5zZS50cmltKCksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgYnV0dG9uIHJlc3BvbnNpYmxlIGZvciB1cGRhdGluZyBhbGwgaW5zdGFsbGVkIG1vZHVsZXMuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkYnRuVXBkYXRlQWxsTW9kdWxlczogJCgnI3VwZGF0ZS1hbGwtbW9kdWxlcy1idXR0b24nKSxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBibG9jayB0aGF0IGNvbnRhaW5zIHRoZSBwcm9ncmVzcyBiYXIsIHVzZWQgdG8gaW5kaWNhdGVcbiAgICAgKiB0aGUgcHJvZ3Jlc3Mgb2YgbW9kdWxlIGluc3RhbGxhdGlvbiBvciB1cGRhdGluZyBwcm9jZXNzZXMuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXJCbG9jazogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXItYmxvY2snKSxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBpbnN0YWxsYXRpb24gbW9kdWxlIG1vZGFsIGZvcm0uXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkaW5zdGFsbE1vZHVsZU1vZGFsRm9ybTogJCgnI2luc3RhbGwtbW9kYWwtZm9ybScpLFxuXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgaW5zdGFsbGF0aW9uRnJvbVJlcG8gbW9kdWxlLiBTZXRzIHVwIGV2ZW50IGhhbmRsZXJzIGZvciBVSSBpbnRlcmFjdGlvbnNcbiAgICAgKiBhbmQgaGlkZXMgVUkgZWxlbWVudHMgdGhhdCBhcmUgbm90IGltbWVkaWF0ZWx5IG5lZWRlZC5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKCkge1xuICAgICAgICBpbnN0YWxsYXRpb25Gcm9tUmVwby5pbml0aWFsaXplQnV0dG9uRXZlbnRzKCk7XG4gICAgICAgIGluc3RhbGxhdGlvbkZyb21SZXBvLiRwcm9ncmVzc0JhckJsb2NrLmhpZGUoKTtcbiAgICAgICAgaW5zdGFsbGF0aW9uRnJvbVJlcG8uJGJ0blVwZGF0ZUFsbE1vZHVsZXMuaGlkZSgpOyAvLyBVbnRpbCBhdCBsZWFzdCBvbmUgdXBkYXRlIGF2YWlsYWJsZVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTZXRzIHVwIGV2ZW50IGhhbmRsZXJzIGZvciBidXR0b24gY2xpY2tzIHdpdGhpbiB0aGUgbW9kdWxlLlxuICAgICAqIFRoaXMgaW5jbHVkZXMgaGFuZGxpbmcgdGhlIGluc3RhbGxhdGlvbiBhbmQgdXBkYXRlIG9mIGluZGl2aWR1YWxcbiAgICAgKiBtb2R1bGVzIGFzIHdlbGwgYXMgdGhlIGJ1bGsgdXBkYXRlIGZ1bmN0aW9uYWxpdHkuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZUJ1dHRvbkV2ZW50cygpIHtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIHRoZSBkb3dubG9hZCBsaW5rIGNsaWNrIGV2ZW50LlxuICAgICAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gVGhlIGNsaWNrIGV2ZW50IG9iamVjdC5cbiAgICAgICAgICovXG4gICAgICAgICQoZG9jdW1lbnQpLm9uKCdjbGljaycsICdhLmRvd25sb2FkLCBhLnVwZGF0ZScsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBjb25zdCAkY3VycmVudEJ1dHRvbiA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJ2EuYnV0dG9uJyk7XG4gICAgICAgICAgICBpZiAoaW5zdGFsbGF0aW9uRnJvbVJlcG8ucGJ4TGljZW5zZSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfXBieC1leHRlbnNpb24tbW9kdWxlcy9pbmRleCMvbGljZW5zaW5nYDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaW5zdGFsbGF0aW9uRnJvbVJlcG8ub3Blbkluc3RhbGxNb2R1bGVNb2RhbCgkY3VycmVudEJ1dHRvbik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgICAgIGluc3RhbGxhdGlvbkZyb21SZXBvLiRidG5VcGRhdGVBbGxNb2R1bGVzLm9uKCdjbGljaycsIGluc3RhbGxhdGlvbkZyb21SZXBvLnVwZGF0ZUFsbE1vZHVsZXMpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBPcGVucyB0aGUgbW9kYWwgZm9ybSBmb3IgaW5zdGFsbGluZyBhIG1vZHVsZS4gVGhpcyBtb2RhbCBwcm92aWRlcyB0aGUgdXNlciB3aXRoIGluZm9ybWF0aW9uXG4gICAgICogYWJvdXQgdGhlIG1vZHVsZSB0aGV5IGFyZSBhYm91dCB0byBpbnN0YWxsLCBhbmQgY29uZmlybXMgdGhlaXIgYWN0aW9uLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtqUXVlcnl9ICRjdXJyZW50QnV0dG9uIC0gVGhlIGpRdWVyeSBvYmplY3Qgb2YgdGhlIGJ1dHRvbiB0aGF0IHdhcyBjbGlja2VkIHRvIHRyaWdnZXIgdGhpcyBtb2RhbC5cbiAgICAgKi9cbiAgICBvcGVuSW5zdGFsbE1vZHVsZU1vZGFsKCRjdXJyZW50QnV0dG9uKSB7XG4gICAgICAgIGNvbnN0IG1vZHVsZVVuaXF1ZUlkID0gJGN1cnJlbnRCdXR0b24uZGF0YSgndW5pcWlkJyk7XG4gICAgICAgIGNvbnN0IHJlbGVhc2VJZCA9ICRjdXJyZW50QnV0dG9uLmRhdGEoJ3JlbGVhc2VpZCcpO1xuICAgICAgICBpbnN0YWxsYXRpb25Gcm9tUmVwby4kaW5zdGFsbE1vZHVsZU1vZGFsRm9ybVxuICAgICAgICAgICAgLm1vZGFsKHtcbiAgICAgICAgICAgICAgICBjbG9zYWJsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgb25TaG93OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1vZHVsZU5hbWUgPSAkY3VycmVudEJ1dHRvbi5jbG9zZXN0KCd0cicpLmRhdGEoJ25hbWUnKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhlRm9ybSA9ICBpbnN0YWxsYXRpb25Gcm9tUmVwby4kaW5zdGFsbE1vZHVsZU1vZGFsRm9ybTtcbiAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5maW5kKCdzcGFuLm1vZHVsZS1uYW1lJykudGV4dChtb2R1bGVOYW1lKTtcblxuICAgICAgICAgICAgICAgICAgICBjb25zdCAkaW5zdGFsbGVkTW9kdWxlUm93ID0gJChgdHIubW9kdWxlLXJvd1tkYXRhLWlkPSR7bW9kdWxlVW5pcXVlSWR9XWApO1xuICAgICAgICAgICAgICAgICAgICBpZiAoJGluc3RhbGxlZE1vZHVsZVJvdy5sZW5ndGg+MCl7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0YWxsZWRWZXJzaW9uID0gJGluc3RhbGxlZE1vZHVsZVJvdy5kYXRhKCd2ZXJzaW9uJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdWZXJzaW9uID0gJGN1cnJlbnRCdXR0b24uZGF0YSgndmVyc2lvbicpPz9pbnN0YWxsZWRWZXJzaW9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hcmtldHBsYWNlLnZlcnNpb25Db21wYXJlKG5ld1ZlcnNpb24sIGluc3RhbGxlZFZlcnNpb24pPjApe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZUZvcm0uZmluZCgnc3Bhbi5hY3Rpb24nKS50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBkYXRlTW9kdWxlVGl0bGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZUZvcm0uZmluZCgnZGl2LmRlc2NyaXB0aW9uJykuaHRtbChnbG9iYWxUcmFuc2xhdGUuZXh0X01vZHVsZVVwZGF0ZURlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5maW5kKCdzcGFuLmFjdGlvbicpLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9Eb3duZ3JhZGVNb2R1bGVUaXRsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5maW5kKCdkaXYuZGVzY3JpcHRpb24nKS5odG1sKGdsb2JhbFRyYW5zbGF0ZS5leHRfTW9kdWxlRG93bmdyYWRlRGVzY3JpcHRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5maW5kKCdzcGFuLmFjdGlvbicpLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsTW9kdWxlVGl0bGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5maW5kKCdkaXYuZGVzY3JpcHRpb24nKS5odG1sKGdsb2JhbFRyYW5zbGF0ZS5leHRfTW9kdWxlSW5zdGFsbERlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb25EZW55OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICQoJ2EuYnV0dG9uJykucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgb25BcHByb3ZlOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICQoJ2EuYnV0dG9uJykuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyYW1zID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdW5pcWlkOiBtb2R1bGVVbmlxdWVJZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbGVhc2VJZDogcmVsZWFzZUlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbElkOiBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jaGFubmVsSWRcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICAkKGAjbW9kYWwtJHtwYXJhbXMudW5pcWlkfWApLm1vZGFsKCdoaWRlJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0ICRtb2R1bGVCdXR0b25zID0gJChgYVtkYXRhLXVuaXFpZD0ke3BhcmFtcy51bmlxaWR9YCk7XG5cbiAgICAgICAgICAgICAgICAgICAgJG1vZHVsZUJ1dHRvbnMucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICRtb2R1bGVCdXR0b25zLmZpbmQoJ2knKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdkb3dubG9hZCcpXG4gICAgICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ3JlZG8nKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdzcGlubmVyIGxvYWRpbmcnKTtcblxuICAgICAgICAgICAgICAgICAgICAkKCd0ci50YWJsZS1lcnJvci1tZXNzYWdlcycpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAkKCd0ci5lcnJvcicpLnJlbW92ZUNsYXNzKCdlcnJvcicpO1xuXG4gICAgICAgICAgICAgICAgICAgIFBieEFwaS5Nb2R1bGVzSW5zdGFsbEZyb21SZXBvKHBhcmFtcywgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAubW9kYWwoJ3Nob3cnKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhdGVzIHRoZSBwcm9jZXNzIG9mIHVwZGF0aW5nIGFsbCBpbnN0YWxsZWQgbW9kdWxlcy4gVGhpcyBmdW5jdGlvbiBpcyB0cmlnZ2VyZWQgYnkgdGhlIHVzZXJcbiAgICAgKiBjbGlja2luZyB0aGUgJ1VwZGF0ZSBBbGwnIGJ1dHRvbi4gSXQgZmlyc3QgZGlzYWJsZXMgVUkgZWxlbWVudHMgdG8gcHJldmVudCBmdXJ0aGVyIHVzZXIgYWN0aW9uc1xuICAgICAqIGFuZCB0aGVuIGNhbGxzIHRoZSBBUEkgdG8gc3RhcnQgdGhlIHVwZGF0ZSBwcm9jZXNzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtFdmVudH0gZSAtIFRoZSBjbGljayBldmVudCBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoZSAnVXBkYXRlIEFsbCcgYnV0dG9uIGNsaWNrLlxuICAgICAqL1xuICAgIHVwZGF0ZUFsbE1vZHVsZXMoZSkge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICQoJ2EuYnV0dG9uJykuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgIGNvbnN0ICRjdXJyZW50QnV0dG9uID0gJChlLnRhcmdldCkuY2xvc2VzdCgnYScpO1xuICAgICAgICBpbnN0YWxsYXRpb25Gcm9tUmVwby5vcGVuVXBkYXRlQWxsTW9kdWxlc01vZGFsKCRjdXJyZW50QnV0dG9uKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogT3BlbnMgYSBtb2RhbCBjb25maXJtYXRpb24gZGlhbG9nIHdoZW4gdXBkYXRpbmcgYWxsIG1vZHVsZXMuIFRoaXMgZGlhbG9nIGluZm9ybXMgdGhlIHVzZXIgYWJvdXRcbiAgICAgKiB0aGUgdXBkYXRlIHByb2Nlc3MgYW5kIGFza3MgZm9yIGNvbmZpcm1hdGlvbiB0byBwcm9jZWVkIHdpdGggdXBkYXRpbmcgYWxsIGluc3RhbGxlZCBtb2R1bGVzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtqUXVlcnl9ICRjdXJyZW50QnV0dG9uIC0gVGhlIGpRdWVyeSBvYmplY3Qgb2YgdGhlIGJ1dHRvbiB0aGF0IHdhcyBjbGlja2VkIHRvIHRyaWdnZXIgdGhpcyBtb2RhbC5cbiAgICAgKi9cbiAgICBvcGVuVXBkYXRlQWxsTW9kdWxlc01vZGFsKCRjdXJyZW50QnV0dG9uKSB7XG4gICAgICAgIGluc3RhbGxhdGlvbkZyb21SZXBvLiRpbnN0YWxsTW9kdWxlTW9kYWxGb3JtXG4gICAgICAgICAgICAubW9kYWwoe1xuICAgICAgICAgICAgICAgIGNsb3NhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBvblNob3c6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGhlRm9ybSA9ICBpbnN0YWxsYXRpb25Gcm9tUmVwby4kaW5zdGFsbE1vZHVsZU1vZGFsRm9ybTtcbiAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5maW5kKCdzcGFuLmFjdGlvbicpLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGRhdGVBbGxNb2R1bGVzVGl0bGUpO1xuICAgICAgICAgICAgICAgICAgICB0aGVGb3JtLmZpbmQoJ3NwYW4ubW9kdWxlLW5hbWUnKS50ZXh0KCcnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhlRm9ybS5maW5kKCdkaXYuZGVzY3JpcHRpb24nKS5odG1sKGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBkYXRlQWxsTW9kdWxlc0Rlc2NyaXB0aW9uKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9uRGVueTogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAkKCdhLmJ1dHRvbicpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIG9uQXBwcm92ZTogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAkKCdhLmJ1dHRvbicpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXG4gICAgICAgICAgICAgICAgICAgICRjdXJyZW50QnV0dG9uLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgICAgICAgICAkY3VycmVudEJ1dHRvbi5jbG9zZXN0KCdpLmljb24nKVxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKCdyZWRvJylcbiAgICAgICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnc3Bpbm5lciBsb2FkaW5nJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgbGV0IHVuaXF1ZU1vZHVsZXNGb3JVcGRhdGUgPSBuZXcgU2V0KCk7XG4gICAgICAgICAgICAgICAgICAgICQoJ2EudXBkYXRlJykuZWFjaCgoaW5kZXgsICRidXR0b24pPT57XG4gICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWVNb2R1bGVzRm9yVXBkYXRlLmFkZCgkKCRidXR0b24pLmRhdGEoJ3VuaXFpZCcpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxJZDogaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlc0ZvclVwZGF0ZTogWy4uLnVuaXF1ZU1vZHVsZXNGb3JVcGRhdGVdLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBQYnhBcGkuTW9kdWxlc1VwZGF0ZUFsbChwYXJhbXMsIChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICQoJ3RyLnRhYmxlLWVycm9yLW1lc3NhZ2VzJykucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICQoJ3RyLmVycm9yJykucmVtb3ZlQ2xhc3MoJ2Vycm9yJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAubW9kYWwoJ3Nob3cnKTtcbiAgICB9LFxuXG59O1xuXG4vLyBJbml0aWFsaXplcyB0aGUgaW5zdGFsbGF0aW9uRnJvbVJlcG8gbW9kdWxlIHdoZW4gdGhlIGRvY3VtZW50IGlzIHJlYWR5LFxuLy8gcHJlcGFyaW5nIHRoZSBleHRlbnNpb24gbW9kdWxlcyBtYW5hZ2VtZW50IFVJLlxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIGluc3RhbGxhdGlvbkZyb21SZXBvLmluaXRpYWxpemUoKTtcbn0pOyJdfQ==