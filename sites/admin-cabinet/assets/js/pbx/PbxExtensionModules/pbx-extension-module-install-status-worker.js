"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Handles real-time monitoring and updates of module installation statuses.
 * Utilizes server-sent events to receive updates and reflects these changes in the UI,
 * particularly in the progress bar and status messages displayed to the user.
 *
 * @module installStatusLoopWorker
 */
var installStatusLoopWorker = {
  /**
   * The jQuery object representing the progress bar element in the DOM.
   * Used to visually indicate the progress of module installation or updates.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * The jQuery object for the container of the progress bar.
   * This element is shown and hidden based on the presence of active installation or update processes.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * The jQuery object for the label element associated with the progress bar.
   * Used to display textual information about the current stage of the installation or update process.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * The EventSource object used for receiving real-time updates from the server about module installation statuses.
   * This allows for a push-based mechanism to keep the UI updated with the latest progress information.
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * The identifier for the PUB/SUB channel used to subscribe to installation status updates.
   * This ensures that the client is listening on the correct channel for relevant events.
   */
  channelId: 'install-module',

  /**
   * Initializes the installStatusLoopWorker module by setting up the connection to receive server-sent events.
   */
  initialize: function initialize() {
    installStatusLoopWorker.startListenPushNotifications();
  },

  /**
   * Establishes a connection to the server to start receiving real-time updates on module installation progress.
   * Utilizes the EventSource API to listen for messages on a specified channel.
   */
  startListenPushNotifications: function startListenPushNotifications() {
    var lastEventIdKey = "".concat(installStatusLoopWorker.channelId, "-lastEventId");
    var lastEventId = localStorage.getItem(lastEventIdKey);
    var subPath = lastEventId ? "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId, "?last_event_id=").concat(lastEventId) : "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId);
    installStatusLoopWorker.eventSource = new EventSource(subPath);
    installStatusLoopWorker.eventSource.addEventListener('message', function (e) {
      var response = JSON.parse(e.data);
      installStatusLoopWorker.processModuleInstallation(response);
      console.debug(response);
      localStorage.setItem(lastEventIdKey, e.lastEventId);
    });
  },

  /**
   * Processes incoming server-sent events related to module installation.
   * Updates the UI based on the current stage of installation, download, upload, or error states.
   *
   * @param {Object} response - The data payload of the server-sent event, containing details about the installation stage and progress.
   */
  processModuleInstallation: function processModuleInstallation(response) {
    var moduleUniqueId = response.moduleUniqueId;
    var stage = response.stage;
    var stageDetails = response.stageDetails;
    var $row = $("tr[data-id=".concat(moduleUniqueId, "]"));

    if (stage === 'Stage_I_GetRelease') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_GetReleaseInProgress, 1);
    } else if (stage === 'Stage_II_CheckLicense') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 2);
    } else if (stage === 'Stage_III_GetDownloadLink') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 3);
    } else if (stage === 'Stage_IV_DownloadModule') {
      installStatusLoopWorker.cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_I_UploadModule') {
      installStatusLoopWorker.cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_V_InstallModule') {
      installStatusLoopWorker.cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_VI_EnableModule') {} else if (stage === 'Stage_VII_FinalStatus') {
      if (stageDetails.result === false) {
        installStatusLoopWorker.$progressBarBlock.hide();

        if (stageDetails.messages !== undefined) {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError, stageDetails.messages);
        } else {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError);
        }
      } else {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }
    }
  },

  /**
   * Updates the UI to reflect the progress of a module download.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being downloaded.
   * @param {Object} stageDetails - Detailed information about the download progress.
   */
  cbAfterReceiveNewDownloadStatus: function cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'DOWNLOAD_IN_PROGRESS') {
      var downloadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, downloadProgress);
    } else if (stageDetails.d_status === 'DOWNLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, 50);
    }
  },

  /**
   * Updates the UI to reflect the progress of a module upload.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being uploaded.
   * @param {Object} stageDetails - Detailed information about the upload progress.
   */
  cbAfterReceiveNewUploadStatus: function cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'UPLOAD_IN_PROGRESS') {
      var uploadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, uploadProgress);
    } else if (stageDetails.d_status === 'UPLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, 50);
    }
  },

  /**
   * Handles updates on the installation progress of a module.
   * Updates the progress bar and status message based on the information received in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being installed.
   * @param {Object} stageDetails - Detailed information about the installation progress.
   */
  cbAfterReceiveNewInstallationStatus: function cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails) {
    // Check module installation status
    if (stageDetails.data.i_status === 'INSTALLATION_IN_PROGRESS') {
      var installationProgress = Math.round(parseInt(stageDetails.data.i_status_progress, 10) / 2 + 50);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, installationProgress);
    } else if (stageDetails.data.i_status === 'INSTALLATION_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, 100);
    }
  },

  /**
   * Resets the UI elements associated with a module row to their default state.
   * This is typically called after an installation process completes or fails.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   */
  resetButtonView: function resetButtonView($row) {
    $('a.button').removeClass('disabled');
    $row.find('i.loading').removeClass('spinner loading');
    $row.find('a.download i').addClass('download');
    $row.find('a.update i').addClass('redo');
  },

  /**
   * Displays an error message related to module installation in the UI.
   * This function is called when an installation fails, providing feedback to the user.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   * @param {string} header - The header text for the error message.
   * @param {Object} messages - Detailed error messages to be displayed.
   */
  showModuleInstallationError: function showModuleInstallationError($row, header) {
    var messages = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';
    installStatusLoopWorker.resetButtonView($row);

    if (messages.license !== undefined) {
      var manageLink = "<br>".concat(globalTranslate.lic_ManageLicense, " <a href=\"").concat(Config.keyManagementUrl, "\" target=\"_blank\">").concat(Config.keyManagementSite, "</a>");
      messages.license.push(manageLink);
    }

    var textDescription = UserMessage.convertToText(messages);
    var htmlMessage = "<tr class=\"ui error center aligned table-error-messages\"><td colspan=\"4\"><div class=\"ui header\">".concat(header, "</div><p>").concat(textDescription, "</p></div></td></tr>");
    $row.addClass('error');
    $row.before(htmlMessage);
  },

  /**
   * Updates the progress bar and status message to reflect the current state of a module installation process.
   * This function is used throughout different stages of installation to provide real-time feedback to the user.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module.
   * @param {string} header - The status message to be displayed above the progress bar.
   * @param {number} [percent=0] - The current progress percentage to be reflected in the progress bar.
   */
  updateProgressBar: function updateProgressBar(moduleUniqueId, header) {
    var percent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

    if (moduleUniqueId === undefined || moduleUniqueId === '') {
      return;
    }

    var moduleName = $("tr.new-module-row[data-id=".concat(moduleUniqueId, "]")).data('name');

    if (moduleName === undefined) {
      moduleName = '';
    }

    installStatusLoopWorker.$progressBarBlock.show();
    installStatusLoopWorker.$progressBar.show();

    if (header) {
      var barText = moduleName + ': ' + header;
      installStatusLoopWorker.$progressBarLabel.text(barText);
    }

    if (percent > 0) {
      installStatusLoopWorker.$progressBar.progress({
        percent: percent
      });
    }
  }
}; // Initializes the installStatusLoopWorker module when the DOM is fully loaded.

$(document).ready(function () {
  installStatusLoopWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsIiRwcm9ncmVzc0JhciIsIiQiLCIkcHJvZ3Jlc3NCYXJCbG9jayIsIiRwcm9ncmVzc0JhckxhYmVsIiwiZXZlbnRTb3VyY2UiLCJjaGFubmVsSWQiLCJpbml0aWFsaXplIiwic3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucyIsImxhc3RFdmVudElkS2V5IiwibGFzdEV2ZW50SWQiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwic3ViUGF0aCIsIkV2ZW50U291cmNlIiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCJyZXNwb25zZSIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJwcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uIiwiY29uc29sZSIsImRlYnVnIiwic2V0SXRlbSIsIm1vZHVsZVVuaXF1ZUlkIiwic3RhZ2UiLCJzdGFnZURldGFpbHMiLCIkcm93IiwidXBkYXRlUHJvZ3Jlc3NCYXIiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfR2V0UmVsZWFzZUluUHJvZ3Jlc3MiLCJleHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcyIsImNiQWZ0ZXJSZWNlaXZlTmV3RG93bmxvYWRTdGF0dXMiLCJjYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyIsImNiQWZ0ZXJSZWNlaXZlTmV3SW5zdGFsbGF0aW9uU3RhdHVzIiwicmVzdWx0IiwiaGlkZSIsIm1lc3NhZ2VzIiwidW5kZWZpbmVkIiwic2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yIiwiZXh0X0luc3RhbGxhdGlvbkVycm9yIiwid2luZG93IiwibG9jYXRpb24iLCJnbG9iYWxSb290VXJsIiwiZF9zdGF0dXMiLCJkb3dubG9hZFByb2dyZXNzIiwiTWF0aCIsIm1heCIsInJvdW5kIiwicGFyc2VJbnQiLCJkX3N0YXR1c19wcm9ncmVzcyIsImV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MiLCJ1cGxvYWRQcm9ncmVzcyIsImV4dF9VcGxvYWRJblByb2dyZXNzIiwiaV9zdGF0dXMiLCJpbnN0YWxsYXRpb25Qcm9ncmVzcyIsImlfc3RhdHVzX3Byb2dyZXNzIiwiZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MiLCJyZXNldEJ1dHRvblZpZXciLCJyZW1vdmVDbGFzcyIsImZpbmQiLCJhZGRDbGFzcyIsImhlYWRlciIsImxpY2Vuc2UiLCJtYW5hZ2VMaW5rIiwibGljX01hbmFnZUxpY2Vuc2UiLCJDb25maWciLCJrZXlNYW5hZ2VtZW50VXJsIiwia2V5TWFuYWdlbWVudFNpdGUiLCJwdXNoIiwidGV4dERlc2NyaXB0aW9uIiwiVXNlck1lc3NhZ2UiLCJjb252ZXJ0VG9UZXh0IiwiaHRtbE1lc3NhZ2UiLCJiZWZvcmUiLCJwZXJjZW50IiwibW9kdWxlTmFtZSIsInNob3ciLCJiYXJUZXh0IiwidGV4dCIsInByb2dyZXNzIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsdUJBQXVCLEdBQUc7QUFDNUI7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxZQUFZLEVBQUVDLENBQUMsQ0FBQyxzQkFBRCxDQU5hOztBQVE1QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGlCQUFpQixFQUFFRCxDQUFDLENBQUMsNEJBQUQsQ0FiUTs7QUFlNUI7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJRSxFQUFBQSxpQkFBaUIsRUFBRUYsQ0FBQyxDQUFDLDRCQUFELENBcEJROztBQXNCNUI7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJRyxFQUFBQSxXQUFXLEVBQUUs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QUExQyxDQUErQ0QsT0FBL0M7QUFDSDs7QUFDRCxRQUFJSCxPQUFPLEdBQUMsQ0FBWixFQUFjO0FBQ1Y1RSxNQUFBQSx1QkFBdUIsQ0FBQ0MsWUFBeEIsQ0FBcUNnRixRQUFyQyxDQUE4QztBQUMxQ0wsUUFBQUEsT0FBTyxFQUFFQTtBQURpQyxPQUE5QztBQUdIO0FBQ0o7QUFsTjJCLENBQWhDLEMsQ0FxTkE7O0FBQ0ExRSxDQUFDLENBQUNnRixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCbkYsRUFBQUEsdUJBQXVCLENBQUNPLFVBQXhCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UgKi9cblxuLyoqXG4gKiBIYW5kbGVzIHJlYWwtdGltZSBtb25pdG9yaW5nIGFuZCB1cGRhdGVzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24gc3RhdHVzZXMuXG4gKiBVdGlsaXplcyBzZXJ2ZXItc2VudCBldmVudHMgdG8gcmVjZWl2ZSB1cGRhdGVzIGFuZCByZWZsZWN0cyB0aGVzZSBjaGFuZ2VzIGluIHRoZSBVSSxcbiAqIHBhcnRpY3VsYXJseSBpbiB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZXMgZGlzcGxheWVkIHRvIHRoZSB1c2VyLlxuICpcbiAqIEBtb2R1bGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgPSB7XG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBwcm9ncmVzcyBiYXIgZWxlbWVudCBpbiB0aGUgRE9NLlxuICAgICAqIFVzZWQgdG8gdmlzdWFsbHkgaW5kaWNhdGUgdGhlIHByb2dyZXNzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgY29udGFpbmVyIG9mIHRoZSBwcm9ncmVzcyBiYXIuXG4gICAgICogVGhpcyBlbGVtZW50IGlzIHNob3duIGFuZCBoaWRkZW4gYmFzZWQgb24gdGhlIHByZXNlbmNlIG9mIGFjdGl2ZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlIHByb2Nlc3Nlcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhckJsb2NrOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhci1ibG9jaycpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBsYWJlbCBlbGVtZW50IGFzc29jaWF0ZWQgd2l0aCB0aGUgcHJvZ3Jlc3MgYmFyLlxuICAgICAqIFVzZWQgdG8gZGlzcGxheSB0ZXh0dWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IHN0YWdlIG9mIHRoZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlIHByb2Nlc3MuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXItbGFiZWwnKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBFdmVudFNvdXJjZSBvYmplY3QgdXNlZCBmb3IgcmVjZWl2aW5nIHJlYWwtdGltZSB1cGRhdGVzIGZyb20gdGhlIHNlcnZlciBhYm91dCBtb2R1bGUgaW5zdGFsbGF0aW9uIHN0YXR1c2VzLlxuICAgICAqIFRoaXMgYWxsb3dzIGZvciBhIHB1c2gtYmFzZWQgbWVjaGFuaXNtIHRvIGtlZXAgdGhlIFVJIHVwZGF0ZWQgd2l0aCB0aGUgbGF0ZXN0IHByb2dyZXNzIGluZm9ybWF0aW9uLlxuICAgICAqIEB0eXBlIHtFdmVudFNvdXJjZX1cbiAgICAgKi9cbiAgICBldmVudFNvdXJjZTogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBpZGVudGlmaWVyIGZvciB0aGUgUFVCL1NVQiBjaGFubmVsIHVzZWQgdG8gc3Vic2NyaWJlIHRvIGluc3RhbGxhdGlvbiBzdGF0dXMgdXBkYXRlcy5cbiAgICAgKiBUaGlzIGVuc3VyZXMgdGhhdCB0aGUgY2xpZW50IGlzIGxpc3RlbmluZyBvbiB0aGUgY29ycmVjdCBjaGFubmVsIGZvciByZWxldmFudCBldmVudHMuXG4gICAgICovXG4gICAgY2hhbm5lbElkOiAnaW5zdGFsbC1tb2R1bGUnLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIGluc3RhbGxTdGF0dXNMb29wV29ya2VyIG1vZHVsZSBieSBzZXR0aW5nIHVwIHRoZSBjb25uZWN0aW9uIHRvIHJlY2VpdmUgc2VydmVyLXNlbnQgZXZlbnRzLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKXtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucygpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBFc3RhYmxpc2hlcyBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciB0byBzdGFydCByZWNlaXZpbmcgcmVhbC10aW1lIHVwZGF0ZXMgb24gbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9ncmVzcy5cbiAgICAgKiBVdGlsaXplcyB0aGUgRXZlbnRTb3VyY2UgQVBJIHRvIGxpc3RlbiBmb3IgbWVzc2FnZXMgb24gYSBzcGVjaWZpZWQgY2hhbm5lbC5cbiAgICAgKi9cbiAgICBzdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zKCkge1xuICAgICAgICBjb25zdCBsYXN0RXZlbnRJZEtleSA9IGAke2luc3RhbGxTdGF0dXNMb29wV29ya2VyLmNoYW5uZWxJZH0tbGFzdEV2ZW50SWRgO1xuICAgICAgICBsZXQgbGFzdEV2ZW50SWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShsYXN0RXZlbnRJZEtleSk7XG4gICAgICAgIGNvbnN0IHN1YlBhdGggPSBsYXN0RXZlbnRJZCA/IGAvcGJ4Y29yZS9hcGkvbmNoYW4vc3ViLyR7aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfT9sYXN0X2V2ZW50X2lkPSR7bGFzdEV2ZW50SWR9YCA6IGAvcGJ4Y29yZS9hcGkvbmNoYW4vc3ViLyR7aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfWA7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmV2ZW50U291cmNlID0gbmV3IEV2ZW50U291cmNlKHN1YlBhdGgpO1xuXG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmV2ZW50U291cmNlLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5wYXJzZShlLmRhdGEpO1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIucHJvY2Vzc01vZHVsZUluc3RhbGxhdGlvbihyZXNwb25zZSk7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGxhc3RFdmVudElkS2V5LCBlLmxhc3RFdmVudElkKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFByb2Nlc3NlcyBpbmNvbWluZyBzZXJ2ZXItc2VudCBldmVudHMgcmVsYXRlZCB0byBtb2R1bGUgaW5zdGFsbGF0aW9uLlxuICAgICAqIFVwZGF0ZXMgdGhlIFVJIGJhc2VkIG9uIHRoZSBjdXJyZW50IHN0YWdlIG9mIGluc3RhbGxhdGlvbiwgZG93bmxvYWQsIHVwbG9hZCwgb3IgZXJyb3Igc3RhdGVzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIC0gVGhlIGRhdGEgcGF5bG9hZCBvZiB0aGUgc2VydmVyLXNlbnQgZXZlbnQsIGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dCB0aGUgaW5zdGFsbGF0aW9uIHN0YWdlIGFuZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBwcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgY29uc3QgbW9kdWxlVW5pcXVlSWQgPSByZXNwb25zZS5tb2R1bGVVbmlxdWVJZDtcbiAgICAgICAgY29uc3Qgc3RhZ2UgPSByZXNwb25zZS5zdGFnZTtcbiAgICAgICAgY29uc3Qgc3RhZ2VEZXRhaWxzID0gcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzO1xuICAgICAgICBjb25zdCAkcm93ID0gJChgdHJbZGF0YS1pZD0ke21vZHVsZVVuaXF1ZUlkfV1gKTtcbiAgICAgICAgaWYgKHN0YWdlID09PSdTdGFnZV9JX0dldFJlbGVhc2UnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0dldFJlbGVhc2VJblByb2dyZXNzLCAxKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lJX0NoZWNrTGljZW5zZScpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcywgMik7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9JSUlfR2V0RG93bmxvYWRMaW5rJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9DaGVja0xpY2Vuc2VJblByb2dyZXNzLCAzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lWX0Rvd25sb2FkTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld0Rvd25sb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfSV9VcGxvYWRNb2R1bGUnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmNiQWZ0ZXJSZWNlaXZlTmV3VXBsb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfVl9JbnN0YWxsTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld0luc3RhbGxhdGlvblN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX1ZJX0VuYWJsZU1vZHVsZScpe1xuXG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9WSUlfRmluYWxTdGF0dXMnKXtcbiAgICAgICAgICAgIGlmIChzdGFnZURldGFpbHMucmVzdWx0PT09ZmFsc2Upe1xuICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0JhckJsb2NrLmhpZGUoKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLm1lc3NhZ2VzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IsIHN0YWdlRGV0YWlscy5tZXNzYWdlcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7Z2xvYmFsUm9vdFVybH1wYngtZXh0ZW5zaW9uLW1vZHVsZXMvaW5kZXgvYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBVSSB0byByZWZsZWN0IHRoZSBwcm9ncmVzcyBvZiBhIG1vZHVsZSBkb3dubG9hZC5cbiAgICAgKiBBZGp1c3RzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIGJhc2VkIG9uIHRoZSBkZXRhaWxzIHByb3ZpZGVkIGluIHRoZSBzZXJ2ZXItc2VudCBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbW9kdWxlIGJlaW5nIGRvd25sb2FkZWQuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHN0YWdlRGV0YWlscyAtIERldGFpbGVkIGluZm9ybWF0aW9uIGFib3V0IHRoZSBkb3dubG9hZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld0Rvd25sb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpIHtcbiAgICAgICAgLy8gQ2hlY2sgbW9kdWxlIGRvd25sb2FkIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXMgPT09ICdET1dOTE9BRF9JTl9QUk9HUkVTUycpIHtcbiAgICAgICAgICAgIGNvbnN0IGRvd25sb2FkUHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLnJvdW5kKHBhcnNlSW50KHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzX3Byb2dyZXNzLCAxMCkvMiksIDMpO1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfRG93bmxvYWRJblByb2dyZXNzLCBkb3dubG9hZFByb2dyZXNzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZURldGFpbHMuZF9zdGF0dXMgPT09ICdET1dOTE9BRF9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0Rvd25sb2FkSW5Qcm9ncmVzcywgNTApO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIFVJIHRvIHJlZmxlY3QgdGhlIHByb2dyZXNzIG9mIGEgbW9kdWxlIHVwbG9hZC5cbiAgICAgKiBBZGp1c3RzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIGJhc2VkIG9uIHRoZSBkZXRhaWxzIHByb3ZpZGVkIGluIHRoZSBzZXJ2ZXItc2VudCBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbW9kdWxlIGJlaW5nIHVwbG9hZGVkLlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzdGFnZURldGFpbHMgLSBEZXRhaWxlZCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgdXBsb2FkIHByb2dyZXNzLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZWNlaXZlTmV3VXBsb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpIHtcbiAgICAgICAgLy8gQ2hlY2sgbW9kdWxlIGRvd25sb2FkIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXMgPT09ICdVUExPQURfSU5fUFJPR1JFU1MnKSB7XG4gICAgICAgICAgICBjb25zdCB1cGxvYWRQcm9ncmVzcyA9IE1hdGgubWF4KE1hdGgucm91bmQocGFyc2VJbnQoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXNfcHJvZ3Jlc3MsIDEwKS8yKSwgMyk7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRJblByb2dyZXNzLCB1cGxvYWRQcm9ncmVzcyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2VEZXRhaWxzLmRfc3RhdHVzID09PSAnVVBMT0FEX0NPTVBMRVRFJykge1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcywgNTApO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgdXBkYXRlcyBvbiB0aGUgaW5zdGFsbGF0aW9uIHByb2dyZXNzIG9mIGEgbW9kdWxlLlxuICAgICAqIFVwZGF0ZXMgdGhlIHByb2dyZXNzIGJhciBhbmQgc3RhdHVzIG1lc3NhZ2UgYmFzZWQgb24gdGhlIGluZm9ybWF0aW9uIHJlY2VpdmVkIGluIHRoZSBzZXJ2ZXItc2VudCBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbW9kdWxlIGJlaW5nIGluc3RhbGxlZC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gc3RhZ2VEZXRhaWxzIC0gRGV0YWlsZWQgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGluc3RhbGxhdGlvbiBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld0luc3RhbGxhdGlvblN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKSB7XG4gICAgICAgIC8vIENoZWNrIG1vZHVsZSBpbnN0YWxsYXRpb24gc3RhdHVzXG4gICAgICAgIGlmIChzdGFnZURldGFpbHMuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9JTl9QUk9HUkVTUycpIHtcbiAgICAgICAgICAgIGNvbnN0IGluc3RhbGxhdGlvblByb2dyZXNzID0gTWF0aC5yb3VuZChwYXJzZUludChzdGFnZURldGFpbHMuZGF0YS5pX3N0YXR1c19wcm9ncmVzcywgMTApLzIrNTApO1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcywgaW5zdGFsbGF0aW9uUHJvZ3Jlc3MpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlRGV0YWlscy5kYXRhLmlfc3RhdHVzID09PSAnSU5TVEFMTEFUSU9OX0NPTVBMRVRFJykge1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcywgMTAwKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXNldHMgdGhlIFVJIGVsZW1lbnRzIGFzc29jaWF0ZWQgd2l0aCBhIG1vZHVsZSByb3cgdG8gdGhlaXIgZGVmYXVsdCBzdGF0ZS5cbiAgICAgKiBUaGlzIGlzIHR5cGljYWxseSBjYWxsZWQgYWZ0ZXIgYW4gaW5zdGFsbGF0aW9uIHByb2Nlc3MgY29tcGxldGVzIG9yIGZhaWxzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtqUXVlcnl9ICRyb3cgLSBUaGUgalF1ZXJ5IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJvdyBpbiB0aGUgVUkgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUuXG4gICAgICovXG4gICAgcmVzZXRCdXR0b25WaWV3KCRyb3cpe1xuICAgICAgICAkKCdhLmJ1dHRvbicpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAkcm93LmZpbmQoJ2kubG9hZGluZycpLnJlbW92ZUNsYXNzKCdzcGlubmVyIGxvYWRpbmcnKTtcbiAgICAgICAgJHJvdy5maW5kKCdhLmRvd25sb2FkIGknKS5hZGRDbGFzcygnZG93bmxvYWQnKTtcbiAgICAgICAgJHJvdy5maW5kKCdhLnVwZGF0ZSBpJykuYWRkQ2xhc3MoJ3JlZG8nKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRGlzcGxheXMgYW4gZXJyb3IgbWVzc2FnZSByZWxhdGVkIHRvIG1vZHVsZSBpbnN0YWxsYXRpb24gaW4gdGhlIFVJLlxuICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHdoZW4gYW4gaW5zdGFsbGF0aW9uIGZhaWxzLCBwcm92aWRpbmcgZmVlZGJhY2sgdG8gdGhlIHVzZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJHJvdyAtIFRoZSBqUXVlcnkgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcm93IGluIHRoZSBVSSBhc3NvY2lhdGVkIHdpdGggdGhlIG1vZHVsZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVyIC0gVGhlIGhlYWRlciB0ZXh0IGZvciB0aGUgZXJyb3IgbWVzc2FnZS5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gbWVzc2FnZXMgLSBEZXRhaWxlZCBlcnJvciBtZXNzYWdlcyB0byBiZSBkaXNwbGF5ZWQuXG4gICAgICovXG4gICAgc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGhlYWRlciwgbWVzc2FnZXM9JycpIHtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIucmVzZXRCdXR0b25WaWV3KCRyb3cpO1xuICAgICAgICBpZiAobWVzc2FnZXMubGljZW5zZSE9PXVuZGVmaW5lZCl7XG4gICAgICAgICAgICBjb25zdCBtYW5hZ2VMaW5rID0gYDxicj4ke2dsb2JhbFRyYW5zbGF0ZS5saWNfTWFuYWdlTGljZW5zZX0gPGEgaHJlZj1cIiR7Q29uZmlnLmtleU1hbmFnZW1lbnRVcmx9XCIgdGFyZ2V0PVwiX2JsYW5rXCI+JHtDb25maWcua2V5TWFuYWdlbWVudFNpdGV9PC9hPmA7XG4gICAgICAgICAgICBtZXNzYWdlcy5saWNlbnNlLnB1c2gobWFuYWdlTGluayk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGV4dERlc2NyaXB0aW9uID0gVXNlck1lc3NhZ2UuY29udmVydFRvVGV4dChtZXNzYWdlcyk7XG4gICAgICAgIGNvbnN0IGh0bWxNZXNzYWdlPSAgYDx0ciBjbGFzcz1cInVpIGVycm9yIGNlbnRlciBhbGlnbmVkIHRhYmxlLWVycm9yLW1lc3NhZ2VzXCI+PHRkIGNvbHNwYW49XCI0XCI+PGRpdiBjbGFzcz1cInVpIGhlYWRlclwiPiR7aGVhZGVyfTwvZGl2PjxwPiR7dGV4dERlc2NyaXB0aW9ufTwvcD48L2Rpdj48L3RkPjwvdHI+YDtcbiAgICAgICAgJHJvdy5hZGRDbGFzcygnZXJyb3InKTtcbiAgICAgICAgJHJvdy5iZWZvcmUoaHRtbE1lc3NhZ2UpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIHRvIHJlZmxlY3QgdGhlIGN1cnJlbnQgc3RhdGUgb2YgYSBtb2R1bGUgaW5zdGFsbGF0aW9uIHByb2Nlc3MuXG4gICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRocm91Z2hvdXQgZGlmZmVyZW50IHN0YWdlcyBvZiBpbnN0YWxsYXRpb24gdG8gcHJvdmlkZSByZWFsLXRpbWUgZmVlZGJhY2sgdG8gdGhlIHVzZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIG1vZHVsZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVyIC0gVGhlIHN0YXR1cyBtZXNzYWdlIHRvIGJlIGRpc3BsYXllZCBhYm92ZSB0aGUgcHJvZ3Jlc3MgYmFyLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcGVyY2VudD0wXSAtIFRoZSBjdXJyZW50IHByb2dyZXNzIHBlcmNlbnRhZ2UgdG8gYmUgcmVmbGVjdGVkIGluIHRoZSBwcm9ncmVzcyBiYXIuXG4gICAgICovXG4gICAgdXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGhlYWRlciwgcGVyY2VudD0wKXtcbiAgICAgICAgaWYgKG1vZHVsZVVuaXF1ZUlkID09PSB1bmRlZmluZWQgfHwgbW9kdWxlVW5pcXVlSWQgPT09ICcnKXtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBsZXQgbW9kdWxlTmFtZSA9ICQoYHRyLm5ldy1tb2R1bGUtcm93W2RhdGEtaWQ9JHttb2R1bGVVbmlxdWVJZH1dYCkuZGF0YSgnbmFtZScpO1xuICAgICAgICBpZiAobW9kdWxlTmFtZSA9PT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgIG1vZHVsZU5hbWUgPSAnJztcbiAgICAgICAgfVxuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXJCbG9jay5zaG93KCk7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0Jhci5zaG93KCk7XG4gICAgICAgIGlmIChoZWFkZXIpe1xuICAgICAgICAgICAgY29uc3QgYmFyVGV4dD0gbW9kdWxlTmFtZSsnOiAnK2hlYWRlcjtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoYmFyVGV4dCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBlcmNlbnQ+MCl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXIucHJvZ3Jlc3Moe1xuICAgICAgICAgICAgICAgIHBlcmNlbnQ6IHBlcmNlbnQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbi8vIEluaXRpYWxpemVzIHRoZSBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciBtb2R1bGUgd2hlbiB0aGUgRE9NIGlzIGZ1bGx5IGxvYWRlZC5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pbml0aWFsaXplKCk7XG59KTsiXX0=