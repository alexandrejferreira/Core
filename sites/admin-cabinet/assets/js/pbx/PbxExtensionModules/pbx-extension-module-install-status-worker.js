"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Monitors status of module installation
 *
 */
var installStatusLoopWorker = {
  timeOut: 1000,
  timeOutHandle: '',
  filePath: '',
  iterations: 0,
  oldPercent: '0',
  needEnableAfterInstall: false,
  initialize: function initialize(filePath) {
    var needEnable = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
    installStatusLoopWorker.filePath = filePath;
    installStatusLoopWorker.iterations = 0;
    installStatusLoopWorker.needEnableAfterInstall = needEnable;
    installStatusLoopWorker.restartWorker();
  },
  restartWorker: function restartWorker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    installStatusLoopWorker.worker();
  },
  worker: function worker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    PbxApi.SystemGetModuleInstallationStatus(installStatusLoopWorker.filePath, installStatusLoopWorker.cbAfterReceiveNewStatus);
  },
  cbAfterReceiveNewStatus: function cbAfterReceiveNewStatus(result, response) {
    installStatusLoopWorker.iterations += 1;
    installStatusLoopWorker.timeoutHandle = window.setTimeout(installStatusLoopWorker.worker, installStatusLoopWorker.timeOut); // Check installation status

    if (result === false && installStatusLoopWorker.iterations < 50) {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    } else if (installStatusLoopWorker.iterations > 50 || response.i_status === 'INSTALLATION_ERROR' || response.i_status === 'PROGRESS_FILE_NOT_FOUND') {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
      var errorMessage = response.i_error !== undefined ? response.i_error : '';
      errorMessage = errorMessage.replace(/\n/g, '<br>');
      UserMessage.showMultiString(errorMessage, globalTranslate.ext_InstallationError);
    } else if (response.i_status === 'INSTALLATION_IN_PROGRESS') {
      if (installStatusLoopWorker.oldPercent !== response.i_status_progress) {
        installStatusLoopWorker.iterations = 0;
      }

      installStatusLoopWorker.oldPercent = response.d_status_progress;
    } else if (response.i_status === 'INSTALLATION_COMPLETE') {
      if (installStatusLoopWorker.needEnableAfterInstall) {
        PbxApi.SystemEnableModule(installStatusLoopWorker.moduleUniqid, function () {
          window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
        });
      } else {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }

      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZmlsZVBhdGgiLCJpdGVyYXRpb25zIiwib2xkUGVyY2VudCIsIm5lZWRFbmFibGVBZnRlckluc3RhbGwiLCJpbml0aWFsaXplIiwibmVlZEVuYWJsZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiUGJ4QXBpIiwiU3lzdGVtR2V0TW9kdWxlSW5zdGFsbGF0aW9uU3RhdHVzIiwiY2JBZnRlclJlY2VpdmVOZXdTdGF0dXMiLCJyZXN1bHQiLCJyZXNwb25zZSIsInNldFRpbWVvdXQiLCJpX3N0YXR1cyIsImVycm9yTWVzc2FnZSIsImlfZXJyb3IiLCJ1bmRlZmluZWQiLCJyZXBsYWNlIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfSW5zdGFsbGF0aW9uRXJyb3IiLCJpX3N0YXR1c19wcm9ncmVzcyIsImRfc3RhdHVzX3Byb2dyZXNzIiwiU3lzdGVtRW5hYmxlTW9kdWxlIiwibW9kdWxlVW5pcWlkIiwibG9jYXRpb24iLCJnbG9iYWxSb290VXJsIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUMvQkMsRUFBQUEsT0FBTyxFQUFFLElBRHNCO0FBRS9CQyxFQUFBQSxhQUFhLEVBQUUsRUFGZ0I7QUFHL0JDLEVBQUFBLFFBQVEsRUFBRSxFQUhxQjtBQUkvQkMs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QXJCO0FBQ0EsU0FKRjtBQU1BLE9BUEQsTUFPTztBQUNOeEIsUUFBQUEsTUFBTSxDQUFDdUIsUUFBUCxhQUFxQkMsYUFBckI7QUFDQTs7QUFDRHhCLE1BQUFBLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQlgsdUJBQXVCLENBQUNZLGFBQTVDO0FBQ0E7QUFDRDtBQTFEOEIsQ0FBaEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IChDKSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIFBieEFwaSwgZ2xvYmFsVHJhbnNsYXRlLCBVc2VyTWVzc2FnZSAqL1xuXG4vKipcbiAqIE1vbml0b3JzIHN0YXR1cyBvZiBtb2R1bGUgaW5zdGFsbGF0aW9uXG4gKlxuICovXG5jb25zdCBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciA9IHtcblx0dGltZU91dDogMTAwMCxcblx0dGltZU91dEhhbmRsZTogJycsXG5cdGZpbGVQYXRoOiAnJyxcblx0aXRlcmF0aW9uczogMCxcblx0b2xkUGVyY2VudDogJzAnLFxuXHRuZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsOiBmYWxzZSxcblx0aW5pdGlhbGl6ZShmaWxlUGF0aCwgbmVlZEVuYWJsZT1mYWxzZSkge1xuXHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmZpbGVQYXRoID0gZmlsZVBhdGg7XG5cdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA9IDA7XG5cdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIubmVlZEVuYWJsZUFmdGVySW5zdGFsbCA9IG5lZWRFbmFibGU7XG5cdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuXHR9LFxuXHRyZXN0YXJ0V29ya2VyKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIud29ya2VyKCk7XG5cdH0sXG5cdHdvcmtlcigpIHtcblx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdFBieEFwaS5TeXN0ZW1HZXRNb2R1bGVJbnN0YWxsYXRpb25TdGF0dXMoXG5cdFx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5maWxlUGF0aCxcblx0XHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmNiQWZ0ZXJSZWNlaXZlTmV3U3RhdHVzXG5cdFx0KTtcblx0fSxcblx0Y2JBZnRlclJlY2VpdmVOZXdTdGF0dXMocmVzdWx0LCByZXNwb25zZSkge1xuXHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgKz0gMTtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlID1cblx0XHRcdHdpbmRvdy5zZXRUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLndvcmtlciwgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZU91dCk7XG5cdFx0Ly8gQ2hlY2sgaW5zdGFsbGF0aW9uIHN0YXR1c1xuXHRcdGlmIChyZXN1bHQgPT09IGZhbHNlXG5cdFx0XHQmJiBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zIDwgNTApIHtcblx0XHRcdHdpbmRvdy5jbGVhclRpbWVvdXQoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0fSBlbHNlIGlmIChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID4gNTBcblx0XHRcdHx8IHJlc3BvbnNlLmlfc3RhdHVzID09PSAnSU5TVEFMTEFUSU9OX0VSUk9SJ1xuXHRcdFx0fHwgcmVzcG9uc2UuaV9zdGF0dXMgPT09ICdQUk9HUkVTU19GSUxFX05PVF9GT1VORCdcblx0XHQpIHtcblx0XHRcdHdpbmRvdy5jbGVhclRpbWVvdXQoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0XHRsZXQgZXJyb3JNZXNzYWdlID0gKHJlc3BvbnNlLmlfZXJyb3IgIT09IHVuZGVmaW5lZCkgPyByZXNwb25zZS5pX2Vycm9yIDogJyc7XG5cdFx0XHRlcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2UucmVwbGFjZSgvXFxuL2csICc8YnI+Jyk7XG5cdFx0XHRVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoZXJyb3JNZXNzYWdlLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkVycm9yKTtcblx0XHR9IGVsc2UgaWYgKHJlc3BvbnNlLmlfc3RhdHVzID09PSAnSU5TVEFMTEFUSU9OX0lOX1BST0dSRVNTJykge1xuXHRcdFx0aWYgKGluc3RhbGxTdGF0dXNMb29wV29ya2VyLm9sZFBlcmNlbnQgIT09IHJlc3BvbnNlLmlfc3RhdHVzX3Byb2dyZXNzKSB7XG5cdFx0XHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPSAwO1xuXHRcdFx0fVxuXHRcdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIub2xkUGVyY2VudCA9IHJlc3BvbnNlLmRfc3RhdHVzX3Byb2dyZXNzO1xuXHRcdH0gZWxzZSBpZiAocmVzcG9uc2UuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fQ09NUExFVEUnKSB7XG5cdFx0XHRpZiAoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIubmVlZEVuYWJsZUFmdGVySW5zdGFsbCkge1xuXHRcdFx0XHRQYnhBcGkuU3lzdGVtRW5hYmxlTW9kdWxlKFxuXHRcdFx0XHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLm1vZHVsZVVuaXFpZCxcblx0XHRcdFx0XHQoKSA9PiB7XG5cdFx0XHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfXBieC1leHRlbnNpb24tbW9kdWxlcy9pbmRleC9gO1xuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdCk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfXBieC1leHRlbnNpb24tbW9kdWxlcy9pbmRleC9gO1xuXHRcdFx0fVxuXHRcdFx0d2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHR9XG5cdH0sXG59O1xuIl19