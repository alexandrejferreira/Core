"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Handles real-time monitoring and updates of module installation statuses.
 * Utilizes server-sent events to receive updates and reflects these changes in the UI,
 * particularly in the progress bar and status messages displayed to the user.
 *
 * @module installStatusLoopWorker
 */
var installStatusLoopWorker = {
  /**
   * The jQuery object representing the progress bar element in the DOM.
   * Used to visually indicate the progress of module installation or updates.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * The jQuery object for the container of the progress bar.
   * This element is shown and hidden based on the presence of active installation or update processes.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * The jQuery object for the label element associated with the progress bar.
   * Used to display textual information about the current stage of the installation or update process.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * The EventSource object used for receiving real-time updates from the server about module installation statuses.
   * This allows for a push-based mechanism to keep the UI updated with the latest progress information.
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * The identifier for the PUB/SUB channel used to subscribe to installation status updates.
   * This ensures that the client is listening on the correct channel for relevant events.
   */
  channelId: 'install-module',

  /**
   * Initializes the installStatusLoopWorker module by setting up the connection to receive server-sent events.
   */
  initialize: function initialize() {
    installStatusLoopWorker.startListenPushNotifications();
  },

  /**
   * Establishes a connection to the server to start receiving real-time updates on module installation progress.
   * Utilizes the EventSource API to listen for messages on a specified channel.
   */
  startListenPushNotifications: function startListenPushNotifications() {
    var lastEventIdKey = "lastEventId";
    var lastEventId = localStorage.getItem(lastEventIdKey);
    var subPath = lastEventId ? "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId, "?last_event_id=").concat(lastEventId) : "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId);
    installStatusLoopWorker.eventSource = new EventSource(subPath);
    installStatusLoopWorker.eventSource.addEventListener('message', function (e) {
      var response = JSON.parse(e.data);
      installStatusLoopWorker.processModuleInstallation(response);
      console.debug(response);
      localStorage.setItem(lastEventIdKey, e.lastEventId);
    });
  },

  /**
   * Processes incoming server-sent events related to module installation.
   * Updates the UI based on the current stage of installation, download, upload, or error states.
   *
   * @param {Object} response - The data payload of the server-sent event, containing details about the installation stage and progress.
   */
  processModuleInstallation: function processModuleInstallation(response) {
    var moduleUniqueId = response.moduleUniqueId;
    var stage = response.stage;
    var stageDetails = response.stageDetails;
    var $row = $("tr[data-id=".concat(moduleUniqueId, "]"));

    if (stage === 'Stage_I_GetRelease') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_GetReleaseInProgress, 1);
    } else if (stage === 'Stage_II_CheckLicense') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 2);
    } else if (stage === 'Stage_III_GetDownloadLink') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 3);
    } else if (stage === 'Stage_IV_DownloadModule') {
      installStatusLoopWorker.cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_I_UploadModule') {
      installStatusLoopWorker.cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_V_InstallModule') {
      installStatusLoopWorker.cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_VI_EnableModule') {} else if (stage === 'Stage_VII_FinalStatus') {
      if (stageDetails.result === false) {
        installStatusLoopWorker.$progressBarBlock.hide();

        if (stageDetails.messages !== undefined) {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError, stageDetails.messages);
        } else {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError);
        }
      } else {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }
    }
  },

  /**
   * Updates the UI to reflect the progress of a module download.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being downloaded.
   * @param {Object} stageDetails - Detailed information about the download progress.
   */
  cbAfterReceiveNewDownloadStatus: function cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'DOWNLOAD_IN_PROGRESS') {
      var downloadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, downloadProgress);
    } else if (stageDetails.d_status === 'DOWNLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, 50);
    }
  },

  /**
   * Updates the UI to reflect the progress of a module upload.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being uploaded.
   * @param {Object} stageDetails - Detailed information about the upload progress.
   */
  cbAfterReceiveNewUploadStatus: function cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'UPLOAD_IN_PROGRESS') {
      var uploadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, uploadProgress);
    } else if (stageDetails.d_status === 'UPLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, 50);
    }
  },

  /**
   * Handles updates on the installation progress of a module.
   * Updates the progress bar and status message based on the information received in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being installed.
   * @param {Object} stageDetails - Detailed information about the installation progress.
   */
  cbAfterReceiveNewInstallationStatus: function cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails) {
    // Check module installation status
    if (stageDetails.data.i_status === 'INSTALLATION_IN_PROGRESS') {
      var installationProgress = Math.round(parseInt(stageDetails.data.i_status_progress, 10) / 2 + 50);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, installationProgress);
    } else if (stageDetails.data.i_status === 'INSTALLATION_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, 100);
    }
  },

  /**
   * Resets the UI elements associated with a module row to their default state.
   * This is typically called after an installation process completes or fails.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   */
  resetButtonView: function resetButtonView($row) {
    $('a.button').removeClass('disabled');
    $row.find('i.loading').removeClass('spinner loading');
    $row.find('a.download i').addClass('download');
    $row.find('a.update i').addClass('redo');
  },

  /**
   * Displays an error message related to module installation in the UI.
   * This function is called when an installation fails, providing feedback to the user.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   * @param {string} header - The header text for the error message.
   * @param {Object} messages - Detailed error messages to be displayed.
   */
  showModuleInstallationError: function showModuleInstallationError($row, header) {
    var messages = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';
    installStatusLoopWorker.resetButtonView($row);

    if (messages.license !== undefined) {
      var manageLink = "<br>".concat(globalTranslate.lic_ManageLicense, " <a href=\"").concat(Config.keyManagementUrl, "\" target=\"_blank\">").concat(Config.keyManagementSite, "</a>");
      messages.license.push(manageLink);
    }

    var textDescription = UserMessage.convertToText(messages);
    var htmlMessage = "<tr class=\"ui error center aligned table-error-messages\"><td colspan=\"4\"><div class=\"ui header\">".concat(header, "</div><p>").concat(textDescription, "</p></div></td></tr>");
    $row.addClass('error');
    $row.before(htmlMessage);
  },

  /**
   * Updates the progress bar and status message to reflect the current state of a module installation process.
   * This function is used throughout different stages of installation to provide real-time feedback to the user.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module.
   * @param {string} header - The status message to be displayed above the progress bar.
   * @param {number} [percent=0] - The current progress percentage to be reflected in the progress bar.
   */
  updateProgressBar: function updateProgressBar(moduleUniqueId, header) {
    var percent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

    if (moduleUniqueId === undefined || moduleUniqueId === '') {
      return;
    }

    var moduleName = $("tr.new-module-row[data-id=".concat(moduleUniqueId, "]")).data('name');

    if (moduleName === undefined) {
      moduleName = '';
    }

    installStatusLoopWorker.$progressBarBlock.show();
    installStatusLoopWorker.$progressBar.show();

    if (header) {
      var barText = moduleName + ': ' + header;
      installStatusLoopWorker.$progressBarLabel.text(barText);
    }

    if (percent > 0) {
      installStatusLoopWorker.$progressBar.progress({
        percent: percent
      });
    }
  }
}; // Initializes the installStatusLoopWorker module when the DOM is fully loaded.

$(document).ready(function () {
  installStatusLoopWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsIiRwcm9ncmVzc0JhciIsIiQiLCIkcHJvZ3Jlc3NCYXJCbG9jayIsIiRwcm9ncmVzc0JhckxhYmVsIiwiZXZlbnRTb3VyY2UiLCJjaGFubmVsSWQiLCJpbml0aWFsaXplIiwic3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucyIsImxhc3RFdmVudElkS2V5IiwibGFzdEV2ZW50SWQiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwic3ViUGF0aCIsIkV2ZW50U291cmNlIiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCJyZXNwb25zZSIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJwcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uIiwiY29uc29sZSIsImRlYnVnIiwic2V0SXRlbSIsIm1vZHVsZVVuaXF1ZUlkIiwic3RhZ2UiLCJzdGFnZURldGFpbHMiLCIkcm93IiwidXBkYXRlUHJvZ3Jlc3NCYXIiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfR2V0UmVsZWFzZUluUHJvZ3Jlc3MiLCJleHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcyIsImNiQWZ0ZXJSZWNlaXZlTmV3RG93bmxvYWRTdGF0dXMiLCJjYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyIsImNiQWZ0ZXJSZWNlaXZlTmV3SW5zdGFsbGF0aW9uU3RhdHVzIiwicmVzdWx0IiwiaGlkZSIsIm1lc3NhZ2VzIiwidW5kZWZpbmVkIiwic2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yIiwiZXh0X0luc3RhbGxhdGlvbkVycm9yIiwid2luZG93IiwibG9jYXRpb24iLCJnbG9iYWxSb290VXJsIiwiZF9zdGF0dXMiLCJkb3dubG9hZFByb2dyZXNzIiwiTWF0aCIsIm1heCIsInJvdW5kIiwicGFyc2VJbnQiLCJkX3N0YXR1c19wcm9ncmVzcyIsImV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MiLCJ1cGxvYWRQcm9ncmVzcyIsImV4dF9VcGxvYWRJblByb2dyZXNzIiwiaV9zdGF0dXMiLCJpbnN0YWxsYXRpb25Qcm9ncmVzcyIsImlfc3RhdHVzX3Byb2dyZXNzIiwiZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MiLCJyZXNldEJ1dHRvblZpZXciLCJyZW1vdmVDbGFzcyIsImZpbmQiLCJhZGRDbGFzcyIsImhlYWRlciIsImxpY2Vuc2UiLCJtYW5hZ2VMaW5rIiwibGljX01hbmFnZUxpY2Vuc2UiLCJDb25maWciLCJrZXlNYW5hZ2VtZW50VXJsIiwia2V5TWFuYWdlbWVudFNpdGUiLCJwdXNoIiwidGV4dERlc2NyaXB0aW9uIiwiVXNlck1lc3NhZ2UiLCJjb252ZXJ0VG9UZXh0IiwiaHRtbE1lc3NhZ2UiLCJiZWZvcmUiLCJwZXJjZW50IiwibW9kdWxlTmFtZSIsInNob3ciLCJiYXJUZXh0IiwidGV4dCIsInByb2dyZXNzIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsdUJBQXVCLEdBQUc7QUFDNUI7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxZQUFZLEVBQUVDLENBQUMsQ0FBQyxzQkFBRCxDQU5hOztBQVE1QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGlCQUFpQixFQUFFRCxDQUFDLENBQUMsNEJBQUQsQ0FiUTs7QUFlNUI7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJRSxFQUFBQSxpQkFBaUIsRUFBRUYsQ0FBQyxDQUFDLDRCQUFELENBcEJROztBQXNCNUI7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJRyxFQUFBQSxXQUFXLEVBQUUs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QUNELFFBQUlILE9BQU8sR0FBQyxDQUFaLEVBQWM7QUFDVjVFLE1BQUFBLHVCQUF1QixDQUFDQyxZQUF4QixDQUFxQ2dGLFFBQXJDLENBQThDO0FBQzFDTCxRQUFBQSxPQUFPLEVBQUVBO0FBRGlDLE9BQTlDO0FBR0g7QUFDSjtBQWxOMkIsQ0FBaEMsQyxDQXFOQTs7QUFDQTFFLENBQUMsQ0FBQ2dGLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDcEJuRixFQUFBQSx1QkFBdUIsQ0FBQ08sVUFBeEI7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIFBieEFwaSwgZ2xvYmFsVHJhbnNsYXRlLCBVc2VyTWVzc2FnZSAqL1xuXG4vKipcbiAqIEhhbmRsZXMgcmVhbC10aW1lIG1vbml0b3JpbmcgYW5kIHVwZGF0ZXMgb2YgbW9kdWxlIGluc3RhbGxhdGlvbiBzdGF0dXNlcy5cbiAqIFV0aWxpemVzIHNlcnZlci1zZW50IGV2ZW50cyB0byByZWNlaXZlIHVwZGF0ZXMgYW5kIHJlZmxlY3RzIHRoZXNlIGNoYW5nZXMgaW4gdGhlIFVJLFxuICogcGFydGljdWxhcmx5IGluIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlcyBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIuXG4gKlxuICogQG1vZHVsZSBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlclxuICovXG5jb25zdCBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciA9IHtcbiAgICAvKipcbiAgICAgKiBUaGUgalF1ZXJ5IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHByb2dyZXNzIGJhciBlbGVtZW50IGluIHRoZSBET00uXG4gICAgICogVXNlZCB0byB2aXN1YWxseSBpbmRpY2F0ZSB0aGUgcHJvZ3Jlc3Mgb2YgbW9kdWxlIGluc3RhbGxhdGlvbiBvciB1cGRhdGVzLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhcicpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBjb250YWluZXIgb2YgdGhlIHByb2dyZXNzIGJhci5cbiAgICAgKiBUaGlzIGVsZW1lbnQgaXMgc2hvd24gYW5kIGhpZGRlbiBiYXNlZCBvbiB0aGUgcHJlc2VuY2Ugb2YgYWN0aXZlIGluc3RhbGxhdGlvbiBvciB1cGRhdGUgcHJvY2Vzc2VzLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyQmxvY2s6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyLWJsb2NrJyksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGxhYmVsIGVsZW1lbnQgYXNzb2NpYXRlZCB3aXRoIHRoZSBwcm9ncmVzcyBiYXIuXG4gICAgICogVXNlZCB0byBkaXNwbGF5IHRleHR1YWwgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGN1cnJlbnQgc3RhZ2Ugb2YgdGhlIGluc3RhbGxhdGlvbiBvciB1cGRhdGUgcHJvY2Vzcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhckxhYmVsOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhci1sYWJlbCcpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIEV2ZW50U291cmNlIG9iamVjdCB1c2VkIGZvciByZWNlaXZpbmcgcmVhbC10aW1lIHVwZGF0ZXMgZnJvbSB0aGUgc2VydmVyIGFib3V0IG1vZHVsZSBpbnN0YWxsYXRpb24gc3RhdHVzZXMuXG4gICAgICogVGhpcyBhbGxvd3MgZm9yIGEgcHVzaC1iYXNlZCBtZWNoYW5pc20gdG8ga2VlcCB0aGUgVUkgdXBkYXRlZCB3aXRoIHRoZSBsYXRlc3QgcHJvZ3Jlc3MgaW5mb3JtYXRpb24uXG4gICAgICogQHR5cGUge0V2ZW50U291cmNlfVxuICAgICAqL1xuICAgIGV2ZW50U291cmNlOiBudWxsLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkZW50aWZpZXIgZm9yIHRoZSBQVUIvU1VCIGNoYW5uZWwgdXNlZCB0byBzdWJzY3JpYmUgdG8gaW5zdGFsbGF0aW9uIHN0YXR1cyB1cGRhdGVzLlxuICAgICAqIFRoaXMgZW5zdXJlcyB0aGF0IHRoZSBjbGllbnQgaXMgbGlzdGVuaW5nIG9uIHRoZSBjb3JyZWN0IGNoYW5uZWwgZm9yIHJlbGV2YW50IGV2ZW50cy5cbiAgICAgKi9cbiAgICBjaGFubmVsSWQ6ICdpbnN0YWxsLW1vZHVsZScsXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgbW9kdWxlIGJ5IHNldHRpbmcgdXAgdGhlIGNvbm5lY3Rpb24gdG8gcmVjZWl2ZSBzZXJ2ZXItc2VudCBldmVudHMuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpe1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5zdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEVzdGFibGlzaGVzIGEgY29ubmVjdGlvbiB0byB0aGUgc2VydmVyIHRvIHN0YXJ0IHJlY2VpdmluZyByZWFsLXRpbWUgdXBkYXRlcyBvbiBtb2R1bGUgaW5zdGFsbGF0aW9uIHByb2dyZXNzLlxuICAgICAqIFV0aWxpemVzIHRoZSBFdmVudFNvdXJjZSBBUEkgdG8gbGlzdGVuIGZvciBtZXNzYWdlcyBvbiBhIHNwZWNpZmllZCBjaGFubmVsLlxuICAgICAqL1xuICAgIHN0YXJ0TGlzdGVuUHVzaE5vdGlmaWNhdGlvbnMoKSB7XG4gICAgICAgIGNvbnN0IGxhc3RFdmVudElkS2V5ID0gYGxhc3RFdmVudElkYDtcbiAgICAgICAgbGV0IGxhc3RFdmVudElkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0obGFzdEV2ZW50SWRLZXkpO1xuICAgICAgICBjb25zdCBzdWJQYXRoID0gbGFzdEV2ZW50SWQgPyBgL3BieGNvcmUvYXBpL25jaGFuL3N1Yi8ke2luc3RhbGxTdGF0dXNMb29wV29ya2VyLmNoYW5uZWxJZH0/bGFzdF9ldmVudF9pZD0ke2xhc3RFdmVudElkfWAgOiBgL3BieGNvcmUvYXBpL25jaGFuL3N1Yi8ke2luc3RhbGxTdGF0dXNMb29wV29ya2VyLmNoYW5uZWxJZH1gO1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5ldmVudFNvdXJjZSA9IG5ldyBFdmVudFNvdXJjZShzdWJQYXRoKTtcblxuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5ldmVudFNvdXJjZS5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZSA9PiB7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IEpTT04ucGFyc2UoZS5kYXRhKTtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnByb2Nlc3NNb2R1bGVJbnN0YWxsYXRpb24ocmVzcG9uc2UpO1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhyZXNwb25zZSk7XG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShsYXN0RXZlbnRJZEtleSwgZS5sYXN0RXZlbnRJZCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBQcm9jZXNzZXMgaW5jb21pbmcgc2VydmVyLXNlbnQgZXZlbnRzIHJlbGF0ZWQgdG8gbW9kdWxlIGluc3RhbGxhdGlvbi5cbiAgICAgKiBVcGRhdGVzIHRoZSBVSSBiYXNlZCBvbiB0aGUgY3VycmVudCBzdGFnZSBvZiBpbnN0YWxsYXRpb24sIGRvd25sb2FkLCB1cGxvYWQsIG9yIGVycm9yIHN0YXRlcy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSAtIFRoZSBkYXRhIHBheWxvYWQgb2YgdGhlIHNlcnZlci1zZW50IGV2ZW50LCBjb250YWluaW5nIGRldGFpbHMgYWJvdXQgdGhlIGluc3RhbGxhdGlvbiBzdGFnZSBhbmQgcHJvZ3Jlc3MuXG4gICAgICovXG4gICAgcHJvY2Vzc01vZHVsZUluc3RhbGxhdGlvbihyZXNwb25zZSl7XG4gICAgICAgIGNvbnN0IG1vZHVsZVVuaXF1ZUlkID0gcmVzcG9uc2UubW9kdWxlVW5pcXVlSWQ7XG4gICAgICAgIGNvbnN0IHN0YWdlID0gcmVzcG9uc2Uuc3RhZ2U7XG4gICAgICAgIGNvbnN0IHN0YWdlRGV0YWlscyA9IHJlc3BvbnNlLnN0YWdlRGV0YWlscztcbiAgICAgICAgY29uc3QgJHJvdyA9ICQoYHRyW2RhdGEtaWQ9JHttb2R1bGVVbmlxdWVJZH1dYCk7XG4gICAgICAgIGlmIChzdGFnZSA9PT0nU3RhZ2VfSV9HZXRSZWxlYXNlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9HZXRSZWxlYXNlSW5Qcm9ncmVzcywgMSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9JSV9DaGVja0xpY2Vuc2UnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0NoZWNrTGljZW5zZUluUHJvZ3Jlc3MsIDIpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfSUlJX0dldERvd25sb2FkTGluaycpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcywgMyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9JVl9Eb3dubG9hZE1vZHVsZScpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2JBZnRlclJlY2VpdmVOZXdEb3dubG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lfVXBsb2FkTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX1ZfSW5zdGFsbE1vZHVsZScpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2JBZnRlclJlY2VpdmVOZXdJbnN0YWxsYXRpb25TdGF0dXMobW9kdWxlVW5pcXVlSWQsIHN0YWdlRGV0YWlscyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9WSV9FbmFibGVNb2R1bGUnKXtcblxuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfVklJX0ZpbmFsU3RhdHVzJyl7XG4gICAgICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLnJlc3VsdD09PWZhbHNlKXtcbiAgICAgICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXJCbG9jay5oaWRlKCk7XG4gICAgICAgICAgICAgICAgaWYgKHN0YWdlRGV0YWlscy5tZXNzYWdlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnNob3dNb2R1bGVJbnN0YWxsYXRpb25FcnJvcigkcm93LCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkVycm9yLCBzdGFnZURldGFpbHMubWVzc2FnZXMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnNob3dNb2R1bGVJbnN0YWxsYXRpb25FcnJvcigkcm93LCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkVycm9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9cGJ4LWV4dGVuc2lvbi1tb2R1bGVzL2luZGV4L2A7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgVUkgdG8gcmVmbGVjdCB0aGUgcHJvZ3Jlc3Mgb2YgYSBtb2R1bGUgZG93bmxvYWQuXG4gICAgICogQWRqdXN0cyB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZSBiYXNlZCBvbiB0aGUgZGV0YWlscyBwcm92aWRlZCBpbiB0aGUgc2VydmVyLXNlbnQgZXZlbnQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIG1vZHVsZSBiZWluZyBkb3dubG9hZGVkLlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzdGFnZURldGFpbHMgLSBEZXRhaWxlZCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgZG93bmxvYWQgcHJvZ3Jlc3MuXG4gICAgICovXG4gICAgY2JBZnRlclJlY2VpdmVOZXdEb3dubG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKSB7XG4gICAgICAgIC8vIENoZWNrIG1vZHVsZSBkb3dubG9hZCBzdGF0dXNcbiAgICAgICAgaWYgKHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzID09PSAnRE9XTkxPQURfSU5fUFJPR1JFU1MnKSB7XG4gICAgICAgICAgICBjb25zdCBkb3dubG9hZFByb2dyZXNzID0gTWF0aC5tYXgoTWF0aC5yb3VuZChwYXJzZUludChzdGFnZURldGFpbHMuZGF0YS5kX3N0YXR1c19wcm9ncmVzcywgMTApLzIpLCAzKTtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0Rvd25sb2FkSW5Qcm9ncmVzcywgZG93bmxvYWRQcm9ncmVzcyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2VEZXRhaWxzLmRfc3RhdHVzID09PSAnRE9XTkxPQURfQ09NUExFVEUnKSB7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MsIDUwKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBVSSB0byByZWZsZWN0IHRoZSBwcm9ncmVzcyBvZiBhIG1vZHVsZSB1cGxvYWQuXG4gICAgICogQWRqdXN0cyB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZSBiYXNlZCBvbiB0aGUgZGV0YWlscyBwcm92aWRlZCBpbiB0aGUgc2VydmVyLXNlbnQgZXZlbnQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIG1vZHVsZSBiZWluZyB1cGxvYWRlZC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gc3RhZ2VEZXRhaWxzIC0gRGV0YWlsZWQgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHVwbG9hZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKSB7XG4gICAgICAgIC8vIENoZWNrIG1vZHVsZSBkb3dubG9hZCBzdGF0dXNcbiAgICAgICAgaWYgKHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzID09PSAnVVBMT0FEX0lOX1BST0dSRVNTJykge1xuICAgICAgICAgICAgY29uc3QgdXBsb2FkUHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLnJvdW5kKHBhcnNlSW50KHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzX3Byb2dyZXNzLCAxMCkvMiksIDMpO1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcywgdXBsb2FkUHJvZ3Jlc3MpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlRGV0YWlscy5kX3N0YXR1cyA9PT0gJ1VQTE9BRF9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEluUHJvZ3Jlc3MsIDUwKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIHVwZGF0ZXMgb24gdGhlIGluc3RhbGxhdGlvbiBwcm9ncmVzcyBvZiBhIG1vZHVsZS5cbiAgICAgKiBVcGRhdGVzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIGJhc2VkIG9uIHRoZSBpbmZvcm1hdGlvbiByZWNlaXZlZCBpbiB0aGUgc2VydmVyLXNlbnQgZXZlbnQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIG1vZHVsZSBiZWluZyBpbnN0YWxsZWQuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHN0YWdlRGV0YWlscyAtIERldGFpbGVkIGluZm9ybWF0aW9uIGFib3V0IHRoZSBpbnN0YWxsYXRpb24gcHJvZ3Jlc3MuXG4gICAgICovXG4gICAgY2JBZnRlclJlY2VpdmVOZXdJbnN0YWxsYXRpb25TdGF0dXMobW9kdWxlVW5pcXVlSWQsIHN0YWdlRGV0YWlscykge1xuICAgICAgICAvLyBDaGVjayBtb2R1bGUgaW5zdGFsbGF0aW9uIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fSU5fUFJPR1JFU1MnKSB7XG4gICAgICAgICAgICBjb25zdCBpbnN0YWxsYXRpb25Qcm9ncmVzcyA9IE1hdGgucm91bmQocGFyc2VJbnQoc3RhZ2VEZXRhaWxzLmRhdGEuaV9zdGF0dXNfcHJvZ3Jlc3MsIDEwKS8yKzUwKTtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MsIGluc3RhbGxhdGlvblByb2dyZXNzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZURldGFpbHMuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MsIDEwMCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVzZXRzIHRoZSBVSSBlbGVtZW50cyBhc3NvY2lhdGVkIHdpdGggYSBtb2R1bGUgcm93IHRvIHRoZWlyIGRlZmF1bHQgc3RhdGUuXG4gICAgICogVGhpcyBpcyB0eXBpY2FsbHkgY2FsbGVkIGFmdGVyIGFuIGluc3RhbGxhdGlvbiBwcm9jZXNzIGNvbXBsZXRlcyBvciBmYWlscy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkcm93IC0gVGhlIGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByb3cgaW4gdGhlIFVJIGFzc29jaWF0ZWQgd2l0aCB0aGUgbW9kdWxlLlxuICAgICAqL1xuICAgIHJlc2V0QnV0dG9uVmlldygkcm93KXtcbiAgICAgICAgJCgnYS5idXR0b24nKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgJHJvdy5maW5kKCdpLmxvYWRpbmcnKS5yZW1vdmVDbGFzcygnc3Bpbm5lciBsb2FkaW5nJyk7XG4gICAgICAgICRyb3cuZmluZCgnYS5kb3dubG9hZCBpJykuYWRkQ2xhc3MoJ2Rvd25sb2FkJyk7XG4gICAgICAgICRyb3cuZmluZCgnYS51cGRhdGUgaScpLmFkZENsYXNzKCdyZWRvJyk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIERpc3BsYXlzIGFuIGVycm9yIG1lc3NhZ2UgcmVsYXRlZCB0byBtb2R1bGUgaW5zdGFsbGF0aW9uIGluIHRoZSBVSS5cbiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aGVuIGFuIGluc3RhbGxhdGlvbiBmYWlscywgcHJvdmlkaW5nIGZlZWRiYWNrIHRvIHRoZSB1c2VyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtqUXVlcnl9ICRyb3cgLSBUaGUgalF1ZXJ5IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJvdyBpbiB0aGUgVUkgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhlYWRlciAtIFRoZSBoZWFkZXIgdGV4dCBmb3IgdGhlIGVycm9yIG1lc3NhZ2UuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IG1lc3NhZ2VzIC0gRGV0YWlsZWQgZXJyb3IgbWVzc2FnZXMgdG8gYmUgZGlzcGxheWVkLlxuICAgICAqL1xuICAgIHNob3dNb2R1bGVJbnN0YWxsYXRpb25FcnJvcigkcm93LCBoZWFkZXIsIG1lc3NhZ2VzPScnKSB7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnJlc2V0QnV0dG9uVmlldygkcm93KTtcbiAgICAgICAgaWYgKG1lc3NhZ2VzLmxpY2Vuc2UhPT11bmRlZmluZWQpe1xuICAgICAgICAgICAgY29uc3QgbWFuYWdlTGluayA9IGA8YnI+JHtnbG9iYWxUcmFuc2xhdGUubGljX01hbmFnZUxpY2Vuc2V9IDxhIGhyZWY9XCIke0NvbmZpZy5rZXlNYW5hZ2VtZW50VXJsfVwiIHRhcmdldD1cIl9ibGFua1wiPiR7Q29uZmlnLmtleU1hbmFnZW1lbnRTaXRlfTwvYT5gO1xuICAgICAgICAgICAgbWVzc2FnZXMubGljZW5zZS5wdXNoKG1hbmFnZUxpbmspO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRleHREZXNjcmlwdGlvbiA9IFVzZXJNZXNzYWdlLmNvbnZlcnRUb1RleHQobWVzc2FnZXMpO1xuICAgICAgICBjb25zdCBodG1sTWVzc2FnZT0gIGA8dHIgY2xhc3M9XCJ1aSBlcnJvciBjZW50ZXIgYWxpZ25lZCB0YWJsZS1lcnJvci1tZXNzYWdlc1wiPjx0ZCBjb2xzcGFuPVwiNFwiPjxkaXYgY2xhc3M9XCJ1aSBoZWFkZXJcIj4ke2hlYWRlcn08L2Rpdj48cD4ke3RleHREZXNjcmlwdGlvbn08L3A+PC9kaXY+PC90ZD48L3RyPmA7XG4gICAgICAgICRyb3cuYWRkQ2xhc3MoJ2Vycm9yJyk7XG4gICAgICAgICRyb3cuYmVmb3JlKGh0bWxNZXNzYWdlKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZSB0byByZWZsZWN0IHRoZSBjdXJyZW50IHN0YXRlIG9mIGEgbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9jZXNzLlxuICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0aHJvdWdob3V0IGRpZmZlcmVudCBzdGFnZXMgb2YgaW5zdGFsbGF0aW9uIHRvIHByb3ZpZGUgcmVhbC10aW1lIGZlZWRiYWNrIHRvIHRoZSB1c2VyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZVVuaXF1ZUlkIC0gVGhlIHVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBtb2R1bGUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhlYWRlciAtIFRoZSBzdGF0dXMgbWVzc2FnZSB0byBiZSBkaXNwbGF5ZWQgYWJvdmUgdGhlIHByb2dyZXNzIGJhci5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3BlcmNlbnQ9MF0gLSBUaGUgY3VycmVudCBwcm9ncmVzcyBwZXJjZW50YWdlIHRvIGJlIHJlZmxlY3RlZCBpbiB0aGUgcHJvZ3Jlc3MgYmFyLlxuICAgICAqL1xuICAgIHVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBoZWFkZXIsIHBlcmNlbnQ9MCl7XG4gICAgICAgIGlmIChtb2R1bGVVbmlxdWVJZCA9PT0gdW5kZWZpbmVkIHx8IG1vZHVsZVVuaXF1ZUlkID09PSAnJyl7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG1vZHVsZU5hbWUgPSAkKGB0ci5uZXctbW9kdWxlLXJvd1tkYXRhLWlkPSR7bW9kdWxlVW5pcXVlSWR9XWApLmRhdGEoJ25hbWUnKTtcbiAgICAgICAgaWYgKG1vZHVsZU5hbWUgPT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICBtb2R1bGVOYW1lID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuJHByb2dyZXNzQmFyQmxvY2suc2hvdygpO1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXIuc2hvdygpO1xuICAgICAgICBpZiAoaGVhZGVyKXtcbiAgICAgICAgICAgIGNvbnN0IGJhclRleHQ9IG1vZHVsZU5hbWUrJzogJytoZWFkZXI7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGJhclRleHQpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwZXJjZW50PjApe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuJHByb2dyZXNzQmFyLnByb2dyZXNzKHtcbiAgICAgICAgICAgICAgICBwZXJjZW50OiBwZXJjZW50LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG4vLyBJbml0aWFsaXplcyB0aGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgbW9kdWxlIHdoZW4gdGhlIERPTSBpcyBmdWxseSBsb2FkZWQuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaW5pdGlhbGl6ZSgpO1xufSk7Il19