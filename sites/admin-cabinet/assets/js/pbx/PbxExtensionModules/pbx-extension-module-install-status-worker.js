"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Monitors status of module installation
 *
 */
var installStatusLoopWorker = {
  timeOut: 1000,
  timeOutHandle: '',
  filePath: '',
  iterations: 0,
  oldPercent: '0',
  needEnableAfterInstall: false,
  initialize: function initialize(filePath) {
    var needEnable = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
    installStatusLoopWorker.filePath = filePath;
    installStatusLoopWorker.iterations = 0;
    installStatusLoopWorker.needEnableAfterInstall = needEnable;
    installStatusLoopWorker.restartWorker();
  },
  restartWorker: function restartWorker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    installStatusLoopWorker.worker();
  },
  worker: function worker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    PbxApi.SystemGetModuleInstallationStatus(installStatusLoopWorker.filePath, installStatusLoopWorker.cbAfterReceiveNewStatus);
  },
  cbAfterReceiveNewStatus: function cbAfterReceiveNewStatus(result, response) {
    installStatusLoopWorker.iterations += 1;
    installStatusLoopWorker.timeoutHandle = window.setTimeout(installStatusLoopWorker.worker, installStatusLoopWorker.timeOut);
    // Check installation status
    if (result === false && installStatusLoopWorker.iterations < 50) {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    } else if (installStatusLoopWorker.iterations > 50 || response.i_status === 'INSTALLATION_ERROR' || response.i_status === 'PROGRESS_FILE_NOT_FOUND') {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
      var errorMessage = response.i_error !== undefined ? response.i_error : '';
      errorMessage = errorMessage.replace(/\n/g, '<br>');
      UserMessage.showMultiString(errorMessage, globalTranslate.ext_InstallationError);
    } else if (response.i_status === 'INSTALLATION_IN_PROGRESS') {
      if (installStatusLoopWorker.oldPercent !== response.i_status_progress) {
        installStatusLoopWorker.iterations = 0;
      }
      installStatusLoopWorker.oldPercent = response.d_status_progress;
    } else if (response.i_status === 'INSTALLATION_COMPLETE') {
      if (installStatusLoopWorker.needEnableAfterInstall) {
        PbxApi.SystemEnableModule(installStatusLoopWorker.moduleUniqid, function () {
          window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
        });
      } else {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZmlsZVBhdGgiLCJpdGVyYXRpb25zIiwib2xkUGVyY2VudCIsIm5lZWRFbmFibGVBZnRlckluc3RhbGwiLCJpbml0aWFsaXplIiwibmVlZEVuYWJsZSIsImFyZ3VtZW50cyIsImxlbmd0aCIsInVuZGVmaW5lZCIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiUGJ4QXBpIiwiU3lzdGVtR2V0TW9kdWxlSW5zdGFsbGF0aW9uU3RhdHVzIiwiY2JBZnRlclJlY2VpdmVOZXdTdGF0dXMiLCJyZXN1bHQiLCJyZXNwb25zZSIsInNldFRpbWVvdXQiLCJpX3N0YXR1cyIsImVycm9yTWVzc2FnZSIsImlfZXJyb3IiLCJyZXBsYWNlIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfSW5zdGFsbGF0aW9uRXJyb3IiLCJpX3N0YXR1c19wcm9ncmVzcyIsImRfc3RhdHVzX3Byb2dyZXNzIiwiU3lzdGVtRW5hYmxlTW9kdWxlIiwibW9kdWxlVW5pcWlkIiwibG9jYXRpb24iLCJjb25jYXQiLCJnbG9iYWxSb290VXJsIl0sInNvdXJjZXMiOlsiLi4vLi4vc3JjL1BieEV4dGVuc2lvbk1vZHVsZXMvcGJ4LWV4dGVuc2lvbi1tb2R1bGUtaW5zdGFsbC1zdGF0dXMtd29ya2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgKEMpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgUGJ4QXBpLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlICovXG5cbi8qKlxuICogTW9uaXRvcnMgc3RhdHVzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb25cbiAqXG4gKi9cbmNvbnN0IGluc3RhbGxTdGF0dXNMb29wV29ya2VyID0ge1xuXHR0aW1lT3V0OiAxMDAwLFxuXHR0aW1lT3V0SGFuZGxlOiAnJyxcblx0ZmlsZVBhdGg6ICcnLFxuXHRpdGVyYXRpb25zOiAwLFxuXHRvbGRQZXJjZW50OiAnMCcsXG5cdG5lZWRFbmFibGVBZnRlckluc3RhbGw6IGZhbHNlLFxuXHRpbml0aWFsaXplKGZpbGVQYXRoLCBuZWVkRW5hYmxlPWZhbHNlKSB7XG5cdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuZmlsZVBhdGggPSBmaWxlUGF0aDtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID0gMDtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5uZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsID0gbmVlZEVuYWJsZTtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG5cdH0sXG5cdHJlc3RhcnRXb3JrZXIoKSB7XG5cdFx0d2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci53b3JrZXIoKTtcblx0fSxcblx0d29ya2VyKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG5cdFx0UGJ4QXBpLlN5c3RlbUdldE1vZHVsZUluc3RhbGxhdGlvblN0YXR1cyhcblx0XHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmZpbGVQYXRoLFxuXHRcdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2JBZnRlclJlY2VpdmVOZXdTdGF0dXNcblx0XHQpO1xuXHR9LFxuXHRjYkFmdGVyUmVjZWl2ZU5ld1N0YXR1cyhyZXN1bHQsIHJlc3BvbnNlKSB7XG5cdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyArPSAxO1xuXHRcdGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUgPVxuXHRcdFx0d2luZG93LnNldFRpbWVvdXQoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIud29ya2VyLCBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lT3V0KTtcblx0XHQvLyBDaGVjayBpbnN0YWxsYXRpb24gc3RhdHVzXG5cdFx0aWYgKHJlc3VsdCA9PT0gZmFsc2Vcblx0XHRcdCYmIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPCA1MCkge1xuXHRcdFx0d2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHR9IGVsc2UgaWYgKGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPiA1MFxuXHRcdFx0fHwgcmVzcG9uc2UuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fRVJST1InXG5cdFx0XHR8fCByZXNwb25zZS5pX3N0YXR1cyA9PT0gJ1BST0dSRVNTX0ZJTEVfTk9UX0ZPVU5EJ1xuXHRcdCkge1xuXHRcdFx0d2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0XHRcdGxldCBlcnJvck1lc3NhZ2UgPSAocmVzcG9uc2UuaV9lcnJvciAhPT0gdW5kZWZpbmVkKSA/IHJlc3BvbnNlLmlfZXJyb3IgOiAnJztcblx0XHRcdGVycm9yTWVzc2FnZSA9IGVycm9yTWVzc2FnZS5yZXBsYWNlKC9cXG4vZywgJzxicj4nKTtcblx0XHRcdFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhlcnJvck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuXHRcdH0gZWxzZSBpZiAocmVzcG9uc2UuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fSU5fUFJPR1JFU1MnKSB7XG5cdFx0XHRpZiAoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIub2xkUGVyY2VudCAhPT0gcmVzcG9uc2UuaV9zdGF0dXNfcHJvZ3Jlc3MpIHtcblx0XHRcdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA9IDA7XG5cdFx0XHR9XG5cdFx0XHRpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5vbGRQZXJjZW50ID0gcmVzcG9uc2UuZF9zdGF0dXNfcHJvZ3Jlc3M7XG5cdFx0fSBlbHNlIGlmIChyZXNwb25zZS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9DT01QTEVURScpIHtcblx0XHRcdGlmIChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5uZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsKSB7XG5cdFx0XHRcdFBieEFwaS5TeXN0ZW1FbmFibGVNb2R1bGUoXG5cdFx0XHRcdFx0aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIubW9kdWxlVW5pcWlkLFxuXHRcdFx0XHRcdCgpID0+IHtcblx0XHRcdFx0XHRcdHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9cGJ4LWV4dGVuc2lvbi1tb2R1bGVzL2luZGV4L2A7XG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0KTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9cGJ4LWV4dGVuc2lvbi1tb2R1bGVzL2luZGV4L2A7XG5cdFx0XHR9XG5cdFx0XHR3aW5kb3cuY2xlYXJUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdH1cblx0fSxcbn07XG4iXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHVCQUF1QixHQUFHO0VBQy9CQyxPQUFPLEVBQUUsSUFBSTtFQUNiQyxhQUFhLEVBQUUsRUFBRTtFQUNqQkMsUUFBUSxFQUFFLEVBQUU7RUFDWkMsVUFBVSxFQUFFLENBQUM7RUFDYkMsVUFBVSxFQUFFLEdBQUc7RUFDZkMsc0JBQXNCLEVBQUUsS0FBSztFQUM3QkMsVUFBVSxXQUFBQSxXQUFDSixRQUFRLEVBQW9CO0lBQUEsSUFBbEJLLFVBQVUsR0FBQUMsU0FBQSxDQUFBQyxNQUFBLFFBQUFELFNBQUEsUUFBQUUsU0FBQSxHQUFBRixTQUFBLE1BQUMsS0FBSztJQUNwQ1QsdUJBQXVC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