"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Handles real-time monitoring and updates of module installation statuses.
 * Utilizes server-sent events to receive updates and reflects these changes in the UI,
 * particularly in the progress bar and status messages displayed to the user.
 *
 * @module installStatusLoopWorker
 */
var installStatusLoopWorker = {
  /**
   * The jQuery object representing the progress bar element in the DOM.
   * Used to visually indicate the progress of module installation or updates.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * The jQuery object for the container of the progress bar.
   * This element is shown and hidden based on the presence of active installation or update processes.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * The jQuery object for the label element associated with the progress bar.
   * Used to display textual information about the current stage of the installation or update process.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * The EventSource object used for receiving real-time updates from the server about module installation statuses.
   * This allows for a push-based mechanism to keep the UI updated with the latest progress information.
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * The identifier for the PUB/SUB channel used to subscribe to installation status updates.
   * This ensures that the client is listening on the correct channel for relevant events.
   */
  channelId: 'install-module',

  /**
   * Initializes the installStatusLoopWorker module by setting up the connection to receive server-sent events.
   */
  initialize: function initialize() {
    installStatusLoopWorker.startListenPushNotifications();
  },

  /**
   * Establishes a connection to the server to start receiving real-time updates on module installation progress.
   * Utilizes the EventSource API to listen for messages on a specified channel.
   */
  startListenPushNotifications: function startListenPushNotifications() {
    var lastEventIdKey = "lastEventId";
    var lastEventId = localStorage.getItem(lastEventIdKey);
    var subPath = lastEventId ? "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId, "?last_event_id=").concat(lastEventId) : "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId);
    installStatusLoopWorker.eventSource = new EventSource(subPath);
    installStatusLoopWorker.eventSource.addEventListener('message', function (e) {
      var response = JSON.parse(e.data);
      installStatusLoopWorker.processModuleInstallation(response);
      localStorage.setItem(lastEventIdKey, e.lastEventId);
    });
  },

  /**
   * Processes incoming server-sent events related to module installation.
   * Updates the UI based on the current stage of installation, download, upload, or error states.
   *
   * @param {Object} response - The data payload of the server-sent event, containing details about the installation stage and progress.
   */
  processModuleInstallation: function processModuleInstallation(response) {
    var moduleUniqueId = response.moduleUniqueId;
    var stage = response.stage;
    var stageDetails = response.stageDetails;
    var $row = $("#".concat(moduleUniqueId));

    if (stage === 'Stage_I_GetRelease') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_GetReleaseInProgress, 1);
    } else if (stage === 'Stage_II_CheckLicense') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 2);
    } else if (stage === 'Stage_III_GetDownloadLink') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 3);
    } else if (stage === 'Stage_IV_DownloadModule') {
      installStatusLoopWorker.cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_I_UploadModule') {
      installStatusLoopWorker.cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_V_InstallModule') {
      installStatusLoopWorker.cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_VI_EnableModule') {} else if (stage === 'Stage_VII_FinalStatus') {
      if (stageDetails.result === true) {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      } else {
        installStatusLoopWorker.$progressBarBlock.hide();

        if (stageDetails.messages !== undefined) {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError, stageDetails.messages);
        } else {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError);
        }
      }
    }
  },

  /**
   * Updates the UI to reflect the progress of a module download.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being downloaded.
   * @param {Object} stageDetails - Detailed information about the download progress.
   */
  cbAfterReceiveNewDownloadStatus: function cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'DOWNLOAD_IN_PROGRESS') {
      var downloadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, downloadProgress);
    } else if (stageDetails.d_status === 'DOWNLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, 50);
    }
  },

  /**
   * Updates the UI to reflect the progress of a module upload.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being uploaded.
   * @param {Object} stageDetails - Detailed information about the upload progress.
   */
  cbAfterReceiveNewUploadStatus: function cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'UPLOAD_IN_PROGRESS') {
      var uploadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, uploadProgress);
    } else if (stageDetails.d_status === 'UPLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, 50);
    }
  },

  /**
   * Handles updates on the installation progress of a module.
   * Updates the progress bar and status message based on the information received in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being installed.
   * @param {Object} stageDetails - Detailed information about the installation progress.
   */
  cbAfterReceiveNewInstallationStatus: function cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails) {
    // Check module installation status
    if (stageDetails.data.i_status === 'INSTALLATION_IN_PROGRESS') {
      var installationProgress = Math.round(parseInt(stageDetails.data.i_status_progress, 10) / 2 + 50);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, installationProgress);
    } else if (stageDetails.data.i_status === 'INSTALLATION_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, 100);
    }
  },

  /**
   * Resets the UI elements associated with a module row to their default state.
   * This is typically called after an installation process completes or fails.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   */
  resetButtonView: function resetButtonView($row) {
    $('a.button').removeClass('disabled');
    $row.find('i.loading').removeClass('spinner loading');
    $row.find('a.download i').addClass('download');
    $row.find('a.update i').addClass('redo');
  },

  /**
   * Displays an error message related to module installation in the UI.
   * This function is called when an installation fails, providing feedback to the user.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   * @param {string} header - The header text for the error message.
   * @param {Object} messages - Detailed error messages to be displayed.
   */
  showModuleInstallationError: function showModuleInstallationError($row, header) {
    var messages = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';
    installStatusLoopWorker.resetButtonView($row);

    if (messages.license !== undefined) {
      var manageLink = "<br>".concat(globalTranslate.lic_ManageLicense, " <a href=\"").concat(Config.keyManagementUrl, "\" target=\"_blank\">").concat(Config.keyManagementSite, "</a>");
      messages.license.push(manageLink);
    }

    var textDescription = UserMessage.convertToText(messages);
    var htmlMessage = "<tr class=\"ui error center aligned table-error-messages\"><td colspan=\"4\"><div class=\"ui header\">".concat(header, "</div><p>").concat(textDescription, "</p></div></td></tr>");
    $row.addClass('error');
    $row.before(htmlMessage);
  },

  /**
   * Updates the progress bar and status message to reflect the current state of a module installation process.
   * This function is used throughout different stages of installation to provide real-time feedback to the user.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module.
   * @param {string} header - The status message to be displayed above the progress bar.
   * @param {number} [percent=0] - The current progress percentage to be reflected in the progress bar.
   */
  updateProgressBar: function updateProgressBar(moduleUniqueId, header) {
    var percent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;
    var moduleName = $("tr.new-module-row[data-id=".concat(moduleUniqueId, "]")).data('name');

    if (moduleName === undefined) {
      moduleName = '';
    }

    installStatusLoopWorker.$progressBarBlock.show();
    installStatusLoopWorker.$progressBar.show();

    if (header) {
      var barText = moduleName + ': ' + header;
      installStatusLoopWorker.$progressBarLabel.text(barText);
    }

    if (percent > 0) {
      installStatusLoopWorker.$progressBar.progress({
        percent: percent
      });
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsIiRwcm9ncmVzc0JhciIsIiQiLCIkcHJvZ3Jlc3NCYXJCbG9jayIsIiRwcm9ncmVzc0JhckxhYmVsIiwiZXZlbnRTb3VyY2UiLCJjaGFubmVsSWQiLCJpbml0aWFsaXplIiwic3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucyIsImxhc3RFdmVudElkS2V5IiwibGFzdEV2ZW50SWQiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwic3ViUGF0aCIsIkV2ZW50U291cmNlIiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCJyZXNwb25zZSIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJwcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uIiwic2V0SXRlbSIsIm1vZHVsZVVuaXF1ZUlkIiwic3RhZ2UiLCJzdGFnZURldGFpbHMiLCIkcm93IiwidXBkYXRlUHJvZ3Jlc3NCYXIiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfR2V0UmVsZWFzZUluUHJvZ3Jlc3MiLCJleHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcyIsImNiQWZ0ZXJSZWNlaXZlTmV3RG93bmxvYWRTdGF0dXMiLCJjYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyIsImNiQWZ0ZXJSZWNlaXZlTmV3SW5zdGFsbGF0aW9uU3RhdHVzIiwicmVzdWx0Iiwid2luZG93IiwibG9jYXRpb24iLCJnbG9iYWxSb290VXJsIiwiaGlkZSIsIm1lc3NhZ2VzIiwidW5kZWZpbmVkIiwic2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yIiwiZXh0X0luc3RhbGxhdGlvbkVycm9yIiwiZF9zdGF0dXMiLCJkb3dubG9hZFByb2dyZXNzIiwiTWF0aCIsIm1heCIsInJvdW5kIiwicGFyc2VJbnQiLCJkX3N0YXR1c19wcm9ncmVzcyIsImV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MiLCJ1cGxvYWRQcm9ncmVzcyIsImV4dF9VcGxvYWRJblByb2dyZXNzIiwiaV9zdGF0dXMiLCJpbnN0YWxsYXRpb25Qcm9ncmVzcyIsImlfc3RhdHVzX3Byb2dyZXNzIiwiZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MiLCJyZXNldEJ1dHRvblZpZXciLCJyZW1vdmVDbGFzcyIsImZpbmQiLCJhZGRDbGFzcyIsImhlYWRlciIsImxpY2Vuc2UiLCJtYW5hZ2VMaW5rIiwibGljX01hbmFnZUxpY2Vuc2UiLCJDb25maWciLCJrZXlNYW5hZ2VtZW50VXJsIiwia2V5TWFuYWdlbWVudFNpdGUiLCJwdXNoIiwidGV4dERlc2NyaXB0aW9uIiwiVXNlck1lc3NhZ2UiLCJjb252ZXJ0VG9UZXh0IiwiaHRtbE1lc3NhZ2UiLCJiZWZvcmUiLCJwZXJjZW50IiwibW9kdWxlTmFtZSIsInNob3ciLCJiYXJUZXh0IiwidGV4dCIsInByb2dyZXNzIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUM1QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFlBQVksRUFBRUMsQ0FBQyxDQUFDLHNCQUFELENBTmE7O0FBUTVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsaUJBQWlCLEVBQUVELENBQUMsQ0FBQyw0QkFBRCxDQWJROztBQWU1QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lFLEVBQUFBLGlCQUFpQixFQUFFRixDQUFDLENBQUMsNEJBQUQsQ0FwQlE7O0FBc0I1QjtBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lHLEVBQUFBLFdBQVcsRUFBRSxJQTNCZTs7QUE2QjVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVB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ZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UgKi9cblxuLyoqXG4gKiBIYW5kbGVzIHJlYWwtdGltZSBtb25pdG9yaW5nIGFuZCB1cGRhdGVzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24gc3RhdHVzZXMuXG4gKiBVdGlsaXplcyBzZXJ2ZXItc2VudCBldmVudHMgdG8gcmVjZWl2ZSB1cGRhdGVzIGFuZCByZWZsZWN0cyB0aGVzZSBjaGFuZ2VzIGluIHRoZSBVSSxcbiAqIHBhcnRpY3VsYXJseSBpbiB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZXMgZGlzcGxheWVkIHRvIHRoZSB1c2VyLlxuICpcbiAqIEBtb2R1bGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgPSB7XG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBwcm9ncmVzcyBiYXIgZWxlbWVudCBpbiB0aGUgRE9NLlxuICAgICAqIFVzZWQgdG8gdmlzdWFsbHkgaW5kaWNhdGUgdGhlIHByb2dyZXNzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgY29udGFpbmVyIG9mIHRoZSBwcm9ncmVzcyBiYXIuXG4gICAgICogVGhpcyBlbGVtZW50IGlzIHNob3duIGFuZCBoaWRkZW4gYmFzZWQgb24gdGhlIHByZXNlbmNlIG9mIGFjdGl2ZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlIHByb2Nlc3Nlcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhckJsb2NrOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhci1ibG9jaycpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBsYWJlbCBlbGVtZW50IGFzc29jaWF0ZWQgd2l0aCB0aGUgcHJvZ3Jlc3MgYmFyLlxuICAgICAqIFVzZWQgdG8gZGlzcGxheSB0ZXh0dWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IHN0YWdlIG9mIHRoZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlIHByb2Nlc3MuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXItbGFiZWwnKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBFdmVudFNvdXJjZSBvYmplY3QgdXNlZCBmb3IgcmVjZWl2aW5nIHJlYWwtdGltZSB1cGRhdGVzIGZyb20gdGhlIHNlcnZlciBhYm91dCBtb2R1bGUgaW5zdGFsbGF0aW9uIHN0YXR1c2VzLlxuICAgICAqIFRoaXMgYWxsb3dzIGZvciBhIHB1c2gtYmFzZWQgbWVjaGFuaXNtIHRvIGtlZXAgdGhlIFVJIHVwZGF0ZWQgd2l0aCB0aGUgbGF0ZXN0IHByb2dyZXNzIGluZm9ybWF0aW9uLlxuICAgICAqIEB0eXBlIHtFdmVudFNvdXJjZX1cbiAgICAgKi9cbiAgICBldmVudFNvdXJjZTogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBpZGVudGlmaWVyIGZvciB0aGUgUFVCL1NVQiBjaGFubmVsIHVzZWQgdG8gc3Vic2NyaWJlIHRvIGluc3RhbGxhdGlvbiBzdGF0dXMgdXBkYXRlcy5cbiAgICAgKiBUaGlzIGVuc3VyZXMgdGhhdCB0aGUgY2xpZW50IGlzIGxpc3RlbmluZyBvbiB0aGUgY29ycmVjdCBjaGFubmVsIGZvciByZWxldmFudCBldmVudHMuXG4gICAgICovXG4gICAgY2hhbm5lbElkOiAnaW5zdGFsbC1tb2R1bGUnLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIGluc3RhbGxTdGF0dXNMb29wV29ya2VyIG1vZHVsZSBieSBzZXR0aW5nIHVwIHRoZSBjb25uZWN0aW9uIHRvIHJlY2VpdmUgc2VydmVyLXNlbnQgZXZlbnRzLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKXtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucygpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBFc3RhYmxpc2hlcyBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciB0byBzdGFydCByZWNlaXZpbmcgcmVhbC10aW1lIHVwZGF0ZXMgb24gbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9ncmVzcy5cbiAgICAgKiBVdGlsaXplcyB0aGUgRXZlbnRTb3VyY2UgQVBJIHRvIGxpc3RlbiBmb3IgbWVzc2FnZXMgb24gYSBzcGVjaWZpZWQgY2hhbm5lbC5cbiAgICAgKi9cbiAgICBzdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zKCkge1xuICAgICAgICBjb25zdCBsYXN0RXZlbnRJZEtleSA9IGBsYXN0RXZlbnRJZGA7XG4gICAgICAgIGxldCBsYXN0RXZlbnRJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGxhc3RFdmVudElkS2V5KTtcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IGxhc3RFdmVudElkID8gYC9wYnhjb3JlL2FwaS9uY2hhbi9zdWIvJHtpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jaGFubmVsSWR9P2xhc3RfZXZlbnRfaWQ9JHtsYXN0RXZlbnRJZH1gIDogYC9wYnhjb3JlL2FwaS9uY2hhbi9zdWIvJHtpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jaGFubmVsSWR9YDtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuZXZlbnRTb3VyY2UgPSBuZXcgRXZlbnRTb3VyY2Uoc3ViUGF0aCk7XG5cbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuZXZlbnRTb3VyY2UuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKGUuZGF0YSk7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5wcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGxhc3RFdmVudElkS2V5LCBlLmxhc3RFdmVudElkKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFByb2Nlc3NlcyBpbmNvbWluZyBzZXJ2ZXItc2VudCBldmVudHMgcmVsYXRlZCB0byBtb2R1bGUgaW5zdGFsbGF0aW9uLlxuICAgICAqIFVwZGF0ZXMgdGhlIFVJIGJhc2VkIG9uIHRoZSBjdXJyZW50IHN0YWdlIG9mIGluc3RhbGxhdGlvbiwgZG93bmxvYWQsIHVwbG9hZCwgb3IgZXJyb3Igc3RhdGVzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIC0gVGhlIGRhdGEgcGF5bG9hZCBvZiB0aGUgc2VydmVyLXNlbnQgZXZlbnQsIGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dCB0aGUgaW5zdGFsbGF0aW9uIHN0YWdlIGFuZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBwcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgY29uc3QgbW9kdWxlVW5pcXVlSWQgPSByZXNwb25zZS5tb2R1bGVVbmlxdWVJZDtcbiAgICAgICAgY29uc3Qgc3RhZ2UgPSByZXNwb25zZS5zdGFnZTtcbiAgICAgICAgY29uc3Qgc3RhZ2VEZXRhaWxzID0gcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzO1xuICAgICAgICBjb25zdCAkcm93ID0gJChgIyR7bW9kdWxlVW5pcXVlSWR9YCk7XG4gICAgICAgIGlmIChzdGFnZSA9PT0nU3RhZ2VfSV9HZXRSZWxlYXNlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9HZXRSZWxlYXNlSW5Qcm9ncmVzcywgMSk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9JSV9DaGVja0xpY2Vuc2UnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0NoZWNrTGljZW5zZUluUHJvZ3Jlc3MsIDIpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfSUlJX0dldERvd25sb2FkTGluaycpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcywgMyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9JVl9Eb3dubG9hZE1vZHVsZScpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2JBZnRlclJlY2VpdmVOZXdEb3dubG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lfVXBsb2FkTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX1ZfSW5zdGFsbE1vZHVsZScpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2JBZnRlclJlY2VpdmVOZXdJbnN0YWxsYXRpb25TdGF0dXMobW9kdWxlVW5pcXVlSWQsIHN0YWdlRGV0YWlscyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9WSV9FbmFibGVNb2R1bGUnKXtcblxuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfVklJX0ZpbmFsU3RhdHVzJyl7XG4gICAgICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLnJlc3VsdD09PXRydWUpe1xuICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9cGJ4LWV4dGVuc2lvbi1tb2R1bGVzL2luZGV4L2A7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0JhckJsb2NrLmhpZGUoKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLm1lc3NhZ2VzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IsIHN0YWdlRGV0YWlscy5tZXNzYWdlcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBVSSB0byByZWZsZWN0IHRoZSBwcm9ncmVzcyBvZiBhIG1vZHVsZSBkb3dubG9hZC5cbiAgICAgKiBBZGp1c3RzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIGJhc2VkIG9uIHRoZSBkZXRhaWxzIHByb3ZpZGVkIGluIHRoZSBzZXJ2ZXItc2VudCBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbW9kdWxlIGJlaW5nIGRvd25sb2FkZWQuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHN0YWdlRGV0YWlscyAtIERldGFpbGVkIGluZm9ybWF0aW9uIGFib3V0IHRoZSBkb3dubG9hZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld0Rvd25sb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpIHtcbiAgICAgICAgLy8gQ2hlY2sgbW9kdWxlIGRvd25sb2FkIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXMgPT09ICdET1dOTE9BRF9JTl9QUk9HUkVTUycpIHtcbiAgICAgICAgICAgIGNvbnN0IGRvd25sb2FkUHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLnJvdW5kKHBhcnNlSW50KHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzX3Byb2dyZXNzLCAxMCkvMiksIDMpO1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfRG93bmxvYWRJblByb2dyZXNzLCBkb3dubG9hZFByb2dyZXNzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZURldGFpbHMuZF9zdGF0dXMgPT09ICdET1dOTE9BRF9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0Rvd25sb2FkSW5Qcm9ncmVzcywgNTApO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIFVJIHRvIHJlZmxlY3QgdGhlIHByb2dyZXNzIG9mIGEgbW9kdWxlIHVwbG9hZC5cbiAgICAgKiBBZGp1c3RzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIGJhc2VkIG9uIHRoZSBkZXRhaWxzIHByb3ZpZGVkIGluIHRoZSBzZXJ2ZXItc2VudCBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbW9kdWxlIGJlaW5nIHVwbG9hZGVkLlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzdGFnZURldGFpbHMgLSBEZXRhaWxlZCBpbmZvcm1hdGlvbiBhYm91dCB0aGUgdXBsb2FkIHByb2dyZXNzLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZWNlaXZlTmV3VXBsb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpIHtcbiAgICAgICAgLy8gQ2hlY2sgbW9kdWxlIGRvd25sb2FkIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXMgPT09ICdVUExPQURfSU5fUFJPR1JFU1MnKSB7XG4gICAgICAgICAgICBjb25zdCB1cGxvYWRQcm9ncmVzcyA9IE1hdGgubWF4KE1hdGgucm91bmQocGFyc2VJbnQoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXNfcHJvZ3Jlc3MsIDEwKS8yKSwgMyk7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRJblByb2dyZXNzLCB1cGxvYWRQcm9ncmVzcyk7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2VEZXRhaWxzLmRfc3RhdHVzID09PSAnVVBMT0FEX0NPTVBMRVRFJykge1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcywgNTApO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEhhbmRsZXMgdXBkYXRlcyBvbiB0aGUgaW5zdGFsbGF0aW9uIHByb2dyZXNzIG9mIGEgbW9kdWxlLlxuICAgICAqIFVwZGF0ZXMgdGhlIHByb2dyZXNzIGJhciBhbmQgc3RhdHVzIG1lc3NhZ2UgYmFzZWQgb24gdGhlIGluZm9ybWF0aW9uIHJlY2VpdmVkIGluIHRoZSBzZXJ2ZXItc2VudCBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbW9kdWxlIGJlaW5nIGluc3RhbGxlZC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gc3RhZ2VEZXRhaWxzIC0gRGV0YWlsZWQgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGluc3RhbGxhdGlvbiBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld0luc3RhbGxhdGlvblN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKSB7XG4gICAgICAgIC8vIENoZWNrIG1vZHVsZSBpbnN0YWxsYXRpb24gc3RhdHVzXG4gICAgICAgIGlmIChzdGFnZURldGFpbHMuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9JTl9QUk9HUkVTUycpIHtcbiAgICAgICAgICAgIGNvbnN0IGluc3RhbGxhdGlvblByb2dyZXNzID0gTWF0aC5yb3VuZChwYXJzZUludChzdGFnZURldGFpbHMuZGF0YS5pX3N0YXR1c19wcm9ncmVzcywgMTApLzIrNTApO1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcywgaW5zdGFsbGF0aW9uUHJvZ3Jlc3MpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlRGV0YWlscy5kYXRhLmlfc3RhdHVzID09PSAnSU5TVEFMTEFUSU9OX0NPTVBMRVRFJykge1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcywgMTAwKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXNldHMgdGhlIFVJIGVsZW1lbnRzIGFzc29jaWF0ZWQgd2l0aCBhIG1vZHVsZSByb3cgdG8gdGhlaXIgZGVmYXVsdCBzdGF0ZS5cbiAgICAgKiBUaGlzIGlzIHR5cGljYWxseSBjYWxsZWQgYWZ0ZXIgYW4gaW5zdGFsbGF0aW9uIHByb2Nlc3MgY29tcGxldGVzIG9yIGZhaWxzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtqUXVlcnl9ICRyb3cgLSBUaGUgalF1ZXJ5IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJvdyBpbiB0aGUgVUkgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUuXG4gICAgICovXG4gICAgcmVzZXRCdXR0b25WaWV3KCRyb3cpe1xuICAgICAgICAkKCdhLmJ1dHRvbicpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAkcm93LmZpbmQoJ2kubG9hZGluZycpLnJlbW92ZUNsYXNzKCdzcGlubmVyIGxvYWRpbmcnKTtcbiAgICAgICAgJHJvdy5maW5kKCdhLmRvd25sb2FkIGknKS5hZGRDbGFzcygnZG93bmxvYWQnKTtcbiAgICAgICAgJHJvdy5maW5kKCdhLnVwZGF0ZSBpJykuYWRkQ2xhc3MoJ3JlZG8nKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRGlzcGxheXMgYW4gZXJyb3IgbWVzc2FnZSByZWxhdGVkIHRvIG1vZHVsZSBpbnN0YWxsYXRpb24gaW4gdGhlIFVJLlxuICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgY2FsbGVkIHdoZW4gYW4gaW5zdGFsbGF0aW9uIGZhaWxzLCBwcm92aWRpbmcgZmVlZGJhY2sgdG8gdGhlIHVzZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge2pRdWVyeX0gJHJvdyAtIFRoZSBqUXVlcnkgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgcm93IGluIHRoZSBVSSBhc3NvY2lhdGVkIHdpdGggdGhlIG1vZHVsZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVyIC0gVGhlIGhlYWRlciB0ZXh0IGZvciB0aGUgZXJyb3IgbWVzc2FnZS5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gbWVzc2FnZXMgLSBEZXRhaWxlZCBlcnJvciBtZXNzYWdlcyB0byBiZSBkaXNwbGF5ZWQuXG4gICAgICovXG4gICAgc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGhlYWRlciwgbWVzc2FnZXM9JycpIHtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIucmVzZXRCdXR0b25WaWV3KCRyb3cpO1xuICAgICAgICBpZiAobWVzc2FnZXMubGljZW5zZSE9PXVuZGVmaW5lZCl7XG4gICAgICAgICAgICBjb25zdCBtYW5hZ2VMaW5rID0gYDxicj4ke2dsb2JhbFRyYW5zbGF0ZS5saWNfTWFuYWdlTGljZW5zZX0gPGEgaHJlZj1cIiR7Q29uZmlnLmtleU1hbmFnZW1lbnRVcmx9XCIgdGFyZ2V0PVwiX2JsYW5rXCI+JHtDb25maWcua2V5TWFuYWdlbWVudFNpdGV9PC9hPmA7XG4gICAgICAgICAgICBtZXNzYWdlcy5saWNlbnNlLnB1c2gobWFuYWdlTGluayk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGV4dERlc2NyaXB0aW9uID0gVXNlck1lc3NhZ2UuY29udmVydFRvVGV4dChtZXNzYWdlcyk7XG4gICAgICAgIGNvbnN0IGh0bWxNZXNzYWdlPSAgYDx0ciBjbGFzcz1cInVpIGVycm9yIGNlbnRlciBhbGlnbmVkIHRhYmxlLWVycm9yLW1lc3NhZ2VzXCI+PHRkIGNvbHNwYW49XCI0XCI+PGRpdiBjbGFzcz1cInVpIGhlYWRlclwiPiR7aGVhZGVyfTwvZGl2PjxwPiR7dGV4dERlc2NyaXB0aW9ufTwvcD48L2Rpdj48L3RkPjwvdHI+YDtcbiAgICAgICAgJHJvdy5hZGRDbGFzcygnZXJyb3InKTtcbiAgICAgICAgJHJvdy5iZWZvcmUoaHRtbE1lc3NhZ2UpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIHRvIHJlZmxlY3QgdGhlIGN1cnJlbnQgc3RhdGUgb2YgYSBtb2R1bGUgaW5zdGFsbGF0aW9uIHByb2Nlc3MuXG4gICAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIHRocm91Z2hvdXQgZGlmZmVyZW50IHN0YWdlcyBvZiBpbnN0YWxsYXRpb24gdG8gcHJvdmlkZSByZWFsLXRpbWUgZmVlZGJhY2sgdG8gdGhlIHVzZXIuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIG1vZHVsZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVyIC0gVGhlIHN0YXR1cyBtZXNzYWdlIHRvIGJlIGRpc3BsYXllZCBhYm92ZSB0aGUgcHJvZ3Jlc3MgYmFyLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcGVyY2VudD0wXSAtIFRoZSBjdXJyZW50IHByb2dyZXNzIHBlcmNlbnRhZ2UgdG8gYmUgcmVmbGVjdGVkIGluIHRoZSBwcm9ncmVzcyBiYXIuXG4gICAgICovXG4gICAgdXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGhlYWRlciwgcGVyY2VudD0wKXtcbiAgICAgICAgbGV0IG1vZHVsZU5hbWUgPSAkKGB0ci5uZXctbW9kdWxlLXJvd1tkYXRhLWlkPSR7bW9kdWxlVW5pcXVlSWR9XWApLmRhdGEoJ25hbWUnKTtcbiAgICAgICAgaWYgKG1vZHVsZU5hbWUgPT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICBtb2R1bGVOYW1lID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuJHByb2dyZXNzQmFyQmxvY2suc2hvdygpO1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXIuc2hvdygpO1xuICAgICAgICBpZiAoaGVhZGVyKXtcbiAgICAgICAgICAgIGNvbnN0IGJhclRleHQ9IG1vZHVsZU5hbWUrJzogJytoZWFkZXI7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGJhclRleHQpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwZXJjZW50PjApe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuJHByb2dyZXNzQmFyLnByb2dyZXNzKHtcbiAgICAgICAgICAgICAgICBwZXJjZW50OiBwZXJjZW50LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG59OyJdfQ==