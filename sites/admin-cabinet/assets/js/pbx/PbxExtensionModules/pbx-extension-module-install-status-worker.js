"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Handles real-time monitoring and updates of module installation statuses.
 * Utilizes server-sent events to receive updates and reflects these changes in the UI,
 * particularly in the progress bar and status messages displayed to the user.
 *
 * @module installStatusLoopWorker
 */
var installStatusLoopWorker = {
  /**
   * The jQuery object representing the progress bar element in the DOM.
   * Used to visually indicate the progress of module installation or updates.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * The jQuery object for the container of the progress bar.
   * This element is shown and hidden based on the presence of active installation or update processes.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * The jQuery object for the label element associated with the progress bar.
   * Used to display textual information about the current stage of the installation or update process.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * The EventSource object used for receiving real-time updates from the server about module installation statuses.
   * This allows for a push-based mechanism to keep the UI updated with the latest progress information.
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * The identifier for the PUB/SUB channel used to subscribe to installation status updates.
   * This ensures that the client is listening on the correct channel for relevant events.
   */
  channelId: 'install-module',

  /**
   * Initializes the installStatusLoopWorker module by setting up the connection to receive server-sent events.
   */
  initialize: function initialize() {
    installStatusLoopWorker.startListenPushNotifications();
  },

  /**
   * Establishes a connection to the server to start receiving real-time updates on module installation progress.
   * Utilizes the EventSource API to listen for messages on a specified channel.
   */
  startListenPushNotifications: function startListenPushNotifications() {
    var lastEventIdKey = "".concat(installStatusLoopWorker.channelId, "-lastEventId");
    var lastEventId = localStorage.getItem(lastEventIdKey);
    var subPath = lastEventId ? "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId, "?last_event_id=").concat(lastEventId) : "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId);
    installStatusLoopWorker.eventSource = new EventSource(subPath);
    installStatusLoopWorker.eventSource.addEventListener('message', function (e) {
      var response = JSON.parse(e.data);
      console.debug(response);
      installStatusLoopWorker.processModuleInstallation(response);
      localStorage.setItem(lastEventIdKey, e.lastEventId);
    });
  },

  /**
   * Processes incoming server-sent events related to module installation.
   * Updates the UI based on the current stage of installation, download, upload, or error states.
   *
   * @param {Object} response - The data payload of the server-sent event, containing details about the installation stage and progress.
   */
  processModuleInstallation: function processModuleInstallation(response) {
    var moduleUniqueId = response.moduleUniqueId;
    var stage = response.stage;
    var stageDetails = response.stageDetails;
    var $row = $("tr[data-id=".concat(moduleUniqueId, "]"));

    if (stage === 'Stage_I_GetRelease') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_GetReleaseInProgress, 1);
    } else if (stage === 'Stage_II_CheckLicense') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 2);
    } else if (stage === 'Stage_III_GetDownloadLink') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 3);
    } else if (stage === 'Stage_IV_DownloadModule') {
      installStatusLoopWorker.cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_I_UploadModule') {
      installStatusLoopWorker.cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_V_InstallModule') {
      installStatusLoopWorker.cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_VI_EnableModule') {} else if (stage === 'Stage_VII_FinalStatus') {
      if (stageDetails.result === false) {
        installStatusLoopWorker.$progressBarBlock.hide();

        if (stageDetails.messages !== undefined) {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError, stageDetails.messages);
        } else {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError);
        }
      } else {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }
    }
  },

  /**
   * Updates the UI to reflect the progress of a module download.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being downloaded.
   * @param {Object} stageDetails - Detailed information about the download progress.
   */
  cbAfterReceiveNewDownloadStatus: function cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'DOWNLOAD_IN_PROGRESS') {
      var downloadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2) - 1, 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, downloadProgress);
    } else if (stageDetails.data.d_status === 'DOWNLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, 50);
    }
  },

  /**
   * Updates the UI to reflect the progress of a module upload.
   * Adjusts the progress bar and status message based on the details provided in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being uploaded.
   * @param {Object} stageDetails - Detailed information about the upload progress.
   */
  cbAfterReceiveNewUploadStatus: function cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails) {
    // Check module upload status
    if (stageDetails.data.d_status === 'UPLOAD_IN_PROGRESS') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, 49);
    } else if (stageDetails.data.d_status === 'UPLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, 50);
    }
  },

  /**
   * Handles updates on the installation progress of a module.
   * Updates the progress bar and status message based on the information received in the server-sent event.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module being installed.
   * @param {Object} stageDetails - Detailed information about the installation progress.
   */
  cbAfterReceiveNewInstallationStatus: function cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails) {
    // Check module installation status
    if (stageDetails.data.i_status === 'INSTALLATION_IN_PROGRESS') {
      var installationProgress = Math.round(parseInt(stageDetails.data.i_status_progress, 10) / 2 + 50);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, installationProgress);
    } else if (stageDetails.data.i_status === 'INSTALLATION_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, 100);
    }
  },

  /**
   * Resets the UI elements associated with a module row to their default state.
   * This is typically called after an installation process completes or fails.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   */
  resetButtonView: function resetButtonView($row) {
    $('a.button').removeClass('disabled');
    $row.find('i.loading').removeClass('spinner loading');
    $row.find('a.download i').addClass('download');
    $row.find('a.update i').addClass('redo');
  },

  /**
   * Displays an error message related to module installation in the UI.
   * This function is called when an installation fails, providing feedback to the user.
   *
   * @param {jQuery} $row - The jQuery object representing the row in the UI associated with the module.
   * @param {string} header - The header text for the error message.
   * @param {Object} messages - Detailed error messages to be displayed.
   */
  showModuleInstallationError: function showModuleInstallationError($row, header) {
    var messages = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';

    if (messages === undefined) {
      return;
    }

    if ($row.length === 0) {
      UserMessage.showMultiString(messages, header);
      $('#add-new-button').removeClass('loading');
      return;
    }

    installStatusLoopWorker.resetButtonView($row);

    if (messages.license !== undefined) {
      var manageLink = "<br>".concat(globalTranslate.lic_ManageLicense, " <a href=\"").concat(Config.keyManagementUrl, "\" target=\"_blank\">").concat(Config.keyManagementSite, "</a>");
      messages.license.push(manageLink);
    }

    var textDescription = UserMessage.convertToText(messages);
    var htmlMessage = "<tr class=\"ui error center aligned table-error-messages\"><td colspan=\"5\"><div class=\"ui header\">".concat(header, "</div><p>").concat(textDescription, "</p></div></td></tr>");
    $row.addClass('error');
    $row.before(htmlMessage);
  },

  /**
   * Updates the progress bar and status message to reflect the current state of a module installation process.
   * This function is used throughout different stages of installation to provide real-time feedback to the user.
   *
   * @param {string} moduleUniqueId - The unique identifier of the module.
   * @param {string} header - The status message to be displayed above the progress bar.
   * @param {number} [percent=0] - The current progress percentage to be reflected in the progress bar.
   */
  updateProgressBar: function updateProgressBar(moduleUniqueId, header) {
    var percent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;

    if (moduleUniqueId === undefined || moduleUniqueId === '') {
      return;
    }

    var moduleName = $("tr.new-module-row[data-id=".concat(moduleUniqueId, "]")).data('name');

    if (moduleName === undefined) {
      moduleName = '';
    }

    installStatusLoopWorker.$progressBarBlock.show();
    installStatusLoopWorker.$progressBar.show();

    if (header) {
      var barText = moduleName + ': ' + header;
      installStatusLoopWorker.$progressBarLabel.text(barText);
    }

    if (percent > 0) {
      installStatusLoopWorker.$progressBar.progress({
        percent: percent
      });
    }
  }
}; // Initializes the installStatusLoopWorker module when the DOM is fully loaded.

$(document).ready(function () {
  installStatusLoopWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsIiRwcm9ncmVzc0JhciIsIiQiLCIkcHJvZ3Jlc3NCYXJCbG9jayIsIiRwcm9ncmVzc0JhckxhYmVsIiwiZXZlbnRTb3VyY2UiLCJjaGFubmVsSWQiLCJpbml0aWFsaXplIiwic3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucyIsImxhc3RFdmVudElkS2V5IiwibGFzdEV2ZW50SWQiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwic3ViUGF0aCIsIkV2ZW50U291cmNlIiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCJyZXNwb25zZSIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJjb25zb2xlIiwiZGVidWciLCJwcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uIiwic2V0SXRlbSIsIm1vZHVsZVVuaXF1ZUlkIiwic3RhZ2UiLCJzdGFnZURldGFpbHMiLCIkcm93IiwidXBkYXRlUHJvZ3Jlc3NCYXIiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfR2V0UmVsZWFzZUluUHJvZ3Jlc3MiLCJleHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcyIsImNiQWZ0ZXJSZWNlaXZlTmV3RG93bmxvYWRTdGF0dXMiLCJjYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyIsImNiQWZ0ZXJSZWNlaXZlTmV3SW5zdGFsbGF0aW9uU3RhdHVzIiwicmVzdWx0IiwiaGlkZSIsIm1lc3NhZ2VzIiwidW5kZWZpbmVkIiwic2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yIiwiZXh0X0luc3RhbGxhdGlvbkVycm9yIiwid2luZG93IiwibG9jYXRpb24iLCJnbG9iYWxSb290VXJsIiwiZF9zdGF0dXMiLCJkb3dubG9hZFByb2dyZXNzIiwiTWF0aCIsIm1heCIsInJvdW5kIiwicGFyc2VJbnQiLCJkX3N0YXR1c19wcm9ncmVzcyIsImV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MiLCJleHRfVXBsb2FkSW5Qcm9ncmVzcyIsImlfc3RhdHVzIiwiaW5zdGFsbGF0aW9uUHJvZ3Jlc3MiLCJpX3N0YXR1c19wcm9ncmVzcyIsImV4dF9JbnN0YWxsYXRpb25JblByb2dyZXNzIiwicmVzZXRCdXR0b25WaWV3IiwicmVtb3ZlQ2xhc3MiLCJmaW5kIiwiYWRkQ2xhc3MiLCJoZWFkZXIiLCJsZW5ndGgiLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsImxpY2Vuc2UiLCJtYW5hZ2VMaW5rIiwibGljX01hbmFnZUxpY2Vuc2UiLCJDb25maWciLCJrZXlNYW5hZ2VtZW50VXJsIiwia2V5TWFuYWdlbWVudFNpdGUiLCJwdXNoIiwidGV4dERlc2NyaXB0aW9uIiwiY29udmVydFRvVGV4dCIsImh0bWxNZXNzYWdlIiwiYmVmb3JlIiwicGVyY2VudCIsIm1vZHVsZU5hbWUiLCJzaG93IiwiYmFyVGV4dCIsInRleHQiLCJwcm9ncmVzcyIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHVCQUF1QixHQUFHO0FBQzVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsWUFBWSxFQUFFQyxDQUFDLENBQUMsc0JBQUQsQ0FOYTs7QUFRNUI7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxpQkFBaUIsRUFBRUQsQ0FBQyxDQUFDLDRCQUFELENBYlE7O0FBZTVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUUsRUFBQUEsaUJBQWlCLEVBQUVGLENBQUMsQ0FBQyw0QkFBRCxDQXBCUTs7QUFzQjVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUcsRUFBQUEs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QUosRUFBVztBQUNQLFVBQU1rQixPQUFPLEdBQUVGLFVBQVUsR0FBQyxJQUFYLEdBQWdCaEIsTUFBL0I7QUFDQTlELE1BQUFBLHVCQUF1QixDQUFDSSxpQkFBeEIsQ0FBMEM2RSxJQUExQyxDQUErQ0QsT0FBL0M7QUFDSDs7QUFDRCxRQUFJSCxPQUFPLEdBQUMsQ0FBWixFQUFjO0FBQ1Y3RSxNQUFBQSx1QkFBdUIsQ0FBQ0MsWUFBeEIsQ0FBcUNpRixRQUFyQyxDQUE4QztBQUMxQ0wsUUFBQUEsT0FBTyxFQUFFQTtBQURpQyxPQUE5QztBQUdIO0FBQ0o7QUF6TjJCLENBQWhDLEMsQ0E0TkE7O0FBQ0EzRSxDQUFDLENBQUNpRixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCcEYsRUFBQUEsdUJBQXVCLENBQUNPLFVBQXhCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UgKi9cblxuLyoqXG4gKiBIYW5kbGVzIHJlYWwtdGltZSBtb25pdG9yaW5nIGFuZCB1cGRhdGVzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24gc3RhdHVzZXMuXG4gKiBVdGlsaXplcyBzZXJ2ZXItc2VudCBldmVudHMgdG8gcmVjZWl2ZSB1cGRhdGVzIGFuZCByZWZsZWN0cyB0aGVzZSBjaGFuZ2VzIGluIHRoZSBVSSxcbiAqIHBhcnRpY3VsYXJseSBpbiB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZXMgZGlzcGxheWVkIHRvIHRoZSB1c2VyLlxuICpcbiAqIEBtb2R1bGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgPSB7XG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBwcm9ncmVzcyBiYXIgZWxlbWVudCBpbiB0aGUgRE9NLlxuICAgICAqIFVzZWQgdG8gdmlzdWFsbHkgaW5kaWNhdGUgdGhlIHByb2dyZXNzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgY29udGFpbmVyIG9mIHRoZSBwcm9ncmVzcyBiYXIuXG4gICAgICogVGhpcyBlbGVtZW50IGlzIHNob3duIGFuZCBoaWRkZW4gYmFzZWQgb24gdGhlIHByZXNlbmNlIG9mIGFjdGl2ZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlIHByb2Nlc3Nlcy5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhckJsb2NrOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhci1ibG9jaycpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBsYWJlbCBlbGVtZW50IGFzc29jaWF0ZWQgd2l0aCB0aGUgcHJvZ3Jlc3MgYmFyLlxuICAgICAqIFVzZWQgdG8gZGlzcGxheSB0ZXh0dWFsIGluZm9ybWF0aW9uIGFib3V0IHRoZSBjdXJyZW50IHN0YWdlIG9mIHRoZSBpbnN0YWxsYXRpb24gb3IgdXBkYXRlIHByb2Nlc3MuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXItbGFiZWwnKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBFdmVudFNvdXJjZSBvYmplY3QgdXNlZCBmb3IgcmVjZWl2aW5nIHJlYWwtdGltZSB1cGRhdGVzIGZyb20gdGhlIHNlcnZlciBhYm91dCBtb2R1bGUgaW5zdGFsbGF0aW9uIHN0YXR1c2VzLlxuICAgICAqIFRoaXMgYWxsb3dzIGZvciBhIHB1c2gtYmFzZWQgbWVjaGFuaXNtIHRvIGtlZXAgdGhlIFVJIHVwZGF0ZWQgd2l0aCB0aGUgbGF0ZXN0IHByb2dyZXNzIGluZm9ybWF0aW9uLlxuICAgICAqIEB0eXBlIHtFdmVudFNvdXJjZX1cbiAgICAgKi9cbiAgICBldmVudFNvdXJjZTogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBpZGVudGlmaWVyIGZvciB0aGUgUFVCL1NVQiBjaGFubmVsIHVzZWQgdG8gc3Vic2NyaWJlIHRvIGluc3RhbGxhdGlvbiBzdGF0dXMgdXBkYXRlcy5cbiAgICAgKiBUaGlzIGVuc3VyZXMgdGhhdCB0aGUgY2xpZW50IGlzIGxpc3RlbmluZyBvbiB0aGUgY29ycmVjdCBjaGFubmVsIGZvciByZWxldmFudCBldmVudHMuXG4gICAgICovXG4gICAgY2hhbm5lbElkOiAnaW5zdGFsbC1tb2R1bGUnLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIGluc3RhbGxTdGF0dXNMb29wV29ya2VyIG1vZHVsZSBieSBzZXR0aW5nIHVwIHRoZSBjb25uZWN0aW9uIHRvIHJlY2VpdmUgc2VydmVyLXNlbnQgZXZlbnRzLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKXtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucygpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBFc3RhYmxpc2hlcyBhIGNvbm5lY3Rpb24gdG8gdGhlIHNlcnZlciB0byBzdGFydCByZWNlaXZpbmcgcmVhbC10aW1lIHVwZGF0ZXMgb24gbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9ncmVzcy5cbiAgICAgKiBVdGlsaXplcyB0aGUgRXZlbnRTb3VyY2UgQVBJIHRvIGxpc3RlbiBmb3IgbWVzc2FnZXMgb24gYSBzcGVjaWZpZWQgY2hhbm5lbC5cbiAgICAgKi9cbiAgICBzdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zKCkge1xuICAgICAgICBjb25zdCBsYXN0RXZlbnRJZEtleSA9IGAke2luc3RhbGxTdGF0dXNMb29wV29ya2VyLmNoYW5uZWxJZH0tbGFzdEV2ZW50SWRgO1xuICAgICAgICBsZXQgbGFzdEV2ZW50SWQgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShsYXN0RXZlbnRJZEtleSk7XG4gICAgICAgIGNvbnN0IHN1YlBhdGggPSBsYXN0RXZlbnRJZCA/IGAvcGJ4Y29yZS9hcGkvbmNoYW4vc3ViLyR7aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfT9sYXN0X2V2ZW50X2lkPSR7bGFzdEV2ZW50SWR9YCA6IGAvcGJ4Y29yZS9hcGkvbmNoYW4vc3ViLyR7aW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2hhbm5lbElkfWA7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmV2ZW50U291cmNlID0gbmV3IEV2ZW50U291cmNlKHN1YlBhdGgpO1xuXG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmV2ZW50U291cmNlLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gSlNPTi5wYXJzZShlLmRhdGEpO1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZyhyZXNwb25zZSk7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5wcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uKHJlc3BvbnNlKTtcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGxhc3RFdmVudElkS2V5LCBlLmxhc3RFdmVudElkKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFByb2Nlc3NlcyBpbmNvbWluZyBzZXJ2ZXItc2VudCBldmVudHMgcmVsYXRlZCB0byBtb2R1bGUgaW5zdGFsbGF0aW9uLlxuICAgICAqIFVwZGF0ZXMgdGhlIFVJIGJhc2VkIG9uIHRoZSBjdXJyZW50IHN0YWdlIG9mIGluc3RhbGxhdGlvbiwgZG93bmxvYWQsIHVwbG9hZCwgb3IgZXJyb3Igc3RhdGVzLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIC0gVGhlIGRhdGEgcGF5bG9hZCBvZiB0aGUgc2VydmVyLXNlbnQgZXZlbnQsIGNvbnRhaW5pbmcgZGV0YWlscyBhYm91dCB0aGUgaW5zdGFsbGF0aW9uIHN0YWdlIGFuZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBwcm9jZXNzTW9kdWxlSW5zdGFsbGF0aW9uKHJlc3BvbnNlKXtcbiAgICAgICAgY29uc3QgbW9kdWxlVW5pcXVlSWQgPSByZXNwb25zZS5tb2R1bGVVbmlxdWVJZDtcbiAgICAgICAgY29uc3Qgc3RhZ2UgPSByZXNwb25zZS5zdGFnZTtcbiAgICAgICAgY29uc3Qgc3RhZ2VEZXRhaWxzID0gcmVzcG9uc2Uuc3RhZ2VEZXRhaWxzO1xuICAgICAgICBjb25zdCAkcm93ID0gJChgdHJbZGF0YS1pZD0ke21vZHVsZVVuaXF1ZUlkfV1gKTtcbiAgICAgICAgaWYgKHN0YWdlID09PSdTdGFnZV9JX0dldFJlbGVhc2UnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0dldFJlbGVhc2VJblByb2dyZXNzLCAxKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lJX0NoZWNrTGljZW5zZScpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcywgMik7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9JSUlfR2V0RG93bmxvYWRMaW5rJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9DaGVja0xpY2Vuc2VJblByb2dyZXNzLCAzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lWX0Rvd25sb2FkTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld0Rvd25sb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfSV9VcGxvYWRNb2R1bGUnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmNiQWZ0ZXJSZWNlaXZlTmV3VXBsb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfVl9JbnN0YWxsTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld0luc3RhbGxhdGlvblN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX1ZJX0VuYWJsZU1vZHVsZScpe1xuXG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9WSUlfRmluYWxTdGF0dXMnKXtcbiAgICAgICAgICAgIGlmIChzdGFnZURldGFpbHMucmVzdWx0PT09ZmFsc2Upe1xuICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0JhckJsb2NrLmhpZGUoKTtcbiAgICAgICAgICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLm1lc3NhZ2VzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IsIHN0YWdlRGV0YWlscy5tZXNzYWdlcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc2hvd01vZHVsZUluc3RhbGxhdGlvbkVycm9yKCRyb3csIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7Z2xvYmFsUm9vdFVybH1wYngtZXh0ZW5zaW9uLW1vZHVsZXMvaW5kZXgvYDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBVSSB0byByZWZsZWN0IHRoZSBwcm9ncmVzcyBvZiBhIG1vZHVsZSBkb3dubG9hZC5cbiAgICAgKiBBZGp1c3RzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIGJhc2VkIG9uIHRoZSBkZXRhaWxzIHByb3ZpZGVkIGluIHRoZSBzZXJ2ZXItc2VudCBldmVudC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZCAtIFRoZSB1bmlxdWUgaWRlbnRpZmllciBvZiB0aGUgbW9kdWxlIGJlaW5nIGRvd25sb2FkZWQuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHN0YWdlRGV0YWlscyAtIERldGFpbGVkIGluZm9ybWF0aW9uIGFib3V0IHRoZSBkb3dubG9hZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld0Rvd25sb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpIHtcbiAgICAgICAgLy8gQ2hlY2sgbW9kdWxlIGRvd25sb2FkIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXMgPT09ICdET1dOTE9BRF9JTl9QUk9HUkVTUycpIHtcbiAgICAgICAgICAgIGNvbnN0IGRvd25sb2FkUHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLnJvdW5kKHBhcnNlSW50KHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzX3Byb2dyZXNzLCAxMCkvMiktMSwgMyk7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MsIGRvd25sb2FkUHJvZ3Jlc3MpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzID09PSAnRE9XTkxPQURfQ09NUExFVEUnKSB7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MsIDUwKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBVSSB0byByZWZsZWN0IHRoZSBwcm9ncmVzcyBvZiBhIG1vZHVsZSB1cGxvYWQuXG4gICAgICogQWRqdXN0cyB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZSBiYXNlZCBvbiB0aGUgZGV0YWlscyBwcm92aWRlZCBpbiB0aGUgc2VydmVyLXNlbnQgZXZlbnQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIG1vZHVsZSBiZWluZyB1cGxvYWRlZC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gc3RhZ2VEZXRhaWxzIC0gRGV0YWlsZWQgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHVwbG9hZCBwcm9ncmVzcy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKSB7XG4gICAgICAgIC8vIENoZWNrIG1vZHVsZSB1cGxvYWQgc3RhdHVzXG4gICAgICAgIGlmIChzdGFnZURldGFpbHMuZGF0YS5kX3N0YXR1cyA9PT0gJ1VQTE9BRF9JTl9QUk9HUkVTUycpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEluUHJvZ3Jlc3MsIDQ5KTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZURldGFpbHMuZGF0YS5kX3N0YXR1cyA9PT0gJ1VQTE9BRF9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEluUHJvZ3Jlc3MsIDUwKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIHVwZGF0ZXMgb24gdGhlIGluc3RhbGxhdGlvbiBwcm9ncmVzcyBvZiBhIG1vZHVsZS5cbiAgICAgKiBVcGRhdGVzIHRoZSBwcm9ncmVzcyBiYXIgYW5kIHN0YXR1cyBtZXNzYWdlIGJhc2VkIG9uIHRoZSBpbmZvcm1hdGlvbiByZWNlaXZlZCBpbiB0aGUgc2VydmVyLXNlbnQgZXZlbnQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWQgLSBUaGUgdW5pcXVlIGlkZW50aWZpZXIgb2YgdGhlIG1vZHVsZSBiZWluZyBpbnN0YWxsZWQuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHN0YWdlRGV0YWlscyAtIERldGFpbGVkIGluZm9ybWF0aW9uIGFib3V0IHRoZSBpbnN0YWxsYXRpb24gcHJvZ3Jlc3MuXG4gICAgICovXG4gICAgY2JBZnRlclJlY2VpdmVOZXdJbnN0YWxsYXRpb25TdGF0dXMobW9kdWxlVW5pcXVlSWQsIHN0YWdlRGV0YWlscykge1xuICAgICAgICAvLyBDaGVjayBtb2R1bGUgaW5zdGFsbGF0aW9uIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fSU5fUFJPR1JFU1MnKSB7XG4gICAgICAgICAgICBjb25zdCBpbnN0YWxsYXRpb25Qcm9ncmVzcyA9IE1hdGgucm91bmQocGFyc2VJbnQoc3RhZ2VEZXRhaWxzLmRhdGEuaV9zdGF0dXNfcHJvZ3Jlc3MsIDEwKS8yKzUwKTtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MsIGluc3RhbGxhdGlvblByb2dyZXNzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZURldGFpbHMuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MsIDEwMCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVzZXRzIHRoZSBVSSBlbGVtZW50cyBhc3NvY2lhdGVkIHdpdGggYSBtb2R1bGUgcm93IHRvIHRoZWlyIGRlZmF1bHQgc3RhdGUuXG4gICAgICogVGhpcyBpcyB0eXBpY2FsbHkgY2FsbGVkIGFmdGVyIGFuIGluc3RhbGxhdGlvbiBwcm9jZXNzIGNvbXBsZXRlcyBvciBmYWlscy5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkcm93IC0gVGhlIGpRdWVyeSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSByb3cgaW4gdGhlIFVJIGFzc29jaWF0ZWQgd2l0aCB0aGUgbW9kdWxlLlxuICAgICAqL1xuICAgIHJlc2V0QnV0dG9uVmlldygkcm93KXtcbiAgICAgICAgJCgnYS5idXR0b24nKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgJHJvdy5maW5kKCdpLmxvYWRpbmcnKS5yZW1vdmVDbGFzcygnc3Bpbm5lciBsb2FkaW5nJyk7XG4gICAgICAgICRyb3cuZmluZCgnYS5kb3dubG9hZCBpJykuYWRkQ2xhc3MoJ2Rvd25sb2FkJyk7XG4gICAgICAgICRyb3cuZmluZCgnYS51cGRhdGUgaScpLmFkZENsYXNzKCdyZWRvJyk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIERpc3BsYXlzIGFuIGVycm9yIG1lc3NhZ2UgcmVsYXRlZCB0byBtb2R1bGUgaW5zdGFsbGF0aW9uIGluIHRoZSBVSS5cbiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCB3aGVuIGFuIGluc3RhbGxhdGlvbiBmYWlscywgcHJvdmlkaW5nIGZlZWRiYWNrIHRvIHRoZSB1c2VyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtqUXVlcnl9ICRyb3cgLSBUaGUgalF1ZXJ5IG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHJvdyBpbiB0aGUgVUkgYXNzb2NpYXRlZCB3aXRoIHRoZSBtb2R1bGUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhlYWRlciAtIFRoZSBoZWFkZXIgdGV4dCBmb3IgdGhlIGVycm9yIG1lc3NhZ2UuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IG1lc3NhZ2VzIC0gRGV0YWlsZWQgZXJyb3IgbWVzc2FnZXMgdG8gYmUgZGlzcGxheWVkLlxuICAgICAqL1xuICAgIHNob3dNb2R1bGVJbnN0YWxsYXRpb25FcnJvcigkcm93LCBoZWFkZXIsIG1lc3NhZ2VzPScnKSB7XG4gICAgICAgIGlmIChtZXNzYWdlcz09PXVuZGVmaW5lZCl7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCRyb3cubGVuZ3RoPT09MCl7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcobWVzc2FnZXMsIGhlYWRlcik7XG4gICAgICAgICAgICAkKCcjYWRkLW5ldy1idXR0b24nKS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnJlc2V0QnV0dG9uVmlldygkcm93KTtcbiAgICAgICAgaWYgKG1lc3NhZ2VzLmxpY2Vuc2UhPT11bmRlZmluZWQpe1xuICAgICAgICAgICAgY29uc3QgbWFuYWdlTGluayA9IGA8YnI+JHtnbG9iYWxUcmFuc2xhdGUubGljX01hbmFnZUxpY2Vuc2V9IDxhIGhyZWY9XCIke0NvbmZpZy5rZXlNYW5hZ2VtZW50VXJsfVwiIHRhcmdldD1cIl9ibGFua1wiPiR7Q29uZmlnLmtleU1hbmFnZW1lbnRTaXRlfTwvYT5gO1xuICAgICAgICAgICAgbWVzc2FnZXMubGljZW5zZS5wdXNoKG1hbmFnZUxpbmspO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRleHREZXNjcmlwdGlvbiA9IFVzZXJNZXNzYWdlLmNvbnZlcnRUb1RleHQobWVzc2FnZXMpO1xuICAgICAgICBjb25zdCBodG1sTWVzc2FnZT0gIGA8dHIgY2xhc3M9XCJ1aSBlcnJvciBjZW50ZXIgYWxpZ25lZCB0YWJsZS1lcnJvci1tZXNzYWdlc1wiPjx0ZCBjb2xzcGFuPVwiNVwiPjxkaXYgY2xhc3M9XCJ1aSBoZWFkZXJcIj4ke2hlYWRlcn08L2Rpdj48cD4ke3RleHREZXNjcmlwdGlvbn08L3A+PC9kaXY+PC90ZD48L3RyPmA7XG4gICAgICAgICRyb3cuYWRkQ2xhc3MoJ2Vycm9yJyk7XG4gICAgICAgICRyb3cuYmVmb3JlKGh0bWxNZXNzYWdlKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgcHJvZ3Jlc3MgYmFyIGFuZCBzdGF0dXMgbWVzc2FnZSB0byByZWZsZWN0IHRoZSBjdXJyZW50IHN0YXRlIG9mIGEgbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9jZXNzLlxuICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCB0aHJvdWdob3V0IGRpZmZlcmVudCBzdGFnZXMgb2YgaW5zdGFsbGF0aW9uIHRvIHByb3ZpZGUgcmVhbC10aW1lIGZlZWRiYWNrIHRvIHRoZSB1c2VyLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZVVuaXF1ZUlkIC0gVGhlIHVuaXF1ZSBpZGVudGlmaWVyIG9mIHRoZSBtb2R1bGUuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhlYWRlciAtIFRoZSBzdGF0dXMgbWVzc2FnZSB0byBiZSBkaXNwbGF5ZWQgYWJvdmUgdGhlIHByb2dyZXNzIGJhci5cbiAgICAgKiBAcGFyYW0ge251bWJlcn0gW3BlcmNlbnQ9MF0gLSBUaGUgY3VycmVudCBwcm9ncmVzcyBwZXJjZW50YWdlIHRvIGJlIHJlZmxlY3RlZCBpbiB0aGUgcHJvZ3Jlc3MgYmFyLlxuICAgICAqL1xuICAgIHVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBoZWFkZXIsIHBlcmNlbnQ9MCl7XG4gICAgICAgIGlmIChtb2R1bGVVbmlxdWVJZCA9PT0gdW5kZWZpbmVkIHx8IG1vZHVsZVVuaXF1ZUlkID09PSAnJyl7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbGV0IG1vZHVsZU5hbWUgPSAkKGB0ci5uZXctbW9kdWxlLXJvd1tkYXRhLWlkPSR7bW9kdWxlVW5pcXVlSWR9XWApLmRhdGEoJ25hbWUnKTtcbiAgICAgICAgaWYgKG1vZHVsZU5hbWUgPT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICBtb2R1bGVOYW1lID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuJHByb2dyZXNzQmFyQmxvY2suc2hvdygpO1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXIuc2hvdygpO1xuICAgICAgICBpZiAoaGVhZGVyKXtcbiAgICAgICAgICAgIGNvbnN0IGJhclRleHQ9IG1vZHVsZU5hbWUrJzogJytoZWFkZXI7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGJhclRleHQpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwZXJjZW50PjApe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuJHByb2dyZXNzQmFyLnByb2dyZXNzKHtcbiAgICAgICAgICAgICAgICBwZXJjZW50OiBwZXJjZW50LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG4vLyBJbml0aWFsaXplcyB0aGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgbW9kdWxlIHdoZW4gdGhlIERPTSBpcyBmdWxseSBsb2FkZWQuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaW5pdGlhbGl6ZSgpO1xufSk7Il19