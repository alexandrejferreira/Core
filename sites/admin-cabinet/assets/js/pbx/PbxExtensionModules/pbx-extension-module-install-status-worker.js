"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Monitors the status of module installation.
 *
 * @module installStatusLoopWorker
 */
var installStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status request.
   * @type {number}
   */
  timeOut: 1000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * The file path of the module being installed.
   * @type {string}
   */
  filePath: '',

  /**
   * The number of iterations performed.
   * @type {number}
   */
  iterations: 0,

  /**
   * The previous progress percentage.
   * @type {string}
   */
  oldPercent: '0',

  /**
   * Flag indicating if enabling is needed after installation.
   * @type {boolean}
   */
  needEnableAfterInstall: false,

  /**
   * The progress bar label element.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * Initializes the installStatusLoopWorker object.
   * @param {string} filePath - The file path of the module being installed.
   * @param {boolean} [needEnable=false] - Flag indicating if enabling is needed after installation.
   */
  initialize: function initialize(filePath) {
    var needEnable = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
    installStatusLoopWorker.filePath = filePath;
    installStatusLoopWorker.iterations = 0;
    installStatusLoopWorker.needEnableAfterInstall = needEnable;
    installStatusLoopWorker.restartWorker();
  },

  /**
   * Restarts the worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    installStatusLoopWorker.worker();
  },

  /**
   * Worker function for checking the installation status.
   */
  worker: function worker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    PbxApi.ModulesGetModuleInstallationStatus(installStatusLoopWorker.filePath, installStatusLoopWorker.cbAfterReceiveNewStatus);
  },

  /**
   * Callback function after receiving the new installation status.
   * @param {boolean} result - The result of the installation status check.
   * @param {object} response - The response object containing the installation status.
   */
  cbAfterReceiveNewStatus: function cbAfterReceiveNewStatus(result, response) {
    installStatusLoopWorker.iterations += 1;
    installStatusLoopWorker.timeoutHandle = window.setTimeout(installStatusLoopWorker.worker, installStatusLoopWorker.timeOut); // Check installation status

    if (result === false && installStatusLoopWorker.iterations < 50) {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    } else if (installStatusLoopWorker.iterations > 50 || response.data.i_status === 'INSTALLATION_ERROR' || response.data.i_status === 'PROGRESS_FILE_NOT_FOUND') {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
      UserMessage.showMultiString(response.messages, globalTranslate.ext_InstallationError);
    } else if (response.data.i_status === 'INSTALLATION_IN_PROGRESS') {
      installStatusLoopWorker.$progressBar.progress({
        percent: parseInt(response.data.i_status_progress, 10)
      });

      if (installStatusLoopWorker.oldPercent !== response.data.i_status_progress) {
        installStatusLoopWorker.iterations = 0;
      }

      installStatusLoopWorker.oldPercent = response.data.i_status_progress;
    } else if (response.data.i_status === 'INSTALLATION_COMPLETE') {
      installStatusLoopWorker.$progressBar.progress({
        percent: 100
      });

      if (installStatusLoopWorker.needEnableAfterInstall) {
        // Enable the installed module and redirect to the module index page
        PbxApi.ModulesEnableModule(installStatusLoopWorker.moduleUniqid, function () {
          window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
        });
      } else {
        // Redirect to the module index page
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }

      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZmlsZVBhdGgiLCJpdGVyYXRpb25zIiwib2xkUGVyY2VudCIsIm5lZWRFbmFibGVBZnRlckluc3RhbGwiLCIkcHJvZ3Jlc3NCYXIiLCIkIiwiaW5pdGlhbGl6ZSIsIm5lZWRFbmFibGUiLCJyZXN0YXJ0V29ya2VyIiwid2luZG93IiwiY2xlYXJUaW1lb3V0IiwidGltZW91dEhhbmRsZSIsIndvcmtlciIsIlBieEFwaSIsIk1vZHVsZXNHZXRNb2R1bGVJbnN0YWxsYXRpb25TdGF0dXMiLCJjYkFmdGVyUmVjZWl2ZU5ld1N0YXR1cyIsInJlc3VsdCIsInJlc3BvbnNlIiwic2V0VGltZW91dCIsImRhdGEiLCJpX3N0YXR1cyIsIlVzZXJNZXNzYWdlIiwic2hvd011bHRpU3RyaW5nIiwibWVzc2FnZXMiLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfSW5zdGFsbGF0aW9uRXJyb3IiLCJwcm9ncmVzcyIsInBlcmNlbnQiLCJwYXJzZUludCIsImlfc3RhdHVzX3Byb2dyZXNzIiwiTW9kdWxlc0VuYWJsZU1vZHVsZSIsIm1vZHVsZVVuaXFpZCIsImxvY2F0aW9uIiwiZ2xvYmFsUm9vdFVybCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUU1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxPQUFPLEVBQUUsSUFObUI7O0FBUTVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGFB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UUFBUSxDQUFDRSxJQUFULENBQWNVLGlCQUF6RCxFQUE0RTtBQUN4RWhDLFFBQUFBLHVCQUF1QixDQUFDSSxVQUF4QixHQUFxQyxDQUFyQztBQUNIOztBQUNESixNQUFBQSx1QkFBdUIsQ0FBQ0ssVUFBeEIsR0FBcUNlLFFBQVEsQ0FBQ0UsSUFBVCxDQUFjVSxpQkFBbkQ7QUFDSCxLQVJNLE1BUUEsSUFBSVosUUFBUSxDQUFDRSxJQUFULENBQWNDLFFBQWQsS0FBMkIsdUJBQS9CLEVBQXdEO0FBQzNEdkIsTUFBQUEsdUJBQXVCLENBQUNPLFlBQXhCLENBQXFDc0IsUUFBckMsQ0FBOEM7QUFDMUNDLFFBQUFBLE9BQU8sRUFBRTtBQURpQyxPQUE5Qzs7QUFHQSxVQUFJOUIsdUJBQXVCLENBQUNNLHNCQUE1QixFQUFvRDtBQUNoRDtBQUNBVSxRQUFBQSxNQUFNLENBQUNpQixtQkFBUCxDQUNJakMsdUJBQXVCLENBQUNrQyxZQUQ1QixFQUVJLFlBQU07QUFDRnRCLFVBQUFBLE1BQU0sQ0FBQ3VCLFFBQVAsYUFBcUJDLGFBQXJCO0FBQ0gsU0FKTDtBQU1ILE9BUkQsTUFRTztBQUNIO0FBQ0F4QixRQUFBQSxNQUFNLENBQUN1QixRQUFQLGFBQXFCQyxhQUFyQjtBQUNIOztBQUNEeEIsTUFBQUEsTUFBTSxDQUFDQyxZQUFQLENBQW9CYix1QkFBdUIsQ0FBQ2MsYUFBNUM7QUFDSDtBQUNKO0FBMUgyQixDQUFoQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UgKi9cblxuLyoqXG4gKiBNb25pdG9ycyB0aGUgc3RhdHVzIG9mIG1vZHVsZSBpbnN0YWxsYXRpb24uXG4gKlxuICogQG1vZHVsZSBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlclxuICovXG5jb25zdCBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgc3RhdHVzIHJlcXVlc3QuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0OiAxMDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3IgdGhlIHN0YXR1cyB3b3JrZXIuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0SGFuZGxlOiAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGZpbGUgcGF0aCBvZiB0aGUgbW9kdWxlIGJlaW5nIGluc3RhbGxlZC5cbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIGZpbGVQYXRoOiAnJyxcblxuICAgIC8qKlxuICAgICAqIFRoZSBudW1iZXIgb2YgaXRlcmF0aW9ucyBwZXJmb3JtZWQuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICBpdGVyYXRpb25zOiAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHByZXZpb3VzIHByb2dyZXNzIHBlcmNlbnRhZ2UuXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBvbGRQZXJjZW50OiAnMCcsXG5cbiAgICAvKipcbiAgICAgKiBGbGFnIGluZGljYXRpbmcgaWYgZW5hYmxpbmcgaXMgbmVlZGVkIGFmdGVyIGluc3RhbGxhdGlvbi5cbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBuZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsOiBmYWxzZSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBwcm9ncmVzcyBiYXIgbGFiZWwgZWxlbWVudC5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhcjogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXInKSxcblxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIGluc3RhbGxTdGF0dXNMb29wV29ya2VyIG9iamVjdC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGggLSBUaGUgZmlsZSBwYXRoIG9mIHRoZSBtb2R1bGUgYmVpbmcgaW5zdGFsbGVkLlxuICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW25lZWRFbmFibGU9ZmFsc2VdIC0gRmxhZyBpbmRpY2F0aW5nIGlmIGVuYWJsaW5nIGlzIG5lZWRlZCBhZnRlciBpbnN0YWxsYXRpb24uXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZShmaWxlUGF0aCwgbmVlZEVuYWJsZSA9IGZhbHNlKSB7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmZpbGVQYXRoID0gZmlsZVBhdGg7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPSAwO1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5uZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsID0gbmVlZEVuYWJsZTtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXN0YXJ0cyB0aGUgd29ya2VyLlxuICAgICAqL1xuICAgIHJlc3RhcnRXb3JrZXIoKSB7XG4gICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBXb3JrZXIgZnVuY3Rpb24gZm9yIGNoZWNraW5nIHRoZSBpbnN0YWxsYXRpb24gc3RhdHVzLlxuICAgICAqL1xuICAgIHdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgUGJ4QXBpLk1vZHVsZXNHZXRNb2R1bGVJbnN0YWxsYXRpb25TdGF0dXMoXG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5maWxlUGF0aCxcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmNiQWZ0ZXJSZWNlaXZlTmV3U3RhdHVzXG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIHJlY2VpdmluZyB0aGUgbmV3IGluc3RhbGxhdGlvbiBzdGF0dXMuXG4gICAgICogQHBhcmFtIHtib29sZWFufSByZXN1bHQgLSBUaGUgcmVzdWx0IG9mIHRoZSBpbnN0YWxsYXRpb24gc3RhdHVzIGNoZWNrLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgaW5zdGFsbGF0aW9uIHN0YXR1cy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld1N0YXR1cyhyZXN1bHQsIHJlc3BvbnNlKSB7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgKz0gMTtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSA9XG4gICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci53b3JrZXIsIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVPdXQpO1xuXG4gICAgICAgIC8vIENoZWNrIGluc3RhbGxhdGlvbiBzdGF0dXNcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2VcbiAgICAgICAgICAgICYmIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPCA1MCkge1xuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgfSBlbHNlIGlmIChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID4gNTBcbiAgICAgICAgICAgIHx8IHJlc3BvbnNlLmRhdGEuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fRVJST1InXG4gICAgICAgICAgICB8fCByZXNwb25zZS5kYXRhLmlfc3RhdHVzID09PSAnUFJPR1JFU1NfRklMRV9OT1RfRk9VTkQnXG4gICAgICAgICkge1xuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZS5tZXNzYWdlcywgZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25FcnJvcik7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9JTl9QUk9HUkVTUycpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0Jhci5wcm9ncmVzcyh7XG4gICAgICAgICAgICAgICAgcGVyY2VudDogcGFyc2VJbnQocmVzcG9uc2UuZGF0YS5pX3N0YXR1c19wcm9ncmVzcywgMTApLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIub2xkUGVyY2VudCAhPT0gcmVzcG9uc2UuZGF0YS5pX3N0YXR1c19wcm9ncmVzcykge1xuICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIub2xkUGVyY2VudCA9IHJlc3BvbnNlLmRhdGEuaV9zdGF0dXNfcHJvZ3Jlc3M7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0Jhci5wcm9ncmVzcyh7XG4gICAgICAgICAgICAgICAgcGVyY2VudDogMTAwLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIubmVlZEVuYWJsZUFmdGVySW5zdGFsbCkge1xuICAgICAgICAgICAgICAgIC8vIEVuYWJsZSB0aGUgaW5zdGFsbGVkIG1vZHVsZSBhbmQgcmVkaXJlY3QgdG8gdGhlIG1vZHVsZSBpbmRleCBwYWdlXG4gICAgICAgICAgICAgICAgUGJ4QXBpLk1vZHVsZXNFbmFibGVNb2R1bGUoXG4gICAgICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLm1vZHVsZVVuaXFpZCxcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7Z2xvYmFsUm9vdFVybH1wYngtZXh0ZW5zaW9uLW1vZHVsZXMvaW5kZXgvYDtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBSZWRpcmVjdCB0byB0aGUgbW9kdWxlIGluZGV4IHBhZ2VcbiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfXBieC1leHRlbnNpb24tbW9kdWxlcy9pbmRleC9gO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuIl19