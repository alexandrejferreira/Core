"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Monitors the status of module installation.
 *
 * @module installStatusLoopWorker
 */
var installStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status request.
   * @type {number}
   */
  timeOut: 1000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * The file path of the module being installed.
   * @type {string}
   */
  filePath: '',

  /**
   * The number of iterations performed.
   * @type {number}
   */
  iterations: 0,

  /**
   * The previous progress percentage.
   * @type {string}
   */
  oldPercent: '0',

  /**
   * Flag indicating if enabling is needed after installation.
   * @type {boolean}
   */
  needEnableAfterInstall: false,

  /**
   * Initializes the installStatusLoopWorker object.
   * @param {string} filePath - The file path of the module being installed.
   * @param {boolean} [needEnable=false] - Flag indicating if enabling is needed after installation.
   */
  initialize: function initialize(filePath) {
    var needEnable = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
    installStatusLoopWorker.filePath = filePath;
    installStatusLoopWorker.iterations = 0;
    installStatusLoopWorker.needEnableAfterInstall = needEnable;
    installStatusLoopWorker.restartWorker();
  },

  /**
   * Restarts the worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    installStatusLoopWorker.worker();
  },

  /**
   * Worker function for checking the installation status.
   */
  worker: function worker() {
    window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    PbxApi.ModulesGetModuleInstallationStatus(installStatusLoopWorker.filePath, installStatusLoopWorker.cbAfterReceiveNewStatus);
  },

  /**
   * Callback function after receiving the new installation status.
   * @param {boolean} result - The result of the installation status check.
   * @param {object} response - The response object containing the installation status.
   */
  cbAfterReceiveNewStatus: function cbAfterReceiveNewStatus(result, response) {
    installStatusLoopWorker.iterations += 1;
    installStatusLoopWorker.timeoutHandle = window.setTimeout(installStatusLoopWorker.worker, installStatusLoopWorker.timeOut); // Check installation status

    if (result === false && installStatusLoopWorker.iterations < 50) {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    } else if (installStatusLoopWorker.iterations > 50 || response.data.i_status === 'INSTALLATION_ERROR' || response.data.i_status === 'PROGRESS_FILE_NOT_FOUND') {
      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
      UserMessage.showMultiString(response.messages, globalTranslate.ext_InstallationError);
    } else if (response.data.i_status === 'INSTALLATION_IN_PROGRESS') {
      if (installStatusLoopWorker.oldPercent !== response.data.i_status_progress) {
        installStatusLoopWorker.iterations = 0;
      }

      installStatusLoopWorker.oldPercent = response.data.i_status_progress;
    } else if (response.data.i_status === 'INSTALLATION_COMPLETE') {
      if (installStatusLoopWorker.needEnableAfterInstall) {
        // Enable the installed module and redirect to the module index page
        PbxApi.ModulesEnableModule(installStatusLoopWorker.moduleUniqid, function () {
          window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
        });
      } else {
        // Redirect to the module index page
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      }

      window.clearTimeout(installStatusLoopWorker.timeoutHandle);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwiZmlsZVBhdGgiLCJpdGVyYXRpb25zIiwib2xkUGVyY2VudCIsIm5lZWRFbmFibGVBZnRlckluc3RhbGwiLCJpbml0aWFsaXplIiwibmVlZEVuYWJsZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiUGJ4QXBpIiwiTW9kdWxlc0dldE1vZHVsZUluc3RhbGxhdGlvblN0YXR1cyIsImNiQWZ0ZXJSZWNlaXZlTmV3U3RhdHVzIiwicmVzdWx0IiwicmVzcG9uc2UiLCJzZXRUaW1lb3V0IiwiZGF0YSIsImlfc3RhdHVzIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJtZXNzYWdlcyIsImdsb2JhbFRyYW5zbGF0ZSIsImV4dF9JbnN0YWxsYXRpb25FcnJvciIsImlfc3RhdHVzX3Byb2dyZXNzIiwiTW9kdWxlc0VuYWJsZU1vZHVsZSIsIm1vZHVsZVVuaXFpZCIsImxvY2F0aW9uIiwiZ2xvYmFsUm9vdFVybCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUU1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxPQUFPLEVBQUUsSUFObUI7O0FBUTVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGFBQWEsRUFBRSxDQVphOztBQWM1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFR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Q2hEO0FBQ0FRLFFBQUFBLE1BQU0sQ0FBQ2MsbUJBQVAsQ0FDSTVCLHVCQUF1QixDQUFDNkIsWUFENUIsRUFFSSxZQUFNO0FBQ0ZuQixVQUFBQSxNQUFNLENBQUNvQixRQUFQLGFBQXFCQyxhQUFyQjtBQUNILFNBSkw7QUFNSCxPQVJELE1BUU87QUFDSDtBQUNBckIsUUFBQUEsTUFBTSxDQUFDb0IsUUFBUCxhQUFxQkMsYUFBckI7QUFDSDs7QUFDRHJCLE1BQUFBLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQlgsdUJBQXVCLENBQUNZLGFBQTVDO0FBQ0g7QUFDSjtBQTdHMkIsQ0FBaEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgUGJ4QXBpLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlICovXG5cbi8qKlxuICogTW9uaXRvcnMgdGhlIHN0YXR1cyBvZiBtb2R1bGUgaW5zdGFsbGF0aW9uLlxuICpcbiAqIEBtb2R1bGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgPSB7XG5cbiAgICAvKipcbiAgICAgKiBUaW1lIGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgZmV0Y2hpbmcgbmV3IHN0YXR1cyByZXF1ZXN0LlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dDogMTAwMCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBpZCBvZiB0aGUgdGltZXIgZnVuY3Rpb24gZm9yIHRoZSBzdGF0dXMgd29ya2VyLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dEhhbmRsZTogMCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBmaWxlIHBhdGggb2YgdGhlIG1vZHVsZSBiZWluZyBpbnN0YWxsZWQuXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBmaWxlUGF0aDogJycsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgbnVtYmVyIG9mIGl0ZXJhdGlvbnMgcGVyZm9ybWVkLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgaXRlcmF0aW9uczogMCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBwcmV2aW91cyBwcm9ncmVzcyBwZXJjZW50YWdlLlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgb2xkUGVyY2VudDogJzAnLFxuXG4gICAgLyoqXG4gICAgICogRmxhZyBpbmRpY2F0aW5nIGlmIGVuYWJsaW5nIGlzIG5lZWRlZCBhZnRlciBpbnN0YWxsYXRpb24uXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgbmVlZEVuYWJsZUFmdGVySW5zdGFsbDogZmFsc2UsXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgb2JqZWN0LlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmaWxlUGF0aCAtIFRoZSBmaWxlIHBhdGggb2YgdGhlIG1vZHVsZSBiZWluZyBpbnN0YWxsZWQuXG4gICAgICogQHBhcmFtIHtib29sZWFufSBbbmVlZEVuYWJsZT1mYWxzZV0gLSBGbGFnIGluZGljYXRpbmcgaWYgZW5hYmxpbmcgaXMgbmVlZGVkIGFmdGVyIGluc3RhbGxhdGlvbi5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKGZpbGVQYXRoLCBuZWVkRW5hYmxlID0gZmFsc2UpIHtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuZmlsZVBhdGggPSBmaWxlUGF0aDtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA9IDA7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLm5lZWRFbmFibGVBZnRlckluc3RhbGwgPSBuZWVkRW5hYmxlO1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIud29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFdvcmtlciBmdW5jdGlvbiBmb3IgY2hlY2tpbmcgdGhlIGluc3RhbGxhdGlvbiBzdGF0dXMuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICBQYnhBcGkuTW9kdWxlc0dldE1vZHVsZUluc3RhbGxhdGlvblN0YXR1cyhcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmZpbGVQYXRoLFxuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuY2JBZnRlclJlY2VpdmVOZXdTdGF0dXNcbiAgICAgICAgKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgcmVjZWl2aW5nIHRoZSBuZXcgaW5zdGFsbGF0aW9uIHN0YXR1cy5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IHJlc3VsdCAtIFRoZSByZXN1bHQgb2YgdGhlIGluc3RhbGxhdGlvbiBzdGF0dXMgY2hlY2suXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIG9iamVjdCBjb250YWluaW5nIHRoZSBpbnN0YWxsYXRpb24gc3RhdHVzLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZWNlaXZlTmV3U3RhdHVzKHJlc3VsdCwgcmVzcG9uc2UpIHtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyArPSAxO1xuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlID1cbiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLndvcmtlciwgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudGltZU91dCk7XG5cbiAgICAgICAgLy8gQ2hlY2sgaW5zdGFsbGF0aW9uIHN0YXR1c1xuICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZVxuICAgICAgICAgICAgJiYgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA8IDUwKSB7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICB9IGVsc2UgaWYgKGluc3RhbGxTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPiA1MFxuICAgICAgICAgICAgfHwgcmVzcG9uc2UuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9FUlJPUidcbiAgICAgICAgICAgIHx8IHJlc3BvbnNlLmRhdGEuaV9zdGF0dXMgPT09ICdQUk9HUkVTU19GSUxFX05PVF9GT1VORCdcbiAgICAgICAgKSB7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd011bHRpU3RyaW5nKHJlc3BvbnNlLm1lc3NhZ2VzLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkVycm9yKTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kYXRhLmlfc3RhdHVzID09PSAnSU5TVEFMTEFUSU9OX0lOX1BST0dSRVNTJykge1xuICAgICAgICAgICAgaWYgKGluc3RhbGxTdGF0dXNMb29wV29ya2VyLm9sZFBlcmNlbnQgIT09IHJlc3BvbnNlLmRhdGEuaV9zdGF0dXNfcHJvZ3Jlc3MpIHtcbiAgICAgICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLm9sZFBlcmNlbnQgPSByZXNwb25zZS5kYXRhLmlfc3RhdHVzX3Byb2dyZXNzO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRhdGEuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fQ09NUExFVEUnKSB7XG4gICAgICAgICAgICBpZiAoaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIubmVlZEVuYWJsZUFmdGVySW5zdGFsbCkge1xuICAgICAgICAgICAgICAgIC8vIEVuYWJsZSB0aGUgaW5zdGFsbGVkIG1vZHVsZSBhbmQgcmVkaXJlY3QgdG8gdGhlIG1vZHVsZSBpbmRleCBwYWdlXG4gICAgICAgICAgICAgICAgUGJ4QXBpLk1vZHVsZXNFbmFibGVNb2R1bGUoXG4gICAgICAgICAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLm1vZHVsZVVuaXFpZCxcbiAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7Z2xvYmFsUm9vdFVybH1wYngtZXh0ZW5zaW9uLW1vZHVsZXMvaW5kZXgvYDtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBSZWRpcmVjdCB0byB0aGUgbW9kdWxlIGluZGV4IHBhZ2VcbiAgICAgICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfXBieC1leHRlbnNpb24tbW9kdWxlcy9pbmRleC9gO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuIl19