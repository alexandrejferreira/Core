"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage */

/**
 * Monitors the status of module installation.
 *
 * @module installStatusLoopWorker
 */
var installStatusLoopWorker = {
  /**
   * The progress bar element.
   * @type {jQuery}
   */
  $progressBar: $('#upload-progress-bar'),

  /**
   * The progress bar block.
   * @type {jQuery}
   */
  $progressBarBlock: $('#upload-progress-bar-block'),

  /**
   * The progress bar label element.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),

  /**
   * EventSource object for the module installation and upgrade status
   * @type {EventSource}
   */
  eventSource: null,

  /**
   * PUB/SUB channel ID
   */
  channelId: 'install-module',
  initialize: function initialize() {
    installStatusLoopWorker.startListenPushNotifications();
  },

  /**
   * Starts listen to push notifications from backend
   */
  startListenPushNotifications: function startListenPushNotifications() {
    var lastEventIdKey = "lastEventId";
    var lastEventId = localStorage.getItem(lastEventIdKey);
    var subPath = lastEventId ? "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId, "?last_event_id=").concat(lastEventId) : "/pbxcore/api/nchan/sub/".concat(installStatusLoopWorker.channelId);
    installStatusLoopWorker.eventSource = new EventSource(subPath);
    installStatusLoopWorker.eventSource.addEventListener('message', function (e) {
      var response = JSON.parse(e.data);
      console.log('New message: ', response);
      installStatusLoopWorker.processModuleInstallation(response);
      localStorage.setItem(lastEventIdKey, e.lastEventId);
    });
  },

  /**
   * Parses push events from backend and process them
   * @param {object} response
   */
  processModuleInstallation: function processModuleInstallation(response) {
    var moduleUniqueId = response.moduleUniqueId;
    var stage = response.stage;
    var stageDetails = response.stageDetails;
    var $row = $("#".concat(moduleUniqueId));

    if (stage === 'Stage_I_GetRelease') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_GetReleaseInProgress, 1);
    } else if (stage === 'Stage_II_CheckLicense') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 2);
    } else if (stage === 'Stage_III_GetDownloadLink') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_CheckLicenseInProgress, 3);
    } else if (stage === 'Stage_IV_DownloadModule') {
      installStatusLoopWorker.cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_I_UploadModule') {
      installStatusLoopWorker.cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_V_InstallModule') {
      installStatusLoopWorker.cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails);
    } else if (stage === 'Stage_VI_EnableModule') {} else if (stage === 'Stage_VII_FinalStatus') {
      if (stageDetails.result === true) {
        window.location = "".concat(globalRootUrl, "pbx-extension-modules/index/");
      } else {
        installStatusLoopWorker.$progressBarBlock.hide();

        if (stageDetails.messages !== undefined) {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError, stageDetails.messages);
        } else {
          installStatusLoopWorker.showModuleInstallationError($row, globalTranslate.ext_InstallationError);
        }
      }
    }
  },

  /**
   * Callback function to refresh the module download status.
   * @param {string} moduleUniqueId
   * @param {object} stageDetails - The response object containing the download status.
   */
  cbAfterReceiveNewDownloadStatus: function cbAfterReceiveNewDownloadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'DOWNLOAD_IN_PROGRESS') {
      var downloadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, downloadProgress);
    } else if (stageDetails.d_status === 'DOWNLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_DownloadInProgress, 50);
    }
  },

  /**
   * Callback function to refresh the module upload status.
   * @param {string} moduleUniqueId
   * @param {object} stageDetails - The response object containing the upload status.
   */
  cbAfterReceiveNewUploadStatus: function cbAfterReceiveNewUploadStatus(moduleUniqueId, stageDetails) {
    // Check module download status
    if (stageDetails.data.d_status === 'UPLOAD_IN_PROGRESS') {
      var uploadProgress = Math.max(Math.round(parseInt(stageDetails.data.d_status_progress, 10) / 2), 3);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, uploadProgress);
    } else if (stageDetails.d_status === 'UPLOAD_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_UploadInProgress, 50);
    }
  },

  /**
   * Callback function after receiving the new installation status.
   * @param {string} moduleUniqueId
   * @param {object} stageDetails - The response object containing the installation status.
   */
  cbAfterReceiveNewInstallationStatus: function cbAfterReceiveNewInstallationStatus(moduleUniqueId, stageDetails) {
    // Check module installation status
    if (stageDetails.data.i_status === 'INSTALLATION_IN_PROGRESS') {
      var installationProgress = Math.round(parseInt(stageDetails.data.i_status_progress, 10) / 2 + 50);
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, installationProgress);
    } else if (stageDetails.data.i_status === 'INSTALLATION_COMPLETE') {
      installStatusLoopWorker.updateProgressBar(moduleUniqueId, globalTranslate.ext_InstallationInProgress, 100);
    }
  },

  /**
   * Reset the download/update button to default stage
   * @param {jQuery} $row
   */
  resetButtonView: function resetButtonView($row) {
    $('a.button').removeClass('disabled');
    $row.find('i.loading').removeClass('spinner loading');
    $row.find('a.download i').addClass('download');
    $row.find('a.update i').addClass('redo');
  },

  /**
   * Shows module installation error above the module row
   * @param {jQuery} $row
   * @param {string} header
   * @param messages
   */
  showModuleInstallationError: function showModuleInstallationError($row, header) {
    var messages = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : '';
    installStatusLoopWorker.resetButtonView($row);

    if (messages.license !== undefined) {
      var manageLink = "<br>".concat(globalTranslate.lic_ManageLicense, " <a href=\"").concat(Config.keyManagementUrl, "\" target=\"_blank\">").concat(Config.keyManagementSite, "</a>");
      messages.license.push(manageLink);
    }

    var textDescription = UserMessage.convertToText(messages);
    var htmlMessage = "<tr class=\"ui error center aligned table-error-messages\"><td colspan=\"4\"><div class=\"ui header\">".concat(header, "</div><p>").concat(textDescription, "</p></div></td></tr>");
    $row.addClass('error');
    $row.before(htmlMessage);
  },

  /**
   * Shows module installation progress bar and installation status
   * @param {string} moduleUniqueId
   * @param {string} header
   * @param {int} percent
   */
  updateProgressBar: function updateProgressBar(moduleUniqueId, header) {
    var percent = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0;
    var moduleName = $("tr.new-module-row[data-id=".concat(moduleUniqueId, "]")).data('name');

    if (moduleName === undefined) {
      moduleName = '';
    }

    installStatusLoopWorker.$progressBarBlock.show();
    installStatusLoopWorker.$progressBar.show();

    if (header) {
      var barText = moduleName + ': ' + header;
      installStatusLoopWorker.$progressBarLabel.text(barText);
    }

    if (percent > 0) {
      installStatusLoopWorker.$progressBar.progress({
        percent: percent
      });
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLWluc3RhbGwtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsIiRwcm9ncmVzc0JhciIsIiQiLCIkcHJvZ3Jlc3NCYXJCbG9jayIsIiRwcm9ncmVzc0JhckxhYmVsIiwiZXZlbnRTb3VyY2UiLCJjaGFubmVsSWQiLCJpbml0aWFsaXplIiwic3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucyIsImxhc3RFdmVudElkS2V5IiwibGFzdEV2ZW50SWQiLCJsb2NhbFN0b3JhZ2UiLCJnZXRJdGVtIiwic3ViUGF0aCIsIkV2ZW50U291cmNlIiwiYWRkRXZlbnRMaXN0ZW5lciIsImUiLCJyZXNwb25zZSIsIkpTT04iLCJwYXJzZSIsImRhdGEiLCJjb25zb2xlIiwibG9nIiwicHJvY2Vzc01vZHVsZUluc3RhbGxhdGlvbiIsInNldEl0ZW0iLCJtb2R1bGVVbmlxdWVJZCIsInN0YWdlIiwic3RhZ2VEZXRhaWxzIiwiJHJvdyIsInVwZGF0ZVByb2dyZXNzQmFyIiwiZ2xvYmFsVHJhbnNsYXRlIiwiZXh0X0dldFJlbGVhc2VJblByb2dyZXNzIiwiZXh0X0NoZWNrTGljZW5zZUluUHJvZ3Jlc3MiLCJjYkFmdGVyUmVjZWl2ZU5ld0Rvd25sb2FkU3RhdHVzIiwiY2JBZnRlclJlY2VpdmVOZXdVcGxvYWRTdGF0dXMiLCJjYkFmdGVyUmVjZWl2ZU5ld0luc3RhbGxhdGlvblN0YXR1cyIsInJlc3VsdCIsIndpbmRvdyIsImxvY2F0aW9uIiwiZ2xvYmFsUm9vdFVybCIsImhpZGUiLCJtZXNzYWdlcyIsInVuZGVmaW5lZCIsInNob3dNb2R1bGVJbnN0YWxsYXRpb25FcnJvciIsImV4dF9JbnN0YWxsYXRpb25FcnJvciIsImRfc3RhdHVzIiwiZG93bmxvYWRQcm9ncmVzcyIsIk1hdGgiLCJtYXgiLCJyb3VuZCIsInBhcnNlSW50IiwiZF9zdGF0dXNfcHJvZ3Jlc3MiLCJleHRfRG93bmxvYWRJblByb2dyZXNzIiwidXBsb2FkUHJvZ3Jlc3MiLCJleHRfVXBsb2FkSW5Qcm9ncmVzcyIsImlfc3RhdHVzIiwiaW5zdGFsbGF0aW9uUHJvZ3Jlc3MiLCJpX3N0YXR1c19wcm9ncmVzcyIsImV4dF9JbnN0YWxsYXRpb25JblByb2dyZXNzIiwicmVzZXRCdXR0b25WaWV3IiwicmVtb3ZlQ2xhc3MiLCJmaW5kIiwiYWRkQ2xhc3MiLCJoZWFkZXIiLCJsaWNlbnNlIiwibWFuYWdlTGluayIsImxpY19NYW5hZ2VMaWNlbnNlIiwiQ29uZmlnIiwia2V5TWFuYWdlbWVudFVybCIsImtleU1hbmFnZW1lbnRTaXRlIiwicHVzaCIsInRleHREZXNjcmlwdGlvbiIsIlVzZXJNZXNzYWdlIiwiY29udmVydFRvVGV4dCIsImh0bWxNZXNzYWdlIiwiYmVmb3JlIiwicGVyY2VudCIsIm1vZHVsZU5hbWUiLCJzaG93IiwiYmFyVGV4dCIsInRleHQiLCJwcm9ncmVzcyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSx1QkFBdUIsR0FBRztBQUM1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxZQUFZLEVBQUVDLENBQUMsQ0FBQyxzQkFBRCxDQUxhOztBQU81QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxpQkFBaUIsRUFBRUQsQ0FBQyxDQUFDLDRCQUFELENBWFE7O0FBYTVCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lFLEVBQUFBLGlCQUFpQixFQUFFRixDQUFDLENBQUMsNEJBQUQsQ0FqQlE7O0FBbUI1QjtBQUNKO0FBQ0E7QUFDQTtBQUNJRyxFQUFBQSxXQUFXLEVBQUUsSUF2QmU7O0FBeUI1QjtBQUNKO0FBQ0E7QUFDSUMsRUFBQUEsU0FBUyxFQUFFLGdCQTVC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dXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgUGJ4QXBpLCBnbG9iYWxUcmFuc2xhdGUsIFVzZXJNZXNzYWdlICovXG5cbi8qKlxuICogTW9uaXRvcnMgdGhlIHN0YXR1cyBvZiBtb2R1bGUgaW5zdGFsbGF0aW9uLlxuICpcbiAqIEBtb2R1bGUgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgPSB7XG4gICAgLyoqXG4gICAgICogVGhlIHByb2dyZXNzIGJhciBlbGVtZW50LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhcicpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHByb2dyZXNzIGJhciBibG9jay5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRwcm9ncmVzc0JhckJsb2NrOiAkKCcjdXBsb2FkLXByb2dyZXNzLWJhci1ibG9jaycpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHByb2dyZXNzIGJhciBsYWJlbCBlbGVtZW50LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJHByb2dyZXNzQmFyTGFiZWw6ICQoJyN1cGxvYWQtcHJvZ3Jlc3MtYmFyLWxhYmVsJyksXG5cbiAgICAvKipcbiAgICAgKiBFdmVudFNvdXJjZSBvYmplY3QgZm9yIHRoZSBtb2R1bGUgaW5zdGFsbGF0aW9uIGFuZCB1cGdyYWRlIHN0YXR1c1xuICAgICAqIEB0eXBlIHtFdmVudFNvdXJjZX1cbiAgICAgKi9cbiAgICBldmVudFNvdXJjZTogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIFBVQi9TVUIgY2hhbm5lbCBJRFxuICAgICAqL1xuICAgIGNoYW5uZWxJZDogJ2luc3RhbGwtbW9kdWxlJyxcblxuICAgIGluaXRpYWxpemUoKXtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuc3RhcnRMaXN0ZW5QdXNoTm90aWZpY2F0aW9ucygpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTdGFydHMgbGlzdGVuIHRvIHB1c2ggbm90aWZpY2F0aW9ucyBmcm9tIGJhY2tlbmRcbiAgICAgKi9cbiAgICBzdGFydExpc3RlblB1c2hOb3RpZmljYXRpb25zKCkge1xuICAgICAgICBjb25zdCBsYXN0RXZlbnRJZEtleSA9IGBsYXN0RXZlbnRJZGA7XG4gICAgICAgIGxldCBsYXN0RXZlbnRJZCA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGxhc3RFdmVudElkS2V5KTtcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IGxhc3RFdmVudElkID8gYC9wYnhjb3JlL2FwaS9uY2hhbi9zdWIvJHtpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jaGFubmVsSWR9P2xhc3RfZXZlbnRfaWQ9JHtsYXN0RXZlbnRJZH1gIDogYC9wYnhjb3JlL2FwaS9uY2hhbi9zdWIvJHtpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jaGFubmVsSWR9YDtcbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuZXZlbnRTb3VyY2UgPSBuZXcgRXZlbnRTb3VyY2Uoc3ViUGF0aCk7XG5cbiAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuZXZlbnRTb3VyY2UuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBKU09OLnBhcnNlKGUuZGF0YSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnTmV3IG1lc3NhZ2U6ICcsIHJlc3BvbnNlKTtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnByb2Nlc3NNb2R1bGVJbnN0YWxsYXRpb24ocmVzcG9uc2UpO1xuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0obGFzdEV2ZW50SWRLZXksIGUubGFzdEV2ZW50SWQpO1xuICAgICAgICB9KTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIFBhcnNlcyBwdXNoIGV2ZW50cyBmcm9tIGJhY2tlbmQgYW5kIHByb2Nlc3MgdGhlbVxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZVxuICAgICAqL1xuICAgIHByb2Nlc3NNb2R1bGVJbnN0YWxsYXRpb24ocmVzcG9uc2Upe1xuICAgICAgICBjb25zdCBtb2R1bGVVbmlxdWVJZCA9IHJlc3BvbnNlLm1vZHVsZVVuaXF1ZUlkO1xuICAgICAgICBjb25zdCBzdGFnZSA9IHJlc3BvbnNlLnN0YWdlO1xuICAgICAgICBjb25zdCBzdGFnZURldGFpbHMgPSByZXNwb25zZS5zdGFnZURldGFpbHM7XG4gICAgICAgIGNvbnN0ICRyb3cgPSAkKGAjJHttb2R1bGVVbmlxdWVJZH1gKTtcbiAgICAgICAgaWYgKHN0YWdlID09PSdTdGFnZV9JX0dldFJlbGVhc2UnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0dldFJlbGVhc2VJblByb2dyZXNzLCAxKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lJX0NoZWNrTGljZW5zZScpe1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfQ2hlY2tMaWNlbnNlSW5Qcm9ncmVzcywgMik7XG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9JSUlfR2V0RG93bmxvYWRMaW5rJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9DaGVja0xpY2Vuc2VJblByb2dyZXNzLCAzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX0lWX0Rvd25sb2FkTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld0Rvd25sb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfSV9VcGxvYWRNb2R1bGUnKXtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmNiQWZ0ZXJSZWNlaXZlTmV3VXBsb2FkU3RhdHVzKG1vZHVsZVVuaXF1ZUlkLCBzdGFnZURldGFpbHMpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlID09PSAnU3RhZ2VfVl9JbnN0YWxsTW9kdWxlJyl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyUmVjZWl2ZU5ld0luc3RhbGxhdGlvblN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZSA9PT0gJ1N0YWdlX1ZJX0VuYWJsZU1vZHVsZScpe1xuXG4gICAgICAgIH0gZWxzZSBpZiAoc3RhZ2UgPT09ICdTdGFnZV9WSUlfRmluYWxTdGF0dXMnKXtcbiAgICAgICAgICAgIGlmIChzdGFnZURldGFpbHMucmVzdWx0PT09dHJ1ZSl7XG4gICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7Z2xvYmFsUm9vdFVybH1wYngtZXh0ZW5zaW9uLW1vZHVsZXMvaW5kZXgvYDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIuJHByb2dyZXNzQmFyQmxvY2suaGlkZSgpO1xuICAgICAgICAgICAgICAgIGlmIChzdGFnZURldGFpbHMubWVzc2FnZXMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5zaG93TW9kdWxlSW5zdGFsbGF0aW9uRXJyb3IoJHJvdywgZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25FcnJvciwgc3RhZ2VEZXRhaWxzLm1lc3NhZ2VzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci5zaG93TW9kdWxlSW5zdGFsbGF0aW9uRXJyb3IoJHJvdywgZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25FcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIHJlZnJlc2ggdGhlIG1vZHVsZSBkb3dubG9hZCBzdGF0dXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZVVuaXF1ZUlkXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHN0YWdlRGV0YWlscyAtIFRoZSByZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgZG93bmxvYWQgc3RhdHVzLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZWNlaXZlTmV3RG93bmxvYWRTdGF0dXMobW9kdWxlVW5pcXVlSWQsIHN0YWdlRGV0YWlscykge1xuICAgICAgICAvLyBDaGVjayBtb2R1bGUgZG93bmxvYWQgc3RhdHVzXG4gICAgICAgIGlmIChzdGFnZURldGFpbHMuZGF0YS5kX3N0YXR1cyA9PT0gJ0RPV05MT0FEX0lOX1BST0dSRVNTJykge1xuICAgICAgICAgICAgY29uc3QgZG93bmxvYWRQcm9ncmVzcyA9IE1hdGgubWF4KE1hdGgucm91bmQocGFyc2VJbnQoc3RhZ2VEZXRhaWxzLmRhdGEuZF9zdGF0dXNfcHJvZ3Jlc3MsIDEwKS8yKSwgMyk7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci51cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9Eb3dubG9hZEluUHJvZ3Jlc3MsIGRvd25sb2FkUHJvZ3Jlc3MpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlRGV0YWlscy5kX3N0YXR1cyA9PT0gJ0RPV05MT0FEX0NPTVBMRVRFJykge1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfRG93bmxvYWRJblByb2dyZXNzLCA1MCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gdG8gcmVmcmVzaCB0aGUgbW9kdWxlIHVwbG9hZCBzdGF0dXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IG1vZHVsZVVuaXF1ZUlkXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHN0YWdlRGV0YWlscyAtIFRoZSByZXNwb25zZSBvYmplY3QgY29udGFpbmluZyB0aGUgdXBsb2FkIHN0YXR1cy5cbiAgICAgKi9cbiAgICBjYkFmdGVyUmVjZWl2ZU5ld1VwbG9hZFN0YXR1cyhtb2R1bGVVbmlxdWVJZCwgc3RhZ2VEZXRhaWxzKSB7XG4gICAgICAgIC8vIENoZWNrIG1vZHVsZSBkb3dubG9hZCBzdGF0dXNcbiAgICAgICAgaWYgKHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzID09PSAnVVBMT0FEX0lOX1BST0dSRVNTJykge1xuICAgICAgICAgICAgY29uc3QgdXBsb2FkUHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLnJvdW5kKHBhcnNlSW50KHN0YWdlRGV0YWlscy5kYXRhLmRfc3RhdHVzX3Byb2dyZXNzLCAxMCkvMiksIDMpO1xuICAgICAgICAgICAgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIudXBkYXRlUHJvZ3Jlc3NCYXIobW9kdWxlVW5pcXVlSWQsIGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcywgdXBsb2FkUHJvZ3Jlc3MpO1xuICAgICAgICB9IGVsc2UgaWYgKHN0YWdlRGV0YWlscy5kX3N0YXR1cyA9PT0gJ1VQTE9BRF9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEluUHJvZ3Jlc3MsIDUwKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBhZnRlciByZWNlaXZpbmcgdGhlIG5ldyBpbnN0YWxsYXRpb24gc3RhdHVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtb2R1bGVVbmlxdWVJZFxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSBzdGFnZURldGFpbHMgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGluc3RhbGxhdGlvbiBzdGF0dXMuXG4gICAgICovXG4gICAgY2JBZnRlclJlY2VpdmVOZXdJbnN0YWxsYXRpb25TdGF0dXMobW9kdWxlVW5pcXVlSWQsIHN0YWdlRGV0YWlscykge1xuICAgICAgICAvLyBDaGVjayBtb2R1bGUgaW5zdGFsbGF0aW9uIHN0YXR1c1xuICAgICAgICBpZiAoc3RhZ2VEZXRhaWxzLmRhdGEuaV9zdGF0dXMgPT09ICdJTlNUQUxMQVRJT05fSU5fUFJPR1JFU1MnKSB7XG4gICAgICAgICAgICBjb25zdCBpbnN0YWxsYXRpb25Qcm9ncmVzcyA9IE1hdGgucm91bmQocGFyc2VJbnQoc3RhZ2VEZXRhaWxzLmRhdGEuaV9zdGF0dXNfcHJvZ3Jlc3MsIDEwKS8yKzUwKTtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MsIGluc3RhbGxhdGlvblByb2dyZXNzKTtcbiAgICAgICAgfSBlbHNlIGlmIChzdGFnZURldGFpbHMuZGF0YS5pX3N0YXR1cyA9PT0gJ0lOU1RBTExBVElPTl9DT01QTEVURScpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnVwZGF0ZVByb2dyZXNzQmFyKG1vZHVsZVVuaXF1ZUlkLCBnbG9iYWxUcmFuc2xhdGUuZXh0X0luc3RhbGxhdGlvbkluUHJvZ3Jlc3MsIDEwMCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUmVzZXQgdGhlIGRvd25sb2FkL3VwZGF0ZSBidXR0b24gdG8gZGVmYXVsdCBzdGFnZVxuICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkcm93XG4gICAgICovXG4gICAgcmVzZXRCdXR0b25WaWV3KCRyb3cpe1xuICAgICAgICAkKCdhLmJ1dHRvbicpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAkcm93LmZpbmQoJ2kubG9hZGluZycpLnJlbW92ZUNsYXNzKCdzcGlubmVyIGxvYWRpbmcnKTtcbiAgICAgICAgJHJvdy5maW5kKCdhLmRvd25sb2FkIGknKS5hZGRDbGFzcygnZG93bmxvYWQnKTtcbiAgICAgICAgJHJvdy5maW5kKCdhLnVwZGF0ZSBpJykuYWRkQ2xhc3MoJ3JlZG8nKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU2hvd3MgbW9kdWxlIGluc3RhbGxhdGlvbiBlcnJvciBhYm92ZSB0aGUgbW9kdWxlIHJvd1xuICAgICAqIEBwYXJhbSB7alF1ZXJ5fSAkcm93XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGhlYWRlclxuICAgICAqIEBwYXJhbSBtZXNzYWdlc1xuICAgICAqL1xuICAgIHNob3dNb2R1bGVJbnN0YWxsYXRpb25FcnJvcigkcm93LCBoZWFkZXIsIG1lc3NhZ2VzPScnKSB7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLnJlc2V0QnV0dG9uVmlldygkcm93KTtcbiAgICAgICAgaWYgKG1lc3NhZ2VzLmxpY2Vuc2UhPT11bmRlZmluZWQpe1xuICAgICAgICAgICAgY29uc3QgbWFuYWdlTGluayA9IGA8YnI+JHtnbG9iYWxUcmFuc2xhdGUubGljX01hbmFnZUxpY2Vuc2V9IDxhIGhyZWY9XCIke0NvbmZpZy5rZXlNYW5hZ2VtZW50VXJsfVwiIHRhcmdldD1cIl9ibGFua1wiPiR7Q29uZmlnLmtleU1hbmFnZW1lbnRTaXRlfTwvYT5gO1xuICAgICAgICAgICAgbWVzc2FnZXMubGljZW5zZS5wdXNoKG1hbmFnZUxpbmspO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRleHREZXNjcmlwdGlvbiA9IFVzZXJNZXNzYWdlLmNvbnZlcnRUb1RleHQobWVzc2FnZXMpO1xuICAgICAgICBjb25zdCBodG1sTWVzc2FnZT0gIGA8dHIgY2xhc3M9XCJ1aSBlcnJvciBjZW50ZXIgYWxpZ25lZCB0YWJsZS1lcnJvci1tZXNzYWdlc1wiPjx0ZCBjb2xzcGFuPVwiNFwiPjxkaXYgY2xhc3M9XCJ1aSBoZWFkZXJcIj4ke2hlYWRlcn08L2Rpdj48cD4ke3RleHREZXNjcmlwdGlvbn08L3A+PC9kaXY+PC90ZD48L3RyPmA7XG4gICAgICAgICRyb3cuYWRkQ2xhc3MoJ2Vycm9yJyk7XG4gICAgICAgICRyb3cuYmVmb3JlKGh0bWxNZXNzYWdlKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU2hvd3MgbW9kdWxlIGluc3RhbGxhdGlvbiBwcm9ncmVzcyBiYXIgYW5kIGluc3RhbGxhdGlvbiBzdGF0dXNcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gbW9kdWxlVW5pcXVlSWRcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gaGVhZGVyXG4gICAgICogQHBhcmFtIHtpbnR9IHBlcmNlbnRcbiAgICAgKi9cbiAgICB1cGRhdGVQcm9ncmVzc0Jhcihtb2R1bGVVbmlxdWVJZCwgaGVhZGVyLCBwZXJjZW50PTApe1xuICAgICAgICBsZXQgbW9kdWxlTmFtZSA9ICQoYHRyLm5ldy1tb2R1bGUtcm93W2RhdGEtaWQ9JHttb2R1bGVVbmlxdWVJZH1dYCkuZGF0YSgnbmFtZScpO1xuICAgICAgICBpZiAobW9kdWxlTmFtZSA9PT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgIG1vZHVsZU5hbWUgPSAnJztcbiAgICAgICAgfVxuICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXJCbG9jay5zaG93KCk7XG4gICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0Jhci5zaG93KCk7XG4gICAgICAgIGlmIChoZWFkZXIpe1xuICAgICAgICAgICAgY29uc3QgYmFyVGV4dD0gbW9kdWxlTmFtZSsnOiAnK2hlYWRlcjtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoYmFyVGV4dCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBlcmNlbnQ+MCl7XG4gICAgICAgICAgICBpbnN0YWxsU3RhdHVzTG9vcFdvcmtlci4kcHJvZ3Jlc3NCYXIucHJvZ3Jlc3Moe1xuICAgICAgICAgICAgICAgIHBlcmNlbnQ6IHBlcmNlbnQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbn07Il19