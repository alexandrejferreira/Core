"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage, installStatusLoopWorker */

/**
 * Monitors the status of module upgrade.
 *
 * @module upgradeStatusLoopWorker
 */
var upgradeStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status request.
   * @type {number}
   */
  timeOut: 1000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * The unique ID of the module.
   * @type {string}
   */
  moduleUniqid: '',

  /**
   * The number of iterations.
   * @type {number}
   */
  iterations: 0,

  /**
   * The old progress percentage.
   * @type {string}
   */
  oldPercent: '0',

  /**
   * Initializes the module upgrade status.
   * @param {string} uniqid - The unique ID of the module.
   */
  initialize: function initialize(uniqid) {
    upgradeStatusLoopWorker.moduleUniqid = uniqid;
    upgradeStatusLoopWorker.iterations = 0;
    upgradeStatusLoopWorker.restartWorker();
  },

  /**
   * Restarts the upgrade status worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    upgradeStatusLoopWorker.worker();
  },

  /**
   * The worker function that checks the module upgrade status.
   */
  worker: function worker() {
    window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    PbxApi.ModulesModuleDownloadStatus(upgradeStatusLoopWorker.moduleUniqid, upgradeStatusLoopWorker.cbRefreshModuleStatus, upgradeStatusLoopWorker.restartWorker);
  },

  /**
   * Callback function to refresh the module upgrade status.
   * @param {object} response - The response from the server.
   */
  cbRefreshModuleStatus: function cbRefreshModuleStatus(response) {
    upgradeStatusLoopWorker.iterations += 1;
    upgradeStatusLoopWorker.timeoutHandle = window.setTimeout(upgradeStatusLoopWorker.worker, upgradeStatusLoopWorker.timeOut); // Check download status

    if (response === false && upgradeStatusLoopWorker.iterations < 50) {
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    } else if (upgradeStatusLoopWorker.iterations > 50 || response.d_status === 'PROGRESS_FILE_NOT_FOUND' || response.d_status === 'NOT_FOUND') {
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
      var errorMessage = response.d_error !== undefined ? response.d_error : '';
      errorMessage = errorMessage.replace(/\n/g, '<br>');
      UserMessage.showMultiString(errorMessage, globalTranslate.ext_UpdateModuleError);
      $("#".concat(upgradeStatusLoopWorker.moduleUniqid)).find('i').removeClass('loading');
      $('.new-module-row').find('i').addClass('download').removeClass('redo');
      $('a.button').removeClass('disabled');
    } else if (response.d_status === 'DOWNLOAD_IN_PROGRESS') {
      if (upgradeStatusLoopWorker.oldPercent !== response.d_status_progress) {
        upgradeStatusLoopWorker.iterations = 0;
      }

      $('i.loading.redo').closest('a').find('.percent').text("".concat(response.d_status_progress, "%"));
      upgradeStatusLoopWorker.oldPercent = response.d_status_progress;
    } else if (response.d_status === 'DOWNLOAD_COMPLETE') {
      $('i.loading.redo').closest('a').find('.percent').text('100%');
      PbxApi.ModulesInstallFromPackage(response.filePath, upgradeStatusLoopWorker.cbAfterModuleInstall);
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    }
  },

  /**
   * Callback function after installing the module.
   * @param {object} response - The response from the server.
   */
  cbAfterModuleInstall: function cbAfterModuleInstall(response) {
    if (response.result === true && response.data.filePath !== '') {
      installStatusLoopWorker.initialize(response.data.filePath, response.data.moduleWasEnabled);
    } else {
      UserMessage.showMultiString(response, globalTranslate.ext_InstallationError);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLXVwZ3JhZGUtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJ1cGdyYWRlU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwibW9kdWxlVW5pcWlkIiwiaXRlcmF0aW9ucyIsIm9sZFBlcmNlbnQiLCJpbml0aWFsaXplIiwidW5pcWlkIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJQYnhBcGkiLCJNb2R1bGVzTW9kdWxlRG93bmxvYWRTdGF0dXMiLCJjYlJlZnJlc2hNb2R1bGVTdGF0dXMiLCJyZXNwb25zZSIsInNldFRpbWVvdXQiLCJkX3N0YXR1cyIsImVycm9yTWVzc2FnZSIsImRfZXJyb3IiLCJ1bmRlZmluZWQiLCJyZXBsYWNlIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJnbG9iYWxUcmFuc2xhdGUiLCJleHRfVXBkYXRlTW9kdWxlRXJyb3IiLCIkIiwiZmluZCIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJkX3N0YXR1c19wcm9ncmVzcyIsImNsb3Nlc3QiLCJ0ZXh0IiwiTW9kdWxlc0luc3RhbGxGcm9tUGFja2FnZSIsImZpbGVQYXRoIiwiY2JBZnRlck1vZHVsZUluc3RhbGwiLCJyZXN1bHQiLCJkYXRhIiwiaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIiLCJtb2R1bGVXYXNFbmFibGVkIiwiZXh0X0luc3RhbGxhdGlvbkVycm9yIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHVCQUF1QixHQUFHO0FBQzVCO0FBQ0o7QUFD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QUFjSCxRQUFqRCxFQUEyRG5CLFFBQVEsQ0FBQ3NCLElBQVQsQ0FBY0UsZ0JBQXpFO0FBQ0gsS0FGRCxNQUVPO0FBQ0hqQixNQUFBQSxXQUFXLENBQUNDLGVBQVosQ0FBNEJSLFFBQTVCLEVBQXNDUyxlQUFlLENBQUNnQixxQkFBdEQ7QUFDSDtBQUNKO0FBM0cyQixDQUFoQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UsIGluc3RhbGxTdGF0dXNMb29wV29ya2VyICovXG5cbi8qKlxuICogTW9uaXRvcnMgdGhlIHN0YXR1cyBvZiBtb2R1bGUgdXBncmFkZS5cbiAqXG4gKiBAbW9kdWxlIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyXG4gKi9cbmNvbnN0IHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyID0ge1xuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgc3RhdHVzIHJlcXVlc3QuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0OiAxMDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3IgdGhlIHN0YXR1cyB3b3JrZXIuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0SGFuZGxlOiAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHVuaXF1ZSBJRCBvZiB0aGUgbW9kdWxlLlxuICAgICAqIEB0eXBlIHtzdHJpbmd9XG4gICAgICovXG4gICAgbW9kdWxlVW5pcWlkOiAnJyxcblxuICAgIC8qKlxuICAgICAqIFRoZSBudW1iZXIgb2YgaXRlcmF0aW9ucy5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIGl0ZXJhdGlvbnM6IDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgb2xkIHByb2dyZXNzIHBlcmNlbnRhZ2UuXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBvbGRQZXJjZW50OiAnMCcsXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgbW9kdWxlIHVwZ3JhZGUgc3RhdHVzLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB1bmlxaWQgLSBUaGUgdW5pcXVlIElEIG9mIHRoZSBtb2R1bGUuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSh1bmlxaWQpIHtcbiAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIubW9kdWxlVW5pcWlkID0gdW5pcWlkO1xuICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID0gMDtcbiAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXN0YXJ0cyB0aGUgdXBncmFkZSBzdGF0dXMgd29ya2VyLlxuICAgICAqL1xuICAgIHJlc3RhcnRXb3JrZXIoKSB7XG4gICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBUaGUgd29ya2VyIGZ1bmN0aW9uIHRoYXQgY2hlY2tzIHRoZSBtb2R1bGUgdXBncmFkZSBzdGF0dXMuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICBQYnhBcGkuTW9kdWxlc01vZHVsZURvd25sb2FkU3RhdHVzKFxuICAgICAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIubW9kdWxlVW5pcWlkLFxuICAgICAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuY2JSZWZyZXNoTW9kdWxlU3RhdHVzLFxuICAgICAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIucmVzdGFydFdvcmtlcixcbiAgICAgICAgKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gdG8gcmVmcmVzaCB0aGUgbW9kdWxlIHVwZ3JhZGUgc3RhdHVzLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIuXG4gICAgICovXG4gICAgY2JSZWZyZXNoTW9kdWxlU3RhdHVzKHJlc3BvbnNlKSB7XG4gICAgICAgIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgKz0gMTtcbiAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSA9XG4gICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCh1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci53b3JrZXIsIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVPdXQpO1xuICAgICAgICAvLyBDaGVjayBkb3dubG9hZCBzdGF0dXNcbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSBmYWxzZVxuICAgICAgICAgICAgJiYgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA8IDUwKSB7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICB9IGVsc2UgaWYgKHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLml0ZXJhdGlvbnMgPiA1MFxuICAgICAgICAgICAgfHwgcmVzcG9uc2UuZF9zdGF0dXMgPT09ICdQUk9HUkVTU19GSUxFX05PVF9GT1VORCdcbiAgICAgICAgICAgIHx8IHJlc3BvbnNlLmRfc3RhdHVzID09PSAnTk9UX0ZPVU5EJ1xuICAgICAgICApIHtcbiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgICAgICBsZXQgZXJyb3JNZXNzYWdlID0gKHJlc3BvbnNlLmRfZXJyb3IgIT09IHVuZGVmaW5lZCkgPyByZXNwb25zZS5kX2Vycm9yIDogJyc7XG4gICAgICAgICAgICBlcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2UucmVwbGFjZSgvXFxuL2csICc8YnI+Jyk7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcoZXJyb3JNZXNzYWdlLCBnbG9iYWxUcmFuc2xhdGUuZXh0X1VwZGF0ZU1vZHVsZUVycm9yKTtcbiAgICAgICAgICAgICQoYCMke3VwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm1vZHVsZVVuaXFpZH1gKS5maW5kKCdpJykucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgICAgICQoJy5uZXctbW9kdWxlLXJvdycpLmZpbmQoJ2knKS5hZGRDbGFzcygnZG93bmxvYWQnKS5yZW1vdmVDbGFzcygncmVkbycpO1xuICAgICAgICAgICAgJCgnYS5idXR0b24nKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5kX3N0YXR1cyA9PT0gJ0RPV05MT0FEX0lOX1BST0dSRVNTJykge1xuICAgICAgICAgICAgaWYgKHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm9sZFBlcmNlbnQgIT09IHJlc3BvbnNlLmRfc3RhdHVzX3Byb2dyZXNzKSB7XG4gICAgICAgICAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkKCdpLmxvYWRpbmcucmVkbycpLmNsb3Nlc3QoJ2EnKS5maW5kKCcucGVyY2VudCcpLnRleHQoYCR7cmVzcG9uc2UuZF9zdGF0dXNfcHJvZ3Jlc3N9JWApO1xuICAgICAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIub2xkUGVyY2VudCA9IHJlc3BvbnNlLmRfc3RhdHVzX3Byb2dyZXNzO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRfc3RhdHVzID09PSAnRE9XTkxPQURfQ09NUExFVEUnKSB7XG4gICAgICAgICAgICAkKCdpLmxvYWRpbmcucmVkbycpLmNsb3Nlc3QoJ2EnKS5maW5kKCcucGVyY2VudCcpLnRleHQoJzEwMCUnKTtcbiAgICAgICAgICAgIFBieEFwaS5Nb2R1bGVzSW5zdGFsbEZyb21QYWNrYWdlKHJlc3BvbnNlLmZpbGVQYXRoLCB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyTW9kdWxlSW5zdGFsbCk7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGluc3RhbGxpbmcgdGhlIG1vZHVsZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJNb2R1bGVJbnN0YWxsKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZS5yZXN1bHQgPT09IHRydWUgJiYgcmVzcG9uc2UuZGF0YS5maWxlUGF0aCAhPT0nJyApIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemUocmVzcG9uc2UuZGF0YS5maWxlUGF0aCwgcmVzcG9uc2UuZGF0YS5tb2R1bGVXYXNFbmFibGVkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZSwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25FcnJvcik7XG4gICAgICAgIH1cbiAgICB9LFxufTtcbiJdfQ==