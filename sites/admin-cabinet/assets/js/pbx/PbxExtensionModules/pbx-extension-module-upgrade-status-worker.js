"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, PbxApi, globalTranslate, UserMessage, installStatusLoopWorker */

/**
 * Monitors the status of module upgrade.
 *
 * @module upgradeStatusLoopWorker
 */
var upgradeStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new status request.
   * @type {number}
   */
  timeOut: 1000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * The unique ID of the module.
   * @type {string}
   */
  moduleUniqid: '',

  /**
   * The number of iterations.
   * @type {number}
   */
  iterations: 0,

  /**
   * The old progress percentage.
   * @type {string}
   */
  oldPercent: '0',

  /**
   * Indicates whether to enable the module after installation.
   * @type {boolean}
   */
  needEnableAfterInstall: false,

  /**
   * Initializes the module upgrade status.
   * @param {string} uniqid - The unique ID of the module.
   * @param {boolean} [needEnable=false] - Indicates whether to enable the module after installation.
   */
  initialize: function initialize(uniqid) {
    var needEnable = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
    upgradeStatusLoopWorker.moduleUniqid = uniqid;
    upgradeStatusLoopWorker.iterations = 0;
    upgradeStatusLoopWorker.needEnableAfterInstall = needEnable;
    upgradeStatusLoopWorker.restartWorker();
  },

  /**
   * Restarts the upgrade status worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    upgradeStatusLoopWorker.worker();
  },

  /**
   * The worker function that checks the module upgrade status.
   */
  worker: function worker() {
    window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    PbxApi.ModulesModuleDownloadStatus(upgradeStatusLoopWorker.moduleUniqid, upgradeStatusLoopWorker.cbRefreshModuleStatus, upgradeStatusLoopWorker.restartWorker);
  },

  /**
   * Callback function to refresh the module upgrade status.
   * @param {object} response - The response from the server.
   */
  cbRefreshModuleStatus: function cbRefreshModuleStatus(response) {
    upgradeStatusLoopWorker.iterations += 1;
    upgradeStatusLoopWorker.timeoutHandle = window.setTimeout(upgradeStatusLoopWorker.worker, upgradeStatusLoopWorker.timeOut); // Check download status

    if (response === false && upgradeStatusLoopWorker.iterations < 50) {
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    } else if (upgradeStatusLoopWorker.iterations > 50 || response.d_status === 'PROGRESS_FILE_NOT_FOUND' || response.d_status === 'NOT_FOUND') {
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
      var errorMessage = response.d_error !== undefined ? response.d_error : '';
      errorMessage = errorMessage.replace(/\n/g, '<br>');
      UserMessage.showMultiString(errorMessage, globalTranslate.ext_UpdateModuleError);
      $("#".concat(upgradeStatusLoopWorker.moduleUniqid)).find('i').removeClass('loading');
      $('.new-module-row').find('i').addClass('download').removeClass('redo');
      $('a.button').removeClass('disabled');
    } else if (response.d_status === 'DOWNLOAD_IN_PROGRESS') {
      if (upgradeStatusLoopWorker.oldPercent !== response.d_status_progress) {
        upgradeStatusLoopWorker.iterations = 0;
      }

      $('i.loading.redo').closest('a').find('.percent').text("".concat(response.d_status_progress, "%"));
      upgradeStatusLoopWorker.oldPercent = response.d_status_progress;
    } else if (response.d_status === 'DOWNLOAD_COMPLETE') {
      $('i.loading.redo').closest('a').find('.percent').text('100%');
      PbxApi.ModulesInstallModule(response.filePath, upgradeStatusLoopWorker.cbAfterModuleInstall);
      window.clearTimeout(upgradeStatusLoopWorker.timeoutHandle);
    }
  },

  /**
   * Callback function after installing the module.
   * @param {object} response - The response from the server.
   */
  cbAfterModuleInstall: function cbAfterModuleInstall(response) {
    if (response.result === true) {
      installStatusLoopWorker.initialize(response.data.filePath, upgradeStatusLoopWorker.needEnableAfterInstall);
    } else {
      UserMessage.showMultiString(response, globalTranslate.ext_InstallationError);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLXVwZ3JhZGUtc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJ1cGdyYWRlU3RhdHVzTG9vcFdvcmtlciIsInRpbWVPdXQiLCJ0aW1lT3V0SGFuZGxlIiwibW9kdWxlVW5pcWlkIiwiaXRlcmF0aW9ucyIsIm9sZFBlcmNlbnQiLCJuZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsIiwiaW5pdGlhbGl6ZSIsInVuaXFpZCIsIm5lZWRFbmFibGUiLCJyZXN0YXJ0V29ya2VyIiwid2luZG93IiwiY2xlYXJUaW1lb3V0IiwidGltZW91dEhhbmRsZSIsIndvcmtlciIsIlBieEFwaSIsIk1vZHVsZXNNb2R1bGVEb3dubG9hZFN0YXR1cyIsImNiUmVmcmVzaE1vZHVsZVN0YXR1cyIsInJlc3BvbnNlIiwic2V0VGltZW91dCIsImRfc3RhdHVzIiwiZXJyb3JNZXNzYWdlIiwiZF9lcnJvciIsInVuZGVmaW5lZCIsInJlcGxhY2UiLCJVc2VyTWVzc2FnZSIsInNob3dNdWx0aVN0cmluZyIsImdsb2JhbFRyYW5zbGF0ZSIsImV4dF9VcGRhdGVNb2R1bGVFcnJvciIsIiQiLCJmaW5kIiwicmVtb3ZlQ2xhc3MiLCJhZGRDbGFzcyIsImRfc3RhdHVzX3Byb2dyZXNzIiwiY2xvc2VzdCIsInRleHQiLCJNb2R1bGVzSW5zdGFsbE1vZHVsZSIsImZpbGVQYXRoIiwiY2JBZnRlck1vZHVsZUluc3RhbGwiLCJyZXN1bHQiLCJpbnN0YWxsU3RhdHVzTG9vcFdvcmtlciIsImRhdGEiLCJleHRfSW5zdGFsbGF0aW9uRXJyb3IiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsdUJBQXVCLEdBQUc7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QzNCLFFBQUlBLFFBQVEsQ0FBQ3FCLE1BQVQsS0FBb0IsSUFBeEIsRUFBOEI7QUFDMUJDLE1BQUFBLHVCQUF1QixDQUFDakMsVUFBeEIsQ0FBbUNXLFFBQVEsQ0FBQ3VCLElBQVQsQ0FBY0osUUFBakQsRUFBMkRyQyx1QkFBdUIsQ0FBQ00sc0JBQW5GO0FBQ0gsS0FGRCxNQUVPO0FBQ0htQixNQUFBQSxXQUFXLENBQUNDLGVBQVosQ0FBNEJSLFFBQTVCLEVBQXNDUyxlQUFlLENBQUNlLHFCQUF0RDtBQUNIO0FBQ0o7QUFuSDJCLENBQWhDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIFBieEFwaSwgZ2xvYmFsVHJhbnNsYXRlLCBVc2VyTWVzc2FnZSwgaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIgKi9cblxuLyoqXG4gKiBNb25pdG9ycyB0aGUgc3RhdHVzIG9mIG1vZHVsZSB1cGdyYWRlLlxuICpcbiAqIEBtb2R1bGUgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIgPSB7XG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGZldGNoaW5nIG5ldyBzdGF0dXMgcmVxdWVzdC5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXQ6IDEwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciB0aGUgc3RhdHVzIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgdW5pcXVlIElEIG9mIHRoZSBtb2R1bGUuXG4gICAgICogQHR5cGUge3N0cmluZ31cbiAgICAgKi9cbiAgICBtb2R1bGVVbmlxaWQ6ICcnLFxuXG4gICAgLyoqXG4gICAgICogVGhlIG51bWJlciBvZiBpdGVyYXRpb25zLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgaXRlcmF0aW9uczogMCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBvbGQgcHJvZ3Jlc3MgcGVyY2VudGFnZS5cbiAgICAgKiBAdHlwZSB7c3RyaW5nfVxuICAgICAqL1xuICAgIG9sZFBlcmNlbnQ6ICcwJyxcblxuICAgIC8qKlxuICAgICAqIEluZGljYXRlcyB3aGV0aGVyIHRvIGVuYWJsZSB0aGUgbW9kdWxlIGFmdGVyIGluc3RhbGxhdGlvbi5cbiAgICAgKiBAdHlwZSB7Ym9vbGVhbn1cbiAgICAgKi9cbiAgICBuZWVkRW5hYmxlQWZ0ZXJJbnN0YWxsOiBmYWxzZSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBtb2R1bGUgdXBncmFkZSBzdGF0dXMuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHVuaXFpZCAtIFRoZSB1bmlxdWUgSUQgb2YgdGhlIG1vZHVsZS5cbiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtuZWVkRW5hYmxlPWZhbHNlXSAtIEluZGljYXRlcyB3aGV0aGVyIHRvIGVuYWJsZSB0aGUgbW9kdWxlIGFmdGVyIGluc3RhbGxhdGlvbi5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKHVuaXFpZCwgbmVlZEVuYWJsZSA9IGZhbHNlKSB7XG4gICAgICAgIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm1vZHVsZVVuaXFpZCA9IHVuaXFpZDtcbiAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA9IDA7XG4gICAgICAgIHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLm5lZWRFbmFibGVBZnRlckluc3RhbGwgPSBuZWVkRW5hYmxlO1xuICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSB1cGdyYWRlIHN0YXR1cyB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIud29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFRoZSB3b3JrZXIgZnVuY3Rpb24gdGhhdCBjaGVja3MgdGhlIG1vZHVsZSB1cGdyYWRlIHN0YXR1cy5cbiAgICAgKi9cbiAgICB3b3JrZXIoKSB7XG4gICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIFBieEFwaS5Nb2R1bGVzTW9kdWxlRG93bmxvYWRTdGF0dXMoXG4gICAgICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5tb2R1bGVVbmlxaWQsXG4gICAgICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5jYlJlZnJlc2hNb2R1bGVTdGF0dXMsXG4gICAgICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5yZXN0YXJ0V29ya2VyLFxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiB0byByZWZyZXNoIHRoZSBtb2R1bGUgdXBncmFkZSBzdGF0dXMuXG4gICAgICogQHBhcmFtIHtvYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlci5cbiAgICAgKi9cbiAgICBjYlJlZnJlc2hNb2R1bGVTdGF0dXMocmVzcG9uc2UpIHtcbiAgICAgICAgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyArPSAxO1xuICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlID1cbiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLndvcmtlciwgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZU91dCk7XG4gICAgICAgIC8vIENoZWNrIGRvd25sb2FkIHN0YXR1c1xuICAgICAgICBpZiAocmVzcG9uc2UgPT09IGZhbHNlXG4gICAgICAgICAgICAmJiB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zIDwgNTApIHtcbiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIH0gZWxzZSBpZiAodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIuaXRlcmF0aW9ucyA+IDUwXG4gICAgICAgICAgICB8fCByZXNwb25zZS5kX3N0YXR1cyA9PT0gJ1BST0dSRVNTX0ZJTEVfTk9UX0ZPVU5EJ1xuICAgICAgICAgICAgfHwgcmVzcG9uc2UuZF9zdGF0dXMgPT09ICdOT1RfRk9VTkQnXG4gICAgICAgICkge1xuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgICAgIGxldCBlcnJvck1lc3NhZ2UgPSAocmVzcG9uc2UuZF9lcnJvciAhPT0gdW5kZWZpbmVkKSA/IHJlc3BvbnNlLmRfZXJyb3IgOiAnJztcbiAgICAgICAgICAgIGVycm9yTWVzc2FnZSA9IGVycm9yTWVzc2FnZS5yZXBsYWNlKC9cXG4vZywgJzxicj4nKTtcbiAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhlcnJvck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBkYXRlTW9kdWxlRXJyb3IpO1xuICAgICAgICAgICAgJChgIyR7dXBncmFkZVN0YXR1c0xvb3BXb3JrZXIubW9kdWxlVW5pcWlkfWApLmZpbmQoJ2knKS5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgJCgnLm5ldy1tb2R1bGUtcm93JykuZmluZCgnaScpLmFkZENsYXNzKCdkb3dubG9hZCcpLnJlbW92ZUNsYXNzKCdyZWRvJyk7XG4gICAgICAgICAgICAkKCdhLmJ1dHRvbicpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRfc3RhdHVzID09PSAnRE9XTkxPQURfSU5fUFJPR1JFU1MnKSB7XG4gICAgICAgICAgICBpZiAodXBncmFkZVN0YXR1c0xvb3BXb3JrZXIub2xkUGVyY2VudCAhPT0gcmVzcG9uc2UuZF9zdGF0dXNfcHJvZ3Jlc3MpIHtcbiAgICAgICAgICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5pdGVyYXRpb25zID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQoJ2kubG9hZGluZy5yZWRvJykuY2xvc2VzdCgnYScpLmZpbmQoJy5wZXJjZW50JykudGV4dChgJHtyZXNwb25zZS5kX3N0YXR1c19wcm9ncmVzc30lYCk7XG4gICAgICAgICAgICB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5vbGRQZXJjZW50ID0gcmVzcG9uc2UuZF9zdGF0dXNfcHJvZ3Jlc3M7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuZF9zdGF0dXMgPT09ICdET1dOTE9BRF9DT01QTEVURScpIHtcbiAgICAgICAgICAgICQoJ2kubG9hZGluZy5yZWRvJykuY2xvc2VzdCgnYScpLmZpbmQoJy5wZXJjZW50JykudGV4dCgnMTAwJScpO1xuICAgICAgICAgICAgUGJ4QXBpLk1vZHVsZXNJbnN0YWxsTW9kdWxlKHJlc3BvbnNlLmZpbGVQYXRoLCB1cGdyYWRlU3RhdHVzTG9vcFdvcmtlci5jYkFmdGVyTW9kdWxlSW5zdGFsbCk7XG4gICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHVwZ3JhZGVTdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIGluc3RhbGxpbmcgdGhlIG1vZHVsZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJNb2R1bGVJbnN0YWxsKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZS5yZXN1bHQgPT09IHRydWUpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemUocmVzcG9uc2UuZGF0YS5maWxlUGF0aCwgdXBncmFkZVN0YXR1c0xvb3BXb3JrZXIubmVlZEVuYWJsZUFmdGVySW5zdGFsbCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuICAgICAgICB9XG4gICAgfSxcbn07XG4iXX0=