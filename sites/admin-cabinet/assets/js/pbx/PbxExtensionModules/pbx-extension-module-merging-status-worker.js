"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2021 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global PbxApi, globalTranslate, UserMessage, installStatusLoopWorker */

/**
 * Worker object for monitoring the merging process of uploaded file parts.
 *
 * @module mergingCheckWorker
 */
var mergingCheckWorker = {
  /**
   * Time in milliseconds before fetching new status request.
   * @type {number}
   */
  timeOut: 3000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,
  errorCounts: 0,

  /**
   * The progress bar label element.
   * @type {jQuery}
   */
  $progressBarLabel: $('#upload-progress-bar-label'),
  fileID: null,
  filePath: '',

  /**
   * Initializes the merging check worker.
   * @param {string} fileID - The ID of the uploaded file.
   * @param {string} filePath - The path of the uploaded file.
   */
  initialize: function initialize(fileID, filePath) {
    mergingCheckWorker.fileID = fileID;
    mergingCheckWorker.filePath = filePath;
    mergingCheckWorker.restartWorker(fileID);
  },

  /**
   * Restarts the merging check worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(mergingCheckWorker.timeoutHandle);
    mergingCheckWorker.worker();
  },

  /**
   * Performs the merging check worker process.
   */
  worker: function worker() {
    PbxApi.FilesGetStatusUploadFile(mergingCheckWorker.fileID, mergingCheckWorker.cbAfterResponse);
    mergingCheckWorker.timeoutHandle = window.setTimeout(mergingCheckWorker.worker, mergingCheckWorker.timeOut);
  },

  /**
   * Callback function after receiving the merging check response.
   * @param {object} response - The response object from the merging check API.
   */
  cbAfterResponse: function cbAfterResponse(response) {
    // Check if error counts exceeded the limit
    if (mergingCheckWorker.errorCounts > 10) {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadError);
      UserMessage.showMultiString(response, globalTranslate.ext_UploadError);
      addNewExtension.$uploadButton.removeClass('loading');
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    } // Check if the response is valid


    if (response === undefined || Object.keys(response).length === 0) {
      mergingCheckWorker.errorCounts += 1;
      return;
    } // Check the status of the merging process


    if (response.d_status === 'UPLOAD_COMPLETE') {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_InstallationInProgress);
      PbxApi.SystemInstallModule(mergingCheckWorker.filePath, mergingCheckWorker.cbAfterModuleInstall);
      window.clearTimeout(mergingCheckWorker.timeoutHandle);
    } else if (response.d_status !== undefined) {
      mergingCheckWorker.$progressBarLabel.text(globalTranslate.ext_UploadInProgress);
      mergingCheckWorker.errorCounts = 0;
    } else {
      mergingCheckWorker.errorCounts += 1;
    }
  },

  /**
   * Callback function after module installation.
   * @param {object} response - The response object from the module installation API.
   */
  cbAfterModuleInstall: function cbAfterModuleInstall(response) {
    if (response.result === true) {
      installStatusLoopWorker.initialize(response.data.filePath);
    } else {
      UserMessage.showMultiString(response, globalTranslate.ext_InstallationError);
      addNewExtension.$uploadButton.removeClass('loading');
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QYnhFeHRlbnNpb25Nb2R1bGVzL3BieC1leHRlbnNpb24tbW9kdWxlLW1lcmdpbmctc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJtZXJnaW5nQ2hlY2tXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImVycm9yQ291bnRzIiwiJHByb2dyZXNzQmFyTGFiZWwiLCIkIiwiZmlsZUlEIiwiZmlsZVBhdGgiLCJpbml0aWFsaXplIiwicmVzdGFydFdvcmtlciIsIndpbmRvdyIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJQYnhBcGkiLCJGaWxlc0dldFN0YXR1c1VwbG9hZEZpbGUiLCJjYkFmdGVyUmVzcG9uc2UiLCJzZXRUaW1lb3V0IiwicmVzcG9uc2UiLCJ0ZXh0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiZXh0X1VwbG9hZEVycm9yIiwiVXNlck1lc3NhZ2UiLCJzaG93TXVsdGlTdHJpbmciLCJhZGROZXdFeHRlbnNpb24iLCIkdXBsb2FkQnV0dG9uIiwicmVtb3ZlQ2xhc3MiLCJ1bmRlZmluZWQiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwiZF9zdGF0dXMiLCJleHRfSW5zdGFsbGF0aW9uSW5Qcm9ncmVzcyIsIlN5c3RlbUluc3RhbGxNb2R1bGUiLCJjYkFmdGVyTW9kdWxlSW5zdGFsbCIsImV4dF9VcGxvYWRJblByb2dyZXNzIiwicmVzdWx0IiwiaW5zdGFsbFN0YXR1c0xvb3BXb3JrZXIiLCJkYXRhIiwiZXh0X0luc3RhbGxhdGlvbkVycm9yIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLGtCQUFrQixHQUFHO0FBRXZCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLE9BQU8s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Q0FBakM7QUFDSCxLQUhNLE1BR0E7QUFDSEgsTUFBQUEsa0JBQWtCLENBQUNHLFdBQW5CLElBQWtDLENBQWxDO0FBQ0g7QUFDSixHQXRGc0I7O0FBd0Z2QjtBQUNKO0FBQ0E7QUFDQTtBQUNJK0IsRUFBQUEsb0JBNUZ1QixnQ0E0RkZoQixRQTVGRSxFQTRGUTtBQUMzQixRQUFJQSxRQUFRLENBQUNrQixNQUFULEtBQW9CLElBQXhCLEVBQThCO0FBQzFCQyxNQUFBQSx1QkFBdUIsQ0FBQzdCLFVBQXhCLENBQW1DVSxRQUFRLENBQUNvQixJQUFULENBQWMvQixRQUFqRDtBQUNILEtBRkQsTUFFTztBQUNIZSxNQUFBQSxXQUFXLENBQUNDLGVBQVosQ0FBNEJMLFFBQTVCLEVBQXNDRSxlQUFlLENBQUNtQixxQkFBdEQ7QUFDQWYsTUFBQUEsZUFBZSxDQUFDQyxhQUFoQixDQUE4QkMsV0FBOUIsQ0FBMEMsU0FBMUM7QUFDSDtBQUNKO0FBbkdzQixDQUEzQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIxIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBQYnhBcGksIGdsb2JhbFRyYW5zbGF0ZSwgVXNlck1lc3NhZ2UsIGluc3RhbGxTdGF0dXNMb29wV29ya2VyICovXG5cbi8qKlxuICogV29ya2VyIG9iamVjdCBmb3IgbW9uaXRvcmluZyB0aGUgbWVyZ2luZyBwcm9jZXNzIG9mIHVwbG9hZGVkIGZpbGUgcGFydHMuXG4gKlxuICogQG1vZHVsZSBtZXJnaW5nQ2hlY2tXb3JrZXJcbiAqL1xuY29uc3QgbWVyZ2luZ0NoZWNrV29ya2VyID0ge1xuXG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGZldGNoaW5nIG5ldyBzdGF0dXMgcmVxdWVzdC5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXQ6IDMwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciB0aGUgc3RhdHVzIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG4gICAgXG4gICAgZXJyb3JDb3VudHM6IDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgcHJvZ3Jlc3MgYmFyIGxhYmVsIGVsZW1lbnQuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkcHJvZ3Jlc3NCYXJMYWJlbDogJCgnI3VwbG9hZC1wcm9ncmVzcy1iYXItbGFiZWwnKSxcblxuICAgIGZpbGVJRDogbnVsbCxcbiAgICBmaWxlUGF0aDogJycsXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyB0aGUgbWVyZ2luZyBjaGVjayB3b3JrZXIuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbGVJRCAtIFRoZSBJRCBvZiB0aGUgdXBsb2FkZWQgZmlsZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsZVBhdGggLSBUaGUgcGF0aCBvZiB0aGUgdXBsb2FkZWQgZmlsZS5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplKGZpbGVJRCwgZmlsZVBhdGgpIHtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVJRCA9IGZpbGVJRDtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVQYXRoID0gZmlsZVBhdGg7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci5yZXN0YXJ0V29ya2VyKGZpbGVJRCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSBtZXJnaW5nIGNoZWNrIHdvcmtlci5cbiAgICAgKi9cbiAgICByZXN0YXJ0V29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KG1lcmdpbmdDaGVja1dvcmtlci50aW1lb3V0SGFuZGxlKTtcbiAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBQZXJmb3JtcyB0aGUgbWVyZ2luZyBjaGVjayB3b3JrZXIgcHJvY2Vzcy5cbiAgICAgKi9cbiAgICB3b3JrZXIoKSB7XG4gICAgICAgIFBieEFwaS5GaWxlc0dldFN0YXR1c1VwbG9hZEZpbGUobWVyZ2luZ0NoZWNrV29ya2VyLmZpbGVJRCwgbWVyZ2luZ0NoZWNrV29ya2VyLmNiQWZ0ZXJSZXNwb25zZSk7XG4gICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci50aW1lb3V0SGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIud29ya2VyLFxuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVPdXQsXG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIGFmdGVyIHJlY2VpdmluZyB0aGUgbWVyZ2luZyBjaGVjayByZXNwb25zZS5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0IGZyb20gdGhlIG1lcmdpbmcgY2hlY2sgQVBJLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJSZXNwb25zZShyZXNwb25zZSkge1xuXG4gICAgICAgIC8vIENoZWNrIGlmIGVycm9yIGNvdW50cyBleGNlZWRlZCB0aGUgbGltaXRcbiAgICAgICAgaWYgKG1lcmdpbmdDaGVja1dvcmtlci5lcnJvckNvdW50cyA+IDEwKSB7XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuJHByb2dyZXNzQmFyTGFiZWwudGV4dChnbG9iYWxUcmFuc2xhdGUuZXh0X1VwbG9hZEVycm9yKTtcbiAgICAgICAgICAgIFVzZXJNZXNzYWdlLnNob3dNdWx0aVN0cmluZyhyZXNwb25zZSwgZ2xvYmFsVHJhbnNsYXRlLmV4dF9VcGxvYWRFcnJvcik7XG4gICAgICAgICAgICBhZGROZXdFeHRlbnNpb24uJHVwbG9hZEJ1dHRvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuICAgICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChtZXJnaW5nQ2hlY2tXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBpZiB0aGUgcmVzcG9uc2UgaXMgdmFsaWRcbiAgICAgICAgaWYgKHJlc3BvbnNlID09PSB1bmRlZmluZWQgfHwgT2JqZWN0LmtleXMocmVzcG9uc2UpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmVycm9yQ291bnRzICs9IDE7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayB0aGUgc3RhdHVzIG9mIHRoZSBtZXJnaW5nIHByb2Nlc3NcbiAgICAgICAgaWYgKHJlc3BvbnNlLmRfc3RhdHVzID09PSAnVVBMT0FEX0NPTVBMRVRFJykge1xuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLiRwcm9ncmVzc0JhckxhYmVsLnRleHQoZ2xvYmFsVHJhbnNsYXRlLmV4dF9JbnN0YWxsYXRpb25JblByb2dyZXNzKTtcbiAgICAgICAgICAgIFBieEFwaS5TeXN0ZW1JbnN0YWxsTW9kdWxlKG1lcmdpbmdDaGVja1dvcmtlci5maWxlUGF0aCwgbWVyZ2luZ0NoZWNrV29ya2VyLmNiQWZ0ZXJNb2R1bGVJbnN0YWxsKTtcbiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQobWVyZ2luZ0NoZWNrV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmRfc3RhdHVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIG1lcmdpbmdDaGVja1dvcmtlci4kcHJvZ3Jlc3NCYXJMYWJlbC50ZXh0KGdsb2JhbFRyYW5zbGF0ZS5leHRfVXBsb2FkSW5Qcm9ncmVzcyk7XG4gICAgICAgICAgICBtZXJnaW5nQ2hlY2tXb3JrZXIuZXJyb3JDb3VudHMgPSAwO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbWVyZ2luZ0NoZWNrV29ya2VyLmVycm9yQ291bnRzICs9IDE7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gYWZ0ZXIgbW9kdWxlIGluc3RhbGxhdGlvbi5cbiAgICAgKiBAcGFyYW0ge29iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0IGZyb20gdGhlIG1vZHVsZSBpbnN0YWxsYXRpb24gQVBJLlxuICAgICAqL1xuICAgIGNiQWZ0ZXJNb2R1bGVJbnN0YWxsKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZS5yZXN1bHQgPT09IHRydWUpIHtcbiAgICAgICAgICAgIGluc3RhbGxTdGF0dXNMb29wV29ya2VyLmluaXRpYWxpemUocmVzcG9uc2UuZGF0YS5maWxlUGF0aCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93TXVsdGlTdHJpbmcocmVzcG9uc2UsIGdsb2JhbFRyYW5zbGF0ZS5leHRfSW5zdGFsbGF0aW9uRXJyb3IpO1xuICAgICAgICAgICAgYWRkTmV3RXh0ZW5zaW9uLiR1cGxvYWRCdXR0b24ucmVtb3ZlQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICAgICAgfVxuICAgIH0sXG59OyJdfQ==