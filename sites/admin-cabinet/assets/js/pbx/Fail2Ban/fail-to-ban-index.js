"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2024 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalTranslate, PbxApi, Form, globalRootUrl, Datatable, SemanticLocalization */

/**
 * The `fail2BanIndex` object contains methods and variables for managing the Fail2Ban system.
 *
 * @module fail2BanIndex
 */
var fail2BanIndex = {
  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#fail2ban-settings-form'),

  /**
   * The list of banned IPs
   * @type {jQuery}
   */
  $bannedIpListTable: $('#banned-ip-list-table'),

  /**
   * The list of banned IPs
   * @type {Datatable}
   */
  dataTable: null,

  /**
   * The unban buttons
   * @type {jQuery}
   */
  $unbanButtons: $('.unban-button'),

  /**
   * The global search input element.
   * @type {jQuery}
   */
  $globalSearch: $('#global-search'),

  /**
   * Validation rules for the form fields before submission.
   *
   * @type {object}
   */
  validateRules: {
    maxretry: {
      identifier: 'maxretry',
      rules: [{
        type: 'integer[3..99]',
        prompt: globalTranslate.f2b_ValidateMaxRetryRange
      }]
    },
    findtime: {
      identifier: 'findtime',
      rules: [{
        type: 'integer[300..86400]',
        prompt: globalTranslate.f2b_ValidateFindTimeRange
      }]
    },
    bantime: {
      identifier: 'bantime',
      rules: [{
        type: 'integer[300..86400]',
        prompt: globalTranslate.f2b_ValidateBanTimeRange
      }]
    }
  },
  // This method initializes the Fail2Ban management interface.
  initialize: function initialize() {
    $('#fail2ban-tab-menu .item').tab();
    fail2BanIndex.initializeDataTable();
    fail2BanIndex.initializeForm();
    PbxApi.FirewallGetBannedIp(fail2BanIndex.cbGetBannedIpList);
    fail2BanIndex.$bannedIpListTable.on('click', fail2BanIndex.$unbanButtons, function (e) {
      var unbannedIp = $(e.target).attr('data-value');
      fail2BanIndex.$bannedIpListTable.addClass('loading');
      PbxApi.FirewallUnBanIp(unbannedIp, fail2BanIndex.cbAfterUnBanIp);
    });
  },

  /**
   * Initialize data table on the page
   *
   */
  initializeDataTable: function initializeDataTable() {
    fail2BanIndex.dataTable = fail2BanIndex.$bannedIpListTable.DataTable({
      // destroy: true,
      lengthChange: false,
      paging: true,
      pageLength: fail2BanIndex.calculatePageLength(),
      scrollCollapse: true,
      deferRender: true,
      columns: [// IP
      {
        orderable: true,
        // This column is orderable
        searchable: true // This column is searchable

      }, // Reason
      {
        orderable: false,
        // This column is not orderable
        searchable: false // This column is not searchable

      }, // Buttons
      {
        orderable: false,
        // This column is orderable
        searchable: false // This column is searchable

      }],
      order: [0, 'asc'],
      language: SemanticLocalization.dataTableLocalisation
    });
  },
  // This callback method is used to display the list of banned IPs.
  cbGetBannedIpList: function cbGetBannedIpList(response) {
    fail2BanIndex.$bannedIpListTable.removeClass('loading');

    if (response === false) {
      return;
    } // Clear the DataTable


    fail2BanIndex.dataTable.clear(); // Prepare the new data to be added

    var newData = [];
    Object.keys(response).forEach(function (ip) {
      var bans = response[ip]; // Combine all reasons and dates for this IP into one string

      var reasonsDatesCombined = bans.map(function (ban) {
        var blockDate = new Date(ban.timeofban * 1000).toLocaleString();
        var reason = "f2b_Jail_".concat(ban.jail);

        if (reason in globalTranslate) {
          reason = globalTranslate[reason];
        }

        return "".concat(reason, " - ").concat(blockDate);
      }).join('<br>'); // Use line breaks to separate each reason-date pair
      // Construct a row: IP, Combined Reasons and Dates, Unban Button

      var row = [ip, reasonsDatesCombined, "<button class=\"ui icon basic mini button unban-button\" data-value=\"".concat(ip, "\"><i class=\"icon trash red\"></i>").concat(globalTranslate.f2b_Unban, "</button>")];
      newData.push(row);
    }); // Add the new data and redraw the table

    fail2BanIndex.dataTable.rows.add(newData).draw();
  },
  // This callback method is used after an IP has been unbanned.
  cbAfterUnBanIp: function cbAfterUnBanIp() {
    PbxApi.FirewallGetBannedIp(fail2BanIndex.cbGetBannedIpList);
  },

  /**
   * Callback function to be called before the form is sent
   * @param {Object} settings - The current settings of the form
   * @returns {Object} - The updated settings of the form
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = fail2BanIndex.$formObj.form('get values');
    return result;
  },

  /**
   * Callback function to be called after the form has been sent.
   * @param {Object} response - The response from the server after the form is sent
   */
  cbAfterSendForm: function cbAfterSendForm(response) {},

  /**
   * Calculate data table page length
   *
   * @returns {number}
   */
  calculatePageLength: function calculatePageLength() {
    // Calculate row height
    var rowHeight = fail2BanIndex.$bannedIpListTable.find('tr').first().outerHeight(); // Calculate window height and available space for table

    var windowHeight = window.innerHeight;
    var headerFooterHeight = 400; // Estimate height for header, footer, and other elements
    // Calculate new page length

    return Math.max(Math.floor((windowHeight - headerFooterHeight) / rowHeight), 10);
  },

  /**
   * Initialize the form with custom settings
   */
  initializeForm: function initializeForm() {
    Form.$formObj = fail2BanIndex.$formObj;
    Form.url = "".concat(globalRootUrl, "fail2-ban/save"); // Form submission URL

    Form.validateRules = fail2BanIndex.validateRules; // Form validation rules

    Form.cbBeforeSendForm = fail2BanIndex.cbBeforeSendForm; // Callback before form is sent

    Form.cbAfterSendForm = fail2BanIndex.cbAfterSendForm; // Callback after form is sent

    Form.initialize();
  }
}; // When the document is ready, initialize the Fail2Ban management interface.

$(document).ready(function () {
  fail2BanIndex.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9GYWlsMkJhbi9mYWlsLXRvLWJhbi1pbmRleC5qcyJdLCJuYW1lcyI6WyJmYWlsMkJhbkluZGV4IiwiJGZvcm1PYmoiLCIkIiwiJGJhbm5lZElwTGlzdFRhYmxlIiwiZGF0YVRhYmxlIiwiJHVuYmFuQnV0dG9ucyIsIiRnbG9iYWxTZWFyY2giLCJ2YWxpZGF0ZVJ1bGVzIiwibWF4cmV0cnkiLCJpZGVudGlmaWVyIiwicnVsZXMiLCJ0eXBlIiwicHJvbXB0IiwiZ2xvYmFsVHJhbnNsYXRlIiwiZjJiX1ZhbGlkYXRlTWF4UmV0cnlSYW5nZSIsImZpbmR0aW1lIiwiZjJiX1ZhbGlkYXRlRmluZFRpbWVSYW5nZSIsImJhbnRpbWUiLCJmMmJfVmFsaWRhdGVCYW5UaW1lUmFuZ2UiLCJpbml0aWFsaXplIiwidGFiIiwiaW5pdGlhbGl6ZURhdGFUYWJsZSIsImluaXRpYWxpemVGb3JtIiwiUGJ4QXBpIiwiRmlyZXdhbGxHZXRCYW5uZWRJcCIsImNiR2V0QmFubmVkSXBMaXN0Iiwib24iLCJlIiwidW5iYW5uZWRJcCIsInRhcmdldCIsImF0dHIiLCJhZGRDbGFzcyIsIkZpcmV3YWxsVW5CYW5JcCIsImNiQWZ0ZXJVbkJhbklwIiwiRGF0YVRhYmxlIiwibGVuZ3RoQ2hhbmdlIiwicGFnaW5nIiwicGFnZUxlbmd0aCIsImNhbGN1bGF0ZVBhZ2VMZW5ndGgiLCJzY3JvbGxDb2xsYXBzZSIsImRlZmVyUmVuZGVyIiwiY29sdW1ucyIsIm9yZGVyYWJsZSIsInNlYXJjaGFibGUiLCJvcmRlciIsImxhbmd1YWdlIiwiU2VtYW50aWNMb2NhbGl6YXRpb24iLCJkYXRhVGFibGVMb2NhbGlzYXRpb24iLCJyZXNwb25zZSIsInJlbW92ZUNsYXNzIiwiY2xlYXIiLCJuZXdEYXRhIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJpcCIsImJhbnMiLCJyZWFzb25zRGF0ZXNDb21iaW5lZCIsIm1hcCIsImJhbiIsImJsb2NrRGF0ZSIsIkRhdGUiLCJ0aW1lb2ZiYW4iLCJ0b0xvY2FsZVN0cmluZyIsInJlYXNvbiIsImphaWwiLCJqb2luIiwicm93IiwiZjJiX1VuYmFuIiwicHVzaCIsInJvd3MiLCJhZGQiLCJkcmF3IiwiY2JCZWZvcmVTZW5kRm9ybSIsInNldHRpbmdzIiwicmVzdWx0IiwiZGF0YSIsImZvcm0iLCJjYkFmdGVyU2VuZEZvcm0iLCJyb3dIZWlnaHQiLCJmaW5kIiwiZmlyc3QiLCJvdXRlckhlaWdodCIsIndpbmRvd0hlaWdodCIsIndpbmRvdyIsImlubmVySGVpZ2h0IiwiaGVhZGVyRm9vdGVySGVpZ2h0IiwiTWF0aCIsIm1heCIsImZsb29yIiwiRm9ybSIsInVybCIsImdsb2JhbFJvb3RVcmwiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLGFBQWEsR0FBRztBQUVsQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxRQUFRLEVBQUVDLENBQUMsQ0FBQyx5QkFBRCxDQU5POztBQVFsQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxrQkFBa0IsRUFBRUQsQ0FBQyxDQUFDLHVCQUFELENBWkg7O0FBY2xCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lFLEVBQUFBLFNBQVMsRUFBRSxJQWxCTzs7QUFvQmxCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLGFBQWEsRUFBRUgsQ0FBQyxDQUFDLGVBQUQsQ0F4QkU7O0FBMEJsQjtBQUNKO0FBQ0E7QUFDQTtBQUNJSSxFQUFBQSxhQUFhLEVBQUVKLENBQUMsQ0FBQyxnQkFBRCxDQTlCRTs7QUFnQ2xCO0FBQ0o7QUFDQTtBQUNBO0FBQ0E7QUFDSUssRUFBQUEsYUFBYSxFQUFFO0FBQ1hDLElBQUFBLFFBQVEsRUFBRTtBQUNOQyxNQUFBQSxVQUFVLEVBQUUsVUFETjtBQUVO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Z0M7O0FBQzdDRixJQUFBQSxJQUFJLENBQUNuRixhQUFMLEdBQXFCUCxhQUFhLENBQUNPLGFBQW5DLENBSGEsQ0FHcUM7O0FBQ2xEbUYsSUFBQUEsSUFBSSxDQUFDakIsZ0JBQUwsR0FBd0J6RSxhQUFhLENBQUN5RSxnQkFBdEMsQ0FKYSxDQUkyQzs7QUFDeERpQixJQUFBQSxJQUFJLENBQUNaLGVBQUwsR0FBdUI5RSxhQUFhLENBQUM4RSxlQUFyQyxDQUxhLENBS3lDOztBQUN0RFksSUFBQUEsSUFBSSxDQUFDdkUsVUFBTDtBQUNIO0FBMU1pQixDQUF0QixDLENBNk1BOztBQUNBakIsQ0FBQyxDQUFDMkYsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQjlGLEVBQUFBLGFBQWEsQ0FBQ21CLFVBQWQ7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjQgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFRyYW5zbGF0ZSwgUGJ4QXBpLCBGb3JtLCBnbG9iYWxSb290VXJsLCBEYXRhdGFibGUsIFNlbWFudGljTG9jYWxpemF0aW9uICovXG4vKipcbiAqIFRoZSBgZmFpbDJCYW5JbmRleGAgb2JqZWN0IGNvbnRhaW5zIG1ldGhvZHMgYW5kIHZhcmlhYmxlcyBmb3IgbWFuYWdpbmcgdGhlIEZhaWwyQmFuIHN5c3RlbS5cbiAqXG4gKiBAbW9kdWxlIGZhaWwyQmFuSW5kZXhcbiAqL1xuY29uc3QgZmFpbDJCYW5JbmRleCA9IHtcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBmb3JtLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGZvcm1PYmo6ICQoJyNmYWlsMmJhbi1zZXR0aW5ncy1mb3JtJyksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgbGlzdCBvZiBiYW5uZWQgSVBzXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkYmFubmVkSXBMaXN0VGFibGU6ICQoJyNiYW5uZWQtaXAtbGlzdC10YWJsZScpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGxpc3Qgb2YgYmFubmVkIElQc1xuICAgICAqIEB0eXBlIHtEYXRhdGFibGV9XG4gICAgICovXG4gICAgZGF0YVRhYmxlOiBudWxsLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHVuYmFuIGJ1dHRvbnNcbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICR1bmJhbkJ1dHRvbnM6ICQoJy51bmJhbi1idXR0b24nKSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBnbG9iYWwgc2VhcmNoIGlucHV0IGVsZW1lbnQuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkZ2xvYmFsU2VhcmNoOiAkKCcjZ2xvYmFsLXNlYXJjaCcpLFxuXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGlvbiBydWxlcyBmb3IgdGhlIGZvcm0gZmllbGRzIGJlZm9yZSBzdWJtaXNzaW9uLlxuICAgICAqXG4gICAgICogQHR5cGUge29iamVjdH1cbiAgICAgKi9cbiAgICB2YWxpZGF0ZVJ1bGVzOiB7XG4gICAgICAgIG1heHJldHJ5OiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnbWF4cmV0cnknLFxuICAgICAgICAgICAgcnVsZXM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdpbnRlZ2VyWzMuLjk5XScsXG4gICAgICAgICAgICAgICAgICAgIHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmYyYl9WYWxpZGF0ZU1heFJldHJ5UmFuZ2UsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIGZpbmR0aW1lOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnZmluZHRpbWUnLFxuICAgICAgICAgICAgcnVsZXM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdpbnRlZ2VyWzMwMC4uODY0MDBdJyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUuZjJiX1ZhbGlkYXRlRmluZFRpbWVSYW5nZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgICAgYmFudGltZToge1xuICAgICAgICAgICAgaWRlbnRpZmllcjogJ2JhbnRpbWUnLFxuICAgICAgICAgICAgcnVsZXM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdpbnRlZ2VyWzMwMC4uODY0MDBdJyxcbiAgICAgICAgICAgICAgICAgICAgcHJvbXB0OiBnbG9iYWxUcmFuc2xhdGUuZjJiX1ZhbGlkYXRlQmFuVGltZVJhbmdlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgIH0sXG5cbiAgICAvLyBUaGlzIG1ldGhvZCBpbml0aWFsaXplcyB0aGUgRmFpbDJCYW4gbWFuYWdlbWVudCBpbnRlcmZhY2UuXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgJCgnI2ZhaWwyYmFuLXRhYi1tZW51IC5pdGVtJykudGFiKCk7XG4gICAgICAgIGZhaWwyQmFuSW5kZXguaW5pdGlhbGl6ZURhdGFUYWJsZSgpO1xuICAgICAgICBmYWlsMkJhbkluZGV4LmluaXRpYWxpemVGb3JtKCk7XG5cbiAgICAgICAgUGJ4QXBpLkZpcmV3YWxsR2V0QmFubmVkSXAoZmFpbDJCYW5JbmRleC5jYkdldEJhbm5lZElwTGlzdCk7XG5cbiAgICAgICAgZmFpbDJCYW5JbmRleC4kYmFubmVkSXBMaXN0VGFibGUub24oJ2NsaWNrJywgZmFpbDJCYW5JbmRleC4kdW5iYW5CdXR0b25zLCAoZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdW5iYW5uZWRJcCA9ICQoZS50YXJnZXQpLmF0dHIoJ2RhdGEtdmFsdWUnKTtcbiAgICAgICAgICAgIGZhaWwyQmFuSW5kZXguJGJhbm5lZElwTGlzdFRhYmxlLmFkZENsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICBQYnhBcGkuRmlyZXdhbGxVbkJhbklwKHVuYmFubmVkSXAsIGZhaWwyQmFuSW5kZXguY2JBZnRlclVuQmFuSXApO1xuICAgICAgICB9KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSBkYXRhIHRhYmxlIG9uIHRoZSBwYWdlXG4gICAgICpcbiAgICAgKi9cbiAgICBpbml0aWFsaXplRGF0YVRhYmxlKCl7XG4gICAgICAgIGZhaWwyQmFuSW5kZXguZGF0YVRhYmxlID0gZmFpbDJCYW5JbmRleC4kYmFubmVkSXBMaXN0VGFibGUuRGF0YVRhYmxlKHtcbiAgICAgICAgICAgIC8vIGRlc3Ryb3k6IHRydWUsXG4gICAgICAgICAgICBsZW5ndGhDaGFuZ2U6IGZhbHNlLFxuICAgICAgICAgICAgcGFnaW5nOiB0cnVlLFxuICAgICAgICAgICAgcGFnZUxlbmd0aDogZmFpbDJCYW5JbmRleC5jYWxjdWxhdGVQYWdlTGVuZ3RoKCksXG4gICAgICAgICAgICBzY3JvbGxDb2xsYXBzZTogdHJ1ZSxcbiAgICAgICAgICAgIGRlZmVyUmVuZGVyOiB0cnVlLFxuICAgICAgICAgICAgY29sdW1uczogW1xuICAgICAgICAgICAgICAgIC8vIElQXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBvcmRlcmFibGU6IHRydWUsICAvLyBUaGlzIGNvbHVtbiBpcyBvcmRlcmFibGVcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoYWJsZTogdHJ1ZSAgLy8gVGhpcyBjb2x1bW4gaXMgc2VhcmNoYWJsZVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgLy8gUmVhc29uXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBvcmRlcmFibGU6IGZhbHNlLCAgLy8gVGhpcyBjb2x1bW4gaXMgbm90IG9yZGVyYWJsZVxuICAgICAgICAgICAgICAgICAgICBzZWFyY2hhYmxlOiBmYWxzZSAgLy8gVGhpcyBjb2x1bW4gaXMgbm90IHNlYXJjaGFibGVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIC8vIEJ1dHRvbnNcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG9yZGVyYWJsZTogZmFsc2UsICAvLyBUaGlzIGNvbHVtbiBpcyBvcmRlcmFibGVcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoYWJsZTogZmFsc2UgIC8vIFRoaXMgY29sdW1uIGlzIHNlYXJjaGFibGVcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIG9yZGVyOiBbMCwgJ2FzYyddLFxuICAgICAgICAgICAgbGFuZ3VhZ2U6IFNlbWFudGljTG9jYWxpemF0aW9uLmRhdGFUYWJsZUxvY2FsaXNhdGlvbixcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8vIFRoaXMgY2FsbGJhY2sgbWV0aG9kIGlzIHVzZWQgdG8gZGlzcGxheSB0aGUgbGlzdCBvZiBiYW5uZWQgSVBzLlxuICAgIGNiR2V0QmFubmVkSXBMaXN0KHJlc3BvbnNlKSB7XG4gICAgICAgIGZhaWwyQmFuSW5kZXguJGJhbm5lZElwTGlzdFRhYmxlLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgIGlmIChyZXNwb25zZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyBDbGVhciB0aGUgRGF0YVRhYmxlXG4gICAgICAgIGZhaWwyQmFuSW5kZXguZGF0YVRhYmxlLmNsZWFyKCk7XG5cbiAgICAgICAgLy8gUHJlcGFyZSB0aGUgbmV3IGRhdGEgdG8gYmUgYWRkZWRcbiAgICAgICAgbGV0IG5ld0RhdGEgPSBbXTtcbiAgICAgICAgT2JqZWN0LmtleXMocmVzcG9uc2UpLmZvckVhY2goaXAgPT4ge1xuICAgICAgICAgICAgY29uc3QgYmFucyA9IHJlc3BvbnNlW2lwXTtcbiAgICAgICAgICAgIC8vIENvbWJpbmUgYWxsIHJlYXNvbnMgYW5kIGRhdGVzIGZvciB0aGlzIElQIGludG8gb25lIHN0cmluZ1xuICAgICAgICAgICAgbGV0IHJlYXNvbnNEYXRlc0NvbWJpbmVkID0gYmFucy5tYXAoYmFuID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBibG9ja0RhdGUgPSBuZXcgRGF0ZShiYW4udGltZW9mYmFuICogMTAwMCkudG9Mb2NhbGVTdHJpbmcoKTtcbiAgICAgICAgICAgICAgICBsZXQgcmVhc29uID0gYGYyYl9KYWlsXyR7YmFuLmphaWx9YDtcbiAgICAgICAgICAgICAgICBpZiAocmVhc29uIGluIGdsb2JhbFRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICByZWFzb24gPSBnbG9iYWxUcmFuc2xhdGVbcmVhc29uXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke3JlYXNvbn0gLSAke2Jsb2NrRGF0ZX1gO1xuICAgICAgICAgICAgfSkuam9pbignPGJyPicpOyAvLyBVc2UgbGluZSBicmVha3MgdG8gc2VwYXJhdGUgZWFjaCByZWFzb24tZGF0ZSBwYWlyXG5cbiAgICAgICAgICAgIC8vIENvbnN0cnVjdCBhIHJvdzogSVAsIENvbWJpbmVkIFJlYXNvbnMgYW5kIERhdGVzLCBVbmJhbiBCdXR0b25cbiAgICAgICAgICAgIGNvbnN0IHJvdyA9IFtcbiAgICAgICAgICAgICAgICBpcCxcbiAgICAgICAgICAgICAgICByZWFzb25zRGF0ZXNDb21iaW5lZCxcbiAgICAgICAgICAgICAgICBgPGJ1dHRvbiBjbGFzcz1cInVpIGljb24gYmFzaWMgbWluaSBidXR0b24gdW5iYW4tYnV0dG9uXCIgZGF0YS12YWx1ZT1cIiR7aXB9XCI+PGkgY2xhc3M9XCJpY29uIHRyYXNoIHJlZFwiPjwvaT4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfVW5iYW59PC9idXR0b24+YFxuICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIG5ld0RhdGEucHVzaChyb3cpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBBZGQgdGhlIG5ldyBkYXRhIGFuZCByZWRyYXcgdGhlIHRhYmxlXG4gICAgICAgIGZhaWwyQmFuSW5kZXguZGF0YVRhYmxlLnJvd3MuYWRkKG5ld0RhdGEpLmRyYXcoKTtcbiAgICB9LFxuXG4gICAgLy8gVGhpcyBjYWxsYmFjayBtZXRob2QgaXMgdXNlZCBhZnRlciBhbiBJUCBoYXMgYmVlbiB1bmJhbm5lZC5cbiAgICBjYkFmdGVyVW5CYW5JcCgpIHtcbiAgICAgICAgUGJ4QXBpLkZpcmV3YWxsR2V0QmFubmVkSXAoZmFpbDJCYW5JbmRleC5jYkdldEJhbm5lZElwTGlzdCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBiZWZvcmUgdGhlIGZvcm0gaXMgc2VudFxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzZXR0aW5ncyAtIFRoZSBjdXJyZW50IHNldHRpbmdzIG9mIHRoZSBmb3JtXG4gICAgICogQHJldHVybnMge09iamVjdH0gLSBUaGUgdXBkYXRlZCBzZXR0aW5ncyBvZiB0aGUgZm9ybVxuICAgICAqL1xuICAgIGNiQmVmb3JlU2VuZEZvcm0oc2V0dGluZ3MpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gc2V0dGluZ3M7XG4gICAgICAgIHJlc3VsdC5kYXRhID0gZmFpbDJCYW5JbmRleC4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGxiYWNrIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBhZnRlciB0aGUgZm9ybSBoYXMgYmVlbiBzZW50LlxuICAgICAqIEBwYXJhbSB7T2JqZWN0fSByZXNwb25zZSAtIFRoZSByZXNwb25zZSBmcm9tIHRoZSBzZXJ2ZXIgYWZ0ZXIgdGhlIGZvcm0gaXMgc2VudFxuICAgICAqL1xuICAgIGNiQWZ0ZXJTZW5kRm9ybShyZXNwb25zZSkge1xuXG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSBkYXRhIHRhYmxlIHBhZ2UgbGVuZ3RoXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfVxuICAgICAqL1xuICAgIGNhbGN1bGF0ZVBhZ2VMZW5ndGgoKSB7XG4gICAgICAgIC8vIENhbGN1bGF0ZSByb3cgaGVpZ2h0XG4gICAgICAgIGxldCByb3dIZWlnaHQgPSBmYWlsMkJhbkluZGV4LiRiYW5uZWRJcExpc3RUYWJsZS5maW5kKCd0cicpLmZpcnN0KCkub3V0ZXJIZWlnaHQoKTtcbiAgICAgICAgLy8gQ2FsY3VsYXRlIHdpbmRvdyBoZWlnaHQgYW5kIGF2YWlsYWJsZSBzcGFjZSBmb3IgdGFibGVcbiAgICAgICAgY29uc3Qgd2luZG93SGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICAgICAgICBjb25zdCBoZWFkZXJGb290ZXJIZWlnaHQgPSA0MDA7IC8vIEVzdGltYXRlIGhlaWdodCBmb3IgaGVhZGVyLCBmb290ZXIsIGFuZCBvdGhlciBlbGVtZW50c1xuXG4gICAgICAgIC8vIENhbGN1bGF0ZSBuZXcgcGFnZSBsZW5ndGhcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KE1hdGguZmxvb3IoKHdpbmRvd0hlaWdodCAtIGhlYWRlckZvb3RlckhlaWdodCkgLyByb3dIZWlnaHQpLCAxMCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgdGhlIGZvcm0gd2l0aCBjdXN0b20gc2V0dGluZ3NcbiAgICAgKi9cbiAgICBpbml0aWFsaXplRm9ybSgpIHtcbiAgICAgICAgRm9ybS4kZm9ybU9iaiA9IGZhaWwyQmFuSW5kZXguJGZvcm1PYmo7XG4gICAgICAgIEZvcm0udXJsID0gYCR7Z2xvYmFsUm9vdFVybH1mYWlsMi1iYW4vc2F2ZWA7IC8vIEZvcm0gc3VibWlzc2lvbiBVUkxcbiAgICAgICAgRm9ybS52YWxpZGF0ZVJ1bGVzID0gZmFpbDJCYW5JbmRleC52YWxpZGF0ZVJ1bGVzOyAvLyBGb3JtIHZhbGlkYXRpb24gcnVsZXNcbiAgICAgICAgRm9ybS5jYkJlZm9yZVNlbmRGb3JtID0gZmFpbDJCYW5JbmRleC5jYkJlZm9yZVNlbmRGb3JtOyAvLyBDYWxsYmFjayBiZWZvcmUgZm9ybSBpcyBzZW50XG4gICAgICAgIEZvcm0uY2JBZnRlclNlbmRGb3JtID0gZmFpbDJCYW5JbmRleC5jYkFmdGVyU2VuZEZvcm07IC8vIENhbGxiYWNrIGFmdGVyIGZvcm0gaXMgc2VudFxuICAgICAgICBGb3JtLmluaXRpYWxpemUoKTtcbiAgICB9LFxufTtcblxuLy8gV2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHksIGluaXRpYWxpemUgdGhlIEZhaWwyQmFuIG1hbmFnZW1lbnQgaW50ZXJmYWNlLlxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIGZhaWwyQmFuSW5kZXguaW5pdGlhbGl6ZSgpO1xufSk7XG5cbiJdfQ==