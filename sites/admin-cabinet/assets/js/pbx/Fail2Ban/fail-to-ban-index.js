"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalTranslate, PbxApi, Form, globalRootUrl */

/**
 * The `fail2BanIndex` object contains methods and variables for managing the Fail2Ban system.
 *
 * @module fail2BanIndex
 */
var fail2BanIndex = {
  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#fail2ban-settings-form'),
  $bannedIpList: $('#banned-ip-list'),
  // The list of banned IPs
  $unbanButons: $('.unban-button'),
  // The unban buttons
  $enableCheckBox: $('#fail2ban-switch'),
  // The checkbox for enabling Fail2Ban

  /**
   * Validation rules for the form fields before submission.
   *
   * @type {object}
   */
  validateRules: {
    maxretry: {
      identifier: 'maxretry',
      rules: [{
        type: 'integer[3..99]',
        prompt: globalTranslate.f2b_ValidateMaxRetryRange
      }]
    },
    findtime: {
      identifier: 'findtime',
      rules: [{
        type: 'integer[300..86400]',
        prompt: globalTranslate.f2b_ValidateFindTimeRange
      }]
    },
    bantime: {
      identifier: 'bantime',
      rules: [{
        type: 'integer[300..86400]',
        prompt: globalTranslate.f2b_ValidateBanTimeRange
      }]
    }
  },
  // This method initializes the Fail2Ban management interface.
  initialize: function initialize() {
    PbxApi.SystemGetBannedIp(fail2BanIndex.cbGetBannedIpList);
    fail2BanIndex.$bannedIpList.on('click', fail2BanIndex.$unbanButons, function (e) {
      var unbannedIp = $(e.target).attr('data-value');
      PbxApi.SystemUnBanIp(unbannedIp, fail2BanIndex.cbAfterUnBanIp);
    });
    fail2BanIndex.$enableCheckBox.checkbox({
      onChange: function onChange() {
        fail2BanIndex.changeFieldsLook();
      }
    });
    fail2BanIndex.changeFieldsLook();
    fail2BanIndex.initializeForm();
  },
  // This method changes the look of the fields based on whether Fail2Ban is enabled or not.
  changeFieldsLook: function changeFieldsLook() {
    var checked = fail2BanIndex.$enableCheckBox.checkbox('is checked');
    fail2BanIndex.$formObj.find('.disability').each(function (index, obj) {
      if (checked) {
        $(obj).removeClass('disabled');
      } else {
        $(obj).addClass('disabled');
      }
    });
  },
  // This callback method is used to display the list of banned IPs.
  cbGetBannedIpList: function cbGetBannedIpList(response) {
    if (response === false) {
      return;
    }

    var htmlTable = "<h2 class=\"ui header\">".concat(globalTranslate.f2b_TableBannedHeader, "</h2>");
    htmlTable += '<table class="ui very compact unstackable table">';
    htmlTable += '<thead>';
    htmlTable += "<th>".concat(globalTranslate.f2b_Reason, "</th>");
    htmlTable += "<th>".concat(globalTranslate.f2b_IpAddres, "</th>");
    htmlTable += "<th>".concat(globalTranslate.f2b_BanedTime, "</th>");
    htmlTable += '<th></th>';
    htmlTable += '</thead>';
    htmlTable += '<tbody>';
    response.sort(function (a, b) {
      var keyA = a.timeofban;
      var keyB = b.timeofban; // Compare the 2 dates

      if (keyA < keyB) return 1;
      if (keyA > keyB) return -1;
      return 0;
    });
    $.each(response, function (key, value) {
      var blockDate = new Date(value.timeofban * 1000);
      var reason = "f2b_Jail_".concat(value.jail);

      if (reason in globalTranslate) {
        reason = globalTranslate[reason];
      }

      htmlTable += '<tr>';
      htmlTable += "<td>".concat(reason, "</td>");
      htmlTable += "<td>".concat(value.ip, "</td>");
      htmlTable += "<td>".concat(blockDate.toLocaleString(), "</td>");
      htmlTable += "<td class=\"right aligned collapsing\"><button class=\"ui icon basic mini button unban-button\" data-value=\"".concat(value.ip, "\"><i class=\"icon trash red\"></i>").concat(globalTranslate.f2b_Unban, "</button></td>");
      htmlTable += '</tr>';
    });

    if (response.length === 0) {
      htmlTable += "<tr><td colspan=\"4\" class=\"center aligned\">".concat(globalTranslate.f2b_TableBannedEmpty, "</td></tr>");
    }

    htmlTable += '<tbody>';
    htmlTable += '</table>';
    fail2BanIndex.$bannedIpList.html(htmlTable);
  },
  // This callback method is used after an IP has been unbanned.
  cbAfterUnBanIp: function cbAfterUnBanIp() {
    PbxApi.SystemGetBannedIp(fail2BanIndex.cbGetBannedIpList);
  },

  /**
   * Callback function to be called before the form is sent
   * @param {Object} settings - The current settings of the form
   * @returns {Object} - The updated settings of the form
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = fail2BanIndex.$formObj.form('get values');
    return result;
  },

  /**
   * Callback function to be called after the form has been sent.
   * @param {Object} response - The response from the server after the form is sent
   */
  cbAfterSendForm: function cbAfterSendForm(response) {},

  /**
   * Initialize the form with custom settings
   */
  initializeForm: function initializeForm() {
    Form.$formObj = fail2BanIndex.$formObj;
    Form.url = "".concat(globalRootUrl, "fail2-ban/save"); // Form submission URL

    Form.validateRules = fail2BanIndex.validateRules; // Form validation rules

    Form.cbBeforeSendForm = fail2BanIndex.cbBeforeSendForm; // Callback before form is sent

    Form.cbAfterSendForm = fail2BanIndex.cbAfterSendForm; // Callback after form is sent

    Form.initialize();
  }
}; // When the document is ready, initialize the Fail2Ban management interface.

$(document).ready(function () {
  fail2BanIndex.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9GYWlsMkJhbi9mYWlsLXRvLWJhbi1pbmRleC5qcyJdLCJuYW1lcyI6WyJmYWlsMkJhbkluZGV4IiwiJGZvcm1PYmoiLCIkIiwiJGJhbm5lZElwTGlzdCIsIiR1bmJhbkJ1dG9ucyIsIiRlbmFibGVDaGVja0JveCIsInZhbGlkYXRlUnVsZXMiLCJtYXhyZXRyeSIsImlkZW50aWZpZXIiLCJydWxlcyIsInR5cGUiLCJwcm9tcHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJmMmJfVmFsaWRhdGVNYXhSZXRyeVJhbmdlIiwiZmluZHRpbWUiLCJmMmJfVmFsaWRhdGVGaW5kVGltZVJhbmdlIiwiYmFudGltZSIsImYyYl9WYWxpZGF0ZUJhblRpbWVSYW5nZSIsImluaXRpYWxpemUiLCJQYnhBcGkiLCJTeXN0ZW1HZXRCYW5uZWRJcCIsImNiR2V0QmFubmVkSXBMaXN0Iiwib24iLCJlIiwidW5iYW5uZWRJcCIsInRhcmdldCIsImF0dHIiLCJTeXN0ZW1VbkJhbklwIiwiY2JBZnRlclVuQmFuSXAiLCJjaGVja2JveCIsIm9uQ2hhbmdlIiwiY2hhbmdlRmllbGRzTG9vayIsImluaXRpYWxpemVGb3JtIiwiY2hlY2tlZCIsImZpbmQiLCJlYWNoIiwiaW5kZXgiLCJvYmoiLCJyZW1vdmVDbGFzcyIsImFkZENsYXNzIiwicmVzcG9uc2UiLCJodG1sVGFibGUiLCJmMmJfVGFibGVCYW5uZWRIZWFkZXIiLCJmMmJfUmVhc29uIiwiZjJiX0lwQWRkcmVzIiwiZjJiX0JhbmVkVGltZSIsInNvcnQiLCJhIiwiYiIsImtleUEiLCJ0aW1lb2ZiYW4iLCJrZXlCIiwia2V5IiwidmFsdWUiLCJibG9ja0RhdGUiLCJEYXRlIiwicmVhc29uIiwiamFpbCIsImlwIiwidG9Mb2NhbGVTdHJpbmciLCJmMmJfVW5iYW4iLCJsZW5ndGgiLCJmMmJfVGFibGVCYW5uZWRFbXB0eSIsImh0bWwiLCJjYkJlZm9yZVNlbmRGb3JtIiwic2V0dGluZ3MiLCJyZXN1bHQiLCJkYXRhIiwiZm9ybSIsImNiQWZ0ZXJTZW5kRm9ybSIsIkZvcm0iLCJ1cmwiLCJnbG9iYWxSb290VXJsIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFNQSxhQUFhLEdBQUc7QUFFbEI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsUUFBUSxFQUFFQyxDQUFDLENBQUMseUJBQUQsQ0FOTztBQVFsQkMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsaUJBQUQsQ0FSRTtBQVFtQjtBQUNyQ0UsRUFBQUEsWUFBWSxFQUFFRixDQUFDLENBQUMsZUFBRCxDQVRHO0FBU2dCO0FBQ2xDRyxFQUFBQSxlQUFlLEVBQUVILENBQUMsQ0FBQyxrQkFBRCxDQVZBO0FBVXVCOztBQUV6QztBQUNKO0FBQ0E7QUFDQTtBQUNBO0FBQ0lJLEVBQUFBLGFBQWEsRUFBRTtBQUNYQyxJQUFBQSxRQUFRLEVBQUU7QUFDTkMsTUFBQUEsVUFBVSxFQUFFLFVBRE47QUFFTkMsTUFBQUEsS0FBSyxFQUFFLENBQ0g7QUFDSUMsUUFBQUEsSUFBSSxFQUFFLGdCQURWO0FBRUlDLFFBQUFBLE1BQU0sRUFBRUMsZUFBZSxDQUFDQztBQUY1QixPQURHO0FBRkQsS0FEQztBQVVYQyxJQUFBQSxRQUFRLEVBQUU7QUFDTk4sTUFBQUEsVUFBVSxFQUFFLFVBRE47QUFFTkMsTUFBQUEsS0FBSyxFQUFFLENBQ0g7QUFDSUMsUUFBQUEsSUFBSSxFQUFFLHFCQURWO0FBRUlDLFFBQUFBLE1BQU0sRUFBRUMsZUFBZSxDQUFDRztBQUY1QixPQURHO0FBRkQsS0FWQztBQW1CWEMsSUFBQUEsT0FBTyxFQUFFO0FBQ0xSLE1BQUFBLFVBQVUsRUFBRSxTQURQO0FBRUxDLE1BQUFBLEtBQUssRUFBRSxDQUNIO0FBQ0lDLFFBQUFBLElBQUks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TSxDQUFDQyxJQUFQLEdBQWNuRSxhQUFhLENBQUNDLFFBQWQsQ0FBdUJtRSxJQUF2QixDQUE0QixZQUE1QixDQUFkO0FBQ0EsV0FBT0YsTUFBUDtBQUNILEdBdElpQjs7QUF3SWxCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lHLEVBQUFBLGVBNUlrQiwyQkE0SUY3QixRQTVJRSxFQTRJUSxDQUV6QixDQTlJaUI7O0FBK0lsQjtBQUNKO0FBQ0E7QUFDSVIsRUFBQUEsY0FsSmtCLDRCQWtKRDtBQUNic0MsSUFBQUEsSUFBSSxDQUFDckUsUUFBTCxHQUFnQkQsYUFBYSxDQUFDQyxRQUE5QjtBQUNBcUUsSUFBQUEsSUFBSSxDQUFDQyxHQUFMLGFBQWNDLGFBQWQsb0JBRmEsQ0FFZ0M7O0FBQzdDRixJQUFBQSxJQUFJLENBQUNoRSxhQUFMLEdBQXFCTixhQUFhLENBQUNNLGFBQW5DLENBSGEsQ0FHcUM7O0FBQ2xEZ0UsSUFBQUEsSUFBSSxDQUFDTixnQkFBTCxHQUF3QmhFLGFBQWEsQ0FBQ2dFLGdCQUF0QyxDQUphLENBSTJDOztBQUN4RE0sSUFBQUEsSUFBSSxDQUFDRCxlQUFMLEdBQXVCckUsYUFBYSxDQUFDcUUsZUFBckMsQ0FMYSxDQUt5Qzs7QUFDdERDLElBQUFBLElBQUksQ0FBQ3BELFVBQUw7QUFDSDtBQXpKaUIsQ0FBdEIsQyxDQTRKQTs7QUFDQWhCLENBQUMsQ0FBQ3VFLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDcEIxRSxFQUFBQSxhQUFhLENBQUNrQixVQUFkO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxUcmFuc2xhdGUsIFBieEFwaSwgRm9ybSwgZ2xvYmFsUm9vdFVybCAqL1xuLyoqXG4gKiBUaGUgYGZhaWwyQmFuSW5kZXhgIG9iamVjdCBjb250YWlucyBtZXRob2RzIGFuZCB2YXJpYWJsZXMgZm9yIG1hbmFnaW5nIHRoZSBGYWlsMkJhbiBzeXN0ZW0uXG4gKlxuICogQG1vZHVsZSBmYWlsMkJhbkluZGV4XG4gKi9cbmNvbnN0IGZhaWwyQmFuSW5kZXggPSB7XG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjZmFpbDJiYW4tc2V0dGluZ3MtZm9ybScpLFxuXG4gICAgJGJhbm5lZElwTGlzdDogJCgnI2Jhbm5lZC1pcC1saXN0JyksIC8vIFRoZSBsaXN0IG9mIGJhbm5lZCBJUHNcbiAgICAkdW5iYW5CdXRvbnM6ICQoJy51bmJhbi1idXR0b24nKSwgLy8gVGhlIHVuYmFuIGJ1dHRvbnNcbiAgICAkZW5hYmxlQ2hlY2tCb3g6ICQoJyNmYWlsMmJhbi1zd2l0Y2gnKSwgIC8vIFRoZSBjaGVja2JveCBmb3IgZW5hYmxpbmcgRmFpbDJCYW5cblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRpb24gcnVsZXMgZm9yIHRoZSBmb3JtIGZpZWxkcyBiZWZvcmUgc3VibWlzc2lvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtvYmplY3R9XG4gICAgICovXG4gICAgdmFsaWRhdGVSdWxlczoge1xuICAgICAgICBtYXhyZXRyeToge1xuICAgICAgICAgICAgaWRlbnRpZmllcjogJ21heHJldHJ5JyxcbiAgICAgICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW50ZWdlclszLi45OV0nLFxuICAgICAgICAgICAgICAgICAgICBwcm9tcHQ6IGdsb2JhbFRyYW5zbGF0ZS5mMmJfVmFsaWRhdGVNYXhSZXRyeVJhbmdlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICBmaW5kdGltZToge1xuICAgICAgICAgICAgaWRlbnRpZmllcjogJ2ZpbmR0aW1lJyxcbiAgICAgICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW50ZWdlclszMDAuLjg2NDAwXScsXG4gICAgICAgICAgICAgICAgICAgIHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmYyYl9WYWxpZGF0ZUZpbmRUaW1lUmFuZ2UsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgICAgIGJhbnRpbWU6IHtcbiAgICAgICAgICAgIGlkZW50aWZpZXI6ICdiYW50aW1lJyxcbiAgICAgICAgICAgIHJ1bGVzOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW50ZWdlclszMDAuLjg2NDAwXScsXG4gICAgICAgICAgICAgICAgICAgIHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmYyYl9WYWxpZGF0ZUJhblRpbWVSYW5nZSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICB9LFxuXG4gICAgLy8gVGhpcyBtZXRob2QgaW5pdGlhbGl6ZXMgdGhlIEZhaWwyQmFuIG1hbmFnZW1lbnQgaW50ZXJmYWNlLlxuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIFBieEFwaS5TeXN0ZW1HZXRCYW5uZWRJcChmYWlsMkJhbkluZGV4LmNiR2V0QmFubmVkSXBMaXN0KTtcbiAgICAgICAgZmFpbDJCYW5JbmRleC4kYmFubmVkSXBMaXN0Lm9uKCdjbGljaycsIGZhaWwyQmFuSW5kZXguJHVuYmFuQnV0b25zLCAoZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdW5iYW5uZWRJcCA9ICQoZS50YXJnZXQpLmF0dHIoJ2RhdGEtdmFsdWUnKTtcbiAgICAgICAgICAgIFBieEFwaS5TeXN0ZW1VbkJhbklwKHVuYmFubmVkSXAsIGZhaWwyQmFuSW5kZXguY2JBZnRlclVuQmFuSXApO1xuICAgICAgICB9KTtcblxuICAgICAgICBmYWlsMkJhbkluZGV4LiRlbmFibGVDaGVja0JveC5jaGVja2JveCh7XG4gICAgICAgICAgICBvbkNoYW5nZSgpIHtcbiAgICAgICAgICAgICAgICBmYWlsMkJhbkluZGV4LmNoYW5nZUZpZWxkc0xvb2soKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgICBmYWlsMkJhbkluZGV4LmNoYW5nZUZpZWxkc0xvb2soKTtcbiAgICAgICAgZmFpbDJCYW5JbmRleC5pbml0aWFsaXplRm9ybSgpO1xuICAgIH0sXG5cbiAgICAvLyBUaGlzIG1ldGhvZCBjaGFuZ2VzIHRoZSBsb29rIG9mIHRoZSBmaWVsZHMgYmFzZWQgb24gd2hldGhlciBGYWlsMkJhbiBpcyBlbmFibGVkIG9yIG5vdC5cbiAgICBjaGFuZ2VGaWVsZHNMb29rKCkge1xuICAgICAgICBjb25zdCBjaGVja2VkID0gZmFpbDJCYW5JbmRleC4kZW5hYmxlQ2hlY2tCb3guY2hlY2tib3goJ2lzIGNoZWNrZWQnKTtcbiAgICAgICAgZmFpbDJCYW5JbmRleC4kZm9ybU9iai5maW5kKCcuZGlzYWJpbGl0eScpLmVhY2goKGluZGV4LCBvYmopID0+IHtcbiAgICAgICAgICAgIGlmIChjaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgJChvYmopLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAkKG9iaikuYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvLyBUaGlzIGNhbGxiYWNrIG1ldGhvZCBpcyB1c2VkIHRvIGRpc3BsYXkgdGhlIGxpc3Qgb2YgYmFubmVkIElQcy5cbiAgICBjYkdldEJhbm5lZElwTGlzdChyZXNwb25zZSkge1xuICAgICAgICBpZiAocmVzcG9uc2UgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbGV0IGh0bWxUYWJsZSA9IGA8aDIgY2xhc3M9XCJ1aSBoZWFkZXJcIj4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfVGFibGVCYW5uZWRIZWFkZXJ9PC9oMj5gO1xuICAgICAgICBodG1sVGFibGUgKz0gJzx0YWJsZSBjbGFzcz1cInVpIHZlcnkgY29tcGFjdCB1bnN0YWNrYWJsZSB0YWJsZVwiPic7XG4gICAgICAgIGh0bWxUYWJsZSArPSAnPHRoZWFkPic7XG4gICAgICAgIGh0bWxUYWJsZSArPSBgPHRoPiR7Z2xvYmFsVHJhbnNsYXRlLmYyYl9SZWFzb259PC90aD5gO1xuICAgICAgICBodG1sVGFibGUgKz0gYDx0aD4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfSXBBZGRyZXN9PC90aD5gO1xuICAgICAgICBodG1sVGFibGUgKz0gYDx0aD4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfQmFuZWRUaW1lfTwvdGg+YDtcbiAgICAgICAgaHRtbFRhYmxlICs9ICc8dGg+PC90aD4nO1xuICAgICAgICBodG1sVGFibGUgKz0gJzwvdGhlYWQ+JztcbiAgICAgICAgaHRtbFRhYmxlICs9ICc8dGJvZHk+JztcbiAgICAgICAgcmVzcG9uc2Uuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgICAgY29uc3Qga2V5QSA9IGEudGltZW9mYmFuO1xuICAgICAgICAgICAgY29uc3Qga2V5QiA9IGIudGltZW9mYmFuO1xuICAgICAgICAgICAgLy8gQ29tcGFyZSB0aGUgMiBkYXRlc1xuICAgICAgICAgICAgaWYgKGtleUEgPCBrZXlCKSByZXR1cm4gMTtcbiAgICAgICAgICAgIGlmIChrZXlBID4ga2V5QikgcmV0dXJuIC0xO1xuICAgICAgICAgICAgcmV0dXJuIDA7XG4gICAgICAgIH0pO1xuICAgICAgICAkLmVhY2gocmVzcG9uc2UsIChrZXksIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBibG9ja0RhdGUgPSBuZXcgRGF0ZSh2YWx1ZS50aW1lb2ZiYW4gKiAxMDAwKTtcbiAgICAgICAgICAgIGxldCByZWFzb24gPSBgZjJiX0phaWxfJHt2YWx1ZS5qYWlsfWA7XG4gICAgICAgICAgICBpZiAocmVhc29uIGluIGdsb2JhbFRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgIHJlYXNvbiA9IGdsb2JhbFRyYW5zbGF0ZVtyZWFzb25dO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBodG1sVGFibGUgKz0gJzx0cj4nO1xuICAgICAgICAgICAgaHRtbFRhYmxlICs9IGA8dGQ+JHtyZWFzb259PC90ZD5gO1xuICAgICAgICAgICAgaHRtbFRhYmxlICs9IGA8dGQ+JHt2YWx1ZS5pcH08L3RkPmA7XG4gICAgICAgICAgICBodG1sVGFibGUgKz0gYDx0ZD4ke2Jsb2NrRGF0ZS50b0xvY2FsZVN0cmluZygpfTwvdGQ+YDtcbiAgICAgICAgICAgIGh0bWxUYWJsZSArPSBgPHRkIGNsYXNzPVwicmlnaHQgYWxpZ25lZCBjb2xsYXBzaW5nXCI+PGJ1dHRvbiBjbGFzcz1cInVpIGljb24gYmFzaWMgbWluaSBidXR0b24gdW5iYW4tYnV0dG9uXCIgZGF0YS12YWx1ZT1cIiR7dmFsdWUuaXB9XCI+PGkgY2xhc3M9XCJpY29uIHRyYXNoIHJlZFwiPjwvaT4ke2dsb2JhbFRyYW5zbGF0ZS5mMmJfVW5iYW59PC9idXR0b24+PC90ZD5gO1xuICAgICAgICAgICAgaHRtbFRhYmxlICs9ICc8L3RyPic7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAocmVzcG9uc2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBodG1sVGFibGUgKz0gYDx0cj48dGQgY29sc3Bhbj1cIjRcIiBjbGFzcz1cImNlbnRlciBhbGlnbmVkXCI+JHtnbG9iYWxUcmFuc2xhdGUuZjJiX1RhYmxlQmFubmVkRW1wdHl9PC90ZD48L3RyPmA7XG4gICAgICAgIH1cbiAgICAgICAgaHRtbFRhYmxlICs9ICc8dGJvZHk+JztcbiAgICAgICAgaHRtbFRhYmxlICs9ICc8L3RhYmxlPic7XG4gICAgICAgIGZhaWwyQmFuSW5kZXguJGJhbm5lZElwTGlzdC5odG1sKGh0bWxUYWJsZSk7XG4gICAgfSxcblxuICAgIC8vIFRoaXMgY2FsbGJhY2sgbWV0aG9kIGlzIHVzZWQgYWZ0ZXIgYW4gSVAgaGFzIGJlZW4gdW5iYW5uZWQuXG4gICAgY2JBZnRlclVuQmFuSXAoKSB7XG4gICAgICAgIFBieEFwaS5TeXN0ZW1HZXRCYW5uZWRJcChmYWlsMkJhbkluZGV4LmNiR2V0QmFubmVkSXBMaXN0KTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIGJlZm9yZSB0aGUgZm9ybSBpcyBzZW50XG4gICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gVGhlIGN1cnJlbnQgc2V0dGluZ3Mgb2YgdGhlIGZvcm1cbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIFRoZSB1cGRhdGVkIHNldHRpbmdzIG9mIHRoZSBmb3JtXG4gICAgICovXG4gICAgY2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncykge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBzZXR0aW5ncztcbiAgICAgICAgcmVzdWx0LmRhdGEgPSBmYWlsMkJhbkluZGV4LiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIGFmdGVyIHRoZSBmb3JtIGhhcyBiZWVuIHNlbnQuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBhZnRlciB0aGUgZm9ybSBpcyBzZW50XG4gICAgICovXG4gICAgY2JBZnRlclNlbmRGb3JtKHJlc3BvbnNlKSB7XG5cbiAgICB9LFxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemUgdGhlIGZvcm0gd2l0aCBjdXN0b20gc2V0dGluZ3NcbiAgICAgKi9cbiAgICBpbml0aWFsaXplRm9ybSgpIHtcbiAgICAgICAgRm9ybS4kZm9ybU9iaiA9IGZhaWwyQmFuSW5kZXguJGZvcm1PYmo7XG4gICAgICAgIEZvcm0udXJsID0gYCR7Z2xvYmFsUm9vdFVybH1mYWlsMi1iYW4vc2F2ZWA7IC8vIEZvcm0gc3VibWlzc2lvbiBVUkxcbiAgICAgICAgRm9ybS52YWxpZGF0ZVJ1bGVzID0gZmFpbDJCYW5JbmRleC52YWxpZGF0ZVJ1bGVzOyAvLyBGb3JtIHZhbGlkYXRpb24gcnVsZXNcbiAgICAgICAgRm9ybS5jYkJlZm9yZVNlbmRGb3JtID0gZmFpbDJCYW5JbmRleC5jYkJlZm9yZVNlbmRGb3JtOyAvLyBDYWxsYmFjayBiZWZvcmUgZm9ybSBpcyBzZW50XG4gICAgICAgIEZvcm0uY2JBZnRlclNlbmRGb3JtID0gZmFpbDJCYW5JbmRleC5jYkFmdGVyU2VuZEZvcm07IC8vIENhbGxiYWNrIGFmdGVyIGZvcm0gaXMgc2VudFxuICAgICAgICBGb3JtLmluaXRpYWxpemUoKTtcbiAgICB9LFxufTtcblxuLy8gV2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHksIGluaXRpYWxpemUgdGhlIEZhaWwyQmFuIG1hbmFnZW1lbnQgaW50ZXJmYWNlLlxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIGZhaWwyQmFuSW5kZXguaW5pdGlhbGl6ZSgpO1xufSk7XG5cbiJdfQ==