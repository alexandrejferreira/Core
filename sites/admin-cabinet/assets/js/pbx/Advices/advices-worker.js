"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalWebAdminLanguage, sessionStorage, $, globalTranslate */

/**
 * Advice Worker module.
 * @module advicesWorker
 */
var advicesWorker = {
  /**
   * Time in milliseconds before fetching new advice.
   * @type {number}
   */
  timeOut: 300000,

  /**
   * The id of the timer function for advice worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * jQuery element for advice container.
   * @type {jQuery}
   */
  $advices: $('#advices'),

  /**
   * jQuery element for advice bell button.
   * @type {jQuery}
   */
  $advicesBellButton: $('#show-advices-button'),

  /**
   * Initializes the advice worker.
   */
  initialize: function initialize() {
    advicesWorker.showPreviousAdvice(); // Let's initiate the retrieval of new advice.

    advicesWorker.restartWorker();
    window.addEventListener('ConfigDataChanged', advicesWorker.cbOnDataChanged);
  },

  /**
   * Restarts the advices worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(advicesWorker.timeoutHandle);
    advicesWorker.worker();
  },

  /**
   * Event handler for language or data change.
   */
  cbOnDataChanged: function cbOnDataChanged() {
    sessionStorage.removeItem("previousAdvice".concat(globalWebAdminLanguage));
    sessionStorage.removeItem("previousAdviceBell".concat(globalWebAdminLanguage));
    setTimeout(advicesWorker.restartWorker, 3000);
  },

  /**
   * Shows old advice until receiving an update from the station.
   */
  showPreviousAdvice: function showPreviousAdvice() {
    var previousAdviceBell = sessionStorage.getItem("previousAdviceBell".concat(globalWebAdminLanguage));

    if (previousAdviceBell) {
      advicesWorker.$advicesBellButton.html(previousAdviceBell);
    }

    var previousAdvice = sessionStorage.getItem("previousAdvice".concat(globalWebAdminLanguage));

    if (previousAdvice) {
      advicesWorker.$advices.html(previousAdvice);
    }
  },

  /**
   * Worker function for fetching advices.
   */
  worker: function worker() {
    PbxApi.AdvicesGetList(advicesWorker.cbAfterResponse);
  },

  /**
   * Callback function after receiving the response.
   * @param {object} response - Response object from the API.
   */
  cbAfterResponse: function cbAfterResponse(response) {
    if (response === false) {
      return;
    }

    advicesWorker.$advices.html('');

    if (response.advices !== undefined) {
      var htmlMessages = '';
      var countMessages = 0;
      var iconBellClass = '';
      htmlMessages += '<div class="ui relaxed divided list">';

      if (response.advices.needUpdate !== undefined && response.advices.needUpdate.length > 0) {
        $(window).trigger('SecurityWarning', [response.advices]);
      }

      if (response.advices.error !== undefined && response.advices.error.length > 0) {
        $.each(response.advices.error, function (key, value) {
          htmlMessages += '<div class="item">';
          htmlMessages += '<i class="frown outline red icon"></i>';
          htmlMessages += "<b>".concat(value, "</b>");
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advices.warning !== undefined && response.advices.warning.length > 0) {
        $.each(response.advices.warning, function (key, value) {
          htmlMessages += '<div class="item yellow">';
          htmlMessages += '<i class="meh outline yellow icon"></i>';
          htmlMessages += "<b>".concat(value, "</b>");
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advices.info !== undefined && response.advices.info.length > 0) {
        $.each(response.advices.info, function (key, value) {
          htmlMessages += '<div class="item">';
          htmlMessages += '<i class="smile outline blue icon"></i>';
          htmlMessages += "<b>".concat(value, "</b>");
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advices.error !== undefined && response.advices.error.length > 0) {
        iconBellClass = 'red large icon bell';
      } else if (response.advices.warning !== undefined && response.advices.warning.length > 0) {
        iconBellClass = 'yellow icon bell';
      } else if (response.advices.info !== undefined && response.advices.info.length > 0) {
        iconBellClass = 'blue icon bell';
      }

      htmlMessages += '</div>';
      advicesWorker.$advices.html(htmlMessages);
      sessionStorage.setItem("previousAdvice".concat(globalWebAdminLanguage), htmlMessages);

      if (countMessages > 0) {
        advicesWorker.$advicesBellButton.html("<i class=\"".concat(iconBellClass, "\"></i>").concat(countMessages)).popup({
          position: 'bottom left',
          popup: advicesWorker.$advices,
          delay: {
            show: 300,
            hide: 10000
          },
          movePopup: false
        });
        advicesWorker.$advicesBellButton.find('i').transition('set looping').transition('pulse', '1000ms');
      } else {
        advicesWorker.$advicesBellButton.html("<i class=\"grey icon bell\"></i>");
      }

      sessionStorage.setItem("previousAdviceBell".concat(globalWebAdminLanguage), advicesWorker.$advicesBellButton.html());
      advicesWorker.timeoutHandle = window.setTimeout(advicesWorker.worker, advicesWorker.timeOut);
    } else if (response.success === true && response.advices !== undefined && response.advices.length === 0) {
      sessionStorage.removeItem("previousAdvice".concat(globalWebAdminLanguage));
      sessionStorage.removeItem("previousAdviceBell".concat(globalWebAdminLanguage));
      advicesWorker.$advicesBellButton.html('<i class="grey icon bell outline"></i>');
    }
  }
};
/**
 *  Initialize advices worker on document ready
 */

$(document).ready(function () {
  advicesWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BZHZpY2VzL2FkdmljZXMtd29ya2VyLmpzIl0sIm5hbWVzIjpbImFkdmljZXNXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsIiRhZHZpY2VzIiwiJCIsIiRhZHZpY2VzQmVsbEJ1dHRvbiIsImluaXRpYWxpemUiLCJzaG93UHJldmlvdXNBZHZpY2UiLCJyZXN0YXJ0V29ya2VyIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsImNiT25EYXRhQ2hhbmdlZCIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJzZXNzaW9uU3RvcmFnZSIsInJlbW92ZUl0ZW0iLCJnbG9iYWxXZWJBZG1pbkxhbmd1YWdlIiwic2V0VGltZW91dCIsInByZXZpb3VzQWR2aWNlQmVsbCIsImdldEl0ZW0iLCJodG1sIiwicHJldmlvdXNBZHZpY2UiLCJQYnhBcGkiLCJBZHZpY2VzR2V0TGlzdCIsImNiQWZ0ZXJSZXNwb25zZSIsInJlc3BvbnNlIiwiYWR2aWNlcyIsInVuZGVmaW5lZCIsImh0bWxNZXNzYWdlcyIsImNvdW50TWVzc2FnZXMiLCJpY29uQmVsbENsYXNzIiwibmVlZFVwZGF0ZSIsImxlbmd0aCIsInRyaWdnZXIiLCJlcnJvciIsImVhY2giLCJrZXkiLCJ2YWx1ZSIsIndhcm5pbmciLCJpbmZvIiwic2V0SXRlbSIsInBvcHVwIiwicG9zaXRpb24iLCJkZWxheSIsInNob3ciLCJoaWRlIiwibW92ZVBvcHVwIiwiZmluZCIsInRyYW5zaXRpb24iLCJzdWNjZXNzIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsYUFBYSxHQUFHO0FBRWxCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVB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QWpCLENBQUMsQ0FBQytDLFFBQUQsQ0FBRCxDQUFZQyxLQUFaLENBQWtCLFlBQU07QUFDcEJwRCxFQUFBQSxhQUFhLENBQUNNLFVBQWQ7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsIGdsb2JhbFdlYkFkbWluTGFuZ3VhZ2UsIHNlc3Npb25TdG9yYWdlLCAkLCBnbG9iYWxUcmFuc2xhdGUgKi9cblxuLyoqXG4gKiBBZHZpY2UgV29ya2VyIG1vZHVsZS5cbiAqIEBtb2R1bGUgYWR2aWNlc1dvcmtlclxuICovXG5jb25zdCBhZHZpY2VzV29ya2VyID0ge1xuXG4gICAgLyoqXG4gICAgICogVGltZSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGZldGNoaW5nIG5ldyBhZHZpY2UuXG4gICAgICogQHR5cGUge251bWJlcn1cbiAgICAgKi9cbiAgICB0aW1lT3V0OiAzMDAwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciBhZHZpY2Ugd29ya2VyLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dEhhbmRsZTogMCxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBlbGVtZW50IGZvciBhZHZpY2UgY29udGFpbmVyLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGFkdmljZXM6ICQoJyNhZHZpY2VzJyksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgZWxlbWVudCBmb3IgYWR2aWNlIGJlbGwgYnV0dG9uLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGFkdmljZXNCZWxsQnV0dG9uOiAkKCcjc2hvdy1hZHZpY2VzLWJ1dHRvbicpLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIGFkdmljZSB3b3JrZXIuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgYWR2aWNlc1dvcmtlci5zaG93UHJldmlvdXNBZHZpY2UoKTtcblxuICAgICAgICAvLyBMZXQncyBpbml0aWF0ZSB0aGUgcmV0cmlldmFsIG9mIG5ldyBhZHZpY2UuXG4gICAgICAgIGFkdmljZXNXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignQ29uZmlnRGF0YUNoYW5nZWQnLCBhZHZpY2VzV29ya2VyLmNiT25EYXRhQ2hhbmdlZCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJlc3RhcnRzIHRoZSBhZHZpY2VzIHdvcmtlci5cbiAgICAgKi9cbiAgICByZXN0YXJ0V29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGFkdmljZXNXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIGFkdmljZXNXb3JrZXIud29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEV2ZW50IGhhbmRsZXIgZm9yIGxhbmd1YWdlIG9yIGRhdGEgY2hhbmdlLlxuICAgICAqL1xuICAgIGNiT25EYXRhQ2hhbmdlZCgpIHtcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShgcHJldmlvdXNBZHZpY2Uke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCk7XG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oYHByZXZpb3VzQWR2aWNlQmVsbCR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgc2V0VGltZW91dChhZHZpY2VzV29ya2VyLnJlc3RhcnRXb3JrZXIsIDMwMDApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBTaG93cyBvbGQgYWR2aWNlIHVudGlsIHJlY2VpdmluZyBhbiB1cGRhdGUgZnJvbSB0aGUgc3RhdGlvbi5cbiAgICAgKi9cbiAgICBzaG93UHJldmlvdXNBZHZpY2UoKSB7XG4gICAgICAgIGNvbnN0IHByZXZpb3VzQWR2aWNlQmVsbCA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oYHByZXZpb3VzQWR2aWNlQmVsbCR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgaWYgKHByZXZpb3VzQWR2aWNlQmVsbCkge1xuICAgICAgICAgICAgYWR2aWNlc1dvcmtlci4kYWR2aWNlc0JlbGxCdXR0b24uaHRtbChwcmV2aW91c0FkdmljZUJlbGwpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHByZXZpb3VzQWR2aWNlID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShgcHJldmlvdXNBZHZpY2Uke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCk7XG4gICAgICAgIGlmIChwcmV2aW91c0FkdmljZSkge1xuICAgICAgICAgICAgYWR2aWNlc1dvcmtlci4kYWR2aWNlcy5odG1sKHByZXZpb3VzQWR2aWNlKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBXb3JrZXIgZnVuY3Rpb24gZm9yIGZldGNoaW5nIGFkdmljZXMuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICBQYnhBcGkuQWR2aWNlc0dldExpc3QoYWR2aWNlc1dvcmtlci5jYkFmdGVyUmVzcG9uc2UpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBhZnRlciByZWNlaXZpbmcgdGhlIHJlc3BvbnNlLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZSAtIFJlc3BvbnNlIG9iamVjdCBmcm9tIHRoZSBBUEkuXG4gICAgICovXG4gICAgY2JBZnRlclJlc3BvbnNlKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBhZHZpY2VzV29ya2VyLiRhZHZpY2VzLmh0bWwoJycpO1xuICAgICAgICBpZiAocmVzcG9uc2UuYWR2aWNlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsZXQgaHRtbE1lc3NhZ2VzID0gJyc7XG4gICAgICAgICAgICBsZXQgY291bnRNZXNzYWdlcyA9IDA7XG4gICAgICAgICAgICBsZXQgaWNvbkJlbGxDbGFzcyA9ICcnO1xuICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8ZGl2IGNsYXNzPVwidWkgcmVsYXhlZCBkaXZpZGVkIGxpc3RcIj4nO1xuXG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuYWR2aWNlcy5uZWVkVXBkYXRlICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2VzLm5lZWRVcGRhdGUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICQod2luZG93KS50cmlnZ2VyKCdTZWN1cml0eVdhcm5pbmcnLCBbcmVzcG9uc2UuYWR2aWNlc10pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocmVzcG9uc2UuYWR2aWNlcy5lcnJvciAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlcy5lcnJvci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgJC5lYWNoKHJlc3BvbnNlLmFkdmljZXMuZXJyb3IsIChrZXksIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPGRpdiBjbGFzcz1cIml0ZW1cIj4nO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzxpIGNsYXNzPVwiZnJvd24gb3V0bGluZSByZWQgaWNvblwiPjwvaT4nO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gYDxiPiR7dmFsdWV9PC9iPmA7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgY291bnRNZXNzYWdlcyArPSAxO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmFkdmljZXMud2FybmluZyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlcy53YXJuaW5nLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAkLmVhY2gocmVzcG9uc2UuYWR2aWNlcy53YXJuaW5nLCAoa2V5LCB2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzxkaXYgY2xhc3M9XCJpdGVtIHllbGxvd1wiPic7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPGkgY2xhc3M9XCJtZWggb3V0bGluZSB5ZWxsb3cgaWNvblwiPjwvaT4nO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gYDxiPiR7dmFsdWV9PC9iPmA7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgY291bnRNZXNzYWdlcyArPSAxO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmFkdmljZXMuaW5mbyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlcy5pbmZvLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAkLmVhY2gocmVzcG9uc2UuYWR2aWNlcy5pbmZvLCAoa2V5LCB2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzxkaXYgY2xhc3M9XCJpdGVtXCI+JztcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8aSBjbGFzcz1cInNtaWxlIG91dGxpbmUgYmx1ZSBpY29uXCI+PC9pPic7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSBgPGI+JHt2YWx1ZX08L2I+YDtcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICBjb3VudE1lc3NhZ2VzICs9IDE7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5hZHZpY2VzLmVycm9yICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2VzLmVycm9yLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpY29uQmVsbENsYXNzID0gJ3JlZCBsYXJnZSBpY29uIGJlbGwnO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5hZHZpY2VzLndhcm5pbmcgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZXMud2FybmluZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWNvbkJlbGxDbGFzcyA9ICd5ZWxsb3cgaWNvbiBiZWxsJztcblxuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5hZHZpY2VzLmluZm8gIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZXMuaW5mby5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWNvbkJlbGxDbGFzcyA9ICdibHVlIGljb24gYmVsbCc7XG4gICAgICAgICAgICB9XG5cblxuICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8L2Rpdj4nO1xuICAgICAgICAgICAgYWR2aWNlc1dvcmtlci4kYWR2aWNlcy5odG1sKGh0bWxNZXNzYWdlcyk7XG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGBwcmV2aW91c0FkdmljZSR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gLCBodG1sTWVzc2FnZXMpO1xuXG4gICAgICAgICAgICBpZiAoY291bnRNZXNzYWdlcyA+IDApIHtcbiAgICAgICAgICAgICAgICBhZHZpY2VzV29ya2VyLiRhZHZpY2VzQmVsbEJ1dHRvblxuICAgICAgICAgICAgICAgICAgICAuaHRtbChgPGkgY2xhc3M9XCIke2ljb25CZWxsQ2xhc3N9XCI+PC9pPiR7Y291bnRNZXNzYWdlc31gKVxuICAgICAgICAgICAgICAgICAgICAucG9wdXAoe1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICdib3R0b20gbGVmdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3B1cDogYWR2aWNlc1dvcmtlci4kYWR2aWNlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGF5OiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdzogMzAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGU6IDEwMDAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVQb3B1cDogZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYWR2aWNlc1dvcmtlci4kYWR2aWNlc0JlbGxCdXR0b24uZmluZCgnaScpXG4gICAgICAgICAgICAgICAgICAgIC50cmFuc2l0aW9uKCdzZXQgbG9vcGluZycpXG4gICAgICAgICAgICAgICAgICAgIC50cmFuc2l0aW9uKCdwdWxzZScsICcxMDAwbXMnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgYWR2aWNlc1dvcmtlci4kYWR2aWNlc0JlbGxCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgLmh0bWwoYDxpIGNsYXNzPVwiZ3JleSBpY29uIGJlbGxcIj48L2k+YClcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oYHByZXZpb3VzQWR2aWNlQmVsbCR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gLCBhZHZpY2VzV29ya2VyLiRhZHZpY2VzQmVsbEJ1dHRvbi5odG1sKCkpO1xuICAgICAgICAgICAgYWR2aWNlc1dvcmtlci50aW1lb3V0SGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoXG4gICAgICAgICAgICAgICAgYWR2aWNlc1dvcmtlci53b3JrZXIsXG4gICAgICAgICAgICAgICAgYWR2aWNlc1dvcmtlci50aW1lT3V0LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdWNjZXNzID09PSB0cnVlXG4gICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2VzICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGBwcmV2aW91c0FkdmljZSR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oYHByZXZpb3VzQWR2aWNlQmVsbCR7Z2xvYmFsV2ViQWRtaW5MYW5ndWFnZX1gKTtcbiAgICAgICAgICAgIGFkdmljZXNXb3JrZXIuJGFkdmljZXNCZWxsQnV0dG9uXG4gICAgICAgICAgICAgICAgLmh0bWwoJzxpIGNsYXNzPVwiZ3JleSBpY29uIGJlbGwgb3V0bGluZVwiPjwvaT4nKTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG4vKipcbiAqICBJbml0aWFsaXplIGFkdmljZXMgd29ya2VyIG9uIGRvY3VtZW50IHJlYWR5XG4gKi9cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBhZHZpY2VzV29ya2VyLmluaXRpYWxpemUoKTtcbn0pO1xuIl19