"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, globalWebAdminLanguage, sessionStorage, $, globalTranslate */

/**
 * Advice Worker module.
 * @module advicesWorker
 */
var advicesWorker = {
  /**
   * Time in milliseconds before fetching new advice.
   * @type {number}
   */
  timeOut: 300000,

  /**
   * The id of the timer function for advice worker.
   * @type {number}
   */
  timeOutHandle: 0,

  /**
   * jQuery element for advice container.
   * @type {jQuery}
   */
  $advices: $('#advices'),

  /**
   * jQuery element for advice bell button.
   * @type {jQuery}
   */
  $advicesBellButton: $('#show-advices-button'),

  /**
   * Initializes the advice worker.
   */
  initialize: function initialize() {
    advicesWorker.showPreviousAdvice(); // Let's initiate the retrieval of new advice.

    advicesWorker.restartWorker();
    window.addEventListener('ConfigDataChanged', advicesWorker.cbOnDataChanged);
  },

  /**
   * Restarts the advices worker.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(advicesWorker.timeoutHandle);
    advicesWorker.worker();
  },

  /**
   * Event handler for language or data change.
   */
  cbOnDataChanged: function cbOnDataChanged() {
    sessionStorage.removeItem("previousAdvice".concat(globalWebAdminLanguage));
    sessionStorage.removeItem("previousAdviceBell".concat(globalWebAdminLanguage));
    setTimeout(advicesWorker.restartWorker, 3000);
  },

  /**
   * Shows old advice until receiving an update from the station.
   */
  showPreviousAdvice: function showPreviousAdvice() {
    var previousAdviceBell = sessionStorage.getItem("previousAdviceBell".concat(globalWebAdminLanguage));

    if (previousAdviceBell) {
      advicesWorker.$advicesBellButton.html(previousAdviceBell);
    }

    var previousAdvice = sessionStorage.getItem("previousAdvice".concat(globalWebAdminLanguage));

    if (previousAdvice) {
      advicesWorker.$advices.html(previousAdvice);
      advicesWorker.$advicesBellButton.popup({
        position: 'bottom left',
        popup: advicesWorker.$advices,
        delay: {
          show: 300,
          hide: 10000
        },
        on: 'click',
        movePopup: false
      });
    }
  },

  /**
   * Worker function for fetching advices.
   */
  worker: function worker() {
    PbxApi.AdvicesGetList(advicesWorker.cbAfterResponse);
  },

  /**
   * Callback function after receiving the response.
   * @param {object} response - Response object from the API.
   */
  cbAfterResponse: function cbAfterResponse(response) {
    if (response === false) {
      return;
    }

    advicesWorker.$advices.html('');

    if (response.advices !== undefined) {
      var htmlMessages = '';
      var countMessages = 0;
      var iconBellClass = '';
      htmlMessages += "<div class=\"ui header\">".concat(globalTranslate.adv_PopupHeader, "</div>");
      htmlMessages += '<div class="ui relaxed divided list">';

      if (response.advices.needUpdate !== undefined && response.advices.needUpdate.length > 0) {
        $(window).trigger('SecurityWarning', [response.advices]);
      }

      if (response.advices.error !== undefined && response.advices.error.length > 0) {
        $.each(response.advices.error, function (key, value) {
          htmlMessages += '<div class="item">';
          htmlMessages += '<i class="frown outline red icon"></i>';
          htmlMessages += "".concat(value);
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advices.warning !== undefined && response.advices.warning.length > 0) {
        $.each(response.advices.warning, function (key, value) {
          htmlMessages += '<div class="item yellow">';
          htmlMessages += '<i class="meh outline yellow icon"></i>';
          htmlMessages += "".concat(value);
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advices.info !== undefined && response.advices.info.length > 0) {
        $.each(response.advices.info, function (key, value) {
          htmlMessages += '<div class="item">';
          htmlMessages += '<i class="smile outline blue icon"></i>';
          htmlMessages += "".concat(value);
          htmlMessages += '</div>';
          countMessages += 1;
        });
      }

      if (response.advices.error !== undefined && response.advices.error.length > 0) {
        iconBellClass = 'red icon bell';
      } else if (response.advices.warning !== undefined && response.advices.warning.length > 0) {
        iconBellClass = 'yellow icon bell';
      } else if (response.advices.info !== undefined && response.advices.info.length > 0) {
        iconBellClass = 'blue icon bell';
      }

      htmlMessages += '</div>';
      advicesWorker.$advices.html(htmlMessages);
      sessionStorage.setItem("previousAdvice".concat(globalWebAdminLanguage), htmlMessages);

      if (countMessages > 0) {
        advicesWorker.$advicesBellButton.html("<i class=\"".concat(iconBellClass, "\"></i>").concat(countMessages)).popup({
          position: 'bottom left',
          popup: advicesWorker.$advices,
          delay: {
            show: 300,
            hide: 10000
          },
          on: 'click',
          movePopup: false
        });
        advicesWorker.$advicesBellButton.find('i').transition('set looping').transition('pulse', '1000ms');
      } else {
        advicesWorker.$advicesBellButton.html("<i class=\"grey icon bell\"></i>");
      }

      sessionStorage.setItem("previousAdviceBell".concat(globalWebAdminLanguage), advicesWorker.$advicesBellButton.html());
      advicesWorker.timeoutHandle = window.setTimeout(advicesWorker.worker, advicesWorker.timeOut);
    } else if (response.success === true && response.advices !== undefined && response.advices.length === 0) {
      sessionStorage.removeItem("previousAdvice".concat(globalWebAdminLanguage));
      sessionStorage.removeItem("previousAdviceBell".concat(globalWebAdminLanguage));
      advicesWorker.$advicesBellButton.html('<i class="grey icon bell outline"></i>');
    }
  }
};
/**
 *  Initialize advices worker on document ready
 */

$(document).ready(function () {
  advicesWorker.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BZHZpY2VzL2FkdmljZXMtd29ya2VyLmpzIl0sIm5hbWVzIjpbImFkdmljZXNXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsIiRhZHZpY2VzIiwiJCIsIiRhZHZpY2VzQmVsbEJ1dHRvbiIsImluaXRpYWxpemUiLCJzaG93UHJldmlvdXNBZHZpY2UiLCJyZXN0YXJ0V29ya2VyIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsImNiT25EYXRhQ2hhbmdlZCIsImNsZWFyVGltZW91dCIsInRpbWVvdXRIYW5kbGUiLCJ3b3JrZXIiLCJzZXNzaW9uU3RvcmFnZSIsInJlbW92ZUl0ZW0iLCJnbG9iYWxXZWJBZG1pbkxhbmd1YWdlIiwic2V0VGltZW91dCIsInByZXZpb3VzQWR2aWNlQmVsbCIsImdldEl0ZW0iLCJodG1sIiwicHJldmlvdXNBZHZpY2UiLCJwb3B1cCIsInBvc2l0aW9uIiwiZGVsYXkiLCJzaG93IiwiaGlkZSIsIm9uIiwibW92ZVBvcHVwIiwiUGJ4QXBpIiwiQWR2aWNlc0dldExpc3QiLCJjYkFmdGVyUmVzcG9uc2UiLCJyZXNwb25zZSIsImFkdmljZXMiLCJ1bmRlZmluZWQiLCJodG1sTWVzc2FnZXMiLCJjb3VudE1lc3NhZ2VzIiwiaWNvbkJlbGxDbGFzcyIsImdsb2JhbFRyYW5zbGF0ZSIsImFkdl9Qb3B1cEhlYWRlciIsIm5lZWRVcGRhdGUiLCJsZW5ndGgiLCJ0cmlnZ2VyIiwiZXJyb3IiLCJlYWNoIiwia2V5IiwidmFsdWUiLCJ3YXJuaW5nIiwiaW5mbyIsInNldEl0ZW0iLCJmaW5kIiwidHJhbnNpdGlvbiIsInN1Y2Nlc3MiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFN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LFVBQVAsQ0FDMUJsQixhQUFhLENBQUNjLE1BRFksRUFFMUJkLGFBQWEsQ0FBQ0MsT0FGWSxDQUE5QjtBQUlILEtBbkZELE1BbUZPLElBQUlnQyxRQUFRLENBQUNvQixPQUFULEtBQXFCLElBQXJCLElBQ0pwQixRQUFRLENBQUNDLE9BQVQsS0FBcUJDLFNBRGpCLElBRUpGLFFBQVEsQ0FBQ0MsT0FBVCxDQUFpQlEsTUFBakIsS0FBNEIsQ0FGNUIsRUFFK0I7QUFDbEMzQixNQUFBQSxjQUFjLENBQUNDLFVBQWYseUJBQTJDQyxzQkFBM0M7QUFDQUYsTUFBQUEsY0FBYyxDQUFDQyxVQUFmLDZCQUErQ0Msc0JBQS9DO0FBQ0FqQixNQUFBQSxhQUFhLENBQUNLLGtCQUFkLENBQ0tnQixJQURMLENBQ1Usd0NBRFY7QUFFSDtBQUNKO0FBekxpQixDQUF0QjtBQTRMQTtBQUNBO0FBQ0E7O0FBQ0FqQixDQUFDLENBQUNrRCxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCdkQsRUFBQUEsYUFBYSxDQUFDTSxVQUFkO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBnbG9iYWxXZWJBZG1pbkxhbmd1YWdlLCBzZXNzaW9uU3RvcmFnZSwgJCwgZ2xvYmFsVHJhbnNsYXRlICovXG5cbi8qKlxuICogQWR2aWNlIFdvcmtlciBtb2R1bGUuXG4gKiBAbW9kdWxlIGFkdmljZXNXb3JrZXJcbiAqL1xuY29uc3QgYWR2aWNlc1dvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgYWR2aWNlLlxuICAgICAqIEB0eXBlIHtudW1iZXJ9XG4gICAgICovXG4gICAgdGltZU91dDogMzAwMDAwLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGlkIG9mIHRoZSB0aW1lciBmdW5jdGlvbiBmb3IgYWR2aWNlIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgZWxlbWVudCBmb3IgYWR2aWNlIGNvbnRhaW5lci5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRhZHZpY2VzOiAkKCcjYWR2aWNlcycpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IGVsZW1lbnQgZm9yIGFkdmljZSBiZWxsIGJ1dHRvbi5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRhZHZpY2VzQmVsbEJ1dHRvbjogJCgnI3Nob3ctYWR2aWNlcy1idXR0b24nKSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBhZHZpY2Ugd29ya2VyLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIGFkdmljZXNXb3JrZXIuc2hvd1ByZXZpb3VzQWR2aWNlKCk7XG5cbiAgICAgICAgLy8gTGV0J3MgaW5pdGlhdGUgdGhlIHJldHJpZXZhbCBvZiBuZXcgYWR2aWNlLlxuICAgICAgICBhZHZpY2VzV29ya2VyLnJlc3RhcnRXb3JrZXIoKTtcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ0NvbmZpZ0RhdGFDaGFuZ2VkJywgYWR2aWNlc1dvcmtlci5jYk9uRGF0YUNoYW5nZWQpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSZXN0YXJ0cyB0aGUgYWR2aWNlcyB3b3JrZXIuXG4gICAgICovXG4gICAgcmVzdGFydFdvcmtlcigpIHtcbiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChhZHZpY2VzV29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuICAgICAgICBhZHZpY2VzV29ya2VyLndvcmtlcigpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBFdmVudCBoYW5kbGVyIGZvciBsYW5ndWFnZSBvciBkYXRhIGNoYW5nZS5cbiAgICAgKi9cbiAgICBjYk9uRGF0YUNoYW5nZWQoKSB7XG4gICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oYHByZXZpb3VzQWR2aWNlJHtnbG9iYWxXZWJBZG1pbkxhbmd1YWdlfWApO1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGBwcmV2aW91c0FkdmljZUJlbGwke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCk7XG4gICAgICAgIHNldFRpbWVvdXQoYWR2aWNlc1dvcmtlci5yZXN0YXJ0V29ya2VyLCAzMDAwKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogU2hvd3Mgb2xkIGFkdmljZSB1bnRpbCByZWNlaXZpbmcgYW4gdXBkYXRlIGZyb20gdGhlIHN0YXRpb24uXG4gICAgICovXG4gICAgc2hvd1ByZXZpb3VzQWR2aWNlKCkge1xuICAgICAgICBjb25zdCBwcmV2aW91c0FkdmljZUJlbGwgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGBwcmV2aW91c0FkdmljZUJlbGwke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCk7XG4gICAgICAgIGlmIChwcmV2aW91c0FkdmljZUJlbGwpIHtcbiAgICAgICAgICAgIGFkdmljZXNXb3JrZXIuJGFkdmljZXNCZWxsQnV0dG9uLmh0bWwocHJldmlvdXNBZHZpY2VCZWxsKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwcmV2aW91c0FkdmljZSA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oYHByZXZpb3VzQWR2aWNlJHtnbG9iYWxXZWJBZG1pbkxhbmd1YWdlfWApO1xuICAgICAgICBpZiAocHJldmlvdXNBZHZpY2UpIHtcbiAgICAgICAgICAgIGFkdmljZXNXb3JrZXIuJGFkdmljZXMuaHRtbChwcmV2aW91c0FkdmljZSk7XG4gICAgICAgICAgICBhZHZpY2VzV29ya2VyLiRhZHZpY2VzQmVsbEJ1dHRvbi5wb3B1cCh7XG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnYm90dG9tIGxlZnQnLFxuICAgICAgICAgICAgICAgICAgICBwb3B1cDogYWR2aWNlc1dvcmtlci4kYWR2aWNlcyxcbiAgICAgICAgICAgICAgICAgICAgZGVsYXk6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNob3c6IDMwMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpZGU6IDEwMDAwLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBvbjogJ2NsaWNrJyxcbiAgICAgICAgICAgICAgICAgICAgbW92ZVBvcHVwOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBXb3JrZXIgZnVuY3Rpb24gZm9yIGZldGNoaW5nIGFkdmljZXMuXG4gICAgICovXG4gICAgd29ya2VyKCkge1xuICAgICAgICBQYnhBcGkuQWR2aWNlc0dldExpc3QoYWR2aWNlc1dvcmtlci5jYkFmdGVyUmVzcG9uc2UpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBhZnRlciByZWNlaXZpbmcgdGhlIHJlc3BvbnNlLlxuICAgICAqIEBwYXJhbSB7b2JqZWN0fSByZXNwb25zZSAtIFJlc3BvbnNlIG9iamVjdCBmcm9tIHRoZSBBUEkuXG4gICAgICovXG4gICAgY2JBZnRlclJlc3BvbnNlKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBhZHZpY2VzV29ya2VyLiRhZHZpY2VzLmh0bWwoJycpO1xuICAgICAgICBpZiAocmVzcG9uc2UuYWR2aWNlcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsZXQgaHRtbE1lc3NhZ2VzID0gJyc7XG4gICAgICAgICAgICBsZXQgY291bnRNZXNzYWdlcyA9IDA7XG4gICAgICAgICAgICBsZXQgaWNvbkJlbGxDbGFzcyA9ICcnO1xuICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9IGA8ZGl2IGNsYXNzPVwidWkgaGVhZGVyXCI+JHtnbG9iYWxUcmFuc2xhdGUuYWR2X1BvcHVwSGVhZGVyfTwvZGl2PmA7XG4gICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzxkaXYgY2xhc3M9XCJ1aSByZWxheGVkIGRpdmlkZWQgbGlzdFwiPic7XG5cbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5hZHZpY2VzLm5lZWRVcGRhdGUgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZXMubmVlZFVwZGF0ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgJCh3aW5kb3cpLnRyaWdnZXIoJ1NlY3VyaXR5V2FybmluZycsIFtyZXNwb25zZS5hZHZpY2VzXSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5hZHZpY2VzLmVycm9yICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2VzLmVycm9yLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAkLmVhY2gocmVzcG9uc2UuYWR2aWNlcy5lcnJvciwgKGtleSwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8ZGl2IGNsYXNzPVwiaXRlbVwiPic7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPGkgY2xhc3M9XCJmcm93biBvdXRsaW5lIHJlZCBpY29uXCI+PC9pPic7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSBgJHt2YWx1ZX1gO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50TWVzc2FnZXMgKz0gMTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChyZXNwb25zZS5hZHZpY2VzLndhcm5pbmcgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZXMud2FybmluZy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgJC5lYWNoKHJlc3BvbnNlLmFkdmljZXMud2FybmluZywgKGtleSwgdmFsdWUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8ZGl2IGNsYXNzPVwiaXRlbSB5ZWxsb3dcIj4nO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzxpIGNsYXNzPVwibWVoIG91dGxpbmUgeWVsbG93IGljb25cIj48L2k+JztcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9IGAke3ZhbHVlfWA7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgY291bnRNZXNzYWdlcyArPSAxO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmFkdmljZXMuaW5mbyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlcy5pbmZvLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAkLmVhY2gocmVzcG9uc2UuYWR2aWNlcy5pbmZvLCAoa2V5LCB2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzxkaXYgY2xhc3M9XCJpdGVtXCI+JztcbiAgICAgICAgICAgICAgICAgICAgaHRtbE1lc3NhZ2VzICs9ICc8aSBjbGFzcz1cInNtaWxlIG91dGxpbmUgYmx1ZSBpY29uXCI+PC9pPic7XG4gICAgICAgICAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSBgJHt2YWx1ZX1gO1xuICAgICAgICAgICAgICAgICAgICBodG1sTWVzc2FnZXMgKz0gJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgICAgIGNvdW50TWVzc2FnZXMgKz0gMTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmFkdmljZXMuZXJyb3IgIT09IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICYmIHJlc3BvbnNlLmFkdmljZXMuZXJyb3IubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGljb25CZWxsQ2xhc3MgPSAncmVkIGljb24gYmVsbCc7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmFkdmljZXMud2FybmluZyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlcy53YXJuaW5nLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpY29uQmVsbENsYXNzID0gJ3llbGxvdyBpY29uIGJlbGwnO1xuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmFkdmljZXMuaW5mbyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlcy5pbmZvLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpY29uQmVsbENsYXNzID0gJ2JsdWUgaWNvbiBiZWxsJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGh0bWxNZXNzYWdlcyArPSAnPC9kaXY+JztcbiAgICAgICAgICAgIGFkdmljZXNXb3JrZXIuJGFkdmljZXMuaHRtbChodG1sTWVzc2FnZXMpO1xuICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShgcHJldmlvdXNBZHZpY2Uke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCwgaHRtbE1lc3NhZ2VzKTtcblxuICAgICAgICAgICAgaWYgKGNvdW50TWVzc2FnZXMgPiAwKSB7XG4gICAgICAgICAgICAgICAgYWR2aWNlc1dvcmtlci4kYWR2aWNlc0JlbGxCdXR0b25cbiAgICAgICAgICAgICAgICAgICAgLmh0bWwoYDxpIGNsYXNzPVwiJHtpY29uQmVsbENsYXNzfVwiPjwvaT4ke2NvdW50TWVzc2FnZXN9YClcbiAgICAgICAgICAgICAgICAgICAgLnBvcHVwKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnYm90dG9tIGxlZnQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXA6IGFkdmljZXNXb3JrZXIuJGFkdmljZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxheToge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3c6IDMwMCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaWRlOiAxMDAwMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICBvbjogJ2NsaWNrJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vdmVQb3B1cDogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGFkdmljZXNXb3JrZXIuJGFkdmljZXNCZWxsQnV0dG9uLmZpbmQoJ2knKVxuICAgICAgICAgICAgICAgICAgICAudHJhbnNpdGlvbignc2V0IGxvb3BpbmcnKVxuICAgICAgICAgICAgICAgICAgICAudHJhbnNpdGlvbigncHVsc2UnLCAnMTAwMG1zJyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGFkdmljZXNXb3JrZXIuJGFkdmljZXNCZWxsQnV0dG9uXG4gICAgICAgICAgICAgICAgICAgIC5odG1sKGA8aSBjbGFzcz1cImdyZXkgaWNvbiBiZWxsXCI+PC9pPmApXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGBwcmV2aW91c0FkdmljZUJlbGwke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCwgYWR2aWNlc1dvcmtlci4kYWR2aWNlc0JlbGxCdXR0b24uaHRtbCgpKTtcbiAgICAgICAgICAgIGFkdmljZXNXb3JrZXIudGltZW91dEhhbmRsZSA9IHdpbmRvdy5zZXRUaW1lb3V0KFxuICAgICAgICAgICAgICAgIGFkdmljZXNXb3JrZXIud29ya2VyLFxuICAgICAgICAgICAgICAgIGFkdmljZXNXb3JrZXIudGltZU91dCxcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3VjY2VzcyA9PT0gdHJ1ZVxuICAgICAgICAgICAgJiYgcmVzcG9uc2UuYWR2aWNlcyAhPT0gdW5kZWZpbmVkXG4gICAgICAgICAgICAmJiByZXNwb25zZS5hZHZpY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShgcHJldmlvdXNBZHZpY2Uke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCk7XG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGBwcmV2aW91c0FkdmljZUJlbGwke2dsb2JhbFdlYkFkbWluTGFuZ3VhZ2V9YCk7XG4gICAgICAgICAgICBhZHZpY2VzV29ya2VyLiRhZHZpY2VzQmVsbEJ1dHRvblxuICAgICAgICAgICAgICAgIC5odG1sKCc8aSBjbGFzcz1cImdyZXkgaWNvbiBiZWxsIG91dGxpbmVcIj48L2k+Jyk7XG4gICAgICAgIH1cbiAgICB9LFxufTtcblxuLyoqXG4gKiAgSW5pdGlhbGl6ZSBhZHZpY2VzIHdvcmtlciBvbiBkb2N1bWVudCByZWFkeVxuICovXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgYWR2aWNlc1dvcmtlci5pbml0aWFsaXplKCk7XG59KTtcbiJdfQ==