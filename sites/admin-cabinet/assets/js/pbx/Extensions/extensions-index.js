"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, ClipboardJS, SemanticLocalization, InputMaskPatterns, UserMessage, globalTranslate */

/**
 * The ExtensionsIndex module handles the functionality for the extensions index page.
 *
 * @module extensionsIndex
 */
var extensionsIndex = {
  maskList: null,
  $extensionsList: $('#extensions-table'),
  $contentFrame: $('#content-frame'),

  /**
   * Initialize the ExtensionsIndex module.
   * This function sets up necessary interactivity and features on the page.
   */
  initialize: function initialize() {
    // Loop over each avatar and provide a default source if one does not exist.
    $('.avatar').each(function () {
      if ($(this).attr('src') === '') {
        $(this).attr('src', "".concat(globalRootUrl, "assets/img/unknownPerson.jpg"));
      }
    }); // Initialize the input mask for mobile numbers.

    extensionsIndex.initializeInputmask($('input.mobile-number-input')); // Set up the DataTable on the extensions list.

    extensionsIndex.$extensionsList.DataTable({
      lengthChange: false,
      paging: false,
      columns: [{
        orderable: false,
        searchable: false,
        "width": "0"
      }, null, null, null, null, {
        orderable: false,
        searchable: false
      }],
      autoWidth: false,
      order: [1, 'asc'],
      language: SemanticLocalization.dataTableLocalisation,
      drawCallback: function drawCallback() {}
    }); // Move the "Add New" button to the first eight-column div.

    $('#add-new-button').appendTo($('div.eight.column:eq(0)')); // Set up double-click behavior on the extension rows.

    $('.extension-row td').on('dblclick', function (e) {
      var id = $(e.target).closest('tr').attr('id');
      window.location = "".concat(globalRootUrl, "extensions/modify/").concat(id);
    }); // Set up ClipboardJS for copying to the clipboard.

    var clipboard = new ClipboardJS('.clipboard');
    $('.clipboard').popup({
      on: 'manual'
    }); // Set up 'success' event listener for the clipboard.

    clipboard.on('success', function (e) {
      $(e.trigger).popup('show');
      setTimeout(function () {
        $(e.trigger).popup('hide');
      }, 1500);
      e.clearSelection();
    }); // Set up 'error' event listener for the clipboard.

    clipboard.on('error', function (e) {
      console.error('Action:', e.action);
      console.error('Trigger:', e.trigger);
    }); // Setup checkbox functionality in the extension row.

    $('.extension-row .checkbox').checkbox({
      onChecked: function onChecked() {
        var number = $(this).attr('data-value');
        $.api({
          url: "".concat(globalRootUrl, "extensions/enable/").concat(number),
          on: 'now',
          onSuccess: function onSuccess(response) {
            if (response.success) {
              $("#".concat(number, " .disability")).removeClass('disabled');
            }
          }
        });
      },
      onUnchecked: function onUnchecked() {
        var number = $(this).attr('data-value');
        $.api({
          url: "".concat(globalRootUrl, "extensions/disable/").concat(number),
          on: 'now',
          onSuccess: function onSuccess(response) {
            if (response.success) {
              $("#".concat(number, " .disability")).addClass('disabled');
            }
          }
        });
      }
    }); // Set up delete functionality on delete button click.

    $('body').on('click', 'a.delete', function (e) {
      e.preventDefault();
      var extensionId = $(e.target).closest('tr').attr('id');
      extensionsIndex.deleteExtension(extensionId);
    });
  },

  /**
   * Deletes an extension with the given ID.
   * @param {string} extensionId - The ID of the extension to delete.
   */
  deleteExtension: function deleteExtension(extensionId) {
    $('.message.ajax').remove();
    $.api({
      url: "".concat(globalRootUrl, "extensions/delete/").concat(extensionId),
      on: 'now',
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0;
      },
      onSuccess: function onSuccess(response) {
        if (response.success === true) {
          extensionsIndex.$extensionsList.find("tr[id=".concat(extensionId, "]")).remove();
          Extensions.cbOnDataChanged();
        } else {
          UserMessage.showError(response.message.error, globalTranslate.ex_ImpossibleToDeleteExtension);
        }
      }
    });
  },

  /**
   * Initializes input masks for visualizing formatted numbers.
   * @param {Object} $el - The jQuery object for the element to initialize the input mask on.
   */
  initializeInputmask: function initializeInputmask($el) {
    if (extensionsIndex.maskList === null) {
      // Prepares the table for sort
      extensionsIndex.maskList = $.masksSort(InputMaskPatterns, ['#'], /[0-9]|#/, 'mask');
    }

    $el.inputmasks({
      inputmask: {
        definitions: {
          '#': {
            validator: '[0-9]',
            cardinality: 1
          }
        }
      },
      match: /[0-9]/,
      replace: '9',
      list: extensionsIndex.maskList,
      listKey: 'mask'
    });
  }
};
/**
 *  Initialize Employees table on document ready
 */

$(document).ready(function () {
  extensionsIndex.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FeHRlbnNpb25zL2V4dGVuc2lvbnMtaW5kZXguanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9uc0luZGV4IiwibWFza0xpc3QiLCIkZXh0ZW5zaW9uc0xpc3QiLCIkIiwiJGNvbnRlbnRGcmFtZSIsImluaXRpYWxpemUiLCJlYWNoIiwiYXR0ciIsImdsb2JhbFJvb3RVcmwiLCJpbml0aWFsaXplSW5wdXRtYXNrIiwiRGF0YVRhYmxlIiwibGVuZ3RoQ2hhbmdlIiwicGFnaW5nIiwiY29sdW1ucyIsIm9yZGVyYWJsZSIsInNlYXJjaGFibGUiLCJhdXRvV2lkdGgiLCJvcmRlciIsImxhbmd1YWdlIiwiU2VtYW50aWNMb2NhbGl6YXRpb24iLCJkYXRhVGFibGVMb2NhbGlzYXRpb24iLCJkcmF3Q2FsbGJhY2siLCJhcHBlbmRUbyIsIm9uIiwiZSIsImlkIiwidGFyZ2V0IiwiY2xvc2VzdCIsIndpbmRvdyIsImxvY2F0aW9uIiwiY2xpcGJvYXJkIiwiQ2xpcGJvYXJkSlMiLCJwb3B1cCIsInRyaWdnZXIiLCJzZXRUaW1lb3V0IiwiY2xlYXJTZWxlY3Rpb24iLCJjb25zb2xlIiwiZXJyb3IiLCJhY3Rpb24iLCJjaGVja2JveCIsIm9uQ2hlY2tlZCIsIm51bWJlciIsImFwaSIsInVybCIsIm9uU3VjY2VzcyIsInJlc3BvbnNlIiwic3VjY2VzcyIsInJlbW92ZUNsYXNzIiwib25VbmNoZWNrZWQiLCJhZGRDbGFzcyIsInByZXZlbnREZWZhdWx0IiwiZXh0ZW5zaW9uSWQiLCJkZWxldGVFeHRlbnNpb24iLCJyZW1vdmUiLCJzdWNjZXNzVGVzdCIsInVuZGVmaW5lZCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJmaW5kIiwiRXh0ZW5zaW9ucyIsImNiT25EYXRhQ2hhbmdlZCIsIlVzZXJNZXNzYWdlIiwic2hvd0Vycm9yIiwibWVzc2FnZSIsImdsb2JhbFRyYW5zbGF0ZSIsImV4X0ltcG9zc2libGVUb0RlbGV0ZUV4dGVuc2lvbiIsIiRlbCIsIm1hc2tzU29ydCIsIklucHV0TWFza1BhdHRlcm5zIiwiaW5wdXRtYXNrcyIsImlucHV0bWFzayIsImRlZmluaXRpb25zIiwidmFsaWRhdG9yIiwiY2FyZGluYWxpdHkiLCJtYXRjaCIsInJlcGxhY2UiLCJsaXN0IiwibGlzdEtleSIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsZUFBZSxHQUFHO0FBQ3BCQyxFQUFBQSxRQUFRLEVBQUUsSUFEVTtBQUVwQkMsRUFBQUEsZUFBZSxFQUFFQyxDQUFDLENBQUMsbUJBQUQsQ0FGRTtBQUdwQkMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsZ0JBQUQsQ0FISTs7QUFLcEI7QUFDSjtBQUNBO0FBQ0E7QUFDSUUsRUFBQUEsVUFUb0Isd0JBU1A7QUFFVDtBQUNBRixJQUFBQSxDQUFDLENBQUMsU0FBRCxDQUFELENBQWFHLElBQWIsQ0FBa0IsWUFBWTtBQUMxQixVQUFJSCxDQUFDLENBQUMsSUFBRCxDQUFELENBQVFJLElBQVIsQ0FBYSxLQUFiLE1BQXdCLEVBQTVCLEVBQWdDO0FBQzVCSixRQUFBQSxDQUFDLENBQUMsSUFBRCxDQUFELENBQVFJLElBQVIsQ0FBYSxLQUFiLFlBQXVCQyxhQUF2QjtBQUNIO0FBQ0osS0FKRCxFQUhTLENBU1Q7O0FBQ0FSLElBQUFBLGVBQWUsQ0FBQ1MsbUJBQWhCLENBQW9DTixDQUFDLENBQUMsMkJBQUQsQ0FBckMsRUFWUyxDQVlUOztBQUNBSCxJQUFBQSxlQUFlLENBQUNFLGVBQWhCLENBQWdDUSxTQUFoQyxDQUEwQztBQUN0Q0MsTUFBQUEsWUFBWSxFQUFFLEtBRHdCO0FBRXRDQyxNQUFBQSxNQUFNLEVBQUUsS0FGOEI7QUFHdENDLE1BQUFBLE9BQU8sRUFBRSxDQUNMO0FBQUNDLFFBQUFB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RUFBRSxHQVZFO0FBV1hDLE1BQUFBLElBQUksRUFBRTdFLGVBQWUsQ0FBQ0MsUUFYWDtBQVlYNkUsTUFBQUEsT0FBTyxFQUFFO0FBWkUsS0FBZjtBQWNIO0FBM0ptQixDQUF4QjtBQThKQTtBQUNBO0FBQ0E7O0FBQ0EzRSxDQUFDLENBQUM0RSxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCaEYsRUFBQUEsZUFBZSxDQUFDSyxVQUFoQjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgQ2xpcGJvYXJkSlMsIFNlbWFudGljTG9jYWxpemF0aW9uLCBJbnB1dE1hc2tQYXR0ZXJucywgVXNlck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZSAqL1xuXG5cbi8qKlxuICogVGhlIEV4dGVuc2lvbnNJbmRleCBtb2R1bGUgaGFuZGxlcyB0aGUgZnVuY3Rpb25hbGl0eSBmb3IgdGhlIGV4dGVuc2lvbnMgaW5kZXggcGFnZS5cbiAqXG4gKiBAbW9kdWxlIGV4dGVuc2lvbnNJbmRleFxuICovXG5jb25zdCBleHRlbnNpb25zSW5kZXggPSB7XG4gICAgbWFza0xpc3Q6IG51bGwsXG4gICAgJGV4dGVuc2lvbnNMaXN0OiAkKCcjZXh0ZW5zaW9ucy10YWJsZScpLFxuICAgICRjb250ZW50RnJhbWU6ICQoJyNjb250ZW50LWZyYW1lJyksXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplIHRoZSBFeHRlbnNpb25zSW5kZXggbW9kdWxlLlxuICAgICAqIFRoaXMgZnVuY3Rpb24gc2V0cyB1cCBuZWNlc3NhcnkgaW50ZXJhY3Rpdml0eSBhbmQgZmVhdHVyZXMgb24gdGhlIHBhZ2UuXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcblxuICAgICAgICAvLyBMb29wIG92ZXIgZWFjaCBhdmF0YXIgYW5kIHByb3ZpZGUgYSBkZWZhdWx0IHNvdXJjZSBpZiBvbmUgZG9lcyBub3QgZXhpc3QuXG4gICAgICAgICQoJy5hdmF0YXInKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICgkKHRoaXMpLmF0dHIoJ3NyYycpID09PSAnJykge1xuICAgICAgICAgICAgICAgICQodGhpcykuYXR0cignc3JjJywgYCR7Z2xvYmFsUm9vdFVybH1hc3NldHMvaW1nL3Vua25vd25QZXJzb24uanBnYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgdGhlIGlucHV0IG1hc2sgZm9yIG1vYmlsZSBudW1iZXJzLlxuICAgICAgICBleHRlbnNpb25zSW5kZXguaW5pdGlhbGl6ZUlucHV0bWFzaygkKCdpbnB1dC5tb2JpbGUtbnVtYmVyLWlucHV0JykpO1xuXG4gICAgICAgIC8vIFNldCB1cCB0aGUgRGF0YVRhYmxlIG9uIHRoZSBleHRlbnNpb25zIGxpc3QuXG4gICAgICAgIGV4dGVuc2lvbnNJbmRleC4kZXh0ZW5zaW9uc0xpc3QuRGF0YVRhYmxlKHtcbiAgICAgICAgICAgIGxlbmd0aENoYW5nZTogZmFsc2UsXG4gICAgICAgICAgICBwYWdpbmc6IGZhbHNlLFxuICAgICAgICAgICAgY29sdW1uczogW1xuICAgICAgICAgICAgICAgIHtvcmRlcmFibGU6IGZhbHNlLCBzZWFyY2hhYmxlOiBmYWxzZSwgXCJ3aWR0aFwiOiBcIjBcIn0sXG4gICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICB7b3JkZXJhYmxlOiBmYWxzZSwgc2VhcmNoYWJsZTogZmFsc2V9LFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIGF1dG9XaWR0aDogZmFsc2UsXG4gICAgICAgICAgICBvcmRlcjogWzEsICdhc2MnXSxcbiAgICAgICAgICAgIGxhbmd1YWdlOiBTZW1hbnRpY0xvY2FsaXphdGlvbi5kYXRhVGFibGVMb2NhbGlzYXRpb24sXG4gICAgICAgICAgICBkcmF3Q2FsbGJhY2soKSB7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBNb3ZlIHRoZSBcIkFkZCBOZXdcIiBidXR0b24gdG8gdGhlIGZpcnN0IGVpZ2h0LWNvbHVtbiBkaXYuXG4gICAgICAgICQoJyNhZGQtbmV3LWJ1dHRvbicpLmFwcGVuZFRvKCQoJ2Rpdi5laWdodC5jb2x1bW46ZXEoMCknKSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIGRvdWJsZS1jbGljayBiZWhhdmlvciBvbiB0aGUgZXh0ZW5zaW9uIHJvd3MuXG4gICAgICAgICQoJy5leHRlbnNpb24tcm93IHRkJykub24oJ2RibGNsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gJChlLnRhcmdldCkuY2xvc2VzdCgndHInKS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gYCR7Z2xvYmFsUm9vdFVybH1leHRlbnNpb25zL21vZGlmeS8ke2lkfWA7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFNldCB1cCBDbGlwYm9hcmRKUyBmb3IgY29weWluZyB0byB0aGUgY2xpcGJvYXJkLlxuICAgICAgICBjb25zdCBjbGlwYm9hcmQgPSBuZXcgQ2xpcGJvYXJkSlMoJy5jbGlwYm9hcmQnKTtcbiAgICAgICAgJCgnLmNsaXBib2FyZCcpLnBvcHVwKHtcbiAgICAgICAgICAgIG9uOiAnbWFudWFsJyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwICdzdWNjZXNzJyBldmVudCBsaXN0ZW5lciBmb3IgdGhlIGNsaXBib2FyZC5cbiAgICAgICAgY2xpcGJvYXJkLm9uKCdzdWNjZXNzJywgKGUpID0+IHtcbiAgICAgICAgICAgICQoZS50cmlnZ2VyKS5wb3B1cCgnc2hvdycpO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgJChlLnRyaWdnZXIpLnBvcHVwKCdoaWRlJyk7XG4gICAgICAgICAgICB9LCAxNTAwKTtcbiAgICAgICAgICAgIGUuY2xlYXJTZWxlY3Rpb24oKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwICdlcnJvcicgZXZlbnQgbGlzdGVuZXIgZm9yIHRoZSBjbGlwYm9hcmQuXG4gICAgICAgIGNsaXBib2FyZC5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignQWN0aW9uOicsIGUuYWN0aW9uKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ1RyaWdnZXI6JywgZS50cmlnZ2VyKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0dXAgY2hlY2tib3ggZnVuY3Rpb25hbGl0eSBpbiB0aGUgZXh0ZW5zaW9uIHJvdy5cbiAgICAgICAgJCgnLmV4dGVuc2lvbi1yb3cgLmNoZWNrYm94JylcbiAgICAgICAgICAgIC5jaGVja2JveCh7XG4gICAgICAgICAgICAgICAgb25DaGVja2VkKCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBudW1iZXIgPSAkKHRoaXMpLmF0dHIoJ2RhdGEtdmFsdWUnKTtcbiAgICAgICAgICAgICAgICAgICAgJC5hcGkoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBgJHtnbG9iYWxSb290VXJsfWV4dGVuc2lvbnMvZW5hYmxlLyR7bnVtYmVyfWAsXG4gICAgICAgICAgICAgICAgICAgICAgICBvbjogJ25vdycsXG4gICAgICAgICAgICAgICAgICAgICAgICBvblN1Y2Nlc3MocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGAjJHtudW1iZXJ9IC5kaXNhYmlsaXR5YCkucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBvblVuY2hlY2tlZCgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbnVtYmVyID0gJCh0aGlzKS5hdHRyKCdkYXRhLXZhbHVlJyk7XG4gICAgICAgICAgICAgICAgICAgICQuYXBpKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYCR7Z2xvYmFsUm9vdFVybH1leHRlbnNpb25zL2Rpc2FibGUvJHtudW1iZXJ9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uOiAnbm93JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uU3VjY2VzcyhyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoYCMke251bWJlcn0gLmRpc2FiaWxpdHlgKS5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gU2V0IHVwIGRlbGV0ZSBmdW5jdGlvbmFsaXR5IG9uIGRlbGV0ZSBidXR0b24gY2xpY2suXG4gICAgICAgICQoJ2JvZHknKS5vbignY2xpY2snLCAnYS5kZWxldGUnLCAoZSkgPT4ge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgY29uc3QgZXh0ZW5zaW9uSWQgPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCd0cicpLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICBleHRlbnNpb25zSW5kZXguZGVsZXRlRXh0ZW5zaW9uKGV4dGVuc2lvbklkKTtcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIERlbGV0ZXMgYW4gZXh0ZW5zaW9uIHdpdGggdGhlIGdpdmVuIElELlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBleHRlbnNpb25JZCAtIFRoZSBJRCBvZiB0aGUgZXh0ZW5zaW9uIHRvIGRlbGV0ZS5cbiAgICAgKi9cbiAgICBkZWxldGVFeHRlbnNpb24oZXh0ZW5zaW9uSWQpIHtcbiAgICAgICAgJCgnLm1lc3NhZ2UuYWpheCcpLnJlbW92ZSgpO1xuICAgICAgICAkLmFwaSh7XG4gICAgICAgICAgICB1cmw6IGAke2dsb2JhbFJvb3RVcmx9ZXh0ZW5zaW9ucy9kZWxldGUvJHtleHRlbnNpb25JZH1gLFxuICAgICAgICAgICAgb246ICdub3cnLFxuICAgICAgICAgICAgc3VjY2Vzc1Rlc3QocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAvLyB0ZXN0IHdoZXRoZXIgYSBKU09OIHJlc3BvbnNlIGlzIHZhbGlkXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgJiYgT2JqZWN0LmtleXMocmVzcG9uc2UpLmxlbmd0aCA+IDA7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25TdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgZXh0ZW5zaW9uc0luZGV4LiRleHRlbnNpb25zTGlzdC5maW5kKGB0cltpZD0ke2V4dGVuc2lvbklkfV1gKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgRXh0ZW5zaW9ucy5jYk9uRGF0YUNoYW5nZWQoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBVc2VyTWVzc2FnZS5zaG93RXJyb3IocmVzcG9uc2UubWVzc2FnZS5lcnJvciwgZ2xvYmFsVHJhbnNsYXRlLmV4X0ltcG9zc2libGVUb0RlbGV0ZUV4dGVuc2lvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIGlucHV0IG1hc2tzIGZvciB2aXN1YWxpemluZyBmb3JtYXR0ZWQgbnVtYmVycy5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gJGVsIC0gVGhlIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBlbGVtZW50IHRvIGluaXRpYWxpemUgdGhlIGlucHV0IG1hc2sgb24uXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZUlucHV0bWFzaygkZWwpIHtcbiAgICAgICAgaWYgKGV4dGVuc2lvbnNJbmRleC5tYXNrTGlzdCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gUHJlcGFyZXMgdGhlIHRhYmxlIGZvciBzb3J0XG4gICAgICAgICAgICBleHRlbnNpb25zSW5kZXgubWFza0xpc3QgPSAkLm1hc2tzU29ydChJbnB1dE1hc2tQYXR0ZXJucywgWycjJ10sIC9bMC05XXwjLywgJ21hc2snKTtcbiAgICAgICAgfVxuICAgICAgICAkZWwuaW5wdXRtYXNrcyh7XG4gICAgICAgICAgICBpbnB1dG1hc2s6IHtcbiAgICAgICAgICAgICAgICBkZWZpbml0aW9uczoge1xuICAgICAgICAgICAgICAgICAgICAnIyc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRvcjogJ1swLTldJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhcmRpbmFsaXR5OiAxLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbWF0Y2g6IC9bMC05XS8sXG4gICAgICAgICAgICByZXBsYWNlOiAnOScsXG4gICAgICAgICAgICBsaXN0OiBleHRlbnNpb25zSW5kZXgubWFza0xpc3QsXG4gICAgICAgICAgICBsaXN0S2V5OiAnbWFzaycsXG4gICAgICAgIH0pO1xuICAgIH0sXG59O1xuXG4vKipcbiAqICBJbml0aWFsaXplIEVtcGxveWVlcyB0YWJsZSBvbiBkb2N1bWVudCByZWFkeVxuICovXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgZXh0ZW5zaW9uc0luZGV4LmluaXRpYWxpemUoKTtcbn0pO1xuXG4iXX0=