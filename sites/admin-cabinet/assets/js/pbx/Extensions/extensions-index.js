"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, ClipboardJS, SemanticLocalization, InputMaskPatterns, UserMessage, globalTranslate, Inputmask */

/**
 * The ExtensionsIndex module handles the functionality for the extensions index page.
 *
 * @module extensionsIndex
 */
var extensionsIndex = {
  maskList: null,

  /**
   * The extensions table element.
   * @type {jQuery}
   */
  $extensionsList: $('#extensions-table'),

  /**
   * The global search input element.
   * @type {jQuery}
   */
  $globalSearch: $('#globalsearch'),

  /**
   * The data table object.
   * @type {Object}
   */
  dataTable: {},

  /**
   * The document body.
   * @type {jQuery}
   */
  $body: $('body'),

  /**
   * Initialize the ExtensionsIndex module.
   * This function sets up necessary interactivity and features on the page.
   */
  initialize: function initialize() {
    // Loop over each avatar and provide a default source if one does not exist.
    $('.avatar').each(function () {
      if ($(this).attr('src') === '') {
        $(this).attr('src', "".concat(globalRootUrl, "assets/img/unknownPerson.jpg"));
      }
    }); // Set up the DataTable on the extensions list.

    extensionsIndex.$extensionsList.DataTable({
      search: {
        search: "".concat(extensionsIndex.$globalSearch.val())
      },
      columnDefs: [{
        "defaultContent": "-",
        "targets": "_all"
      }],
      columns: [{
        name: 'status',
        orderable: false,
        // This column is not orderable
        searchable: false // This column is not searchable

      }, {
        name: 'username',
        data: 'Users.username'
      }, {
        name: 'number',
        data: 'CAST(Extensions.number AS INTEGER)'
      }, {
        name: 'mobile',
        data: 'CAST(ExternalExtensions.number AS INTEGER)'
      }, {
        name: 'email',
        data: 'Users.email'
      }, {
        name: 'buttons',
        orderable: false,
        // This column is not orderable
        searchable: false // This column is not searchable

      }],
      order: [[1, 'asc']],
      serverSide: true,
      processing: true,
      ajax: {
        url: "".concat(globalRootUrl, "extensions/getNewRecords"),
        type: 'POST'
      },
      paging: true,
      // stateSave: true,
      sDom: 'rtip',
      deferRender: true,
      pageLength: 16,
      scrollCollapse: true,
      // scroller: true,
      language: SemanticLocalization.dataTableLocalisation,

      /**
       * Constructs the Extensions row.
       * @param {HTMLElement} row - The row element.
       * @param {Array} data - The row data.
       */
      createdRow: function createdRow(row, data) {
        var $templateRow = $('.extension-row-tpl').clone(true);
        var $avatar = $templateRow.find('.avatar');
        $avatar.attr('src', data.avatar);
        $avatar.after(data.username);
        $templateRow.find('.number').text(data.number);
        $templateRow.find('.mobile input').attr('value', data.mobile);
        $templateRow.find('.email').text(data.email);
        var $editButton = $templateRow.find('.action-buttons .button.edit');

        if ($editButton !== undefined) {
          $editButton.attr('href', "".concat(globalRootUrl, "extensions/modify/").concat(data.id));
        }

        var $clipboardButton = $templateRow.find('.action-buttons .button.clipboard');

        if ($clipboardButton !== undefined) {
          $clipboardButton.attr('data-value', data.number);
        }

        $(row).attr('data-value', data.number).html($templateRow.html());
      },

      /**
       * Draw event - fired once the table has completed a draw.
       */
      drawCallback: function drawCallback() {
        // Initialize the input mask for mobile numbers.
        extensionsIndex.initializeInputmask($('input.mobile-number-input')); // Set up ClipboardJS for copying to the clipboard.

        $('.clipboard').popup({
          on: 'manual'
        });
      }
    });
    extensionsIndex.dataTable = extensionsIndex.$extensionsList.DataTable();
    extensionsIndex.$globalSearch.on('keyup', function (e) {
      if (e.keyCode === 13 || e.keyCode === 8 || extensionsIndex.$globalSearch.val().length === 0) {
        var text = extensionsIndex.$globalSearch.val();
        extensionsIndex.applyFilter(text);
      }
    });
    extensionsIndex.dataTable.on('draw', function () {
      extensionsIndex.$globalSearch.closest('div').removeClass('loading');
    }); // Move the "Add New" button to the first eight-column div.

    $('#add-new-button').appendTo($('div.eight.column:eq(0)')); // Set up double-click behavior on the extension rows.

    $('.extension-row td').on('dblclick', function (e) {
      var id = $(e.target).closest('tr').attr('id');
      window.location = "".concat(globalRootUrl, "extensions/modify/").concat(id);
    }); // Set up delete functionality on delete button click.

    extensionsIndex.$body.on('click', 'a.delete', function (e) {
      e.preventDefault();
      $(e.target).addClass('disabled'); // Get the extension ID from the closest table row.

      var extensionId = $(e.target).closest('tr').attr('id'); // Remove any previous AJAX messages.

      $('.message.ajax').remove(); // Call the PbxApi method to delete the extension record.

      PbxApi.ExtensionsDeleteRecord(extensionId, extensionsIndex.cbAfterDeleteRecord);
    }); // Set up copy secret button click.

    extensionsIndex.$body.on('click', 'a.clipboard', function (e) {
      e.preventDefault();
      $(e.target).closest('div.button').addClass('disabled'); // Get the number from the closest table row.

      var number = $(e.target).closest('tr').attr('data-value'); // Remove any previous AJAX messages.

      $('.message.ajax').remove(); // Call the PbxApi method to get the extension secret.

      Extensions.getSecret(number, extensionsIndex.cbAfterGetSecret);
    });
  },

  /**
   * Callback function executed after deleting a record.
   * @param {Object} response - The response object from the API.
   */
  cbAfterDeleteRecord: function cbAfterDeleteRecord(response) {
    if (response.result === true) {
      // Remove the deleted extension's table row.
      extensionsIndex.$extensionsList.find("tr[id=".concat(response.data.id, "]")).remove(); // Call the callback function for data change.

      Extensions.cbOnDataChanged();
    } else {
      // Show an error message if deletion was not successful.
      UserMessage.showError(response.messages.error, globalTranslate.ex_ImpossibleToDeleteExtension);
    }

    $('a.delete').removeClass('disabled');
  },

  /**
   * Callback function executed after cet extension secret.
   * @param {Object} response - The response object from the API.
   */
  cbAfterGetSecret: function cbAfterGetSecret(response) {
    if (response.result === true) {
      var $clipboardButton = extensionsIndex.$extensionsList.find("a.clipboard[data-value=".concat(response.data.number, "]"));
      navigator.clipboard.writeText(response.data.secret);
      $clipboardButton.popup('show');
      setTimeout(function () {
        $clipboardButton.popup('hide');
      }, 1500);
    } else {
      // Show an error message if deletion was not successful.
      UserMessage.showError(response.messages.error, globalTranslate.ex_ImpossibleToGetSecret);
    }

    $('a.clipboard').removeClass('disabled');
  },

  /**
   * Initializes input masks for visualizing formatted numbers.
   * @param {Object} $el - The jQuery object for the element to initialize the input mask on.
   */
  initializeInputmask: function initializeInputmask($el) {
    if (extensionsIndex.maskList === null) {
      // Prepares the table for sort
      extensionsIndex.maskList = $.masksSort(InputMaskPatterns, ['#'], /[0-9]|#/, 'mask');
    }

    $el.inputmasks({
      inputmask: {
        definitions: {
          '#': {
            validator: '[0-9]',
            cardinality: 1
          }
        }
      },
      match: /[0-9]/,
      replace: '9',
      list: extensionsIndex.maskList,
      listKey: 'mask'
    });
  },

  /**
   * Applies the filter to the data table.
   * @param {string} text - The filter text.
   */
  applyFilter: function applyFilter(text) {
    extensionsIndex.dataTable.search(text).draw();
    extensionsIndex.$globalSearch.closest('div').addClass('loading');
  }
};
/**
 *  Initialize Employees table on document ready
 */

$(document).ready(function () {
  extensionsIndex.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FeHRlbnNpb25zL2V4dGVuc2lvbnMtaW5kZXguanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9uc0luZGV4IiwibWFza0xpc3QiLCIkZXh0ZW5zaW9uc0xpc3QiLCIkIiwiJGdsb2JhbFNlYXJjaCIsImRhdGFUYWJsZSIsIiRib2R5IiwiaW5pdGlhbGl6ZSIsImVhY2giLCJhdHRyIiwiZ2xvYmFsUm9vdFVybCIsIkRhdGFUYWJsZSIsInNlYXJjaCIsInZhbCIsImNvbHVtbkRlZnMiLCJjb2x1bW5zIiwibmFtZSIsIm9yZGVyYWJsZSIsInNlYXJjaGFibGUiLCJkYXRhIiwib3JkZXIiLCJzZXJ2ZXJTaWRlIiwicHJvY2Vzc2luZyIsImFqYXgiLCJ1cmwiLCJ0eXBlIiwicGFnaW5nIiwic0RvbSIsImRlZmVyUmVuZGVyIiwicGFnZUxlbmd0aCIsInNjcm9sbENvbGxhcHNlIiwibGFuZ3VhZ2UiLCJTZW1hbnRpY0xvY2FsaXphdGlvbiIsImRhdGFUYWJsZUxvY2FsaXNhdGlvbiIsImNyZWF0ZWRSb3ciLCJyb3ciLCIkdGVtcGxhdGVSb3ciLCJjbG9uZSIsIiRhdmF0YXIiLCJmaW5kIiwiYXZhdGFyIiwiYWZ0ZXIiLCJ1c2VybmFtZSIsInRleHQiLCJudW1iZXIiLCJtb2JpbGUiLCJlbWFpbCIsIiRlZGl0QnV0dG9uIiwidW5kZWZpbmVkIiwiaWQiLCIkY2xpcGJvYXJkQnV0dG9uIiwiaHRtbCIsImRyYXdDYWxsYmFjayIsImluaXRpYWxpemVJbnB1dG1hc2siLCJwb3B1cCIsIm9uIiwiZSIsImtleUNvZGUiLCJsZW5ndGgiLCJhcHBseUZpbHRlciIsImNsb3Nlc3QiLCJyZW1vdmVDbGFzcyIsImFwcGVuZFRvIiwidGFyZ2V0Iiwid2luZG93IiwibG9jYXRpb24iLCJwcmV2ZW50RGVmYXVsdCIsImFkZENsYXNzIiwiZXh0ZW5zaW9uSWQiLCJyZW1vdmUiLCJQYnhBcGkiLCJFeHRlbnNpb25zRGVsZXRlUmVjb3JkIiwiY2JBZnRlckRlbGV0ZVJlY29yZCIsIkV4dGVuc2lvbnMiLCJnZXRTZWNyZXQiLCJjYkFmdGVyR2V0U2VjcmV0IiwicmVzcG9uc2UiLCJyZXN1bHQiLCJjYk9uRGF0YUNoYW5nZWQiLCJVc2VyTWVzc2FnZSIsInNob3dFcnJvciIsIm1lc3NhZ2VzIiwiZXJyb3IiLCJnbG9iYWxUcmFuc2xhdGUiLCJleF9JbXBvc3NpYmxlVG9EZWxldGVFeHRlbnNpb24iLCJuYXZpZ2F0b3IiLCJjbGlwYm9hcmQiLCJ3cml0ZVRleHQiLCJzZWNyZXQiLCJzZXRUaW1lb3V0IiwiZXhfSW1wb3NzaWJsZVRvR2V0U2VjcmV0IiwiJGVsIiwibWFza3NTb3J0IiwiSW5wdXRNYXNrUGF0dGVybnMiLCJpbnB1dG1hc2tzIiwiaW5wdXRtYXNrIiwiZGVmaW5pdGlvbnMiLCJ2YWxpZGF0b3IiLCJjYXJkaW5hbGl0eSIsIm1hdGNoIiwicmVwbGFjZSIsImxpc3QiLCJsaXN0S2V5IiwiZHJhdyIsImRvY3VtZW50IiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsZUFBZSxHQUFHO0FBQ3BCQyxFQUFBQSxRQUFRLEVBQUUsSUFEVTs7QUFHcEI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsZUFBZSxFQUFFQyxDQUFDLENBQUMsbUJBQUQsQ0FQRTs7QUFTcEI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsZUFBRCxDQWJJOztBQWVwQjtBQUNKO0FBQ0E7QUFDQTtBQUNJRSxFQUFBQSxTQUFTLEVBQUUsRUFuQlM7O0FBcUJwQjtBQUNKO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxLQUFLLEVBQUVILENBQUMsQ0FBQyxNQUFELENBekJZOztBQTRCcEI7QUFDSjtBQUNBO0FBQ0E7QUFDSUksRUFBQUEsVUFoQ29C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LENBQWlDK0IsSUFBakMsRUFBdUM0RCxJQUF2QztBQUNBdkcsSUFBQUEsZUFBZSxDQUFDSSxhQUFoQixDQUE4QndELE9BQTlCLENBQXNDLEtBQXRDLEVBQTZDTyxRQUE3QyxDQUFzRCxTQUF0RDtBQUNIO0FBOVBtQixDQUF4QjtBQWlRQTtBQUNBO0FBQ0E7O0FBQ0FoRSxDQUFDLENBQUNxRyxRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCekcsRUFBQUEsZUFBZSxDQUFDTyxVQUFoQjtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsUm9vdFVybCwgQ2xpcGJvYXJkSlMsIFNlbWFudGljTG9jYWxpemF0aW9uLCBJbnB1dE1hc2tQYXR0ZXJucywgVXNlck1lc3NhZ2UsIGdsb2JhbFRyYW5zbGF0ZSwgSW5wdXRtYXNrICovXG5cblxuLyoqXG4gKiBUaGUgRXh0ZW5zaW9uc0luZGV4IG1vZHVsZSBoYW5kbGVzIHRoZSBmdW5jdGlvbmFsaXR5IGZvciB0aGUgZXh0ZW5zaW9ucyBpbmRleCBwYWdlLlxuICpcbiAqIEBtb2R1bGUgZXh0ZW5zaW9uc0luZGV4XG4gKi9cbmNvbnN0IGV4dGVuc2lvbnNJbmRleCA9IHtcbiAgICBtYXNrTGlzdDogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIFRoZSBleHRlbnNpb25zIHRhYmxlIGVsZW1lbnQuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkZXh0ZW5zaW9uc0xpc3Q6ICQoJyNleHRlbnNpb25zLXRhYmxlJyksXG5cbiAgICAvKipcbiAgICAgKiBUaGUgZ2xvYmFsIHNlYXJjaCBpbnB1dCBlbGVtZW50LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGdsb2JhbFNlYXJjaDogJCgnI2dsb2JhbHNlYXJjaCcpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIGRhdGEgdGFibGUgb2JqZWN0LlxuICAgICAqIEB0eXBlIHtPYmplY3R9XG4gICAgICovXG4gICAgZGF0YVRhYmxlOiB7fSxcblxuICAgIC8qKlxuICAgICAqIFRoZSBkb2N1bWVudCBib2R5LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGJvZHk6ICQoJ2JvZHknKSxcblxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgRXh0ZW5zaW9uc0luZGV4IG1vZHVsZS5cbiAgICAgKiBUaGlzIGZ1bmN0aW9uIHNldHMgdXAgbmVjZXNzYXJ5IGludGVyYWN0aXZpdHkgYW5kIGZlYXR1cmVzIG9uIHRoZSBwYWdlLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG5cbiAgICAgICAgLy8gTG9vcCBvdmVyIGVhY2ggYXZhdGFyIGFuZCBwcm92aWRlIGEgZGVmYXVsdCBzb3VyY2UgaWYgb25lIGRvZXMgbm90IGV4aXN0LlxuICAgICAgICAkKCcuYXZhdGFyJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCdzcmMnKSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAkKHRoaXMpLmF0dHIoJ3NyYycsIGAke2dsb2JhbFJvb3RVcmx9YXNzZXRzL2ltZy91bmtub3duUGVyc29uLmpwZ2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTZXQgdXAgdGhlIERhdGFUYWJsZSBvbiB0aGUgZXh0ZW5zaW9ucyBsaXN0LlxuICAgICAgICBleHRlbnNpb25zSW5kZXguJGV4dGVuc2lvbnNMaXN0LkRhdGFUYWJsZSh7XG4gICAgICAgICAgICBzZWFyY2g6IHtcbiAgICAgICAgICAgICAgICBzZWFyY2g6IGAke2V4dGVuc2lvbnNJbmRleC4kZ2xvYmFsU2VhcmNoLnZhbCgpfWAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY29sdW1uRGVmczogW3tcbiAgICAgICAgICAgICAgICBcImRlZmF1bHRDb250ZW50XCI6IFwiLVwiLFxuICAgICAgICAgICAgICAgIFwidGFyZ2V0c1wiOiBcIl9hbGxcIlxuICAgICAgICAgICAgfV0sXG4gICAgICAgICAgICBjb2x1bW5zOiBbXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnc3RhdHVzJyxcbiAgICAgICAgICAgICAgICAgICAgb3JkZXJhYmxlOiBmYWxzZSwgIC8vIFRoaXMgY29sdW1uIGlzIG5vdCBvcmRlcmFibGVcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoYWJsZTogZmFsc2UgIC8vIFRoaXMgY29sdW1uIGlzIG5vdCBzZWFyY2hhYmxlXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6ICd1c2VybmFtZScsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6ICdVc2Vycy51c2VybmFtZSdcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ251bWJlcicsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6ICdDQVNUKEV4dGVuc2lvbnMubnVtYmVyIEFTIElOVEVHRVIpJ1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnbW9iaWxlJyxcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogJ0NBU1QoRXh0ZXJuYWxFeHRlbnNpb25zLm51bWJlciBBUyBJTlRFR0VSKSdcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogJ2VtYWlsJyxcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogJ1VzZXJzLmVtYWlsJ1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiAnYnV0dG9ucycsXG4gICAgICAgICAgICAgICAgICAgIG9yZGVyYWJsZTogZmFsc2UsICAvLyBUaGlzIGNvbHVtbiBpcyBub3Qgb3JkZXJhYmxlXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaGFibGU6IGZhbHNlICAvLyBUaGlzIGNvbHVtbiBpcyBub3Qgc2VhcmNoYWJsZVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgb3JkZXI6IFtbMSwgJ2FzYyddXSxcbiAgICAgICAgICAgIHNlcnZlclNpZGU6IHRydWUsXG4gICAgICAgICAgICBwcm9jZXNzaW5nOiB0cnVlLFxuICAgICAgICAgICAgYWpheDoge1xuICAgICAgICAgICAgICAgIHVybDogYCR7Z2xvYmFsUm9vdFVybH1leHRlbnNpb25zL2dldE5ld1JlY29yZHNgLFxuICAgICAgICAgICAgICAgIHR5cGU6ICdQT1NUJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYWdpbmc6IHRydWUsXG4gICAgICAgICAgICAvLyBzdGF0ZVNhdmU6IHRydWUsXG4gICAgICAgICAgICBzRG9tOiAncnRpcCcsXG4gICAgICAgICAgICBkZWZlclJlbmRlcjogdHJ1ZSxcbiAgICAgICAgICAgIHBhZ2VMZW5ndGg6IDE2LFxuICAgICAgICAgICAgc2Nyb2xsQ29sbGFwc2U6IHRydWUsXG4gICAgICAgICAgICAvLyBzY3JvbGxlcjogdHJ1ZSxcbiAgICAgICAgICAgIGxhbmd1YWdlOiBTZW1hbnRpY0xvY2FsaXphdGlvbi5kYXRhVGFibGVMb2NhbGlzYXRpb24sXG4gICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAqIENvbnN0cnVjdHMgdGhlIEV4dGVuc2lvbnMgcm93LlxuICAgICAgICAgICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gcm93IC0gVGhlIHJvdyBlbGVtZW50LlxuICAgICAgICAgICAgICogQHBhcmFtIHtBcnJheX0gZGF0YSAtIFRoZSByb3cgZGF0YS5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgY3JlYXRlZFJvdyhyb3csIGRhdGEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCAkdGVtcGxhdGVSb3cgID0gICQoJy5leHRlbnNpb24tcm93LXRwbCcpLmNsb25lKHRydWUpO1xuICAgICAgICAgICAgICAgIGNvbnN0ICRhdmF0YXIgPSAkdGVtcGxhdGVSb3cuZmluZCgnLmF2YXRhcicpO1xuICAgICAgICAgICAgICAgICRhdmF0YXIuYXR0cignc3JjJyxkYXRhLmF2YXRhcik7XG4gICAgICAgICAgICAgICAgJGF2YXRhci5hZnRlcihkYXRhLnVzZXJuYW1lKTtcbiAgICAgICAgICAgICAgICAkdGVtcGxhdGVSb3cuZmluZCgnLm51bWJlcicpLnRleHQoZGF0YS5udW1iZXIpO1xuICAgICAgICAgICAgICAgICR0ZW1wbGF0ZVJvdy5maW5kKCcubW9iaWxlIGlucHV0JykuYXR0cigndmFsdWUnLCBkYXRhLm1vYmlsZSk7XG4gICAgICAgICAgICAgICAgJHRlbXBsYXRlUm93LmZpbmQoJy5lbWFpbCcpLnRleHQoZGF0YS5lbWFpbCk7XG5cbiAgICAgICAgICAgICAgICBjb25zdCAkZWRpdEJ1dHRvbiA9ICR0ZW1wbGF0ZVJvdy5maW5kKCcuYWN0aW9uLWJ1dHRvbnMgLmJ1dHRvbi5lZGl0Jyk7XG4gICAgICAgICAgICAgICAgaWYgKCRlZGl0QnV0dG9uIT09dW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICAgICAgJGVkaXRCdXR0b24uYXR0cignaHJlZicsYCR7Z2xvYmFsUm9vdFVybH1leHRlbnNpb25zL21vZGlmeS8ke2RhdGEuaWR9YClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb25zdCAkY2xpcGJvYXJkQnV0dG9uID0gJHRlbXBsYXRlUm93LmZpbmQoJy5hY3Rpb24tYnV0dG9ucyAuYnV0dG9uLmNsaXBib2FyZCcpO1xuICAgICAgICAgICAgICAgIGlmICgkY2xpcGJvYXJkQnV0dG9uIT09dW5kZWZpbmVkKXtcbiAgICAgICAgICAgICAgICAgICAgJGNsaXBib2FyZEJ1dHRvbi5hdHRyKCdkYXRhLXZhbHVlJyxkYXRhLm51bWJlcilcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgJChyb3cpLmF0dHIoJ2RhdGEtdmFsdWUnLCBkYXRhLm51bWJlcikuaHRtbCgkdGVtcGxhdGVSb3cuaHRtbCgpKTtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICogRHJhdyBldmVudCAtIGZpcmVkIG9uY2UgdGhlIHRhYmxlIGhhcyBjb21wbGV0ZWQgYSBkcmF3LlxuICAgICAgICAgICAgICovXG4gICAgICAgICAgICBkcmF3Q2FsbGJhY2soKSB7XG4gICAgICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgaW5wdXQgbWFzayBmb3IgbW9iaWxlIG51bWJlcnMuXG4gICAgICAgICAgICAgICAgZXh0ZW5zaW9uc0luZGV4LmluaXRpYWxpemVJbnB1dG1hc2soJCgnaW5wdXQubW9iaWxlLW51bWJlci1pbnB1dCcpKTtcbiAgICAgICAgICAgICAgICAvLyBTZXQgdXAgQ2xpcGJvYXJkSlMgZm9yIGNvcHlpbmcgdG8gdGhlIGNsaXBib2FyZC5cbiAgICAgICAgICAgICAgICAkKCcuY2xpcGJvYXJkJykucG9wdXAoe1xuICAgICAgICAgICAgICAgICAgICBvbjogJ21hbnVhbCcsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgZXh0ZW5zaW9uc0luZGV4LmRhdGFUYWJsZSA9IGV4dGVuc2lvbnNJbmRleC4kZXh0ZW5zaW9uc0xpc3QuRGF0YVRhYmxlKCk7XG5cbiAgICAgICAgZXh0ZW5zaW9uc0luZGV4LiRnbG9iYWxTZWFyY2gub24oJ2tleXVwJywgKGUpID0+IHtcbiAgICAgICAgICAgIGlmIChlLmtleUNvZGUgPT09IDEzXG4gICAgICAgICAgICAgICAgfHwgZS5rZXlDb2RlID09PSA4XG4gICAgICAgICAgICAgICAgfHwgZXh0ZW5zaW9uc0luZGV4LiRnbG9iYWxTZWFyY2gudmFsKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IGV4dGVuc2lvbnNJbmRleC4kZ2xvYmFsU2VhcmNoLnZhbCgpO1xuICAgICAgICAgICAgICAgIGV4dGVuc2lvbnNJbmRleC5hcHBseUZpbHRlcih0ZXh0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZXh0ZW5zaW9uc0luZGV4LmRhdGFUYWJsZS5vbignZHJhdycsICgpID0+IHtcbiAgICAgICAgICAgIGV4dGVuc2lvbnNJbmRleC4kZ2xvYmFsU2VhcmNoLmNsb3Nlc3QoJ2RpdicpLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIE1vdmUgdGhlIFwiQWRkIE5ld1wiIGJ1dHRvbiB0byB0aGUgZmlyc3QgZWlnaHQtY29sdW1uIGRpdi5cbiAgICAgICAgJCgnI2FkZC1uZXctYnV0dG9uJykuYXBwZW5kVG8oJCgnZGl2LmVpZ2h0LmNvbHVtbjplcSgwKScpKTtcblxuICAgICAgICAvLyBTZXQgdXAgZG91YmxlLWNsaWNrIGJlaGF2aW9yIG9uIHRoZSBleHRlbnNpb24gcm93cy5cbiAgICAgICAgJCgnLmV4dGVuc2lvbi1yb3cgdGQnKS5vbignZGJsY2xpY2snLCAoZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaWQgPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCd0cicpLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSBgJHtnbG9iYWxSb290VXJsfWV4dGVuc2lvbnMvbW9kaWZ5LyR7aWR9YDtcbiAgICAgICAgfSk7XG5cblxuICAgICAgICAvLyBTZXQgdXAgZGVsZXRlIGZ1bmN0aW9uYWxpdHkgb24gZGVsZXRlIGJ1dHRvbiBjbGljay5cbiAgICAgICAgZXh0ZW5zaW9uc0luZGV4LiRib2R5Lm9uKCdjbGljaycsICdhLmRlbGV0ZScsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAkKGUudGFyZ2V0KS5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgIC8vIEdldCB0aGUgZXh0ZW5zaW9uIElEIGZyb20gdGhlIGNsb3Nlc3QgdGFibGUgcm93LlxuICAgICAgICAgICAgY29uc3QgZXh0ZW5zaW9uSWQgPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCd0cicpLmF0dHIoJ2lkJyk7XG5cbiAgICAgICAgICAgIC8vIFJlbW92ZSBhbnkgcHJldmlvdXMgQUpBWCBtZXNzYWdlcy5cbiAgICAgICAgICAgICQoJy5tZXNzYWdlLmFqYXgnKS5yZW1vdmUoKTtcblxuICAgICAgICAgICAgLy8gQ2FsbCB0aGUgUGJ4QXBpIG1ldGhvZCB0byBkZWxldGUgdGhlIGV4dGVuc2lvbiByZWNvcmQuXG4gICAgICAgICAgICBQYnhBcGkuRXh0ZW5zaW9uc0RlbGV0ZVJlY29yZChleHRlbnNpb25JZCwgZXh0ZW5zaW9uc0luZGV4LmNiQWZ0ZXJEZWxldGVSZWNvcmQpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTZXQgdXAgY29weSBzZWNyZXQgYnV0dG9uIGNsaWNrLlxuICAgICAgICBleHRlbnNpb25zSW5kZXguJGJvZHkub24oJ2NsaWNrJywgJ2EuY2xpcGJvYXJkJywgKGUpID0+IHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICQoZS50YXJnZXQpLmNsb3Nlc3QoJ2Rpdi5idXR0b24nKS5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblxuICAgICAgICAgICAgLy8gR2V0IHRoZSBudW1iZXIgZnJvbSB0aGUgY2xvc2VzdCB0YWJsZSByb3cuXG4gICAgICAgICAgICBjb25zdCBudW1iZXIgPSAkKGUudGFyZ2V0KS5jbG9zZXN0KCd0cicpLmF0dHIoJ2RhdGEtdmFsdWUnKTtcblxuICAgICAgICAgICAgLy8gUmVtb3ZlIGFueSBwcmV2aW91cyBBSkFYIG1lc3NhZ2VzLlxuICAgICAgICAgICAgJCgnLm1lc3NhZ2UuYWpheCcpLnJlbW92ZSgpO1xuXG4gICAgICAgICAgICAvLyBDYWxsIHRoZSBQYnhBcGkgbWV0aG9kIHRvIGdldCB0aGUgZXh0ZW5zaW9uIHNlY3JldC5cbiAgICAgICAgICAgIEV4dGVuc2lvbnMuZ2V0U2VjcmV0KG51bWJlciwgZXh0ZW5zaW9uc0luZGV4LmNiQWZ0ZXJHZXRTZWNyZXQpO1xuICAgICAgICB9KTtcblxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBleGVjdXRlZCBhZnRlciBkZWxldGluZyBhIHJlY29yZC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0IGZyb20gdGhlIEFQSS5cbiAgICAgKi9cbiAgICBjYkFmdGVyRGVsZXRlUmVjb3JkKHJlc3BvbnNlKXtcbiAgICAgICAgaWYgKHJlc3BvbnNlLnJlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgLy8gUmVtb3ZlIHRoZSBkZWxldGVkIGV4dGVuc2lvbidzIHRhYmxlIHJvdy5cbiAgICAgICAgICAgIGV4dGVuc2lvbnNJbmRleC4kZXh0ZW5zaW9uc0xpc3QuZmluZChgdHJbaWQ9JHtyZXNwb25zZS5kYXRhLmlkfV1gKS5yZW1vdmUoKTtcbiAgICAgICAgICAgIC8vIENhbGwgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIGZvciBkYXRhIGNoYW5nZS5cbiAgICAgICAgICAgIEV4dGVuc2lvbnMuY2JPbkRhdGFDaGFuZ2VkKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBTaG93IGFuIGVycm9yIG1lc3NhZ2UgaWYgZGVsZXRpb24gd2FzIG5vdCBzdWNjZXNzZnVsLlxuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd0Vycm9yKHJlc3BvbnNlLm1lc3NhZ2VzLmVycm9yLCBnbG9iYWxUcmFuc2xhdGUuZXhfSW1wb3NzaWJsZVRvRGVsZXRlRXh0ZW5zaW9uKTtcbiAgICAgICAgfVxuICAgICAgICAkKCdhLmRlbGV0ZScpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiBleGVjdXRlZCBhZnRlciBjZXQgZXh0ZW5zaW9uIHNlY3JldC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2Ugb2JqZWN0IGZyb20gdGhlIEFQSS5cbiAgICAgKi9cbiAgICBjYkFmdGVyR2V0U2VjcmV0KHJlc3BvbnNlKXtcbiAgICAgICAgaWYgKHJlc3BvbnNlLnJlc3VsdCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgY29uc3QgJGNsaXBib2FyZEJ1dHRvbiA9IGV4dGVuc2lvbnNJbmRleC4kZXh0ZW5zaW9uc0xpc3QuZmluZChgYS5jbGlwYm9hcmRbZGF0YS12YWx1ZT0ke3Jlc3BvbnNlLmRhdGEubnVtYmVyfV1gKTtcbiAgICAgICAgICAgIG5hdmlnYXRvci5jbGlwYm9hcmQud3JpdGVUZXh0KHJlc3BvbnNlLmRhdGEuc2VjcmV0KVxuICAgICAgICAgICAgJGNsaXBib2FyZEJ1dHRvbi5wb3B1cCgnc2hvdycpO1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAkY2xpcGJvYXJkQnV0dG9uLnBvcHVwKCdoaWRlJyk7XG4gICAgICAgICAgICAgICAgfSwgMTUwMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBTaG93IGFuIGVycm9yIG1lc3NhZ2UgaWYgZGVsZXRpb24gd2FzIG5vdCBzdWNjZXNzZnVsLlxuICAgICAgICAgICAgVXNlck1lc3NhZ2Uuc2hvd0Vycm9yKHJlc3BvbnNlLm1lc3NhZ2VzLmVycm9yLCBnbG9iYWxUcmFuc2xhdGUuZXhfSW1wb3NzaWJsZVRvR2V0U2VjcmV0KTtcbiAgICAgICAgfVxuICAgICAgICAkKCdhLmNsaXBib2FyZCcpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBJbml0aWFsaXplcyBpbnB1dCBtYXNrcyBmb3IgdmlzdWFsaXppbmcgZm9ybWF0dGVkIG51bWJlcnMuXG4gICAgICogQHBhcmFtIHtPYmplY3R9ICRlbCAtIFRoZSBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZWxlbWVudCB0byBpbml0aWFsaXplIHRoZSBpbnB1dCBtYXNrIG9uLlxuICAgICAqL1xuICAgIGluaXRpYWxpemVJbnB1dG1hc2soJGVsKSB7XG4gICAgICAgIGlmIChleHRlbnNpb25zSW5kZXgubWFza0xpc3QgPT09IG51bGwpIHtcbiAgICAgICAgICAgIC8vIFByZXBhcmVzIHRoZSB0YWJsZSBmb3Igc29ydFxuICAgICAgICAgICAgZXh0ZW5zaW9uc0luZGV4Lm1hc2tMaXN0ID0gJC5tYXNrc1NvcnQoSW5wdXRNYXNrUGF0dGVybnMsIFsnIyddLCAvWzAtOV18Iy8sICdtYXNrJyk7XG4gICAgICAgIH1cbiAgICAgICAgJGVsLmlucHV0bWFza3Moe1xuICAgICAgICAgICAgaW5wdXRtYXNrOiB7XG4gICAgICAgICAgICAgICAgZGVmaW5pdGlvbnM6IHtcbiAgICAgICAgICAgICAgICAgICAgJyMnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0b3I6ICdbMC05XScsXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXJkaW5hbGl0eTogMSxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG1hdGNoOiAvWzAtOV0vLFxuICAgICAgICAgICAgcmVwbGFjZTogJzknLFxuICAgICAgICAgICAgbGlzdDogZXh0ZW5zaW9uc0luZGV4Lm1hc2tMaXN0LFxuICAgICAgICAgICAgbGlzdEtleTogJ21hc2snLFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIEFwcGxpZXMgdGhlIGZpbHRlciB0byB0aGUgZGF0YSB0YWJsZS5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBmaWx0ZXIgdGV4dC5cbiAgICAgKi9cbiAgICBhcHBseUZpbHRlcih0ZXh0KSB7XG4gICAgICAgIGV4dGVuc2lvbnNJbmRleC5kYXRhVGFibGUuc2VhcmNoKHRleHQpLmRyYXcoKTtcbiAgICAgICAgZXh0ZW5zaW9uc0luZGV4LiRnbG9iYWxTZWFyY2guY2xvc2VzdCgnZGl2JykuYWRkQ2xhc3MoJ2xvYWRpbmcnKTtcbiAgICB9LFxufTtcblxuLyoqXG4gKiAgSW5pdGlhbGl6ZSBFbXBsb3llZXMgdGFibGUgb24gZG9jdW1lbnQgcmVhZHlcbiAqL1xuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuICAgIGV4dGVuc2lvbnNJbmRleC5pbml0aWFsaXplKCk7XG59KTtcblxuIl19