"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2020 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl, ClipboardJS, SemanticLocalization, InputMaskPatterns */
var extensionsIndex = {
  maskList: null,
  $extensionsList: $('#extensions-table'),
  $contentFrame: $('#content-frame'),
  initialize: function initialize() {
    $('.avatar').each(function () {
      if ($(this).attr('src') === '') {
        $(this).attr('src', "".concat(globalRootUrl, "assets/img/unknownPerson.jpg"));
      }
    });
    extensionsIndex.initializeInputmask($('input.mobile-number-input'));
    extensionsIndex.$extensionsList.DataTable({
      lengthChange: false,
      paging: false,
      columns: [{
        orderable: false,
        searchable: false
      }, null, null, null, null, {
        orderable: false,
        searchable: false
      }],
      order: [1, 'asc'],
      language: SemanticLocalization.dataTableLocalisation,
      drawCallback: function drawCallback() {}
    });
    $('#add-new-button').appendTo($('div.eight.column:eq(0)'));
    $('.extension-row td').on('dblclick', function (e) {
      var id = $(e.target).closest('tr').attr('id');
      window.location = "".concat(globalRootUrl, "extensions/modify/").concat(id);
    });
    var clipboard = new ClipboardJS('.clipboard');
    $('.clipboard').popup({
      on: 'manual'
    });
    clipboard.on('success', function (e) {
      $(e.trigger).popup('show');
      setTimeout(function () {
        $(e.trigger).popup('hide');
      }, 1500);
      e.clearSelection();
    });
    clipboard.on('error', function (e) {
      console.error('Action:', e.action);
      console.error('Trigger:', e.trigger);
    });
    $('.extension-row .checkbox').checkbox({
      onChecked: function onChecked() {
        var number = $(this).attr('data-value');
        $.api({
          url: "".concat(globalRootUrl, "extensions/enable/").concat(number),
          on: 'now',
          onSuccess: function onSuccess(response) {
            if (response.success) {
              $("#".concat(number, " .disability")).removeClass('disabled');
            }
          }
        });
      },
      onUnchecked: function onUnchecked() {
        var number = $(this).attr('data-value');
        $.api({
          url: "".concat(globalRootUrl, "extensions/disable/").concat(number),
          on: 'now',
          onSuccess: function onSuccess(response) {
            if (response.success) {
              $("#".concat(number, " .disability")).addClass('disabled');
            }
          }
        });
      }
    });
    $('body').on('click', 'a.delete', function (e) {
      e.preventDefault();
      var extensionId = $(e.target).closest('tr').attr('id');
      extensionsIndex.deleteExtension(extensionId);
    });
  },

  /**
   * Deletes extension with id
   * @param extensionId
   */
  deleteExtension: function deleteExtension(extensionId) {
    $('.message.ajax').remove();
    $.api({
      url: "".concat(globalRootUrl, "extensions/delete/").concat(extensionId),
      on: 'now',
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0;
      },
      onSuccess: function onSuccess(response) {
        if (response.success === true) {
          extensionsIndex.$extensionsList.find("tr[id=".concat(extensionId, "]")).remove();
          Extensions.cbOnDataChanged();
        } else {
          extensionsIndex.$contentFrame.before("<div class=\"ui error message ajax\">".concat(response.message.error, "</div>"));
        }
      }
    });
  },

  /**
   * Makes formatted numbers visualisation
   */
  initializeInputmask: function initializeInputmask($el) {
    if (extensionsIndex.maskList === null) {
      // Prepares the table for sort
      extensionsIndex.maskList = $.masksSort(InputMaskPatterns, ['#'], /[0-9]|#/, 'mask');
    }

    $el.inputmasks({
      inputmask: {
        definitions: {
          '#': {
            validator: '[0-9]',
            cardinality: 1
          }
        }
      },
      match: /[0-9]/,
      replace: '9',
      list: extensionsIndex.maskList,
      listKey: 'mask'
    });
  }
};
$(document).ready(function () {
  extensionsIndex.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FeHRlbnNpb25zL2V4dGVuc2lvbnMtaW5kZXguanMiXSwibmFtZXMiOlsiZXh0ZW5zaW9uc0luZGV4IiwibWFza0xpc3QiLCIkZXh0ZW5zaW9uc0xpc3QiLCIkIiwiJGNvbnRlbnRGcmFtZSIsImluaXRpYWxpemUiLCJlYWNoIiwiYXR0ciIsImdsb2JhbFJvb3RVcmwiLCJpbml0aWFsaXplSW5wdXRtYXNrIiwiRGF0YVRhYmxlIiwibGVuZ3RoQ2hhbmdlIiwicGFnaW5nIiwiY29sdW1ucyIsIm9yZGVyYWJsZSIsInNlYXJjaGFibGUiLCJvcmRlciIsImxhbmd1YWdlIiwiU2VtYW50aWNMb2NhbGl6YXRpb24iLCJkYXRhVGFibGVMb2NhbGlzYXRpb24iLCJkcmF3Q2FsbGJhY2siLCJhcHBlbmRUbyIsIm9uIiwiZSIsImlkIiwidGFyZ2V0IiwiY2xvc2VzdCIsIndpbmRvdyIsImxvY2F0aW9uIiwiY2xpcGJvYXJkIiwiQ2xpcGJvYXJkSlMiLCJwb3B1cCIsInRyaWdnZXIiLCJzZXRUaW1lb3V0IiwiY2xlYXJTZWxlY3Rpb24iLCJjb25zb2xlIiwiZXJyb3IiLCJhY3Rpb24iLCJjaGVja2JveCIsIm9uQ2hlY2tlZCIsIm51bWJlciIsImFwaSIsInVybCIsIm9uU3VjY2VzcyIsInJlc3BvbnNlIiwic3VjY2VzcyIsInJlbW92ZUNsYXNzIiwib25VbmNoZWNrZWQiLCJhZGRDbGFzcyIsInByZXZlbnREZWZhdWx0IiwiZXh0ZW5zaW9uSWQiLCJkZWxldGVFeHRlbnNpb24iLCJyZW1vdmUiLCJzdWNjZXNzVGVzdCIsInVuZGVmaW5lZCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJmaW5kIiwiRXh0ZW5zaW9ucyIsImNiT25EYXRhQ2hhbmdlZCIsImJlZm9yZSIsIm1lc3NhZ2UiLCIkZWwiLCJtYXNrc1NvcnQiLCJJbnB1dE1hc2tQYXR0ZXJucyIsImlucHV0bWFza3MiLCJpbnB1dG1hc2siLCJkZWZpbml0aW9ucyIsInZhbGlkYXRvciIsImNh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QUNBTyxVQUFBQSxVQUFVLENBQUNDLGVBQVg7QUFDQSxTQUhELE1BR087QUFDTjVELFVBQUFBLGVBQWUsQ0FBQ0ksYUFBaEIsQ0FBOEJ5RCxNQUE5QixnREFBMkVqQixRQUFRLENBQUNrQixPQUFULENBQWlCMUIsS0FBNUY7QUFDQTtBQUNEO0FBZkksS0FBTjtBQWlCQSxHQTVHc0I7O0FBNkd2QjtBQUNEO0FBQ0E7QUFDQzNCLEVBQUFBLG1CQWhIdUIsK0JBZ0hIc0QsR0FoSEcsRUFnSEU7QUFDeEIsUUFBSS9ELGVBQWUsQ0FBQ0MsUUFBaEIsS0FBNkIsSUFBakMsRUFBdUM7QUFDdEM7QUFDQ0QsTUFBQUEsZUFBZSxDQUFDQyxRQUFoQixHQUEyQkUsQ0FBQyxDQUFDNkQsU0FBRixDQUFZQyxpQkFBWixFQUErQixDQUFDLEdBQUQsQ0FBL0IsRUFBc0MsU0FBdEMsRUFBaUQsTUFBakQsQ0FBM0I7QUFDRDs7QUFDREYsSUFBQUEsR0FBRyxDQUFDRyxVQUFKLENBQWU7QUFDZEMsTUFBQUEsU0FBUyxFQUFFO0FBQ1ZDLFFBQUFBLFdBQVcsRUFBRTtBQUNaLGVBQUs7QUFDSkMsWUFBQUEsU0FBUyxFQUFFLE9BRFA7QUFFSkMsWUFBQUEsV0FBVyxFQUFFO0FBRlQ7QUFETztBQURILE9BREc7QUFTZEMsTUFBQUEsS0FBSyxFQUFFLE9BVE87QUFVZEMsTUFBQUEsT0FBTyxFQUFFLEdBVks7QUFXZEMsTUFBQUEsSUFBSSxFQUFFekUsZUFBZSxDQUFDQyxRQVhSO0FBWWR5RSxNQUFBQSxPQUFPLEVBQUU7QUFaSyxLQUFmO0FBY0E7QUFuSXNCLENBQXhCO0FBc0lBdkUsQ0FBQyxDQUFDd0UsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUN2QjVFLEVBQUFBLGVBQWUsQ0FBQ0ssVUFBaEI7QUFDQSxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCAoQykgMjAxNy0yMDIwIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG5cbi8qIGdsb2JhbCBnbG9iYWxSb290VXJsLCBDbGlwYm9hcmRKUywgU2VtYW50aWNMb2NhbGl6YXRpb24sIElucHV0TWFza1BhdHRlcm5zICovXG5cbmNvbnN0IGV4dGVuc2lvbnNJbmRleCA9IHtcblx0bWFza0xpc3Q6IG51bGwsXG5cdCRleHRlbnNpb25zTGlzdDogJCgnI2V4dGVuc2lvbnMtdGFibGUnKSxcblx0JGNvbnRlbnRGcmFtZTogJCgnI2NvbnRlbnQtZnJhbWUnKSxcblx0aW5pdGlhbGl6ZSgpIHtcblx0XHQkKCcuYXZhdGFyJykuZWFjaChmdW5jdGlvbiAoKSB7XG5cdFx0XHRpZiAoJCh0aGlzKS5hdHRyKCdzcmMnKSA9PT0gJycpIHtcblx0XHRcdFx0JCh0aGlzKS5hdHRyKCdzcmMnLCBgJHtnbG9iYWxSb290VXJsfWFzc2V0cy9pbWcvdW5rbm93blBlcnNvbi5qcGdgKTtcblx0XHRcdH1cblx0XHR9KTtcblx0XHRleHRlbnNpb25zSW5kZXguaW5pdGlhbGl6ZUlucHV0bWFzaygkKCdpbnB1dC5tb2JpbGUtbnVtYmVyLWlucHV0JykpO1xuXHRcdGV4dGVuc2lvbnNJbmRleC4kZXh0ZW5zaW9uc0xpc3QuRGF0YVRhYmxlKHtcblx0XHRcdGxlbmd0aENoYW5nZTogZmFsc2UsXG5cdFx0XHRwYWdpbmc6IGZhbHNlLFxuXHRcdFx0Y29sdW1uczogW1xuXHRcdFx0XHR7b3JkZXJhYmxlOiBmYWxzZSwgc2VhcmNoYWJsZTogZmFsc2V9LFxuXHRcdFx0XHRudWxsLFxuXHRcdFx0XHRudWxsLFxuXHRcdFx0XHRudWxsLFxuXHRcdFx0XHRudWxsLFxuXHRcdFx0XHR7IG9yZGVyYWJsZTogZmFsc2UsIHNlYXJjaGFibGU6IGZhbHNlIH0sXG5cdFx0XHRdLFxuXHRcdFx0b3JkZXI6IFsxLCAnYXNjJ10sXG5cdFx0XHRsYW5ndWFnZTogU2VtYW50aWNMb2NhbGl6YXRpb24uZGF0YVRhYmxlTG9jYWxpc2F0aW9uLFxuXHRcdFx0ZHJhd0NhbGxiYWNrKCkge1xuXHRcdFx0fSxcblx0XHR9KTtcblxuXHRcdCQoJyNhZGQtbmV3LWJ1dHRvbicpLmFwcGVuZFRvKCQoJ2Rpdi5laWdodC5jb2x1bW46ZXEoMCknKSk7XG5cblx0XHQkKCcuZXh0ZW5zaW9uLXJvdyB0ZCcpLm9uKCdkYmxjbGljaycsIChlKSA9PiB7XG5cdFx0XHRjb25zdCBpZCA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJ3RyJykuYXR0cignaWQnKTtcblx0XHRcdHdpbmRvdy5sb2NhdGlvbiA9IGAke2dsb2JhbFJvb3RVcmx9ZXh0ZW5zaW9ucy9tb2RpZnkvJHtpZH1gO1xuXHRcdH0pO1xuXHRcdGNvbnN0IGNsaXBib2FyZCA9IG5ldyBDbGlwYm9hcmRKUygnLmNsaXBib2FyZCcpO1xuXHRcdCQoJy5jbGlwYm9hcmQnKS5wb3B1cCh7XG5cdFx0XHRvbjogJ21hbnVhbCcsXG5cdFx0fSk7XG5cdFx0Y2xpcGJvYXJkLm9uKCdzdWNjZXNzJywgKGUpID0+IHtcblx0XHRcdCQoZS50cmlnZ2VyKS5wb3B1cCgnc2hvdycpO1xuXHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdCQoZS50cmlnZ2VyKS5wb3B1cCgnaGlkZScpO1xuXHRcdFx0fSwgMTUwMCk7XG5cdFx0XHRlLmNsZWFyU2VsZWN0aW9uKCk7XG5cdFx0fSk7XG5cblx0XHRjbGlwYm9hcmQub24oJ2Vycm9yJywgKGUpID0+IHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoJ0FjdGlvbjonLCBlLmFjdGlvbik7XG5cdFx0XHRjb25zb2xlLmVycm9yKCdUcmlnZ2VyOicsIGUudHJpZ2dlcik7XG5cdFx0fSk7XG5cdFx0JCgnLmV4dGVuc2lvbi1yb3cgLmNoZWNrYm94Jylcblx0XHRcdC5jaGVja2JveCh7XG5cdFx0XHRcdG9uQ2hlY2tlZCgpIHtcblx0XHRcdFx0XHRjb25zdCBudW1iZXIgPSAkKHRoaXMpLmF0dHIoJ2RhdGEtdmFsdWUnKTtcblx0XHRcdFx0XHQkLmFwaSh7XG5cdFx0XHRcdFx0XHR1cmw6IGAke2dsb2JhbFJvb3RVcmx9ZXh0ZW5zaW9ucy9lbmFibGUvJHtudW1iZXJ9YCxcblx0XHRcdFx0XHRcdG9uOiAnbm93Jyxcblx0XHRcdFx0XHRcdG9uU3VjY2VzcyhyZXNwb25zZSkge1xuXHRcdFx0XHRcdFx0XHRpZiAocmVzcG9uc2Uuc3VjY2Vzcykge1xuXHRcdFx0XHRcdFx0XHRcdCQoYCMke251bWJlcn0gLmRpc2FiaWxpdHlgKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSxcblx0XHRcdFx0b25VbmNoZWNrZWQoKSB7XG5cdFx0XHRcdFx0Y29uc3QgbnVtYmVyID0gJCh0aGlzKS5hdHRyKCdkYXRhLXZhbHVlJyk7XG5cdFx0XHRcdFx0JC5hcGkoe1xuXHRcdFx0XHRcdFx0dXJsOiBgJHtnbG9iYWxSb290VXJsfWV4dGVuc2lvbnMvZGlzYWJsZS8ke251bWJlcn1gLFxuXHRcdFx0XHRcdFx0b246ICdub3cnLFxuXHRcdFx0XHRcdFx0b25TdWNjZXNzKHJlc3BvbnNlKSB7XG5cdFx0XHRcdFx0XHRcdGlmIChyZXNwb25zZS5zdWNjZXNzKSB7XG5cdFx0XHRcdFx0XHRcdFx0JChgIyR7bnVtYmVyfSAuZGlzYWJpbGl0eWApLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9LFxuXHRcdFx0fSk7XG5cblx0XHQkKCdib2R5Jykub24oJ2NsaWNrJywgJ2EuZGVsZXRlJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdGNvbnN0IGV4dGVuc2lvbklkID0gJChlLnRhcmdldCkuY2xvc2VzdCgndHInKS5hdHRyKCdpZCcpO1xuXHRcdFx0ZXh0ZW5zaW9uc0luZGV4LmRlbGV0ZUV4dGVuc2lvbihleHRlbnNpb25JZCk7XG5cdFx0fSk7XG5cdH0sXG5cdC8qKlxuXHQgKiBEZWxldGVzIGV4dGVuc2lvbiB3aXRoIGlkXG5cdCAqIEBwYXJhbSBleHRlbnNpb25JZFxuXHQgKi9cblx0ZGVsZXRlRXh0ZW5zaW9uKGV4dGVuc2lvbklkKVxuXHR7XG5cdFx0JCgnLm1lc3NhZ2UuYWpheCcpLnJlbW92ZSgpO1xuXHRcdCQuYXBpKHtcblx0XHRcdHVybDogYCR7Z2xvYmFsUm9vdFVybH1leHRlbnNpb25zL2RlbGV0ZS8ke2V4dGVuc2lvbklkfWAsXG5cdFx0XHRvbjogJ25vdycsXG5cdFx0XHRzdWNjZXNzVGVzdChyZXNwb25zZSkge1xuXHRcdFx0XHQvLyB0ZXN0IHdoZXRoZXIgYSBKU09OIHJlc3BvbnNlIGlzIHZhbGlkXG5cdFx0XHRcdHJldHVybiByZXNwb25zZSAhPT0gdW5kZWZpbmVkXG5cdFx0XHRcdFx0JiYgT2JqZWN0LmtleXMocmVzcG9uc2UpLmxlbmd0aCA+IDA7XG5cdFx0XHR9LFxuXHRcdFx0b25TdWNjZXNzKHJlc3BvbnNlKSB7XG5cdFx0XHRcdGlmIChyZXNwb25zZS5zdWNjZXNzID09PSB0cnVlKSB7XG5cdFx0XHRcdFx0ZXh0ZW5zaW9uc0luZGV4LiRleHRlbnNpb25zTGlzdC5maW5kKGB0cltpZD0ke2V4dGVuc2lvbklkfV1gKS5yZW1vdmUoKTtcblx0XHRcdFx0XHRFeHRlbnNpb25zLmNiT25EYXRhQ2hhbmdlZCgpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdGV4dGVuc2lvbnNJbmRleC4kY29udGVudEZyYW1lLmJlZm9yZShgPGRpdiBjbGFzcz1cInVpIGVycm9yIG1lc3NhZ2UgYWpheFwiPiR7cmVzcG9uc2UubWVzc2FnZS5lcnJvcn08L2Rpdj5gKTtcblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHR9KTtcblx0fSxcblx0LyoqXG5cdCAqIE1ha2VzIGZvcm1hdHRlZCBudW1iZXJzIHZpc3VhbGlzYXRpb25cblx0ICovXG5cdGluaXRpYWxpemVJbnB1dG1hc2soJGVsKSB7XG5cdFx0aWYgKGV4dGVuc2lvbnNJbmRleC5tYXNrTGlzdCA9PT0gbnVsbCkge1xuXHRcdFx0Ly8gUHJlcGFyZXMgdGhlIHRhYmxlIGZvciBzb3J0XG4gXHRcdFx0ZXh0ZW5zaW9uc0luZGV4Lm1hc2tMaXN0ID0gJC5tYXNrc1NvcnQoSW5wdXRNYXNrUGF0dGVybnMsIFsnIyddLCAvWzAtOV18Iy8sICdtYXNrJyk7XG5cdFx0fVxuXHRcdCRlbC5pbnB1dG1hc2tzKHtcblx0XHRcdGlucHV0bWFzazoge1xuXHRcdFx0XHRkZWZpbml0aW9uczoge1xuXHRcdFx0XHRcdCcjJzoge1xuXHRcdFx0XHRcdFx0dmFsaWRhdG9yOiAnWzAtOV0nLFxuXHRcdFx0XHRcdFx0Y2FyZGluYWxpdHk6IDEsXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0fSxcblx0XHRcdH0sXG5cdFx0XHRtYXRjaDogL1swLTldLyxcblx0XHRcdHJlcGxhY2U6ICc5Jyxcblx0XHRcdGxpc3Q6IGV4dGVuc2lvbnNJbmRleC5tYXNrTGlzdCxcblx0XHRcdGxpc3RLZXk6ICdtYXNrJyxcblx0XHR9KTtcblx0fSxcbn07XG5cbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcblx0ZXh0ZW5zaW9uc0luZGV4LmluaXRpYWxpemUoKTtcbn0pO1xuXG4iXX0=