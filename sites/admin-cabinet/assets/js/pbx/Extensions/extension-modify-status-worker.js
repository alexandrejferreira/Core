"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2021 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalTranslate, extension, DebuggerInfo, PbxApi */

/**
 * The extensionStatusLoopWorker object.
 *
 * @module extensionStatusLoopWorker
 */
var extensionStatusLoopWorker = {
  /**
   * Time in milliseconds before fetching new request.
   * @type {number}
   */
  timeOut: 3000,

  /**
   * The id of the timer function for the status worker.
   * @type {number}
   */
  timeOutHandle: 0,
  $statusLabel: $('#status'),

  /**
   * initialize() - Initializes the objects and starts them.
   */
  initialize: function initialize() {
    DebuggerInfo.initialize();

    if (extension.$formObj.form('get value', 'id') !== '') {
      extensionStatusLoopWorker.restartWorker();
    }
  },

  /**
   * restartWorker() - Stops previous worker and starts a new one.
   */
  restartWorker: function restartWorker() {
    window.clearTimeout(extensionStatusLoopWorker.timeoutHandle);
    extensionStatusLoopWorker.worker();
  },

  /**
   * worker() - Sends request to the server for peer status.
   * Calls cbRefreshExtensionStatus() function on response.
   */
  worker: function worker() {
    if (extension.defaultNumber.length === 0) return;
    var param = {
      peer: extension.defaultNumber
    };
    window.clearTimeout(extensionStatusLoopWorker.timeoutHandle);
    PbxApi.GetPeerStatus(param, extensionStatusLoopWorker.cbRefreshExtensionStatus);
  },

  /**
   * cbRefreshExtensionStatus() - Refreshes peer statuses.
   * @param {Object} response - The response object from PbxApi.GetPeerStatus.
   */
  cbRefreshExtensionStatus: function cbRefreshExtensionStatus(response) {
    extensionStatusLoopWorker.timeoutHandle = window.setTimeout(extensionStatusLoopWorker.worker, extensionStatusLoopWorker.timeOut);
    if (response.length === 0 || response === false) return;
    var $status = extensionStatusLoopWorker.$statusLabel; // Iterate over the response data and create HTML table rows for each peer
    // registration info to shows it on debug slider by double press esc button

    var htmlTable = '<table class="ui very compact table">';
    $.each(response, function (key, value) {
      htmlTable += '<tr>';
      htmlTable += "<td>".concat(key, "</td>");
      htmlTable += "<td>".concat(value, "</td>");
      htmlTable += '</tr>';
    });
    htmlTable += '</table>';
    DebuggerInfo.UpdateContent(htmlTable);

    if ('Status' in response && response.Status.toUpperCase().indexOf('REACHABLE') >= 0) {
      $status.removeClass('grey').addClass('green');
    } else {
      $status.removeClass('green').addClass('grey');
    }

    if ($status.hasClass('green')) {
      $status.html(globalTranslate.ex_Online);
    } else {
      $status.html(globalTranslate.ex_Offline);
    }
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9FeHRlbnNpb25zL2V4dGVuc2lvbi1tb2RpZnktc3RhdHVzLXdvcmtlci5qcyJdLCJuYW1lcyI6WyJleHRlbnNpb25TdGF0dXNMb29wV29ya2VyIiwidGltZU91dCIsInRpbWVPdXRIYW5kbGUiLCIkc3RhdHVzTGFiZWwiLCIkIiwiaW5pdGlhbGl6ZSIsIkRlYnVnZ2VySW5mbyIsImV4dGVuc2lvbiIsIiRmb3JtT2JqIiwiZm9ybSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwiZGVmYXVsdE51bWJlciIsImxlbmd0aCIsInBhcmFtIiwicGVlciIsIlBieEFwaSIsIkdldFBlZXJTdGF0dXMiLCJjYlJlZnJlc2hFeHRlbnNpb25TdGF0dXMiLCJyZXNwb25zZSIsInNldFRpbWVvdXQiLCIkc3RhdHVzIiwiaHRtbFRhYmxlIiwiZWFjaCIsImtleSIsInZhbHVlIiwiVXBkYXRlQ29udGVudCIsIlN0YXR1cyIsInRvVXBwZXJDYXNlIiwiaW5kZXhPZiIsInJlbW92ZUNsYXNzIiwiYWRkQ2xhc3MiLCJoYXNDbGFzcyIsImh0bWwiLCJnbG9iYWxUcmFuc2xhdGUiLCJleF9PbmxpbmUiLCJleF9PZmZsaW5lIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBR0E7O0FBR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLHlCQUF5QixHQUFHO0FBRTlCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLE9BQU8sRUFBRSxJQU5xQjs7QUFROUI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsYUFBYSxFQUFFLENBWmU7QUFjOUJDLEVBQUFBLFlBQVksRUFBRUMsQ0FBQyxDQUFDLFNBQUQsQ0FkZTs7QUFnQjlCO0FBQ0o7QUFDQTtBQUNJQyxFQUFBQSxVQW5COEIsd0JBbUJqQjtBQUNUQyxJQUFBQSxZQUFZLENBQUNELFVBQWI7O0FBQ0EsUUFBSUUsU0FBUyxDQUFDQyxRQUFWLENBQW1CQyxJQUFuQixDQUF3QixXQUF4QixFQUFxQyxJQUFyQyxNQUErQyxFQUFuRCxFQUF1RDtBQUNuRFQsTUFBQUEseUJBQXlCLENBQUNVLGFBQTFCO0FBQ0g7QUFDSixHQXhCNkI7O0FBMEI5QjtBQUNKO0FBQ0E7QUFDSUEsRUFBQUEsYUE3QjhCLDJCQTZCZDtBQUNaQyxJQUFBQSxNQUFNLENBQUNDLFlBQVAsQ0FBb0JaLHlCQUF5QixDQUFDYSxhQUE5QztBQUNBYixJQUFBQSx5QkFBeUIsQ0FBQ2MsTUFBMUI7QUFDSCxHQWhDNkI7O0FBa0M5QjtBQUNKO0FBQ0E7QUFDQTtBQUNJQSxFQUFBQSxNQXRDOEIsb0JBc0NyQjtBQUNMLFFBQUlQLFNBQVMsQ0FBQ1EsYUFBVixDQUF3QkMsTUFBeEIsS0FBbUMsQ0FBdkMsRUFBMEM7QUFDMUMsUUFBTUMsS0FBSyxHQUFHO0FBQUNDLE1BQUFBLElBQUksRUFBRVgsU0FBUyxDQUFDUTtBQUFqQixLQUFkO0FBQ0FKLElBQUFBLE1BQU0sQ0FBQ0MsWUFBUCxDQUFvQloseUJBQXlCLENBQUNhLGFBQTlDO0FBQ0FNLElBQUFBLE1BQU0sQ0FBQ0MsYUFBUCxDQUFxQkgsS0FBckIsRUFBNEJqQix5QkFBeUIsQ0FBQ3FCLHdCQUF0RDtBQUNILEdBM0M2Qjs7QUE2QzlCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lBLEVBQUFBLHdCQWpEOEIsb0NBaURMQyxRQWpESyxFQWlESztBQUMvQnRCLElBQUFBLHlCQUF5QixDQUFDYSxhQUExQixHQUNJRixNQUFNLENBQUNZLFVBQVAsQ0FBa0J2Qix5QkFBeUIsQ0FBQ2MsTUFBNUMsRUFBb0RkLHlCQUF5QixDQUFDQyxPQUE5RSxDQURKO0FBRUEsUUFBSXFCLFFBQVEsQ0FBQ04sTUFBVCxLQUFvQixDQUFwQixJQUF5Qk0sUUFBUSxLQUFLLEtBQTFDLEVBQWlEO0FBQ2pELFFBQU1FLE9BQU8sR0FBR3hCLHlCQUF5QixDQUFDRyxZQUExQyxDQUorQixDQU0vQjtBQUNBOztBQUNBLFFBQUlzQixTQUFTLEdBQUcsdUNBQWhCO0FBQ0FyQixJQUFBQSxDQUFDLENBQUNzQixJQUFGLENBQU9KLFFBQVAsRUFBaUIsVUFBQ0ssR0FBRCxFQUFNQyxLQUFOLEVBQWdCO0FBQzdCSCxNQUFBQSxTQUFTLElBQUksTUFBYjtBQUNBQSxNQUFBQSxTQUFTLGtCQUFXRSxHQUFYLFVBQVQ7QUFDQUYsTUFBQUEsU0FBUyxrQkFBV0csS0FBWCxVQUFUO0FBQ0FILE1BQUFBLFNBQVMsSUFBSSxPQUFiO0FBQ0gsS0FMRDtBQU1BQSxJQUFBQSxTQUFTLElBQUksVUFBYjtBQUNBbkIsSUFBQUEsWUFBWSxDQUFDdUIsYUFBYixDQUEyQkosU0FBM0I7O0FBRUEsUUFBSSxZQUFZSCxRQUFaLElBQXdCQSxRQUFRLENBQUNRLE1BQVQsQ0FBZ0JDLFdBQWhCLEdBQThCQyxPQUE5QixDQUFzQyxXQUF0QyxLQUFzRCxDQUFsRixFQUFxRjtBQUNqRlIsTUFBQUEsT0FBTyxDQUFDUyxXQUFSLENBQW9CLE1BQXBCLEVBQTRCQyxRQUE1QixDQUFxQyxPQUFyQztBQUNILEtBRkQsTUFFTztBQUNIVixNQUFBQSxPQUFPLENBQUNTLFdBQVIsQ0FBb0IsT0FBcEIsRUFBNkJDLFFBQTdCLENBQXNDLE1BQXRDO0FBQ0g7O0FBQ0QsUUFBSVYsT0FBTyxDQUFDVyxRQUFSLENBQWlCLE9BQWpCLENBQUosRUFBK0I7QUFDM0JYLE1BQUFBLE9BQU8sQ0FBQ1ksSUFBUixDQUFhQyxlQUFlLENBQUNDLFNBQTdCO0FBQ0gsS0FGRCxNQUVPO0FBQ0hkLE1BQUFBLE9BQU8sQ0FBQ1ksSUFBUixDQUFhQyxlQUFlLENBQUNFLFVBQTdCO0FBQ0g7QUFDSjtBQTdFNkIsQ0FBbEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMSBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG5cbi8qIGdsb2JhbCBnbG9iYWxUcmFuc2xhdGUsIGV4dGVuc2lvbiwgRGVidWdnZXJJbmZvLCBQYnhBcGkgKi9cblxuXG4vKipcbiAqIFRoZSBleHRlbnNpb25TdGF0dXNMb29wV29ya2VyIG9iamVjdC5cbiAqXG4gKiBAbW9kdWxlIGV4dGVuc2lvblN0YXR1c0xvb3BXb3JrZXJcbiAqL1xuY29uc3QgZXh0ZW5zaW9uU3RhdHVzTG9vcFdvcmtlciA9IHtcblxuICAgIC8qKlxuICAgICAqIFRpbWUgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBmZXRjaGluZyBuZXcgcmVxdWVzdC5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXQ6IDMwMDAsXG5cbiAgICAvKipcbiAgICAgKiBUaGUgaWQgb2YgdGhlIHRpbWVyIGZ1bmN0aW9uIGZvciB0aGUgc3RhdHVzIHdvcmtlci5cbiAgICAgKiBAdHlwZSB7bnVtYmVyfVxuICAgICAqL1xuICAgIHRpbWVPdXRIYW5kbGU6IDAsXG4gICAgXG4gICAgJHN0YXR1c0xhYmVsOiAkKCcjc3RhdHVzJyksXG5cbiAgICAvKipcbiAgICAgKiBpbml0aWFsaXplKCkgLSBJbml0aWFsaXplcyB0aGUgb2JqZWN0cyBhbmQgc3RhcnRzIHRoZW0uXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZSgpIHtcbiAgICAgICAgRGVidWdnZXJJbmZvLmluaXRpYWxpemUoKTtcbiAgICAgICAgaWYgKGV4dGVuc2lvbi4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCAnaWQnKSAhPT0gJycpIHtcbiAgICAgICAgICAgIGV4dGVuc2lvblN0YXR1c0xvb3BXb3JrZXIucmVzdGFydFdvcmtlcigpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIHJlc3RhcnRXb3JrZXIoKSAtIFN0b3BzIHByZXZpb3VzIHdvcmtlciBhbmQgc3RhcnRzIGEgbmV3IG9uZS5cbiAgICAgKi9cbiAgICByZXN0YXJ0V29ya2VyKCkge1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGV4dGVuc2lvblN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIGV4dGVuc2lvblN0YXR1c0xvb3BXb3JrZXIud29ya2VyKCk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIHdvcmtlcigpIC0gU2VuZHMgcmVxdWVzdCB0byB0aGUgc2VydmVyIGZvciBwZWVyIHN0YXR1cy5cbiAgICAgKiBDYWxscyBjYlJlZnJlc2hFeHRlbnNpb25TdGF0dXMoKSBmdW5jdGlvbiBvbiByZXNwb25zZS5cbiAgICAgKi9cbiAgICB3b3JrZXIoKSB7XG4gICAgICAgIGlmIChleHRlbnNpb24uZGVmYXVsdE51bWJlci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgY29uc3QgcGFyYW0gPSB7cGVlcjogZXh0ZW5zaW9uLmRlZmF1bHROdW1iZXJ9O1xuICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KGV4dGVuc2lvblN0YXR1c0xvb3BXb3JrZXIudGltZW91dEhhbmRsZSk7XG4gICAgICAgIFBieEFwaS5HZXRQZWVyU3RhdHVzKHBhcmFtLCBleHRlbnNpb25TdGF0dXNMb29wV29ya2VyLmNiUmVmcmVzaEV4dGVuc2lvblN0YXR1cyk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIGNiUmVmcmVzaEV4dGVuc2lvblN0YXR1cygpIC0gUmVmcmVzaGVzIHBlZXIgc3RhdHVzZXMuXG4gICAgICogQHBhcmFtIHtPYmplY3R9IHJlc3BvbnNlIC0gVGhlIHJlc3BvbnNlIG9iamVjdCBmcm9tIFBieEFwaS5HZXRQZWVyU3RhdHVzLlxuICAgICAqL1xuICAgIGNiUmVmcmVzaEV4dGVuc2lvblN0YXR1cyhyZXNwb25zZSkge1xuICAgICAgICBleHRlbnNpb25TdGF0dXNMb29wV29ya2VyLnRpbWVvdXRIYW5kbGUgPVxuICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZXh0ZW5zaW9uU3RhdHVzTG9vcFdvcmtlci53b3JrZXIsIGV4dGVuc2lvblN0YXR1c0xvb3BXb3JrZXIudGltZU91dCk7XG4gICAgICAgIGlmIChyZXNwb25zZS5sZW5ndGggPT09IDAgfHwgcmVzcG9uc2UgPT09IGZhbHNlKSByZXR1cm47XG4gICAgICAgIGNvbnN0ICRzdGF0dXMgPSBleHRlbnNpb25TdGF0dXNMb29wV29ya2VyLiRzdGF0dXNMYWJlbDtcblxuICAgICAgICAvLyBJdGVyYXRlIG92ZXIgdGhlIHJlc3BvbnNlIGRhdGEgYW5kIGNyZWF0ZSBIVE1MIHRhYmxlIHJvd3MgZm9yIGVhY2ggcGVlclxuICAgICAgICAvLyByZWdpc3RyYXRpb24gaW5mbyB0byBzaG93cyBpdCBvbiBkZWJ1ZyBzbGlkZXIgYnkgZG91YmxlIHByZXNzIGVzYyBidXR0b25cbiAgICAgICAgbGV0IGh0bWxUYWJsZSA9ICc8dGFibGUgY2xhc3M9XCJ1aSB2ZXJ5IGNvbXBhY3QgdGFibGVcIj4nO1xuICAgICAgICAkLmVhY2gocmVzcG9uc2UsIChrZXksIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICBodG1sVGFibGUgKz0gJzx0cj4nO1xuICAgICAgICAgICAgaHRtbFRhYmxlICs9IGA8dGQ+JHtrZXl9PC90ZD5gO1xuICAgICAgICAgICAgaHRtbFRhYmxlICs9IGA8dGQ+JHt2YWx1ZX08L3RkPmA7XG4gICAgICAgICAgICBodG1sVGFibGUgKz0gJzwvdHI+JztcbiAgICAgICAgfSk7XG4gICAgICAgIGh0bWxUYWJsZSArPSAnPC90YWJsZT4nO1xuICAgICAgICBEZWJ1Z2dlckluZm8uVXBkYXRlQ29udGVudChodG1sVGFibGUpO1xuXG4gICAgICAgIGlmICgnU3RhdHVzJyBpbiByZXNwb25zZSAmJiByZXNwb25zZS5TdGF0dXMudG9VcHBlckNhc2UoKS5pbmRleE9mKCdSRUFDSEFCTEUnKSA+PSAwKSB7XG4gICAgICAgICAgICAkc3RhdHVzLnJlbW92ZUNsYXNzKCdncmV5JykuYWRkQ2xhc3MoJ2dyZWVuJyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAkc3RhdHVzLnJlbW92ZUNsYXNzKCdncmVlbicpLmFkZENsYXNzKCdncmV5Jyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCRzdGF0dXMuaGFzQ2xhc3MoJ2dyZWVuJykpIHtcbiAgICAgICAgICAgICRzdGF0dXMuaHRtbChnbG9iYWxUcmFuc2xhdGUuZXhfT25saW5lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICRzdGF0dXMuaHRtbChnbG9iYWxUcmFuc2xhdGUuZXhfT2ZmbGluZSk7XG4gICAgICAgIH1cbiAgICB9LFxufTsiXX0=