"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global ace, PbxApi */
var updateLogViewWorker = {
  timeOut: 3000,
  timeOutHandle: '',
  errorCounts: 0,
  initialize: function initialize() {
    updateLogViewWorker.restartWorker();
  },
  restartWorker: function restartWorker() {
    window.clearTimeout(updateLogViewWorker.timeoutHandle);
    updateLogViewWorker.worker();
  },
  worker: function worker() {
    systemDiagnosticLogs.updateLogFromServer();
    updateLogViewWorker.timeoutHandle = window.setTimeout(updateLogViewWorker.worker, updateLogViewWorker.timeOut);
  },
  stop: function stop() {
    window.clearTimeout(updateLogViewWorker.timeoutHandle);
  }
};
var systemDiagnosticLogs = {
  $showBtn: $('#show-last-log'),
  $downloadBtn: $('#download-file'),
  $showAutoBtn: $('#show-last-log-auto'),
  $logContent: $('#log-content-readonly'),
  viewer: '',
  $fileSelectDropDown: $('#system-diagnostic-form .filenames-select'),
  logsItems: [],
  defaultLogItem: null,
  $dimmer: $('#get-logs-dimmer'),
  $formObj: $('#system-diagnostic-form'),
  $fileName: $('#system-diagnostic-form .filename'),
  initialize: function initialize() {
    var aceHeight = window.innerHeight - 250;
    systemDiagnosticLogs.$dimmer.closest('div').css('min-height', "".concat(aceHeight, "px"));
    systemDiagnosticLogs.$fileSelectDropDown.dropdown({
      values: systemDiagnosticLogs.logsItems,
      onChange: systemDiagnosticLogs.cbOnChangeFile,
      ignoreCase: true,
      fullTextSearch: true,
      forceSelection: false
    });
    systemDiagnosticLogs.initializeAce();
    PbxApi.SyslogGetLogsList(systemDiagnosticLogs.cbFormatDropdownResults);
    systemDiagnosticLogs.$showBtn.on('click', function (e) {
      e.preventDefault();
      systemDiagnosticLogs.updateLogFromServer();
    });
    systemDiagnosticLogs.$downloadBtn.on('click', function (e) {
      e.preventDefault();
      var data = systemDiagnosticLogs.$formObj.form('get values');
      PbxApi.SyslogDownloadLogFile(data.filename, systemDiagnosticLogs.cbDownloadFile);
    });
    systemDiagnosticLogs.$showAutoBtn.on('click', function (e) {
      e.preventDefault();
      var $reloadIcon = systemDiagnosticLogs.$showAutoBtn.find('i.refresh');

      if ($reloadIcon.hasClass('loading')) {
        $reloadIcon.removeClass('loading');
        updateLogViewWorker.stop();
      } else {
        $reloadIcon.addClass('loading');
        updateLogViewWorker.initialize();
      }
    });
    $('input').keyup(function (event) {
      if (event.keyCode === 13) {
        systemDiagnosticLogs.updateLogFromServer();
      }
    });
  },
  initializeAce: function initializeAce() {
    systemDiagnosticLogs.viewer = ace.edit('log-content-readonly');

    var julia = ace.require('ace/mode/julia');

    if (julia !== undefined) {
      var IniMode = julia.Mode;
      systemDiagnosticLogs.viewer.session.setMode(new IniMode());
    }

    systemDiagnosticLogs.viewer.setTheme('ace/theme/monokai');
    systemDiagnosticLogs.viewer.renderer.setShowGutter(false);
    systemDiagnosticLogs.viewer.setOptions({
      showLineNumbers: false,
      showPrintMargin: false,
      readOnly: true
    });
    $(window).load(function () {
      var aceHeight = window.innerHeight - systemDiagnosticLogs.$logContent.offset().top - 50;
      $('.log-content-readonly').css('min-height', "".concat(aceHeight, "px"));
      systemDiagnosticLogs.viewer.resize();
    });
  },

  /**
   * Makes formatted menu structure
   */
  cbFormatDropdownResults: function cbFormatDropdownResults(response) {
    if (response === false) {
      return;
    }

    var defVal = '';

    if (systemDiagnosticLogs.logsItems.length === 0 && $("#filename").val() !== '') {
      defVal = $("#filename").val().trim();
    }

    systemDiagnosticLogs.logsItems = [];
    var files = response.files;
    $.each(files, function (index, item) {
      if (defVal !== '') {
        item["default"] = defVal === item.path;
      }

      systemDiagnosticLogs.logsItems.push({
        name: "".concat(index, " (").concat(item.size, ")"),
        value: item.path,
        selected: item["default"]
      });
    });
    systemDiagnosticLogs.$fileSelectDropDown.dropdown('change values', systemDiagnosticLogs.logsItems);
  },

  /**
   * Callback after change log file in select
   * @param value
   */
  cbOnChangeFile: function cbOnChangeFile(value) {
    if (value.length === 0) {
      return;
    }

    systemDiagnosticLogs.$formObj.form('set value', 'filename', value);
    systemDiagnosticLogs.updateLogFromServer();
  },

  /**
   * Asks log file content from server
   */
  updateLogFromServer: function updateLogFromServer() {
    var params = systemDiagnosticLogs.$formObj.form('get values');
    PbxApi.SyslogGetLogFromFile(params, systemDiagnosticLogs.cbUpdateLogText);
  },

  /**
   * Updates log view
   * @param data
   */
  cbUpdateLogText: function cbUpdateLogText(data) {
    systemDiagnosticLogs.viewer.getSession().setValue(data.content);
    var row = systemDiagnosticLogs.viewer.session.getLength() - 1;
    var column = systemDiagnosticLogs.viewer.session.getLine(row).length; // or simply Infinity

    systemDiagnosticLogs.viewer.gotoLine(row + 1, column);
    systemDiagnosticLogs.$dimmer.removeClass('active');
  },

  /**
   * After push button download file
   * @param response
   */
  cbDownloadFile: function cbDownloadFile(response) {
    if (response !== false) {
      window.location = response.filename;
    }
  }
};
$(document).ready(function () {
  systemDiagnosticLogs.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TeXN0ZW1EaWFnbm9zdGljL3N5c3RlbS1kaWFnbm9zdGljLWluZGV4LXNob3dsb2dzLmpzIl0sIm5hbWVzIjpbInVwZGF0ZUxvZ1ZpZXdXb3JrZXIiLCJ0aW1lT3V0IiwidGltZU91dEhhbmRsZSIsImVycm9yQ291bnRzIiwiaW5pdGlhbGl6ZSIsInJlc3RhcnRXb3JrZXIiLCJ3aW5kb3ciLCJjbGVhclRpbWVvdXQiLCJ0aW1lb3V0SGFuZGxlIiwid29ya2VyIiwic3lzdGVtRGlhZ25vc3RpY0xvZ3MiLCJ1cGRhdGVMb2dGcm9tU2VydmVyIiwic2V0VGltZW91dCIsInN0b3AiLCIkc2hvd0J0biIsIiQiLCIkZG93bmxvYWRCdG4iLCIkc2hvd0F1dG9CdG4iLCIkbG9nQ29udGVudCIsInZpZXdlciIsIiRmaWxlU2VsZWN0RHJvcERvd24iLCJsb2dzSXRlbXMiLCJkZWZhdWx0TG9nSXRlbSIsIiRkaW1tZXIiLCIkZm9ybU9iaiIsIiRmaWxlTmFtZSIsImFjZUhlaWdodCIsImlubmVySGVpZ2h0IiwiY2xvc2VzdCIsImNzcyIsImRyb3Bkb3duIiwidmFsdWVzIiwib25DaGFuZ2UiLCJjYk9uQ2hhbmdlRmlsZSIsImlnbm9yZUNhc2UiLCJmdWxsVGV4dFNlYXJjaCIsImZvcmNlU2VsZWN0aW9uIiwiaW5pdGlhbGl6ZUFjZSIsIlBieEFwaSIsIlN5c2xvZ0dldExvZ3NMaXN0IiwiY2JGb3JtYXREcm9wZG93blJlc3VsdHMiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImRhdGEiLCJmb3JtIiwiU3lzbG9nRG93bmxvYWRMb2dGaWxlIiwiZmlsZW5hbWUiLCJjYkRvd25sb2FkRmlsZSIsIiRyZWxvYWRJY29uIiwiZmluZCIsImhhc0NsYXNzIiwicmVtb3ZlQ2xhc3MiLCJhZGRDbGFzcyIsImtleXVwIiwiZXZlbnQiLCJrZXlDb2RlIiwiYWNlIiwiZWRpdCIsImp1bGlhIiwicmVxdWlyZSIsInVuZGVmaW5lZCIsIkluaU1vZGUiLCJNb2RlIiwic2Vzc2lvbiIsInNldE1vZGUiLCJzZXRUaGVtZSIsInJlbmRlcmVyIiwic2V0U2hvd0d1dHRlciIsInNldE9wdGlvbnMiLCJzaG93TGluZU51bWJlcnMiLCJzaG93UHJpbnRNYXJnaW4iLCJyZWFkT25seSIsImxvYWQiLCJvZmZzZXQiLCJ0b3AiLCJyZXNpemUiLCJyZXNwb25zZSIsImRlZlZhbCIsImxlbmd0aCIsInZhbCIsInRyaW0iLCJmaWxlcyIsImVhY2giLCJpbmRleCIsIml0ZW0iLCJwYXRoIiwicHVzaCIsIm5hbWUiLCJzaXplIiwidmFsdWUiLCJzZWxlY3RlZCIsInBhcmFtcyIsIlN5c2xvZ0dldExvZ0Zyb21GaWxlIiwiY2JVcGRhdGVMb2dUZXh0IiwiZ2V0U2Vzc2lvbiIsInNldFZhbHVlIiwiY29udGVudCIsInJvdyIsImdldExlbmd0aCIsImNvbHVtbiIsImdldExpbmUiLCJnb3RvTGluZSIsImxvY2F0aW9uIiwiZG9jdW1lbnQiLCJyZWFkeSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUNBO0FBR0EsSUFBTUEsbUJBQW1CLEdBQUc7QUFDM0JDLEVBQUFBLE9BQU8sRUFBRSxJQURrQjtBQUUzQkMsRUFBQUEsYUFBYSxFQUFFLEVBRlk7QUFHM0JDLEVBQUFBLFdBQVcsRUFBRSxDQUhjO0FBSTNCQyxFQUFBQSxVQUoyQix3QkFJZDtBQUNaSixJQUFBQSxtQkFBbUIsQ0FBQ0ssYUFBcEI7QUFDQSxHQU4wQjtBQU8zQkEsRUFBQUEsYUFQMkIsMkJBT1g7QUFDZkMsSUFBQUEsTUFBTSxDQUFDQyxZQUFQLENBQW9CUCxtQkFBbUIsQ0FBQ1EsYUFBeEM7QUFDQVIsSUFBQUEsbUJBQW1CLENBQUNTLE1BQXBCO0FBQ0EsR0FWMEI7QUFXM0JBLEVBQUFBLE1BWDJCLG9CQVdsQjtBQUNSQyxJQUFBQSxvQkFBb0IsQ0FBQ0MsbUJBQXJCO0FBQ0FYLElBQUFB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QixDQUFDUyxNQUFyQixDQUE0QjRFLFVBQTVCLEdBQXlDQyxRQUF6QyxDQUFrRHBELElBQUksQ0FBQ3FELE9BQXZEO0FBQ0EsUUFBTUMsR0FBRyxHQUFHeEYsb0JBQW9CLENBQUNTLE1BQXJCLENBQTRCNkMsT0FBNUIsQ0FBb0NtQyxTQUFwQyxLQUFrRCxDQUE5RDtBQUNBLFFBQU1DLE1BQU0sR0FBRzFGLG9CQUFvQixDQUFDUyxNQUFyQixDQUE0QjZDLE9BQTVCLENBQW9DcUMsT0FBcEMsQ0FBNENILEdBQTVDLEVBQWlEbkIsTUFBaEUsQ0FIcUIsQ0FHbUQ7O0FBQ3hFckUsSUFBQUEsb0JBQW9CLENBQUNTLE1BQXJCLENBQTRCbUYsUUFBNUIsQ0FBcUNKLEdBQUcsR0FBRyxDQUEzQyxFQUE4Q0UsTUFBOUM7QUFDQTFGLElBQUFBLG9CQUFvQixDQUFDYSxPQUFyQixDQUE2QjZCLFdBQTdCLENBQXlDLFFBQXpDO0FBQ0EsR0FySTJCOztBQXNJNUI7QUFDRDtBQUNBO0FBQ0E7QUFDQ0osRUFBQUEsY0ExSTRCLDBCQTBJYjZCLFFBMUlhLEVBMElKO0FBQ3ZCLFFBQUlBLFFBQVEsS0FBRyxLQUFmLEVBQXFCO0FBQ3BCdkUsTUFBQUEsTUFBTSxDQUFDaUcsUUFBUCxHQUFrQjFCLFFBQVEsQ0FBQzlCLFFBQTNCO0FBQ0E7QUFDRDtBQTlJMkIsQ0FBN0I7QUFpSkFoQyxDQUFDLENBQUN5RixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3ZCL0YsRUFBQUEsb0JBQW9CLENBQUNOLFVBQXJCO0FBQ0EsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG4vKiBnbG9iYWwgYWNlLCBQYnhBcGkgKi9cblxuXG5jb25zdCB1cGRhdGVMb2dWaWV3V29ya2VyID0ge1xuXHR0aW1lT3V0OiAzMDAwLFxuXHR0aW1lT3V0SGFuZGxlOiAnJyxcblx0ZXJyb3JDb3VudHM6IDAsXG5cdGluaXRpYWxpemUoKSB7XG5cdFx0dXBkYXRlTG9nVmlld1dvcmtlci5yZXN0YXJ0V29ya2VyKCk7XG5cdH0sXG5cdHJlc3RhcnRXb3JrZXIoKSB7XG5cdFx0d2luZG93LmNsZWFyVGltZW91dCh1cGRhdGVMb2dWaWV3V29ya2VyLnRpbWVvdXRIYW5kbGUpO1xuXHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIud29ya2VyKCk7XG5cdH0sXG5cdHdvcmtlcigpIHtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy51cGRhdGVMb2dGcm9tU2VydmVyKCk7XG5cdFx0dXBkYXRlTG9nVmlld1dvcmtlci50aW1lb3V0SGFuZGxlID0gd2luZG93LnNldFRpbWVvdXQoXG5cdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLndvcmtlcixcblx0XHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIudGltZU91dCxcblx0XHQpO1xuXHR9LFxuXHRzdG9wKCkge1xuXHRcdHdpbmRvdy5jbGVhclRpbWVvdXQodXBkYXRlTG9nVmlld1dvcmtlci50aW1lb3V0SGFuZGxlKTtcblx0fVxufTtcblxuY29uc3Qgc3lzdGVtRGlhZ25vc3RpY0xvZ3MgPSB7XG5cdCRzaG93QnRuOiAkKCcjc2hvdy1sYXN0LWxvZycpLFxuXHQkZG93bmxvYWRCdG46ICQoJyNkb3dubG9hZC1maWxlJyksXG5cdCRzaG93QXV0b0J0bjogJCgnI3Nob3ctbGFzdC1sb2ctYXV0bycpLFxuXHQkbG9nQ29udGVudDogJCgnI2xvZy1jb250ZW50LXJlYWRvbmx5JyksXG5cdHZpZXdlcjogJycsXG5cdCRmaWxlU2VsZWN0RHJvcERvd246ICQoJyNzeXN0ZW0tZGlhZ25vc3RpYy1mb3JtIC5maWxlbmFtZXMtc2VsZWN0JyksXG5cdGxvZ3NJdGVtczogW10sXG5cdGRlZmF1bHRMb2dJdGVtOiBudWxsLFxuXHQkZGltbWVyOiAkKCcjZ2V0LWxvZ3MtZGltbWVyJyksXG5cdCRmb3JtT2JqOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybScpLFxuXHQkZmlsZU5hbWU6ICQoJyNzeXN0ZW0tZGlhZ25vc3RpYy1mb3JtIC5maWxlbmFtZScpLFxuXHRpbml0aWFsaXplKCkge1xuXHRcdGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodC0yNTA7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGRpbW1lci5jbG9zZXN0KCdkaXYnKS5jc3MoJ21pbi1oZWlnaHQnLCBgJHthY2VIZWlnaHR9cHhgKTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZmlsZVNlbGVjdERyb3BEb3duLmRyb3Bkb3duKFxuXHRcdFx0e1xuXHRcdFx0XHR2YWx1ZXM6IHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcyxcblx0XHRcdFx0b25DaGFuZ2U6IHN5c3RlbURpYWdub3N0aWNMb2dzLmNiT25DaGFuZ2VGaWxlLFxuXHRcdFx0XHRpZ25vcmVDYXNlOiB0cnVlLFxuXHRcdFx0XHRmdWxsVGV4dFNlYXJjaDogdHJ1ZSxcblx0XHRcdFx0Zm9yY2VTZWxlY3Rpb246IGZhbHNlLFxuXHRcdFx0fVxuXHRcdCk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuaW5pdGlhbGl6ZUFjZSgpO1xuXHRcdFBieEFwaS5TeXNsb2dHZXRMb2dzTGlzdChzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYkZvcm1hdERyb3Bkb3duUmVzdWx0cyk7XG5cblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy4kc2hvd0J0bi5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MudXBkYXRlTG9nRnJvbVNlcnZlcigpO1xuXHRcdH0pO1xuXG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGRvd25sb2FkQnRuLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRjb25zdCBkYXRhID0gc3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlcycpO1xuXHRcdFx0UGJ4QXBpLlN5c2xvZ0Rvd25sb2FkTG9nRmlsZShkYXRhLmZpbGVuYW1lLCBzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYkRvd25sb2FkRmlsZSk7XG5cdFx0fSk7XG5cblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy4kc2hvd0F1dG9CdG4ub24oJ2NsaWNrJywgKGUpID0+IHtcblx0XHRcdGUucHJldmVudERlZmF1bHQoKTtcblx0XHRcdGNvbnN0ICRyZWxvYWRJY29uID0gc3lzdGVtRGlhZ25vc3RpY0xvZ3MuJHNob3dBdXRvQnRuLmZpbmQoJ2kucmVmcmVzaCcpO1xuXHRcdFx0aWYgKCRyZWxvYWRJY29uLmhhc0NsYXNzKCdsb2FkaW5nJykpe1xuXHRcdFx0XHQkcmVsb2FkSWNvbi5yZW1vdmVDbGFzcygnbG9hZGluZycpO1xuXHRcdFx0XHR1cGRhdGVMb2dWaWV3V29ya2VyLnN0b3AoKTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdCRyZWxvYWRJY29uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG5cdFx0XHRcdHVwZGF0ZUxvZ1ZpZXdXb3JrZXIuaW5pdGlhbGl6ZSgpO1xuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdCQoJ2lucHV0Jykua2V5dXAoKGV2ZW50KT0+IHtcblx0XHRcdGlmIChldmVudC5rZXlDb2RlID09PSAxMykge1xuXHRcdFx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy51cGRhdGVMb2dGcm9tU2VydmVyKCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH0sXG5cdGluaXRpYWxpemVBY2UoKSB7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyID0gYWNlLmVkaXQoJ2xvZy1jb250ZW50LXJlYWRvbmx5Jyk7XG5cblx0XHRjb25zdCBqdWxpYSA9IGFjZS5yZXF1aXJlKCdhY2UvbW9kZS9qdWxpYScpO1xuXHRcdGlmIChqdWxpYSE9PXVuZGVmaW5lZCl7XG5cdFx0XHRjb25zdCBJbmlNb2RlID0ganVsaWEuTW9kZTtcblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXNzaW9uLnNldE1vZGUobmV3IEluaU1vZGUoKSk7XG5cdFx0fVxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXRUaGVtZSgnYWNlL3RoZW1lL21vbm9rYWknKTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIucmVuZGVyZXIuc2V0U2hvd0d1dHRlcihmYWxzZSk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnNldE9wdGlvbnMoe1xuXHRcdFx0c2hvd0xpbmVOdW1iZXJzOmZhbHNlLFxuXHRcdFx0c2hvd1ByaW50TWFyZ2luOiBmYWxzZSxcblx0XHRcdHJlYWRPbmx5OiB0cnVlLFxuXHRcdH0pO1xuXHRcdCQod2luZG93KS5sb2FkKGZ1bmN0aW9uKCkge1xuXHRcdFx0Y29uc3QgYWNlSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0LXN5c3RlbURpYWdub3N0aWNMb2dzLiRsb2dDb250ZW50Lm9mZnNldCgpLnRvcC01MDtcblx0XHRcdCQoJy5sb2ctY29udGVudC1yZWFkb25seScpLmNzcygnbWluLWhlaWdodCcsIGAke2FjZUhlaWdodH1weGApO1xuXHRcdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnJlc2l6ZSgpO1xuXHRcdH0pO1xuXHR9LFxuXHQvKipcblx0ICogTWFrZXMgZm9ybWF0dGVkIG1lbnUgc3RydWN0dXJlXG5cdCAqL1xuXHRjYkZvcm1hdERyb3Bkb3duUmVzdWx0cyhyZXNwb25zZSkge1xuXHRcdGlmIChyZXNwb25zZSA9PT1mYWxzZSl7XG5cdFx0XHRyZXR1cm4gO1xuXHRcdH1cblxuXHRcdGxldCBkZWZWYWwgPSAnJztcblx0XHRpZihzeXN0ZW1EaWFnbm9zdGljTG9ncy5sb2dzSXRlbXMubGVuZ3RoID09PSAwICYmICQoXCIjZmlsZW5hbWVcIikudmFsKCkgIT09ICcnKXtcblx0XHRcdGRlZlZhbCA9ICQoXCIjZmlsZW5hbWVcIikudmFsKCkudHJpbSgpO1xuXHRcdH1cblxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcyA9IFtdO1xuXHRcdGNvbnN0IGZpbGVzID0gcmVzcG9uc2UuZmlsZXM7XG5cdFx0JC5lYWNoKGZpbGVzLCAoaW5kZXgsIGl0ZW0pID0+IHtcblxuXHRcdFx0aWYoZGVmVmFsICE9PSAnJyl7XG5cdFx0XHRcdGl0ZW0uZGVmYXVsdCA9IChkZWZWYWwgPT09IGl0ZW0ucGF0aCk7XG5cdFx0XHR9XG5cblx0XHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcy5wdXNoKHtcblx0XHRcdFx0bmFtZTogYCR7aW5kZXh9ICgke2l0ZW0uc2l6ZX0pYCxcblx0XHRcdFx0dmFsdWU6IGl0ZW0ucGF0aCxcblx0XHRcdFx0c2VsZWN0ZWQ6IGl0ZW0uZGVmYXVsdFxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZpbGVTZWxlY3REcm9wRG93bi5kcm9wZG93bignY2hhbmdlIHZhbHVlcycsIHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcyk7XG5cdH0sXG5cdC8qKlxuXHQgKiBDYWxsYmFjayBhZnRlciBjaGFuZ2UgbG9nIGZpbGUgaW4gc2VsZWN0XG5cdCAqIEBwYXJhbSB2YWx1ZVxuXHQgKi9cblx0Y2JPbkNoYW5nZUZpbGUodmFsdWUpIHtcblx0XHRpZiAodmFsdWUubGVuZ3RoPT09MCl7XG5cdFx0XHRyZXR1cm47XG5cdFx0fVxuXHRcdHN5c3RlbURpYWdub3N0aWNMb2dzLiRmb3JtT2JqLmZvcm0oJ3NldCB2YWx1ZScsICdmaWxlbmFtZScsIHZhbHVlKTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy51cGRhdGVMb2dGcm9tU2VydmVyKCk7XG5cdH0sXG5cdC8qKlxuXHQgKiBBc2tzIGxvZyBmaWxlIGNvbnRlbnQgZnJvbSBzZXJ2ZXJcblx0ICovXG5cdHVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKXtcblx0XHRjb25zdCBwYXJhbXMgPSBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG5cdFx0UGJ4QXBpLlN5c2xvZ0dldExvZ0Zyb21GaWxlKHBhcmFtcywgc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JVcGRhdGVMb2dUZXh0KTtcblx0fSxcblx0LyoqXG5cdCAqIFVwZGF0ZXMgbG9nIHZpZXdcblx0ICogQHBhcmFtIGRhdGFcblx0ICovXG5cdGNiVXBkYXRlTG9nVGV4dChkYXRhKSB7XG5cdFx0c3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLmdldFNlc3Npb24oKS5zZXRWYWx1ZShkYXRhLmNvbnRlbnQpO1xuXHRcdGNvbnN0IHJvdyA9IHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXNzaW9uLmdldExlbmd0aCgpIC0gMTtcblx0XHRjb25zdCBjb2x1bW4gPSBzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2Vzc2lvbi5nZXRMaW5lKHJvdykubGVuZ3RoOyAvLyBvciBzaW1wbHkgSW5maW5pdHlcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuZ290b0xpbmUocm93ICsgMSwgY29sdW1uKTtcblx0XHRzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZGltbWVyLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcblx0fSxcblx0LyoqXG5cdCAqIEFmdGVyIHB1c2ggYnV0dG9uIGRvd25sb2FkIGZpbGVcblx0ICogQHBhcmFtIHJlc3BvbnNlXG5cdCAqL1xuXHRjYkRvd25sb2FkRmlsZShyZXNwb25zZSl7XG5cdFx0aWYgKHJlc3BvbnNlIT09ZmFsc2Upe1xuXHRcdFx0d2luZG93LmxvY2F0aW9uID0gcmVzcG9uc2UuZmlsZW5hbWU7XG5cdFx0fVxuXHR9LFxufTtcblxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuXHRzeXN0ZW1EaWFnbm9zdGljTG9ncy5pbml0aWFsaXplKCk7XG59KTtcblxuIl19