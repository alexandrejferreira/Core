"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global ace, PbxApi, updateLogViewWorker */

/**
 * Represents the system diagnostic logs object.
 *
 * @module systemDiagnosticLogs
 */
var systemDiagnosticLogs = {
  /**
   * jQuery object for the "Show Last Log" button.
   * @type {jQuery}
   */
  $showBtn: $('#show-last-log'),

  /**
   * jQuery object for the "Download File" button.
   * @type {jQuery}
   */
  $downloadBtn: $('#download-file'),

  /**
   * jQuery object for the "Show Last Log (Auto)" button.
   * @type {jQuery}
   */
  $showAutoBtn: $('#show-last-log-auto'),

  /**
   * jQuery object for the log content.
   * @type {jQuery}
   */
  $logContent: $('#log-content-readonly'),

  /**
   * The viewer for displaying the log content.
   * @type {Ace}
   */
  viewer: '',

  /**
   * jQuery object for the file select dropdown.
   * @type {jQuery}
   */
  $fileSelectDropDown: $('#system-diagnostic-form .filenames-select'),

  /**
   * Array of log items.
   * @type {Array}
   */
  logsItems: [],

  /**
   * Default log item.
   * @type {Object}
   */
  defaultLogItem: null,

  /**
   * jQuery object for the dimmer.
   * @type {jQuery}
   */
  $dimmer: $('#get-logs-dimmer'),

  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#system-diagnostic-form'),

  /**
   * jQuery object for the filename.
   * @type {jQuery}
   */
  $fileName: $('#system-diagnostic-form .filename'),

  /**
   * Initializes the system diagnostic logs.
   */
  initialize: function initialize() {
    var aceHeight = window.innerHeight - 250; // Set the minimum height of the log container

    systemDiagnosticLogs.$dimmer.closest('div').css('min-height', "".concat(aceHeight, "px")); // Initialize the dropdown menu for log files

    systemDiagnosticLogs.$fileSelectDropDown.dropdown({
      values: systemDiagnosticLogs.logsItems,
      onChange: systemDiagnosticLogs.cbOnChangeFile,
      ignoreCase: true,
      fullTextSearch: true,
      forceSelection: false
    }); // Initialize the ACE editor for log content

    systemDiagnosticLogs.initializeAce(); // Fetch the list of log files

    PbxApi.SyslogGetLogsList(systemDiagnosticLogs.cbFormatDropdownResults); // Event listener for "Show Log" button click

    systemDiagnosticLogs.$showBtn.on('click', function (e) {
      e.preventDefault();
      systemDiagnosticLogs.updateLogFromServer();
    }); // Event listener for "Download Log" button click

    systemDiagnosticLogs.$downloadBtn.on('click', function (e) {
      e.preventDefault();
      var data = systemDiagnosticLogs.$formObj.form('get values');
      PbxApi.SyslogDownloadLogFile(data.filename, systemDiagnosticLogs.cbDownloadFile);
    }); // Event listener for "Auto Refresh" button click

    systemDiagnosticLogs.$showAutoBtn.on('click', function (e) {
      e.preventDefault();
      var $reloadIcon = systemDiagnosticLogs.$showAutoBtn.find('i.refresh');

      if ($reloadIcon.hasClass('loading')) {
        $reloadIcon.removeClass('loading');
        updateLogViewWorker.stop();
      } else {
        $reloadIcon.addClass('loading');
        updateLogViewWorker.initialize();
      }
    }); // Event listener for Enter keypress on input fields

    $('input').keyup(function (event) {
      if (event.keyCode === 13) {
        systemDiagnosticLogs.updateLogFromServer();
      }
    });
  },

  /**
   * Initializes the ACE editor for log viewing.
   */
  initializeAce: function initializeAce() {
    systemDiagnosticLogs.viewer = ace.edit('log-content-readonly'); // Check if the Julia mode is available

    var julia = ace.require('ace/mode/julia');

    if (julia !== undefined) {
      // Set the mode to Julia if available
      var IniMode = julia.Mode;
      systemDiagnosticLogs.viewer.session.setMode(new IniMode());
    } // Set the theme and options for the ACE editor


    systemDiagnosticLogs.viewer.setTheme('ace/theme/monokai');
    systemDiagnosticLogs.viewer.renderer.setShowGutter(false);
    systemDiagnosticLogs.viewer.setOptions({
      showLineNumbers: false,
      showPrintMargin: false,
      readOnly: true
    }); // Resize the ACE editor to fit the window height

    $(window).load(function () {
      var aceHeight = window.innerHeight - systemDiagnosticLogs.$logContent.offset().top - 50;
      $('.log-content-readonly').css('min-height', "".concat(aceHeight, "px"));
      systemDiagnosticLogs.viewer.resize();
    });
  },

  /**
   * Callback function to format the dropdown menu structure based on the response.
   * @param {Object} response - The response data.
   */
  cbFormatDropdownResults: function cbFormatDropdownResults(response) {
    if (response === false) {
      return;
    } // Check if there is a default value set for the filename input field


    var defVal = '';

    if (systemDiagnosticLogs.logsItems.length === 0 && $("#filename").val() !== '') {
      defVal = $("#filename").val().trim();
    }

    systemDiagnosticLogs.logsItems = [];
    var files = response.files; // Iterate through each file and create the dropdown menu options

    $.each(files, function (index, item) {
      if (defVal !== '') {
        item["default"] = defVal === item.path;
      } // Create an option object for each file


      systemDiagnosticLogs.logsItems.push({
        name: "".concat(index, " (").concat(item.size, ")"),
        value: item.path,
        selected: item["default"]
      });
    }); // Update the dropdown menu values with the newly formatted options

    systemDiagnosticLogs.$fileSelectDropDown.dropdown('change values', systemDiagnosticLogs.logsItems);
  },

  /**
   * Callback after changing the log file in the select dropdown.
   * @param {string} value - The selected value.
   */
  cbOnChangeFile: function cbOnChangeFile(value) {
    if (value.length === 0) {
      return;
    }

    systemDiagnosticLogs.$formObj.form('set value', 'filename', value);
    systemDiagnosticLogs.updateLogFromServer();
  },

  /**
   * Fetches the log file content from the server.
   */
  updateLogFromServer: function updateLogFromServer() {
    var params = systemDiagnosticLogs.$formObj.form('get values');
    PbxApi.SyslogGetLogFromFile(params, systemDiagnosticLogs.cbUpdateLogText);
  },

  /**
   * Updates the log view.
   * @param {Object} data - The log data.
   */
  cbUpdateLogText: function cbUpdateLogText(data) {
    systemDiagnosticLogs.viewer.getSession().setValue(data.content);
    var row = systemDiagnosticLogs.viewer.session.getLength() - 1;
    var column = systemDiagnosticLogs.viewer.session.getLine(row).length; // or simply Infinity

    systemDiagnosticLogs.viewer.gotoLine(row + 1, column);
    systemDiagnosticLogs.$dimmer.removeClass('active');
  },

  /**
   * Callback after clicking the "Download File" button.
   * @param {Object} response - The response data.
   */
  cbDownloadFile: function cbDownloadFile(response) {
    if (response !== false) {
      window.location = response.filename;
    }
  }
}; // When the document is ready, initialize the show system logs tab

$(document).ready(function () {
  systemDiagnosticLogs.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9TeXN0ZW1EaWFnbm9zdGljL3N5c3RlbS1kaWFnbm9zdGljLWluZGV4LXNob3dsb2dzLmpzIl0sIm5hbWVzIjpbInN5c3RlbURpYWdub3N0aWNMb2dzIiwiJHNob3dCdG4iLCIkIiwiJGRvd25sb2FkQnRuIiwiJHNob3dBdXRvQnRuIiwiJGxvZ0NvbnRlbnQiLCJ2aWV3ZXIiLCIkZmlsZVNlbGVjdERyb3BEb3duIiwibG9nc0l0ZW1zIiwiZGVmYXVsdExvZ0l0ZW0iLCIkZGltbWVyIiwiJGZvcm1PYmoiLCIkZmlsZU5hbWUiLCJpbml0aWFsaXplIiwiYWNlSGVpZ2h0Iiwid2luZG93IiwiaW5uZXJIZWlnaHQiLCJjbG9zZXN0IiwiY3NzIiwiZHJvcGRvd24iLCJ2YWx1ZXMiLCJvbkNoYW5nZSIsImNiT25DaGFuZ2VGaWxlIiwiaWdub3JlQ2FzZSIsImZ1bGxUZXh0U2VhcmNoIiwiZm9yY2VTZWxlY3Rpb24iLCJpbml0aWFsaXplQWNlIiwiUGJ4QXBpIiwiU3lzbG9nR2V0TG9nc0xpc3QiLCJjYkZvcm1hdERyb3Bkb3duUmVzdWx0cyIsIm9uIiwiZSIsInByZXZlbnREZWZhdWx0IiwidXBkYXRlTG9nRnJvbVNlcnZlciIsImRhdGEiLCJmb3JtIiwiU3lzbG9nRG93bmxvYWRMb2dGaWxlIiwiZmlsZW5hbWUiLCJjYkRvd25sb2FkRmlsZSIsIiRyZWxvYWRJY29uIiwiZmluZCIsImhhc0NsYXNzIiwicmVtb3ZlQ2xhc3MiLCJ1cGRhdGVMb2dWaWV3V29ya2VyIiwic3RvcCIsImFkZENsYXNzIiwia2V5dXAiLCJldmVudCIsImtleUNvZGUiLCJhY2UiLCJlZGl0IiwianVsaWEiLCJyZXF1aXJlIiwidW5kZWZpbmVkIiwiSW5pTW9kZSIsIk1vZGUiLCJzZXNzaW9uIiwic2V0TW9kZSIsInNldFRoZW1lIiwicmVuZGVyZXIiLCJzZXRTaG93R3V0dGVyIiwic2V0T3B0aW9ucyIsInNob3dMaW5lTnVtYmVycyIsInNob3dQcmludE1hcmdpbiIsInJlYWRPbmx5IiwibG9hZCIsIm9mZnNldCIsInRvcCIsInJlc2l6ZSIsInJlc3BvbnNlIiwiZGVmVmFsIiwibGVuZ3RoIiwidmFsIiwidHJpbSIsImZpbGVzIiwiZWFjaCIsImluZGV4IiwiaXRlbSIsInBhdGgiLCJwdXNoIiwibmFtZSIsInNpemUiLCJ2YWx1ZSIsInNlbGVjdGVkIiwicGFyYW1zIiwiU3lzbG9nR2V0TG9nRnJvbUZpbGUiLCJjYlVwZGF0ZUxvZ1RleHQiLCJnZXRTZXNzaW9uIiwic2V0VmFsdWUiLCJjb250ZW50Iiwicm93IiwiZ2V0TGVuZ3RoIiwiY29sdW1uIiwiZ2V0TGluZSIsImdvdG9MaW5lIiwibG9jYXRpb24iLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLG9CQUFvQixHQUFHO0FBQ3pCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFFBQVEsRUFBRUMsQ0FBQyxDQUFDLGdCQUFELENBTGM7O0FBT3pCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFlBQVksRUFBRUQsQ0FBQyxDQUFDLGdCQUFELENBWFU7O0FBYXpCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lFLEVBQUFBLFlBQVksRUFBRUYsQ0FBQyxDQUFDLHFCQUFELENBakJVOztBQW1CekI7QUFDSjtBQUNBO0FBQ0E7QUFDSUcsRUFBQUEsV0FBVyxFQUFFSCxDQUFDLENBQUMsdUJBQUQsQ0F2Qlc7O0FBeUJ6QjtBQUNKO0FBQ0E7QUFDQTtBQUNJSSxFQUFBQSxNQUFNLEVBQUUsRUE3QmlCOztBQStCekI7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsbUJBQW1CLEVBQUVMLENBQUMsQ0FBQywyQ0FBRCxDQW5DRzs7QUFxQ3pCO0FBQ0o7QUFDQTtBQUNBO0FBQ0lNLEVBQUFBLFNB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QixDQUE0QmtELE9BQTVCLENBQW9DcUMsT0FBcEMsQ0FBNENILEdBQTVDLEVBQWlEbkIsTUFBaEUsQ0FIa0IsQ0FHc0Q7O0FBQ3hFdkUsSUFBQUEsb0JBQW9CLENBQUNNLE1BQXJCLENBQTRCd0YsUUFBNUIsQ0FBcUNKLEdBQUcsR0FBRyxDQUEzQyxFQUE4Q0UsTUFBOUM7QUFDQTVGLElBQUFBLG9CQUFvQixDQUFDVSxPQUFyQixDQUE2QmdDLFdBQTdCLENBQXlDLFFBQXpDO0FBQ0gsR0E3TndCOztBQStOekI7QUFDSjtBQUNBO0FBQ0E7QUFDSUosRUFBQUEsY0FuT3lCLDBCQW1PVitCLFFBbk9VLEVBbU9BO0FBQ3JCLFFBQUlBLFFBQVEsS0FBSyxLQUFqQixFQUF3QjtBQUNwQnRELE1BQUFBLE1BQU0sQ0FBQ2dGLFFBQVAsR0FBa0IxQixRQUFRLENBQUNoQyxRQUEzQjtBQUNIO0FBQ0o7QUF2T3dCLENBQTdCLEMsQ0EwT0E7O0FBQ0FuQyxDQUFDLENBQUM4RixRQUFELENBQUQsQ0FBWUMsS0FBWixDQUFrQixZQUFNO0FBQ3BCakcsRUFBQUEsb0JBQW9CLENBQUNhLFVBQXJCO0FBQ0gsQ0FGRCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBNaWtvUEJYIC0gZnJlZSBwaG9uZSBzeXN0ZW0gZm9yIHNtYWxsIGJ1c2luZXNzXG4gKiBDb3B5cmlnaHQgwqkgMjAxNy0yMDIzIEFsZXhleSBQb3J0bm92IGFuZCBOaWtvbGF5IEJla2V0b3ZcbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeVxuICogaXQgdW5kZXIgdGhlIHRlcm1zIG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhcyBwdWJsaXNoZWQgYnlcbiAqIHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb247IGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlIExpY2Vuc2UsIG9yXG4gKiAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGZvciBtb3JlIGRldGFpbHMuXG4gKlxuICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uXG4gKiBJZiBub3QsIHNlZSA8aHR0cHM6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICovXG4vKiBnbG9iYWwgYWNlLCBQYnhBcGksIHVwZGF0ZUxvZ1ZpZXdXb3JrZXIgKi9cblxuLyoqXG4gKiBSZXByZXNlbnRzIHRoZSBzeXN0ZW0gZGlhZ25vc3RpYyBsb2dzIG9iamVjdC5cbiAqXG4gKiBAbW9kdWxlIHN5c3RlbURpYWdub3N0aWNMb2dzXG4gKi9cbmNvbnN0IHN5c3RlbURpYWdub3N0aWNMb2dzID0ge1xuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBcIlNob3cgTGFzdCBMb2dcIiBidXR0b24uXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkc2hvd0J0bjogJCgnI3Nob3ctbGFzdC1sb2cnKSxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBcIkRvd25sb2FkIEZpbGVcIiBidXR0b24uXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkZG93bmxvYWRCdG46ICQoJyNkb3dubG9hZC1maWxlJyksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgXCJTaG93IExhc3QgTG9nIChBdXRvKVwiIGJ1dHRvbi5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRzaG93QXV0b0J0bjogJCgnI3Nob3ctbGFzdC1sb2ctYXV0bycpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGxvZyBjb250ZW50LlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGxvZ0NvbnRlbnQ6ICQoJyNsb2ctY29udGVudC1yZWFkb25seScpLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHZpZXdlciBmb3IgZGlzcGxheWluZyB0aGUgbG9nIGNvbnRlbnQuXG4gICAgICogQHR5cGUge0FjZX1cbiAgICAgKi9cbiAgICB2aWV3ZXI6ICcnLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGZpbGUgc2VsZWN0IGRyb3Bkb3duLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGZpbGVTZWxlY3REcm9wRG93bjogJCgnI3N5c3RlbS1kaWFnbm9zdGljLWZvcm0gLmZpbGVuYW1lcy1zZWxlY3QnKSxcblxuICAgIC8qKlxuICAgICAqIEFycmF5IG9mIGxvZyBpdGVtcy5cbiAgICAgKiBAdHlwZSB7QXJyYXl9XG4gICAgICovXG4gICAgbG9nc0l0ZW1zOiBbXSxcblxuICAgIC8qKlxuICAgICAqIERlZmF1bHQgbG9nIGl0ZW0uXG4gICAgICogQHR5cGUge09iamVjdH1cbiAgICAgKi9cbiAgICBkZWZhdWx0TG9nSXRlbTogbnVsbCxcblxuICAgIC8qKlxuICAgICAqIGpRdWVyeSBvYmplY3QgZm9yIHRoZSBkaW1tZXIuXG4gICAgICogQHR5cGUge2pRdWVyeX1cbiAgICAgKi9cbiAgICAkZGltbWVyOiAkKCcjZ2V0LWxvZ3MtZGltbWVyJyksXG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybScpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdCBmb3IgdGhlIGZpbGVuYW1lLlxuICAgICAqIEB0eXBlIHtqUXVlcnl9XG4gICAgICovXG4gICAgJGZpbGVOYW1lOiAkKCcjc3lzdGVtLWRpYWdub3N0aWMtZm9ybSAuZmlsZW5hbWUnKSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBzeXN0ZW0gZGlhZ25vc3RpYyBsb2dzLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIDI1MDtcblxuICAgICAgICAvLyBTZXQgdGhlIG1pbmltdW0gaGVpZ2h0IG9mIHRoZSBsb2cgY29udGFpbmVyXG4gICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLiRkaW1tZXIuY2xvc2VzdCgnZGl2JykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG5cbiAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgZHJvcGRvd24gbWVudSBmb3IgbG9nIGZpbGVzXG4gICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLiRmaWxlU2VsZWN0RHJvcERvd24uZHJvcGRvd24oe1xuICAgICAgICAgICAgICAgIHZhbHVlczogc3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zLFxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiBzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYk9uQ2hhbmdlRmlsZSxcbiAgICAgICAgICAgICAgICBpZ25vcmVDYXNlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZ1bGxUZXh0U2VhcmNoOiB0cnVlLFxuICAgICAgICAgICAgICAgIGZvcmNlU2VsZWN0aW9uOiBmYWxzZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgQUNFIGVkaXRvciBmb3IgbG9nIGNvbnRlbnRcbiAgICAgICAgc3lzdGVtRGlhZ25vc3RpY0xvZ3MuaW5pdGlhbGl6ZUFjZSgpO1xuXG4gICAgICAgIC8vIEZldGNoIHRoZSBsaXN0IG9mIGxvZyBmaWxlc1xuICAgICAgICBQYnhBcGkuU3lzbG9nR2V0TG9nc0xpc3Qoc3lzdGVtRGlhZ25vc3RpY0xvZ3MuY2JGb3JtYXREcm9wZG93blJlc3VsdHMpO1xuXG4gICAgICAgIC8vIEV2ZW50IGxpc3RlbmVyIGZvciBcIlNob3cgTG9nXCIgYnV0dG9uIGNsaWNrXG4gICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLiRzaG93QnRuLm9uKCdjbGljaycsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy51cGRhdGVMb2dGcm9tU2VydmVyKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEV2ZW50IGxpc3RlbmVyIGZvciBcIkRvd25sb2FkIExvZ1wiIGJ1dHRvbiBjbGlja1xuICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZG93bmxvYWRCdG4ub24oJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWVzJyk7XG4gICAgICAgICAgICBQYnhBcGkuU3lzbG9nRG93bmxvYWRMb2dGaWxlKGRhdGEuZmlsZW5hbWUsIHN5c3RlbURpYWdub3N0aWNMb2dzLmNiRG93bmxvYWRGaWxlKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gRXZlbnQgbGlzdGVuZXIgZm9yIFwiQXV0byBSZWZyZXNoXCIgYnV0dG9uIGNsaWNrXG4gICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLiRzaG93QXV0b0J0bi5vbignY2xpY2snLCAoZSkgPT4ge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgY29uc3QgJHJlbG9hZEljb24gPSBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kc2hvd0F1dG9CdG4uZmluZCgnaS5yZWZyZXNoJyk7XG4gICAgICAgICAgICBpZiAoJHJlbG9hZEljb24uaGFzQ2xhc3MoJ2xvYWRpbmcnKSkge1xuICAgICAgICAgICAgICAgICRyZWxvYWRJY29uLnJlbW92ZUNsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgdXBkYXRlTG9nVmlld1dvcmtlci5zdG9wKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICRyZWxvYWRJY29uLmFkZENsYXNzKCdsb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgdXBkYXRlTG9nVmlld1dvcmtlci5pbml0aWFsaXplKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEV2ZW50IGxpc3RlbmVyIGZvciBFbnRlciBrZXlwcmVzcyBvbiBpbnB1dCBmaWVsZHNcbiAgICAgICAgJCgnaW5wdXQnKS5rZXl1cCgoZXZlbnQpID0+IHtcbiAgICAgICAgICAgIGlmIChldmVudC5rZXlDb2RlID09PSAxMykge1xuICAgICAgICAgICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLnVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBBQ0UgZWRpdG9yIGZvciBsb2cgdmlld2luZy5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplQWNlKCkge1xuICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIgPSBhY2UuZWRpdCgnbG9nLWNvbnRlbnQtcmVhZG9ubHknKTtcblxuICAgICAgICAvLyBDaGVjayBpZiB0aGUgSnVsaWEgbW9kZSBpcyBhdmFpbGFibGVcbiAgICAgICAgY29uc3QganVsaWEgPSBhY2UucmVxdWlyZSgnYWNlL21vZGUvanVsaWEnKTtcbiAgICAgICAgaWYgKGp1bGlhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIC8vIFNldCB0aGUgbW9kZSB0byBKdWxpYSBpZiBhdmFpbGFibGVcbiAgICAgICAgICAgIGNvbnN0IEluaU1vZGUgPSBqdWxpYS5Nb2RlO1xuICAgICAgICAgICAgc3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnNlc3Npb24uc2V0TW9kZShuZXcgSW5pTW9kZSgpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNldCB0aGUgdGhlbWUgYW5kIG9wdGlvbnMgZm9yIHRoZSBBQ0UgZWRpdG9yXG4gICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXRUaGVtZSgnYWNlL3RoZW1lL21vbm9rYWknKTtcbiAgICAgICAgc3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnJlbmRlcmVyLnNldFNob3dHdXR0ZXIoZmFsc2UpO1xuICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuc2V0T3B0aW9ucyh7XG4gICAgICAgICAgICBzaG93TGluZU51bWJlcnM6IGZhbHNlLFxuICAgICAgICAgICAgc2hvd1ByaW50TWFyZ2luOiBmYWxzZSxcbiAgICAgICAgICAgIHJlYWRPbmx5OiB0cnVlLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBSZXNpemUgdGhlIEFDRSBlZGl0b3IgdG8gZml0IHRoZSB3aW5kb3cgaGVpZ2h0XG4gICAgICAgICQod2luZG93KS5sb2FkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIHN5c3RlbURpYWdub3N0aWNMb2dzLiRsb2dDb250ZW50Lm9mZnNldCgpLnRvcCAtIDUwO1xuICAgICAgICAgICAgJCgnLmxvZy1jb250ZW50LXJlYWRvbmx5JykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG4gICAgICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIucmVzaXplKCk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiB0byBmb3JtYXQgdGhlIGRyb3Bkb3duIG1lbnUgc3RydWN0dXJlIGJhc2VkIG9uIHRoZSByZXNwb25zZS5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2UgZGF0YS5cbiAgICAgKi9cbiAgICBjYkZvcm1hdERyb3Bkb3duUmVzdWx0cyhyZXNwb25zZSkge1xuICAgICAgICBpZiAocmVzcG9uc2UgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlcmUgaXMgYSBkZWZhdWx0IHZhbHVlIHNldCBmb3IgdGhlIGZpbGVuYW1lIGlucHV0IGZpZWxkXG4gICAgICAgIGxldCBkZWZWYWwgPSAnJztcbiAgICAgICAgaWYgKHN5c3RlbURpYWdub3N0aWNMb2dzLmxvZ3NJdGVtcy5sZW5ndGggPT09IDAgJiYgJChcIiNmaWxlbmFtZVwiKS52YWwoKSAhPT0gJycpIHtcbiAgICAgICAgICAgIGRlZlZhbCA9ICQoXCIjZmlsZW5hbWVcIikudmFsKCkudHJpbSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgc3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zID0gW107XG4gICAgICAgIGNvbnN0IGZpbGVzID0gcmVzcG9uc2UuZmlsZXM7XG5cbiAgICAgICAgLy8gSXRlcmF0ZSB0aHJvdWdoIGVhY2ggZmlsZSBhbmQgY3JlYXRlIHRoZSBkcm9wZG93biBtZW51IG9wdGlvbnNcbiAgICAgICAgJC5lYWNoKGZpbGVzLCAoaW5kZXgsIGl0ZW0pID0+IHtcblxuICAgICAgICAgICAgaWYgKGRlZlZhbCAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICBpdGVtLmRlZmF1bHQgPSAoZGVmVmFsID09PSBpdGVtLnBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQ3JlYXRlIGFuIG9wdGlvbiBvYmplY3QgZm9yIGVhY2ggZmlsZVxuICAgICAgICAgICAgc3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICAgIG5hbWU6IGAke2luZGV4fSAoJHtpdGVtLnNpemV9KWAsXG4gICAgICAgICAgICAgICAgdmFsdWU6IGl0ZW0ucGF0aCxcbiAgICAgICAgICAgICAgICBzZWxlY3RlZDogaXRlbS5kZWZhdWx0XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gVXBkYXRlIHRoZSBkcm9wZG93biBtZW51IHZhbHVlcyB3aXRoIHRoZSBuZXdseSBmb3JtYXR0ZWQgb3B0aW9uc1xuICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZmlsZVNlbGVjdERyb3BEb3duLmRyb3Bkb3duKCdjaGFuZ2UgdmFsdWVzJywgc3lzdGVtRGlhZ25vc3RpY0xvZ3MubG9nc0l0ZW1zKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgYWZ0ZXIgY2hhbmdpbmcgdGhlIGxvZyBmaWxlIGluIHRoZSBzZWxlY3QgZHJvcGRvd24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gVGhlIHNlbGVjdGVkIHZhbHVlLlxuICAgICAqL1xuICAgIGNiT25DaGFuZ2VGaWxlKHZhbHVlKSB7XG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZm9ybU9iai5mb3JtKCdzZXQgdmFsdWUnLCAnZmlsZW5hbWUnLCB2YWx1ZSk7XG4gICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLnVwZGF0ZUxvZ0Zyb21TZXJ2ZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRmV0Y2hlcyB0aGUgbG9nIGZpbGUgY29udGVudCBmcm9tIHRoZSBzZXJ2ZXIuXG4gICAgICovXG4gICAgdXBkYXRlTG9nRnJvbVNlcnZlcigpIHtcbiAgICAgICAgY29uc3QgcGFyYW1zID0gc3lzdGVtRGlhZ25vc3RpY0xvZ3MuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlcycpO1xuICAgICAgICBQYnhBcGkuU3lzbG9nR2V0TG9nRnJvbUZpbGUocGFyYW1zLCBzeXN0ZW1EaWFnbm9zdGljTG9ncy5jYlVwZGF0ZUxvZ1RleHQpO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBsb2cgdmlldy5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSAtIFRoZSBsb2cgZGF0YS5cbiAgICAgKi9cbiAgICBjYlVwZGF0ZUxvZ1RleHQoZGF0YSkge1xuICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy52aWV3ZXIuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKGRhdGEuY29udGVudCk7XG4gICAgICAgIGNvbnN0IHJvdyA9IHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5zZXNzaW9uLmdldExlbmd0aCgpIC0gMTtcbiAgICAgICAgY29uc3QgY29sdW1uID0gc3lzdGVtRGlhZ25vc3RpY0xvZ3Mudmlld2VyLnNlc3Npb24uZ2V0TGluZShyb3cpLmxlbmd0aDsgLy8gb3Igc2ltcGx5IEluZmluaXR5XG4gICAgICAgIHN5c3RlbURpYWdub3N0aWNMb2dzLnZpZXdlci5nb3RvTGluZShyb3cgKyAxLCBjb2x1bW4pO1xuICAgICAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy4kZGltbWVyLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgYWZ0ZXIgY2xpY2tpbmcgdGhlIFwiRG93bmxvYWQgRmlsZVwiIGJ1dHRvbi5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2UgZGF0YS5cbiAgICAgKi9cbiAgICBjYkRvd25sb2FkRmlsZShyZXNwb25zZSkge1xuICAgICAgICBpZiAocmVzcG9uc2UgIT09IGZhbHNlKSB7XG4gICAgICAgICAgICB3aW5kb3cubG9jYXRpb24gPSByZXNwb25zZS5maWxlbmFtZTtcbiAgICAgICAgfVxuICAgIH0sXG59O1xuXG4vLyBXaGVuIHRoZSBkb2N1bWVudCBpcyByZWFkeSwgaW5pdGlhbGl6ZSB0aGUgc2hvdyBzeXN0ZW0gbG9ncyB0YWJcbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBzeXN0ZW1EaWFnbm9zdGljTG9ncy5pbml0aWFsaXplKCk7XG59KTtcblxuIl19