"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalRootUrl,globalTranslate, ace, Form, PbxApi */

/**
 * Module customFile
 * This module manages file interactions in a UI, such as loading file content from a server and handling user input.
 * @module customFile
 */
var customFile = {
  /**
   * jQuery object for the form.
   * @type {jQuery}
   */
  $formObj: $('#custom-file-form'),

  /**
   * jQuery objects
   * This section defines references to DOM elements that the module interacts with.
   */
  $typeSelectDropDown: $('#custom-file-form .type-select'),
  $appCode: $('#application-code'),
  $appCodeFromServer: $('#application-code-readonly'),

  /**
   * Dirty check field, for checking if something on the form was changed
   * @type {jQuery}
   */
  $dirrtyField: $('#dirrty'),

  /**
   * Ace editor instances
   * `editor` is for input and `viewer` is for display, and they are initialized in `initializeAce`.
   */
  editor: '',
  viewer: '',

  /**
   * Validation rules for the form fields before submission.
   *
   * @type {object}
   */
  validateRules: {
    name: {
      identifier: 'filepath',
      rules: [{
        type: 'empty',
        prompt: globalTranslate.cf_ValidateNameIsEmpty
      }]
    }
  },

  /**
   * Initializes the customFile module.
   * Sets up the dropdown, initializes Ace editor, form, and retrieves file content from the server.
   */
  initialize: function initialize() {
    customFile.$typeSelectDropDown.dropdown({
      onChange: function onChange() {
        // Hide or show code depending on the file type
        customFile.hideShowCode(); // Get the content of the file from the server

        customFile.getFileContentFromServer();
      }
    }); // Initialize Ace editor

    customFile.initializeAce(); // Initialize form

    customFile.initializeForm(); // Get the content of the file from the server

    customFile.getFileContentFromServer();
  },

  /**
   * Handles the visibility and content of code based on the 'mode' form value.
   * Adjusts the Ace editor settings accordingly.
   */
  hideShowCode: function hideShowCode() {
    // Calculate ace editor height and rows count
    var aceHeight = window.innerHeight - 475;
    var rowsCount = Math.round(aceHeight / 16.3); // Set minimum height for the code sections on window load

    $(window).load(function () {
      $('.application-code-readonly').css('min-height', "".concat(aceHeight, "px"));
      $('.application-code').css('min-height', "".concat(aceHeight, "px"));
    }); // Retrieve 'mode' value from the form

    var mode = customFile.$formObj.form('get value', 'mode'); // Handle code visibility and content based on the 'mode'

    switch (mode) {
      case 'none':
        // If 'mode' is 'none', show server code and hide custom code
        customFile.viewer.navigateFileStart();
        customFile.$appCodeFromServer.show();
        customFile.$appCode.hide();
        customFile.viewer.setOptions({
          maxLines: rowsCount
        });
        customFile.viewer.resize();
        break;

      case 'append':
        // If 'mode' is 'append', show both server and custom code, append custom code to server code
        customFile.$appCodeFromServer.show();
        customFile.viewer.navigateFileEnd();
        customFile.editor.setValue(customFile.$formObj.form('get value', 'content'));
        customFile.$appCode.show();
        customFile.editor.getSession().on('change', function () {
          // Change the value of '$dirrtyField' to trigger
          // the 'change' form event and enable submit button.
          customFile.$dirrtyField.val(Math.random());
          customFile.$dirrtyField.trigger('change');
        });
        break;

      case 'override':
        // If 'mode' is 'override', show custom code and hide server code, replace server code with custom code
        customFile.editor.navigateFileStart();
        customFile.$appCodeFromServer.hide();
        var changedContent = customFile.$formObj.form('get value', 'content');

        if (changedContent.length > 0) {
          customFile.editor.getSession().setValue(changedContent);
        } else {
          customFile.editor.getSession().setValue(customFile.viewer.getValue());
        }

        customFile.$appCode.show();
        customFile.editor.setOptions({
          maxLines: rowsCount
        });
        customFile.editor.resize();
        customFile.editor.getSession().on('change', function () {
          // Change the value of '$dirrtyField' to trigger
          // the 'change' form event and enable submit button.
          customFile.$dirrtyField.val(Math.random());
          customFile.$dirrtyField.trigger('change');
        });
        break;

      default:
        // Handle any other 'mode' values
        break;
    }
  },

  /**
   * Callback function that handles the response from the server containing the file's content.
   * It will update the 'viewer' with the file's content and adjust the code display.
   */
  cbGetFileContentFromServer: function cbGetFileContentFromServer(response) {
    if (response !== undefined) {
      customFile.viewer.getSession().setValue(response.data.content);
      customFile.hideShowCode();
    }
  },

  /**
   * Fetches file content from the server based on the file path and mode of operation.
   */
  getFileContentFromServer: function getFileContentFromServer() {
    var filePath = customFile.$formObj.form('get value', 'filepath');
    var mode = customFile.$formObj.form('get value', 'mode') !== 'override';
    var data = {
      filename: filePath,
      needOriginal: mode,
      needLogfile: false
    };
    PbxApi.GetFileContent(data, customFile.cbGetFileContentFromServer);
  },

  /**
   * Initializes Ace editor instances for both 'editor' and 'viewer'.
   */
  initializeAce: function initializeAce() {
    var IniMode = ace.require('ace/mode/julia').Mode;

    customFile.viewer = ace.edit('application-code-readonly');
    customFile.viewer.session.setMode(new IniMode());
    customFile.viewer.setTheme('ace/theme/monokai');
    customFile.viewer.setOptions({
      showPrintMargin: false,
      readOnly: true
    });
    customFile.viewer.resize();
    customFile.editor = ace.edit('application-code');
    customFile.editor.setTheme('ace/theme/monokai');
    customFile.editor.session.setMode(new IniMode());
    customFile.editor.setOptions({
      showPrintMargin: false
    });
    customFile.editor.resize();
  },

  /**
   * Callback function to be called before the form is sent
   * @param {Object} settings - The current settings of the form
   * @returns {Object} - The updated settings of the form
   */
  cbBeforeSendForm: function cbBeforeSendForm(settings) {
    var result = settings;
    result.data = customFile.$formObj.form('get values');

    switch (customFile.$formObj.form('get value', 'mode')) {
      case 'append':
      case 'override':
        result.data.content = customFile.editor.getValue();
        break;

      default:
        result.data.content = '';
    }

    return result;
  },

  /**
   * Callback function to be called after the form has been sent.
   * @param {Object} response - The response from the server after the form is sent
   */
  cbAfterSendForm: function cbAfterSendForm(response) {},

  /**
   * Initialize the form with custom settings
   */
  initializeForm: function initializeForm() {
    Form.$formObj = customFile.$formObj;
    Form.url = "".concat(globalRootUrl, "custom-files/save"); // Form submission URL

    Form.validateRules = customFile.validateRules; // Form validation rules

    Form.cbBeforeSendForm = customFile.cbBeforeSendForm; // Callback before form is sent

    Form.cbAfterSendForm = customFile.cbAfterSendForm; // Callback after form is sent

    Form.initialize();
  }
}; // Initialize the custom files modify form when the document is ready.

$(document).ready(function () {
  customFile.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9DdXN0b21GaWxlcy9jdXN0b20tZmlsZXMtbW9kaWZ5LmpzIl0sIm5hbWVzIjpbImN1c3RvbUZpbGUiLCIkZm9ybU9iaiIsIiQiLCIkdHlwZVNlbGVjdERyb3BEb3duIiwiJGFwcENvZGUiLCIkYXBwQ29kZUZyb21TZXJ2ZXIiLCIkZGlycnR5RmllbGQiLCJlZGl0b3IiLCJ2aWV3ZXIiLCJ2YWxpZGF0ZVJ1bGVzIiwibmFtZSIsImlkZW50aWZpZXIiLCJydWxlcyIsInR5cGUiLCJwcm9tcHQiLCJnbG9iYWxUcmFuc2xhdGUiLCJjZl9WYWxpZGF0ZU5hbWVJc0VtcHR5IiwiaW5pdGlhbGl6ZSIsImRyb3Bkb3duIiwib25DaGFuZ2UiLCJoaWRlU2hvd0NvZGUiLCJnZXRGaWxlQ29udGVudEZyb21TZXJ2ZXIiLCJpbml0aWFsaXplQWNlIiwiaW5pdGlhbGl6ZUZvcm0iLCJhY2VIZWlnaHQiLCJ3aW5kb3ciLCJpbm5lckhlaWdodCIsInJvd3NDb3VudCIsIk1hdGgiLCJyb3VuZCIsImxvYWQiLCJjc3MiLCJtb2RlIiwiZm9ybSIsIm5hdmlnYXRlRmlsZVN0YXJ0Iiwic2hvdyIsImhpZGUiLCJzZXRPcHRpb25zIiwibWF4TGluZXMiLCJyZXNpemUiLCJuYXZpZ2F0ZUZpbGVFbmQiLCJzZXRWYWx1ZSIsImdldFNlc3Npb24iLCJvbiIsInZhbCIsInJhbmRvbSIsInRyaWdnZXIiLCJjaGFuZ2VkQ29udGVudCIsImxlbmd0aCIsImdldFZhbHVlIiwiY2JHZXRGaWxlQ29udGVudEZyb21TZXJ2ZXIiLCJyZXNwb25zZSIsInVuZGVmaW5lZCIsImRhdGEiLCJjb250ZW50IiwiZmlsZVBhdGgiLCJmaWxlbmFtZSIsIm5lZWRPcmlnaW5hbCIsIm5lZWRMb2dmaWxlIiwiUGJ4QXBpIiwiR2V0RmlsZUNvbnRlbnQiLCJJbmlNb2RlIiwiYWNlIiwicmVxdWlyZSIsIk1vZGUiLCJlZGl0Iiwic2Vzc2lvbiIsInNldE1vZGUiLCJzZXRUaGVtZSIsInNob3dQcmludE1hcmdpbiIsInJlYWRPbmx5IiwiY2JCZWZvcmVTZW5kRm9ybSIsInNldHRpbmdzIiwicmVzdWx0IiwiY2JBZnRlclNlbmRGb3JtIiwiRm9ybSIsInVybCIsImdsb2JhbFJvb3RVcmwiLCJkb2N1bWVudCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLFVBQVUsR0FBRztBQUVmO0FBQ0o7QUFDQTtBQUNBO0FBQ0lDLEVBQUFBLFFBQVEsRUFBRUMsQ0FBQyxDQUFDLG1CQUFELENBTkk7O0FBUWY7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsbUJBQW1CLEVBQUVELENBQUMsQ0FBQyxnQ0FBRCxDQVpQO0FBYWZFLEVBQUFBLFFBQVEsRUFBRUYsQ0FBQyxDQUFDLG1CQUFELENBYkk7QUFjZkcsRUFBQUEsa0JBQWtCLEVBQUVILENBQUMsQ0FBQyw0QkFBRCxDQWROOztBQWdCZjtBQUNKO0FBQ0E7QUFDQTtBQUNJSSxFQUFBQSxZQUFZLEVBQUVKLENBQUMsQ0FBQyxTQUFELENBcEJBOztBQXNCZjtBQUNKO0FBQ0E7QUFDQTtBQUNJSyxFQUFBQSxNQUFNLEVBQUUsRUExQk87QUEyQmZDLEVBQUFBLE1BQU0sRUFBRSxFQTNCTzs7QUE2QmY7QUFDSjtBQUNBO0FBQ0E7QUFDQTtBQUNJQyxFQUFBQSxhQUFhLEVBQUU7QUFDWEMsSUFBQUEsSUFBSSxFQUFFO0FBQ0ZDLE1BQUFBLFVBQVUsRUFBRSxVQURWO0FBRUZDLE1BQUFBLEtBQUssRUFBRSxDQUNIO0FBQ0lDLFFBQUFBLElBQUksRUFBRSxPQURWO0FBRUlDLFFBQUFBLE1BQU0sRUFBRUMsZUFBZSxDQUFDQztBQUY1QixPQURHO0FBRkw7QUFESyxHQWxDQTs7QUE4Q2Y7QUFDSjtBQUNBO0FBQ0E7QUFDSUMsRUFBQUEsVUFsRGUsd0JB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TkU7QUFDYm9ELElBQUFBLElBQUksQ0FBQzFFLFFBQUwsR0FBZ0JELFVBQVUsQ0FBQ0MsUUFBM0I7QUFDQTBFLElBQUFBLElBQUksQ0FBQ0MsR0FBTCxhQUFjQyxhQUFkLHVCQUZhLENBRW1DOztBQUNoREYsSUFBQUEsSUFBSSxDQUFDbEUsYUFBTCxHQUFxQlQsVUFBVSxDQUFDUyxhQUFoQyxDQUhhLENBR2tDOztBQUMvQ2tFLElBQUFBLElBQUksQ0FBQ0osZ0JBQUwsR0FBd0J2RSxVQUFVLENBQUN1RSxnQkFBbkMsQ0FKYSxDQUl3Qzs7QUFDckRJLElBQUFBLElBQUksQ0FBQ0QsZUFBTCxHQUF1QjFFLFVBQVUsQ0FBQzBFLGVBQWxDLENBTGEsQ0FLc0M7O0FBQ25EQyxJQUFBQSxJQUFJLENBQUMxRCxVQUFMO0FBQ0g7QUFoT2MsQ0FBbkIsQyxDQW1PQTs7QUFDQWYsQ0FBQyxDQUFDNEUsUUFBRCxDQUFELENBQVlDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQi9FLEVBQUFBLFVBQVUsQ0FBQ2lCLFVBQVg7QUFDSCxDQUZEIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIE1pa29QQlggLSBmcmVlIHBob25lIHN5c3RlbSBmb3Igc21hbGwgYnVzaW5lc3NcbiAqIENvcHlyaWdodCDCqSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIGdsb2JhbFJvb3RVcmwsZ2xvYmFsVHJhbnNsYXRlLCBhY2UsIEZvcm0sIFBieEFwaSAqL1xuXG5cbi8qKlxuICogTW9kdWxlIGN1c3RvbUZpbGVcbiAqIFRoaXMgbW9kdWxlIG1hbmFnZXMgZmlsZSBpbnRlcmFjdGlvbnMgaW4gYSBVSSwgc3VjaCBhcyBsb2FkaW5nIGZpbGUgY29udGVudCBmcm9tIGEgc2VydmVyIGFuZCBoYW5kbGluZyB1c2VyIGlucHV0LlxuICogQG1vZHVsZSBjdXN0b21GaWxlXG4gKi9cbmNvbnN0IGN1c3RvbUZpbGUgPSB7XG5cbiAgICAvKipcbiAgICAgKiBqUXVlcnkgb2JqZWN0IGZvciB0aGUgZm9ybS5cbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRmb3JtT2JqOiAkKCcjY3VzdG9tLWZpbGUtZm9ybScpLFxuXG4gICAgLyoqXG4gICAgICogalF1ZXJ5IG9iamVjdHNcbiAgICAgKiBUaGlzIHNlY3Rpb24gZGVmaW5lcyByZWZlcmVuY2VzIHRvIERPTSBlbGVtZW50cyB0aGF0IHRoZSBtb2R1bGUgaW50ZXJhY3RzIHdpdGguXG4gICAgICovXG4gICAgJHR5cGVTZWxlY3REcm9wRG93bjogJCgnI2N1c3RvbS1maWxlLWZvcm0gLnR5cGUtc2VsZWN0JyksXG4gICAgJGFwcENvZGU6ICQoJyNhcHBsaWNhdGlvbi1jb2RlJyksXG4gICAgJGFwcENvZGVGcm9tU2VydmVyOiAkKCcjYXBwbGljYXRpb24tY29kZS1yZWFkb25seScpLFxuXG4gICAgLyoqXG4gICAgICogRGlydHkgY2hlY2sgZmllbGQsIGZvciBjaGVja2luZyBpZiBzb21ldGhpbmcgb24gdGhlIGZvcm0gd2FzIGNoYW5nZWRcbiAgICAgKiBAdHlwZSB7alF1ZXJ5fVxuICAgICAqL1xuICAgICRkaXJydHlGaWVsZDogJCgnI2RpcnJ0eScpLFxuXG4gICAgLyoqXG4gICAgICogQWNlIGVkaXRvciBpbnN0YW5jZXNcbiAgICAgKiBgZWRpdG9yYCBpcyBmb3IgaW5wdXQgYW5kIGB2aWV3ZXJgIGlzIGZvciBkaXNwbGF5LCBhbmQgdGhleSBhcmUgaW5pdGlhbGl6ZWQgaW4gYGluaXRpYWxpemVBY2VgLlxuICAgICAqL1xuICAgIGVkaXRvcjogJycsXG4gICAgdmlld2VyOiAnJyxcblxuICAgIC8qKlxuICAgICAqIFZhbGlkYXRpb24gcnVsZXMgZm9yIHRoZSBmb3JtIGZpZWxkcyBiZWZvcmUgc3VibWlzc2lvbi5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtvYmplY3R9XG4gICAgICovXG4gICAgdmFsaWRhdGVSdWxlczoge1xuICAgICAgICBuYW1lOiB7XG4gICAgICAgICAgICBpZGVudGlmaWVyOiAnZmlsZXBhdGgnLFxuICAgICAgICAgICAgcnVsZXM6IFtcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdlbXB0eScsXG4gICAgICAgICAgICAgICAgICAgIHByb21wdDogZ2xvYmFsVHJhbnNsYXRlLmNmX1ZhbGlkYXRlTmFtZUlzRW1wdHksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgIH0sXG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIHRoZSBjdXN0b21GaWxlIG1vZHVsZS5cbiAgICAgKiBTZXRzIHVwIHRoZSBkcm9wZG93biwgaW5pdGlhbGl6ZXMgQWNlIGVkaXRvciwgZm9ybSwgYW5kIHJldHJpZXZlcyBmaWxlIGNvbnRlbnQgZnJvbSB0aGUgc2VydmVyLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIGN1c3RvbUZpbGUuJHR5cGVTZWxlY3REcm9wRG93bi5kcm9wZG93bih7XG4gICAgICAgICAgICBvbkNoYW5nZSgpIHtcbiAgICAgICAgICAgICAgICAvLyBIaWRlIG9yIHNob3cgY29kZSBkZXBlbmRpbmcgb24gdGhlIGZpbGUgdHlwZVxuICAgICAgICAgICAgICAgIGN1c3RvbUZpbGUuaGlkZVNob3dDb2RlKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIGNvbnRlbnQgb2YgdGhlIGZpbGUgZnJvbSB0aGUgc2VydmVyXG4gICAgICAgICAgICAgICAgY3VzdG9tRmlsZS5nZXRGaWxlQ29udGVudEZyb21TZXJ2ZXIoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgQWNlIGVkaXRvclxuICAgICAgICBjdXN0b21GaWxlLmluaXRpYWxpemVBY2UoKTtcblxuICAgICAgICAvLyBJbml0aWFsaXplIGZvcm1cbiAgICAgICAgY3VzdG9tRmlsZS5pbml0aWFsaXplRm9ybSgpO1xuXG4gICAgICAgIC8vIEdldCB0aGUgY29udGVudCBvZiB0aGUgZmlsZSBmcm9tIHRoZSBzZXJ2ZXJcbiAgICAgICAgY3VzdG9tRmlsZS5nZXRGaWxlQ29udGVudEZyb21TZXJ2ZXIoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlcyB0aGUgdmlzaWJpbGl0eSBhbmQgY29udGVudCBvZiBjb2RlIGJhc2VkIG9uIHRoZSAnbW9kZScgZm9ybSB2YWx1ZS5cbiAgICAgKiBBZGp1c3RzIHRoZSBBY2UgZWRpdG9yIHNldHRpbmdzIGFjY29yZGluZ2x5LlxuICAgICAqL1xuICAgIGhpZGVTaG93Q29kZSgpIHtcbiAgICAgICAgLy8gQ2FsY3VsYXRlIGFjZSBlZGl0b3IgaGVpZ2h0IGFuZCByb3dzIGNvdW50XG4gICAgICAgIGNvbnN0IGFjZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodCAtIDQ3NTtcbiAgICAgICAgY29uc3Qgcm93c0NvdW50ID0gTWF0aC5yb3VuZChhY2VIZWlnaHQgLyAxNi4zKTtcblxuICAgICAgICAvLyBTZXQgbWluaW11bSBoZWlnaHQgZm9yIHRoZSBjb2RlIHNlY3Rpb25zIG9uIHdpbmRvdyBsb2FkXG4gICAgICAgICQod2luZG93KS5sb2FkKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICQoJy5hcHBsaWNhdGlvbi1jb2RlLXJlYWRvbmx5JykuY3NzKCdtaW4taGVpZ2h0JywgYCR7YWNlSGVpZ2h0fXB4YCk7XG4gICAgICAgICAgICAkKCcuYXBwbGljYXRpb24tY29kZScpLmNzcygnbWluLWhlaWdodCcsIGAke2FjZUhlaWdodH1weGApO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBSZXRyaWV2ZSAnbW9kZScgdmFsdWUgZnJvbSB0aGUgZm9ybVxuICAgICAgICBjb25zdCBtb2RlID0gY3VzdG9tRmlsZS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCAnbW9kZScpO1xuXG4gICAgICAgIC8vIEhhbmRsZSBjb2RlIHZpc2liaWxpdHkgYW5kIGNvbnRlbnQgYmFzZWQgb24gdGhlICdtb2RlJ1xuICAgICAgICBzd2l0Y2ggKG1vZGUpIHtcbiAgICAgICAgICAgIGNhc2UgJ25vbmUnOlxuICAgICAgICAgICAgICAgIC8vIElmICdtb2RlJyBpcyAnbm9uZScsIHNob3cgc2VydmVyIGNvZGUgYW5kIGhpZGUgY3VzdG9tIGNvZGVcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLnZpZXdlci5uYXZpZ2F0ZUZpbGVTdGFydCgpO1xuICAgICAgICAgICAgICAgIGN1c3RvbUZpbGUuJGFwcENvZGVGcm9tU2VydmVyLnNob3coKTtcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLiRhcHBDb2RlLmhpZGUoKTtcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLnZpZXdlci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgICAgICAgICAgbWF4TGluZXM6IHJvd3NDb3VudCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLnZpZXdlci5yZXNpemUoKVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnYXBwZW5kJzpcbiAgICAgICAgICAgICAgICAvLyBJZiAnbW9kZScgaXMgJ2FwcGVuZCcsIHNob3cgYm90aCBzZXJ2ZXIgYW5kIGN1c3RvbSBjb2RlLCBhcHBlbmQgY3VzdG9tIGNvZGUgdG8gc2VydmVyIGNvZGVcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLiRhcHBDb2RlRnJvbVNlcnZlci5zaG93KCk7XG4gICAgICAgICAgICAgICAgY3VzdG9tRmlsZS52aWV3ZXIubmF2aWdhdGVGaWxlRW5kKCk7XG4gICAgICAgICAgICAgICAgY3VzdG9tRmlsZS5lZGl0b3Iuc2V0VmFsdWUoY3VzdG9tRmlsZS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCAnY29udGVudCcpKTtcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLiRhcHBDb2RlLnNob3coKTtcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLmVkaXRvci5nZXRTZXNzaW9uKCkub24oJ2NoYW5nZScsICgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBDaGFuZ2UgdGhlIHZhbHVlIG9mICckZGlycnR5RmllbGQnIHRvIHRyaWdnZXJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhlICdjaGFuZ2UnIGZvcm0gZXZlbnQgYW5kIGVuYWJsZSBzdWJtaXQgYnV0dG9uLlxuICAgICAgICAgICAgICAgICAgICBjdXN0b21GaWxlLiRkaXJydHlGaWVsZC52YWwoTWF0aC5yYW5kb20oKSk7XG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUZpbGUuJGRpcnJ0eUZpZWxkLnRyaWdnZXIoJ2NoYW5nZScpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnb3ZlcnJpZGUnOlxuICAgICAgICAgICAgICAgIC8vIElmICdtb2RlJyBpcyAnb3ZlcnJpZGUnLCBzaG93IGN1c3RvbSBjb2RlIGFuZCBoaWRlIHNlcnZlciBjb2RlLCByZXBsYWNlIHNlcnZlciBjb2RlIHdpdGggY3VzdG9tIGNvZGVcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLmVkaXRvci5uYXZpZ2F0ZUZpbGVTdGFydCgpO1xuICAgICAgICAgICAgICAgIGN1c3RvbUZpbGUuJGFwcENvZGVGcm9tU2VydmVyLmhpZGUoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBjaGFuZ2VkQ29udGVudCA9IGN1c3RvbUZpbGUuJGZvcm1PYmouZm9ybSgnZ2V0IHZhbHVlJywgJ2NvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICBpZiAoY2hhbmdlZENvbnRlbnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBjdXN0b21GaWxlLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUoY2hhbmdlZENvbnRlbnQpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUZpbGUuZWRpdG9yLmdldFNlc3Npb24oKS5zZXRWYWx1ZShjdXN0b21GaWxlLnZpZXdlci5nZXRWYWx1ZSgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY3VzdG9tRmlsZS4kYXBwQ29kZS5zaG93KCk7XG4gICAgICAgICAgICAgICAgY3VzdG9tRmlsZS5lZGl0b3Iuc2V0T3B0aW9ucyh7XG4gICAgICAgICAgICAgICAgICAgIG1heExpbmVzOiByb3dzQ291bnQsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgY3VzdG9tRmlsZS5lZGl0b3IucmVzaXplKClcbiAgICAgICAgICAgICAgICBjdXN0b21GaWxlLmVkaXRvci5nZXRTZXNzaW9uKCkub24oJ2NoYW5nZScsICgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAvLyBDaGFuZ2UgdGhlIHZhbHVlIG9mICckZGlycnR5RmllbGQnIHRvIHRyaWdnZXJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhlICdjaGFuZ2UnIGZvcm0gZXZlbnQgYW5kIGVuYWJsZSBzdWJtaXQgYnV0dG9uLlxuICAgICAgICAgICAgICAgICAgICBjdXN0b21GaWxlLiRkaXJydHlGaWVsZC52YWwoTWF0aC5yYW5kb20oKSk7XG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbUZpbGUuJGRpcnJ0eUZpZWxkLnRyaWdnZXIoJ2NoYW5nZScpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgYW55IG90aGVyICdtb2RlJyB2YWx1ZXNcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIHJlc3BvbnNlIGZyb20gdGhlIHNlcnZlciBjb250YWluaW5nIHRoZSBmaWxlJ3MgY29udGVudC5cbiAgICAgKiBJdCB3aWxsIHVwZGF0ZSB0aGUgJ3ZpZXdlcicgd2l0aCB0aGUgZmlsZSdzIGNvbnRlbnQgYW5kIGFkanVzdCB0aGUgY29kZSBkaXNwbGF5LlxuICAgICAqL1xuICAgIGNiR2V0RmlsZUNvbnRlbnRGcm9tU2VydmVyKHJlc3BvbnNlKSB7XG4gICAgICAgIGlmIChyZXNwb25zZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBjdXN0b21GaWxlLnZpZXdlci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUocmVzcG9uc2UuZGF0YS5jb250ZW50KTtcbiAgICAgICAgICAgIGN1c3RvbUZpbGUuaGlkZVNob3dDb2RlKCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogRmV0Y2hlcyBmaWxlIGNvbnRlbnQgZnJvbSB0aGUgc2VydmVyIGJhc2VkIG9uIHRoZSBmaWxlIHBhdGggYW5kIG1vZGUgb2Ygb3BlcmF0aW9uLlxuICAgICAqL1xuICAgIGdldEZpbGVDb250ZW50RnJvbVNlcnZlcigpIHtcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBjdXN0b21GaWxlLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICdmaWxlcGF0aCcpO1xuICAgICAgICBjb25zdCBtb2RlID0gY3VzdG9tRmlsZS4kZm9ybU9iai5mb3JtKCdnZXQgdmFsdWUnLCAnbW9kZScpICE9PSAnb3ZlcnJpZGUnO1xuICAgICAgICBjb25zdCBkYXRhID0ge2ZpbGVuYW1lOiBmaWxlUGF0aCwgbmVlZE9yaWdpbmFsOiBtb2RlLCBuZWVkTG9nZmlsZTogZmFsc2V9O1xuICAgICAgICBQYnhBcGkuR2V0RmlsZUNvbnRlbnQoZGF0YSwgY3VzdG9tRmlsZS5jYkdldEZpbGVDb250ZW50RnJvbVNlcnZlcik7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIEluaXRpYWxpemVzIEFjZSBlZGl0b3IgaW5zdGFuY2VzIGZvciBib3RoICdlZGl0b3InIGFuZCAndmlld2VyJy5cbiAgICAgKi9cbiAgICBpbml0aWFsaXplQWNlKCkge1xuICAgICAgICBjb25zdCBJbmlNb2RlID0gYWNlLnJlcXVpcmUoJ2FjZS9tb2RlL2p1bGlhJykuTW9kZTtcbiAgICAgICAgY3VzdG9tRmlsZS52aWV3ZXIgPSBhY2UuZWRpdCgnYXBwbGljYXRpb24tY29kZS1yZWFkb25seScpO1xuICAgICAgICBjdXN0b21GaWxlLnZpZXdlci5zZXNzaW9uLnNldE1vZGUobmV3IEluaU1vZGUoKSk7XG4gICAgICAgIGN1c3RvbUZpbGUudmlld2VyLnNldFRoZW1lKCdhY2UvdGhlbWUvbW9ub2thaScpO1xuICAgICAgICBjdXN0b21GaWxlLnZpZXdlci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgIHNob3dQcmludE1hcmdpbjogZmFsc2UsXG4gICAgICAgICAgICByZWFkT25seTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgY3VzdG9tRmlsZS52aWV3ZXIucmVzaXplKCk7XG5cbiAgICAgICAgY3VzdG9tRmlsZS5lZGl0b3IgPSBhY2UuZWRpdCgnYXBwbGljYXRpb24tY29kZScpO1xuICAgICAgICBjdXN0b21GaWxlLmVkaXRvci5zZXRUaGVtZSgnYWNlL3RoZW1lL21vbm9rYWknKTtcbiAgICAgICAgY3VzdG9tRmlsZS5lZGl0b3Iuc2Vzc2lvbi5zZXRNb2RlKG5ldyBJbmlNb2RlKCkpO1xuICAgICAgICBjdXN0b21GaWxlLmVkaXRvci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgIHNob3dQcmludE1hcmdpbjogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgICAgICBjdXN0b21GaWxlLmVkaXRvci5yZXNpemUoKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogQ2FsbGJhY2sgZnVuY3Rpb24gdG8gYmUgY2FsbGVkIGJlZm9yZSB0aGUgZm9ybSBpcyBzZW50XG4gICAgICogQHBhcmFtIHtPYmplY3R9IHNldHRpbmdzIC0gVGhlIGN1cnJlbnQgc2V0dGluZ3Mgb2YgdGhlIGZvcm1cbiAgICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIFRoZSB1cGRhdGVkIHNldHRpbmdzIG9mIHRoZSBmb3JtXG4gICAgICovXG4gICAgY2JCZWZvcmVTZW5kRm9ybShzZXR0aW5ncykge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBzZXR0aW5ncztcbiAgICAgICAgcmVzdWx0LmRhdGEgPSBjdXN0b21GaWxlLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZXMnKTtcbiAgICAgICAgc3dpdGNoIChjdXN0b21GaWxlLiRmb3JtT2JqLmZvcm0oJ2dldCB2YWx1ZScsICdtb2RlJykpIHtcbiAgICAgICAgICAgIGNhc2UgJ2FwcGVuZCc6XG4gICAgICAgICAgICBjYXNlICdvdmVycmlkZSc6XG4gICAgICAgICAgICAgICAgcmVzdWx0LmRhdGEuY29udGVudCA9IGN1c3RvbUZpbGUuZWRpdG9yLmdldFZhbHVlKCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJlc3VsdC5kYXRhLmNvbnRlbnQgPSAnJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBmdW5jdGlvbiB0byBiZSBjYWxsZWQgYWZ0ZXIgdGhlIGZvcm0gaGFzIGJlZW4gc2VudC5cbiAgICAgKiBAcGFyYW0ge09iamVjdH0gcmVzcG9uc2UgLSBUaGUgcmVzcG9uc2UgZnJvbSB0aGUgc2VydmVyIGFmdGVyIHRoZSBmb3JtIGlzIHNlbnRcbiAgICAgKi9cbiAgICBjYkFmdGVyU2VuZEZvcm0ocmVzcG9uc2UpIHtcblxuICAgIH0sXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSB0aGUgZm9ybSB3aXRoIGN1c3RvbSBzZXR0aW5nc1xuICAgICAqL1xuICAgIGluaXRpYWxpemVGb3JtKCkge1xuICAgICAgICBGb3JtLiRmb3JtT2JqID0gY3VzdG9tRmlsZS4kZm9ybU9iajtcbiAgICAgICAgRm9ybS51cmwgPSBgJHtnbG9iYWxSb290VXJsfWN1c3RvbS1maWxlcy9zYXZlYDsgLy8gRm9ybSBzdWJtaXNzaW9uIFVSTFxuICAgICAgICBGb3JtLnZhbGlkYXRlUnVsZXMgPSBjdXN0b21GaWxlLnZhbGlkYXRlUnVsZXM7IC8vIEZvcm0gdmFsaWRhdGlvbiBydWxlc1xuICAgICAgICBGb3JtLmNiQmVmb3JlU2VuZEZvcm0gPSBjdXN0b21GaWxlLmNiQmVmb3JlU2VuZEZvcm07IC8vIENhbGxiYWNrIGJlZm9yZSBmb3JtIGlzIHNlbnRcbiAgICAgICAgRm9ybS5jYkFmdGVyU2VuZEZvcm0gPSBjdXN0b21GaWxlLmNiQWZ0ZXJTZW5kRm9ybTsgLy8gQ2FsbGJhY2sgYWZ0ZXIgZm9ybSBpcyBzZW50XG4gICAgICAgIEZvcm0uaW5pdGlhbGl6ZSgpO1xuICAgIH0sXG59O1xuXG4vLyBJbml0aWFsaXplIHRoZSBjdXN0b20gZmlsZXMgbW9kaWZ5IGZvcm0gd2hlbiB0aGUgZG9jdW1lbnQgaXMgcmVhZHkuXG4kKGRvY3VtZW50KS5yZWFkeSgoKSA9PiB7XG4gICAgY3VzdG9tRmlsZS5pbml0aWFsaXplKCk7XG59KTtcblxuIl19