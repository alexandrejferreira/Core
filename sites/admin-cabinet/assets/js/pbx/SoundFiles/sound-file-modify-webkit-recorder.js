"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright (C) 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global MediaStreamRecorder, StereoAudioRecorder, PbxApi, sndPlayer */
var webkitRecorder = {
  $recordLabel: $('#record-label'),
  $recordButton: $('#start-record-button'),
  $stopButton: $('#stop-record-button'),
  $selectAudioInput: $('#select-audio-button'),
  $audioPlayer: $('#audio-player'),
  audioInputMenu: document.getElementById('audio-input-select'),
  chunks: [],
  mediaRecorder: '',
  initialize: function initialize() {
    webkitRecorder.$stopButton.addClass('disabled');
    webkitRecorder.$recordButton.on('click', function (e) {
      e.preventDefault();
      webkitRecorder.chunks = [];
      var constraints = {
        audio: true
      };

      if (webkitRecorder.audioInputMenu.getElementsByClassName('selected').length > 0) {
        var audioSource = webkitRecorder.audioInputMenu.getElementsByClassName('selected')[0].id;
        constraints = {
          audio: {
            deviceId: audioSource ? {
              exact: audioSource
            } : undefined
          }
        };
      }

      console.log(constraints);
      webkitRecorder.captureUserMedia(constraints, webkitRecorder.cbOnSuccess, webkitRecorder.gotDevices, webkitRecorder.onError);
    });
    webkitRecorder.$stopButton.on('click', function (e) {
      e.preventDefault();
      webkitRecorder.mediaRecorder.stop();
    });
    webkitRecorder.$selectAudioInput.dropdown();

    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
      $('#only-https-field').addClass('disabled');
    }

    if (window.navigator.userAgent.indexOf('MSIE ') > 0) {
      $('#only-https-field').addClass('disabled');
    }
  },
  captureUserMedia: function captureUserMedia(mediaConstraints, successCallback, gotDevicesCallBack, errorCallback) {
    navigator.mediaDevices.getUserMedia(mediaConstraints).then(successCallback).then(gotDevicesCallBack)["catch"](errorCallback);
  },
  gotDevices: function gotDevices(deviceInfos) {
    if (webkitRecorder.audioInputMenu.getElementsByTagName('div').length > 0) return;

    for (var i = 0; i !== deviceInfos.length; i += 1) {
      var deviceInfo = deviceInfos[i];
      var option = document.createElement('div');
      option.className = 'item';
      option.id = deviceInfo.deviceId;

      if (deviceInfo.kind === 'audioinput') {
        option.innerHTML = deviceInfo.label || "microphone ".concat(webkitRecorder.audioInputMenu.length + 1);
        webkitRecorder.audioInputMenu.appendChild(option);
      }
    }

    if (webkitRecorder.audioInputMenu.getElementsByTagName('div').length > 0) {
      webkitRecorder.$selectAudioInput.removeClass('disabled');
    }
  },
  cbOnSuccess: function cbOnSuccess(stream) {
    try {
      webkitRecorder.mediaRecorder = new MediaStreamRecorder(stream);
      webkitRecorder.mediaRecorder.stream = stream;
      webkitRecorder.mediaRecorder.recorderType = StereoAudioRecorder;
      webkitRecorder.mediaRecorder.mimeType = 'audio/wav';
      webkitRecorder.mediaRecorder.audioChannels = 1; // webkitRecorder.mediaRecorder = new MediaRecorder(stream);

      webkitRecorder.mediaRecorder.onstop = webkitRecorder.cbOnStopMediaRecorder;
      webkitRecorder.mediaRecorder.ondataavailable = webkitRecorder.cbOnDataAvailable;
      webkitRecorder.mediaRecorder.start(300000);
      console.log('recorder started');
      webkitRecorder.$recordLabel.addClass('red');
      webkitRecorder.$stopButton.removeClass('disabled');
      webkitRecorder.$recordButton.addClass('disabled');
      return navigator.mediaDevices.enumerateDevices();
    } catch (e) {
      console.error('MediaStreamRecorder is not supported by this browser.\n\n' + 'Try Firefox 29 or later, or Chrome 47 or later, with Enable experimental Web Platform features enabled from chrome://flags.');
      console.error('Exception while creating MediaRecorder:', e);
      webkitRecorder.$recordButton.addClass('disabled');
    }

    return false;
  },
  cbOnError: function cbOnError(err) {
    console.log("The following error occured: ".concat(err));
  },
  cbOnStopMediaRecorder: function cbOnStopMediaRecorder() {
    console.log('data available after MediaStreamRecorder.stop() called.');
    soundFileModify.blob = new Blob(webkitRecorder.chunks);
    console.log('recorder stopped');
    var fileURL = URL.createObjectURL(soundFileModify.blob);
    sndPlayer.UpdateSource(fileURL);
    var blobFile = new File([webkitRecorder.chunks[0]], 'blob' + new Date().getTime() + '.wav');
    PbxApi.FilesUploadFile(blobFile, soundFileModify.cbUploadResumable);
    webkitRecorder.$recordLabel.removeClass('red');
    webkitRecorder.$stopButton.addClass('disabled');
    webkitRecorder.$recordButton.removeClass('disabled');
    soundFileModify.$soundFileInput.val('');
  },
  cbOnDataAvailable: function cbOnDataAvailable(e) {
    webkitRecorder.chunks.push(e);
  }
};
$(document).ready(function () {
  webkitRecorder.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Tb3VuZEZpbGVzL3NvdW5kLWZpbGUtbW9kaWZ5LXdlYmtpdC1yZWNvcmRlci5qcyJdLCJuYW1lcyI6WyJ3ZWJraXRSZWNvcmRlciIsIiRyZWNvcmRMYWJlbCIsIiQiLCIkcmVjb3JkQnV0dG9uIiwiJHN0b3BCdXR0b24iLCIkc2VsZWN0QXVkaW9JbnB1dCIsIiRhdWRpb1BsYXllciIsImF1ZGlvSW5wdXRNZW51IiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsImNodW5rcyIsIm1lZGlhUmVjb3JkZXIiLCJpbml0aWFsaXplIiwiYWRkQ2xhc3MiLCJvbiIsImUiLCJwcmV2ZW50RGVmYXVsdCIsImNvbnN0cmFpbnRzIiwiYXVkaW8iLCJnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIiwibGVuZ3RoIiwiYXVkaW9Tb3VyY2UiLCJpZCIsImRldmljZUlkIiwiZXhhY3QiLCJ1bmRlZmluZWQiLCJjb25zb2xlIiwibG9nIiwiY2FwdHVyZVVzZXJNZWRpYSIsImNiT25TdWNjZXNzIiwiZ290RGV2aWNlcyIsIm9uRXJyb3IiLCJzdG9wIiwiZHJvcGRvd24iLCJ3aW5kb3ciLCJsb2NhdGlvbiIsInByb3RvY29sIiwiaG9zdG5hbWUiLCJuYXZpZ2F0b3IiLCJ1c2VyQWdlbnQiLCJpbmRleE9mIiwibWVkaWFDb25zdHJhaW50cyIsInN1Y2Nlc3NDYWxsYmFjayIsImdvdERldmljZXNDYWxsQmFjayIsImVycm9yQ2FsbGJhY2siLCJtZWRpYURldmljZXMiLCJnZXRVc2VyTWVkaWEiLCJ0aGVuIiwiZGV2aWNlSW5mb3MiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsImkiLCJkZXZpY2VJbmZvIiwib3B0aW9uIiwiY3JlYXRlRWxlbWVudCIsImNsYXNzTmFtZSIsImtpbmQiLCJpbm5lckhUTUwiLCJsYWJlbCIsImFwcGVuZENoaWxkIiwicmVtb3ZlQ2xhc3MiLCJzdHJlYW0iLCJNZWRpYVN0cmVhbVJlY29yZGVyIiwicmVjb3JkZXJUeXBlIiwiU3RlcmVvQXVkaW9SZWNvcmRlciIsIm1pbWVUeXBlIiwiYXVkaW9DaGFubmVscyIsIm9uc3RvcCIsImNiT25TdG9wTWVkaWFSZWNvcmRlciIsIm9uZGF0YWF2YWlsYWJsZSIsImNiT25EYXRhQXZhaWxhYmxlIiwic3RhcnQiLCJlbnVtZXJhdGVEZXZpY2VzIiwiZXJyb3IiLCJjYk9uRXJyb3IiLCJlcnIiLCJzb3VuZEZpbGVNb2RpZnkiLCJibG9iIiwiQmxvYiIsImZpbGVVUkwiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJzbmRQbGF5ZXIiLCJVcGRhdGVTb3VyY2UiLCJibG9iRmlsZSIsIkZpbGUiLCJEYXRlIiwiZ2V0VGltZSIsIlBieEFwaSIsIkZpbGVzVXBsb2FkRmlsZSIsImNiVXBsb2FkUmVzdW1hYmxlIiwiJHNvdW5kRmlsZUlucHV0IiwidmFsIiwicHVzaCIsInJlYWR5Il0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSxJQUFNQSxjQUFjLEdBQUc7QUFDdEJDLEVBQUFBLFlBQVksRUFBRUMsQ0FBQyxDQUFDLGVBQUQsQ0FETztBQUV0QkMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsc0JBQUQsQ0FGTTtBQUd0QkUsRUFBQUEsV0FBVyxFQUFFRixDQUFDLENBQUMscUJBQUQsQ0FIUTtBQUl0QkcsRUFBQUEsaUJBQWlCLEVBQUVILENBQUMsQ0FBQyxzQkFBRCxDQUpFO0FBS3RCSSxFQUFBQSxZQUFZLEVBQUVKLENBQUMsQ0FBQyxlQUFELENBTE87QUFNdEJLLEVBQUFBLGNBQWMsRUFBRUMsUUFBUSxDQUFDQyxjQUFULENBQXdCLG9CQUF4QixDQU5NO0FBT3RCQyxFQUFBQSxNQUFNLEVBQUUsRUFQYztBQVF0QkMsRUFBQUEsYUFBYSxFQUFFLEVBUk87QUFTdEJDLEVBQUFBLFVBVHNCLHdCQVNUO0FBQ1paLElBQUFBLGNBQWMsQ0FBQ0ksV0FBZixDQUEy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QUFKLENBQW9CTCxlQUFlLENBQUNDLElBQXBDLENBQWhCO0FBQ0FLLElBQUFBLFNBQVMsQ0FBQ0MsWUFBVixDQUF1QkosT0FBdkI7QUFDQSxRQUFNSyxRQUFRLEdBQUcsSUFBSUMsSUFBSixDQUFTLENBQUNwRixjQUFjLENBQUNVLE1BQWYsQ0FBc0IsQ0FBdEIsQ0FBRCxDQUFULEVBQXFDLFNBQVEsSUFBSTJFLElBQUosR0FBV0MsT0FBWCxFQUFSLEdBQTZCLE1BQWxFLENBQWpCO0FBQ0FDLElBQUFBLE1BQU0sQ0FBQ0MsZUFBUCxDQUF1QkwsUUFBdkIsRUFBaUNSLGVBQWUsQ0FBQ2MsaUJBQWpEO0FBQ0F6RixJQUFBQSxjQUFjLENBQUNDLFlBQWYsQ0FBNEIwRCxXQUE1QixDQUF3QyxLQUF4QztBQUNBM0QsSUFBQUEsY0FBYyxDQUFDSSxXQUFmLENBQTJCUyxRQUEzQixDQUFvQyxVQUFwQztBQUNBYixJQUFBQSxjQUFjLENBQUNHLGFBQWYsQ0FBNkJ3RCxXQUE3QixDQUF5QyxVQUF6QztBQUNBZ0IsSUFBQUEsZUFBZSxDQUFDZSxlQUFoQixDQUFnQ0MsR0FBaEMsQ0FBb0MsRUFBcEM7QUFDQSxHQTlHcUI7QUErR3RCdEIsRUFBQUEsaUJBL0dzQiw2QkErR0p0RCxDQS9HSSxFQStHRDtBQUNwQmYsSUFBQUEsY0FBYyxDQUFDVSxNQUFmLENBQXNCa0YsSUFBdEIsQ0FBMkI3RSxDQUEzQjtBQUNBO0FBakhxQixDQUF2QjtBQXFIQWIsQ0FBQyxDQUFDTSxRQUFELENBQUQsQ0FBWXFGLEtBQVosQ0FBa0IsWUFBTTtBQUN2QjdGLEVBQUFBLGNBQWMsQ0FBQ1ksVUFBZjtBQUNBLENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IChDKSAyMDE3LTIwMjMgQWxleGV5IFBvcnRub3YgYW5kIE5pa29sYXkgQmVrZXRvdlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFzIHB1Ymxpc2hlZCBieVxuICogdGhlIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbjsgZWl0aGVyIHZlcnNpb24gMyBvZiB0aGUgTGljZW5zZSwgb3JcbiAqIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsXG4gKiBidXQgV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZlxuICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZVxuICogR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhbG9uZyB3aXRoIHRoaXMgcHJvZ3JhbS5cbiAqIElmIG5vdCwgc2VlIDxodHRwczovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uXG4gKi9cblxuLyogZ2xvYmFsIE1lZGlhU3RyZWFtUmVjb3JkZXIsIFN0ZXJlb0F1ZGlvUmVjb3JkZXIsIFBieEFwaSwgc25kUGxheWVyICovXG5jb25zdCB3ZWJraXRSZWNvcmRlciA9IHtcblx0JHJlY29yZExhYmVsOiAkKCcjcmVjb3JkLWxhYmVsJyksXG5cdCRyZWNvcmRCdXR0b246ICQoJyNzdGFydC1yZWNvcmQtYnV0dG9uJyksXG5cdCRzdG9wQnV0dG9uOiAkKCcjc3RvcC1yZWNvcmQtYnV0dG9uJyksXG5cdCRzZWxlY3RBdWRpb0lucHV0OiAkKCcjc2VsZWN0LWF1ZGlvLWJ1dHRvbicpLFxuXHQkYXVkaW9QbGF5ZXI6ICQoJyNhdWRpby1wbGF5ZXInKSxcblx0YXVkaW9JbnB1dE1lbnU6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhdWRpby1pbnB1dC1zZWxlY3QnKSxcblx0Y2h1bmtzOiBbXSxcblx0bWVkaWFSZWNvcmRlcjogJycsXG5cdGluaXRpYWxpemUoKSB7XG5cdFx0d2Via2l0UmVjb3JkZXIuJHN0b3BCdXR0b24uYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cblx0XHR3ZWJraXRSZWNvcmRlci4kcmVjb3JkQnV0dG9uLm9uKCdjbGljaycsIChlKSA9PiB7XG5cdFx0XHRlLnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5jaHVua3MgPSBbXTtcblx0XHRcdGxldCBjb25zdHJhaW50cyA9IHtcblx0XHRcdFx0YXVkaW86IHRydWUsXG5cdFx0XHR9O1xuXHRcdFx0aWYgKHdlYmtpdFJlY29yZGVyLmF1ZGlvSW5wdXRNZW51LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3NlbGVjdGVkJykubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRjb25zdCBhdWRpb1NvdXJjZSA9IHdlYmtpdFJlY29yZGVyLmF1ZGlvSW5wdXRNZW51LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3NlbGVjdGVkJylbMF0uaWQ7XG5cdFx0XHRcdGNvbnN0cmFpbnRzID0ge1xuXHRcdFx0XHRcdGF1ZGlvOiB7ZGV2aWNlSWQ6IGF1ZGlvU291cmNlID8ge2V4YWN0OiBhdWRpb1NvdXJjZX0gOiB1bmRlZmluZWR9LFxuXHRcdFx0XHR9O1xuXHRcdFx0fVxuXHRcdFx0Y29uc29sZS5sb2coY29uc3RyYWludHMpO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIuY2FwdHVyZVVzZXJNZWRpYShcblx0XHRcdFx0Y29uc3RyYWludHMsXG5cdFx0XHRcdHdlYmtpdFJlY29yZGVyLmNiT25TdWNjZXNzLFxuXHRcdFx0XHR3ZWJraXRSZWNvcmRlci5nb3REZXZpY2VzLFxuXHRcdFx0XHR3ZWJraXRSZWNvcmRlci5vbkVycm9yLFxuXHRcdFx0KTtcblx0XHR9KTtcblx0XHR3ZWJraXRSZWNvcmRlci4kc3RvcEJ1dHRvbi5vbignY2xpY2snLCAoZSkgPT4ge1xuXHRcdFx0ZS5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIubWVkaWFSZWNvcmRlci5zdG9wKCk7XG5cdFx0fSk7XG5cblx0XHR3ZWJraXRSZWNvcmRlci4kc2VsZWN0QXVkaW9JbnB1dC5kcm9wZG93bigpO1xuXG5cdFx0aWYgKHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCAhPT0gJ2h0dHBzOicgJiYgd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lICE9PSAnbG9jYWxob3N0Jykge1xuXHRcdFx0JCgnI29ubHktaHR0cHMtZmllbGQnKS5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblx0XHR9XG5cdFx0aWYgKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ01TSUUgJykgPiAwKSB7XG5cdFx0XHQkKCcjb25seS1odHRwcy1maWVsZCcpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdH1cblx0fSxcblx0Y2FwdHVyZVVzZXJNZWRpYShtZWRpYUNvbnN0cmFpbnRzLCBzdWNjZXNzQ2FsbGJhY2ssIGdvdERldmljZXNDYWxsQmFjaywgZXJyb3JDYWxsYmFjaykge1xuXHRcdG5hdmlnYXRvclxuXHRcdFx0Lm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEobWVkaWFDb25zdHJhaW50cylcblx0XHRcdC50aGVuKHN1Y2Nlc3NDYWxsYmFjaylcblx0XHRcdC50aGVuKGdvdERldmljZXNDYWxsQmFjaylcblx0XHRcdC5jYXRjaChlcnJvckNhbGxiYWNrKTtcblx0fSxcblx0Z290RGV2aWNlcyhkZXZpY2VJbmZvcykge1xuXHRcdGlmICh3ZWJraXRSZWNvcmRlci5hdWRpb0lucHV0TWVudS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZGl2JykubGVuZ3RoID4gMCkgcmV0dXJuO1xuXHRcdGZvciAobGV0IGkgPSAwOyBpICE9PSBkZXZpY2VJbmZvcy5sZW5ndGg7IGkgKz0gMSkge1xuXHRcdFx0Y29uc3QgZGV2aWNlSW5mbyA9IGRldmljZUluZm9zW2ldO1xuXHRcdFx0Y29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG5cdFx0XHRvcHRpb24uY2xhc3NOYW1lID0gJ2l0ZW0nO1xuXHRcdFx0b3B0aW9uLmlkID0gZGV2aWNlSW5mby5kZXZpY2VJZDtcblx0XHRcdGlmIChkZXZpY2VJbmZvLmtpbmQgPT09ICdhdWRpb2lucHV0Jykge1xuXHRcdFx0XHRvcHRpb24uaW5uZXJIVE1MID0gZGV2aWNlSW5mby5sYWJlbCB8fFxuXHRcdFx0XHRcdGBtaWNyb3Bob25lICR7d2Via2l0UmVjb3JkZXIuYXVkaW9JbnB1dE1lbnUubGVuZ3RoICsgMX1gO1xuXHRcdFx0XHR3ZWJraXRSZWNvcmRlci5hdWRpb0lucHV0TWVudS5hcHBlbmRDaGlsZChvcHRpb24pO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRpZiAod2Via2l0UmVjb3JkZXIuYXVkaW9JbnB1dE1lbnUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2RpdicpLmxlbmd0aCA+IDApIHtcblx0XHRcdHdlYmtpdFJlY29yZGVyLiRzZWxlY3RBdWRpb0lucHV0LnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdH1cblx0fSxcblx0Y2JPblN1Y2Nlc3Moc3RyZWFtKSB7XG5cdFx0dHJ5IHtcblx0XHRcdHdlYmtpdFJlY29yZGVyLm1lZGlhUmVjb3JkZXIgPSBuZXcgTWVkaWFTdHJlYW1SZWNvcmRlcihzdHJlYW0pO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIubWVkaWFSZWNvcmRlci5zdHJlYW0gPSBzdHJlYW07XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5tZWRpYVJlY29yZGVyLnJlY29yZGVyVHlwZSA9IFN0ZXJlb0F1ZGlvUmVjb3JkZXI7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5tZWRpYVJlY29yZGVyLm1pbWVUeXBlID0gJ2F1ZGlvL3dhdic7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci5tZWRpYVJlY29yZGVyLmF1ZGlvQ2hhbm5lbHMgPSAxO1xuXG5cdFx0XHQvLyB3ZWJraXRSZWNvcmRlci5tZWRpYVJlY29yZGVyID0gbmV3IE1lZGlhUmVjb3JkZXIoc3RyZWFtKTtcblx0XHRcdHdlYmtpdFJlY29yZGVyLm1lZGlhUmVjb3JkZXIub25zdG9wID0gd2Via2l0UmVjb3JkZXIuY2JPblN0b3BNZWRpYVJlY29yZGVyO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIubWVkaWFSZWNvcmRlci5vbmRhdGFhdmFpbGFibGUgPSB3ZWJraXRSZWNvcmRlci5jYk9uRGF0YUF2YWlsYWJsZTtcblx0XHRcdHdlYmtpdFJlY29yZGVyLm1lZGlhUmVjb3JkZXIuc3RhcnQoMzAwMDAwKTtcblx0XHRcdGNvbnNvbGUubG9nKCdyZWNvcmRlciBzdGFydGVkJyk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci4kcmVjb3JkTGFiZWwuYWRkQ2xhc3MoJ3JlZCcpO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIuJHN0b3BCdXR0b24ucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0XHR3ZWJraXRSZWNvcmRlci4kcmVjb3JkQnV0dG9uLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuXHRcdFx0cmV0dXJuIG5hdmlnYXRvci5tZWRpYURldmljZXMuZW51bWVyYXRlRGV2aWNlcygpO1xuXHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdGNvbnNvbGUuZXJyb3IoJ01lZGlhU3RyZWFtUmVjb3JkZXIgaXMgbm90IHN1cHBvcnRlZCBieSB0aGlzIGJyb3dzZXIuXFxuXFxuJyArXG5cdFx0XHRcdCdUcnkgRmlyZWZveCAyOSBvciBsYXRlciwgb3IgQ2hyb21lIDQ3IG9yIGxhdGVyLCB3aXRoIEVuYWJsZSBleHBlcmltZW50YWwgV2ViIFBsYXRmb3JtIGZlYXR1cmVzIGVuYWJsZWQgZnJvbSBjaHJvbWU6Ly9mbGFncy4nKTtcblx0XHRcdGNvbnNvbGUuZXJyb3IoJ0V4Y2VwdGlvbiB3aGlsZSBjcmVhdGluZyBNZWRpYVJlY29yZGVyOicsIGUpO1xuXHRcdFx0d2Via2l0UmVjb3JkZXIuJHJlY29yZEJ1dHRvbi5hZGRDbGFzcygnZGlzYWJsZWQnKTtcblx0XHR9XG5cdFx0cmV0dXJuIGZhbHNlO1xuXHR9LFxuXHRjYk9uRXJyb3IoZXJyKSB7XG5cdFx0Y29uc29sZS5sb2coYFRoZSBmb2xsb3dpbmcgZXJyb3Igb2NjdXJlZDogJHtlcnJ9YCk7XG5cdH0sXG5cdGNiT25TdG9wTWVkaWFSZWNvcmRlcigpIHtcblx0XHRjb25zb2xlLmxvZygnZGF0YSBhdmFpbGFibGUgYWZ0ZXIgTWVkaWFTdHJlYW1SZWNvcmRlci5zdG9wKCkgY2FsbGVkLicpO1xuXHRcdHNvdW5kRmlsZU1vZGlmeS5ibG9iID0gbmV3IEJsb2Iod2Via2l0UmVjb3JkZXIuY2h1bmtzKTtcblx0XHRjb25zb2xlLmxvZygncmVjb3JkZXIgc3RvcHBlZCcpO1xuXHRcdGNvbnN0IGZpbGVVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKHNvdW5kRmlsZU1vZGlmeS5ibG9iKTtcblx0XHRzbmRQbGF5ZXIuVXBkYXRlU291cmNlKGZpbGVVUkwpO1xuXHRcdGNvbnN0IGJsb2JGaWxlID0gbmV3IEZpbGUoW3dlYmtpdFJlY29yZGVyLmNodW5rc1swXV0sICdibG9iJysgbmV3IERhdGUoKS5nZXRUaW1lKCkrJy53YXYnKTtcblx0XHRQYnhBcGkuRmlsZXNVcGxvYWRGaWxlKGJsb2JGaWxlLCBzb3VuZEZpbGVNb2RpZnkuY2JVcGxvYWRSZXN1bWFibGUpO1xuXHRcdHdlYmtpdFJlY29yZGVyLiRyZWNvcmRMYWJlbC5yZW1vdmVDbGFzcygncmVkJyk7XG5cdFx0d2Via2l0UmVjb3JkZXIuJHN0b3BCdXR0b24uYWRkQ2xhc3MoJ2Rpc2FibGVkJyk7XG5cdFx0d2Via2l0UmVjb3JkZXIuJHJlY29yZEJ1dHRvbi5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcblx0XHRzb3VuZEZpbGVNb2RpZnkuJHNvdW5kRmlsZUlucHV0LnZhbCgnJyk7XG5cdH0sXG5cdGNiT25EYXRhQXZhaWxhYmxlKGUpIHtcblx0XHR3ZWJraXRSZWNvcmRlci5jaHVua3MucHVzaChlKTtcblx0fSxcbn07XG5cblxuJChkb2N1bWVudCkucmVhZHkoKCkgPT4ge1xuXHR3ZWJraXRSZWNvcmRlci5pbml0aWFsaXplKCk7XG59KTtcbiJdfQ==