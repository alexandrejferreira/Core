"use strict";

/*
 * MikoPBX - free phone system for small business
 * Copyright Â© 2017-2023 Alexey Portnov and Nikolay Beketov
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with this program.
 * If not, see <https://www.gnu.org/licenses/>.
 */

/* global globalTranslate, SemanticLocalization, PbxApi, globalRootUrl, IndexSoundPlayer*/

/**
 * Object representing sound files table.
 *
 * @module soundFiles
 */
var soundFiles = {
  $audioFilesList: $('#custom-sound-files-table, #moh-sound-files-table'),
  $contentFrame: $('#content-frame'),
  $tabMenuItems: $('#sound-files-menu .item'),

  /**
   * Initializes the sound files table.
   */
  initialize: function initialize() {
    // Initialize tab menu with history tracking
    soundFiles.$tabMenuItems.tab({
      history: true,
      historyType: 'hash'
    }); // Initialize DataTable for audio files list

    soundFiles.$audioFilesList.DataTable({
      lengthChange: false,
      paging: false,
      columns: [null, {
        orderable: false,
        searchable: false
      }, {
        orderable: false,
        searchable: false
      }],
      order: [0, 'asc'],
      initComplete: function initComplete() {
        // Initialize IndexSoundPlayer for each file row
        $('.file-row').each(function (index, row) {
          var id = $(row).attr('id');
          return new IndexSoundPlayer(id);
        });
      },
      language: SemanticLocalization.dataTableLocalisation
    });
    soundFiles.dataTable = soundFiles.$audioFilesList.DataTable();
    soundFiles.dataTable.on('draw', function () {
      // Reinitialize IndexSoundPlayer for each file row after DataTable redraw
      $('.file-row').each(function (index, row) {
        var id = $(row).attr('id');
        return new IndexSoundPlayer(id);
      });
    }); // Move the "Add New" button to the first eight-column div

    $('#add-new-custom-button').appendTo($('#custom-sound-files-table_wrapper div.eight.column:eq(0)'));
    $('#add-new-moh-button').appendTo($('#moh-sound-files-table_wrapper div.eight.column:eq(0)')); // Add error event listener to audio elements

    var toArray = Array.prototype.slice;
    toArray.apply(document.getElementsByTagName('audio')).forEach(function (audio) {
      audio.addEventListener('error', soundFiles.handleMediaError);
    }); // Add click event listener to delete links

    $('body').on('click', 'a.delete', function (e) {
      e.preventDefault();
      var fileName = $(e.target).closest('tr').attr('data-value');
      var fileId = $(e.target).closest('tr').attr('id');
      PbxApi.FilesRemoveAudioFile(fileName, fileId, soundFiles.cbAfterDelete);
    });
  },

  /**
   * Callback after successful file deletion.
   * @param {string} id - The ID of the deleted file.
   * @returns {boolean}
   */
  cbAfterDelete: function cbAfterDelete(id) {
    $('.message.ajax').remove();
    $.api({
      url: "".concat(globalRootUrl, "sound-files/delete/").concat(id),
      on: 'now',
      successTest: function successTest(response) {
        // test whether a JSON response is valid
        return response !== undefined && Object.keys(response).length > 0;
      },
      onSuccess: function onSuccess(response) {
        if (response.success === true) {
          soundFiles.$audioFilesList.find("tr[id=".concat(id, "]")).remove();
          sessionStorage.removeItem("".concat(globalRootUrl, "sound-files/getSoundFiles/custom"));
          sessionStorage.removeItem("".concat(globalRootUrl, "sound-files/getSoundFiles/moh"));
        } else {
          soundFiles.$contentFrame.before("<div class=\"ui error message ajax\">".concat(response.message.error, "</div>"));
        }
      }
    });
  },

  /**
   * Handles media errors.
   * @param {Event} e - The error event.
   */
  handleMediaError: function handleMediaError(e) {
    switch (e.target.error.code) {
      case e.target.error.MEDIA_ERR_ABORTED:
        console.log('You aborted the media playback.');
        break;

      case e.target.error.MEDIA_ERR_NETWORK:
        console.log('A network error caused the media download to fail.');
        break;

      case e.target.error.MEDIA_ERR_DECODE:
        console.log('The media playback was aborted due to a corruption problem or because the media used features your browser did not support.');
        break;

      case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
        console.log('The media could not be loaded, either because the server or network failed or because the format is not supported.');
        break;

      default:
        console.log('An unknown media error occurred.');
    }

    var $row = $(e.target).closest('tr');
    $row.addClass('negative');
    $row.find('td.player').html(globalTranslate.sf_FileNotFound);
  }
}; // When the document is ready, initialize the sound files table

$(document).ready(function () {
  soundFiles.initialize();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Tb3VuZEZpbGVzL3NvdW5kLWZpbGVzLWluZGV4LmpzIl0sIm5hbWVzIjpbInNvdW5kRmlsZXMiLCIkYXVkaW9GaWxlc0xpc3QiLCIkIiwiJGNvbnRlbnRGcmFtZSIsIiR0YWJNZW51SXRlbXMiLCJpbml0aWFsaXplIiwidGFiIiwiaGlzdG9yeSIsImhpc3RvcnlUeXBlIiwiRGF0YVRhYmxlIiwibGVuZ3RoQ2hhbmdlIiwicGFnaW5nIiwiY29sdW1ucyIsIm9yZGVyYWJsZSIsInNlYXJjaGFibGUiLCJvcmRlciIsImluaXRDb21wbGV0ZSIsImVhY2giLCJpbmRleCIsInJvdyIsImlkIiwiYXR0ciIsIkluZGV4U291bmRQbGF5ZXIiLCJsYW5ndWFnZSIsIlNlbWFudGljTG9jYWxpemF0aW9uIiwiZGF0YVRhYmxlTG9jYWxpc2F0aW9uIiwiZGF0YVRhYmxlIiwib24iLCJhcHBlbmRUbyIsInRvQXJyYXkiLCJBcnJheSIsInByb3RvdHlwZSIsInNsaWNlIiwiYXBwbHkiLCJkb2N1bWVudCIsImdldEVsZW1lbnRzQnlUYWdOYW1lIiwiZm9yRWFjaCIsImF1ZGlvIiwiYWRkRXZlbnRMaXN0ZW5lciIsImhhbmRsZU1lZGlhRXJyb3IiLCJlIiwicHJldmVudERlZmF1bHQiLCJmaWxlTmFtZSIsInRhcmdldCIsImNsb3Nlc3QiLCJmaWxlSWQiLCJQYnhBcGkiLCJGaWxlc1JlbW92ZUF1ZGlvRmlsZSIsImNiQWZ0ZXJEZWxldGUiLCJyZW1vdmUiLCJhcGkiLCJ1cmwiLCJnbG9iYWxSb290VXJsIiwic3VjY2Vzc1Rlc3QiLCJyZXNwb25zZSIsInVuZGVmaW5lZCIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJvblN1Y2Nlc3MiLCJzdWNjZXNzIiwiZmluZCIsInNlc3Npb25TdG9yYWdlIiwicmVtb3ZlSXRlbSIsImJlZm9yZSIsIm1lc3NhZ2UiLCJlcnJvciIsImNvZGUiLCJNRURJQV9FUlJfQUJPUlRFRCIsImNvbnNvbGUiLCJsb2ciLCJNRURJQV9FUlJfTkVUV09SSyIsIk1FRElBX0VSUl9ERUNPREUiLCJNRURJQV9FUlJfU1JDX05PVF9TVVBQT1JURUQiLCIkcm93IiwiYWRkQ2xhc3MiLCJodG1sIiwiZ2xvYmFsVHJhbnNsYXRlIiwic2ZfRmlsZU5vdEZvdW5kIiwicmVhZHkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTs7QUFHQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsSUFBTUEsVUFBVSxHQUFHO0FBQ2ZDLEVBQUFBLGVBQWUsRUFBRUMsQ0FBQyxDQUFDLG1EQUFELENBREg7QUFFZkMsRUFBQUEsYUFBYSxFQUFFRCxDQUFDLENBQUMsZ0JBQUQsQ0FGRDtBQUdmRSxFQUFBQSxhQUFhLEVBQUVGLENBQUMsQ0FBQyx5QkFBRCxDQUhEOztBQUtmO0FBQ0o7QUFDQTtBQUNJRyxFQUFBQSxVQVJlLHdCQVFGO0FBQ1Q7QUFDQUwsSUFBQUEsVUFBVSxDQUFDSSxhQUFYLENBQXlCRSxHQUF6QixDQUE2QjtBQUN6QkMsTUFBQUEsT0FBTyxFQUFFLElBRGdCO0FBRXpCQyxNQUFBQSxXQUFXLEVBQUU7QUFGWSxLQUE3QixFQUZTLENBT1Q7O0FBQ0FSLElBQUFBLFVBQVUsQ0FBQ0MsZUFBWCxDQUEyQlEsU0FBM0IsQ0FBcUM7QUFDakNDLE1BQUFBLFlBQVksRUFBRSxLQURtQjtBQUVqQ0MsTUFBQUEsTUFBTSxFQUFFLEtBRnlCO0FBR2pDQyxNQUFBQSxPQUFPLEVBQUUsQ0FDTCxJQURLLEVBRUw7QUFBQ0MsUUFBQUEsU0FBUyxFQUFFLEtBQVo7QUFBbUJDLFFBQUFBLFVBQVUsRUFBRTtBQUEvQixPQUZLLEVBR0w7QUFBQ0QsUUFBQUEsU0FBUyxFQUFFLEtBQVo7QUFBbUJDLFFBQUFBLFVBQVUsRUFBRTtBQUEvQixPQUhLLENBSHdCO0FBUWpDQyxNQUFBQSxLQUFLLEVBQUUsQ0FBQyxDQUFELEVBQUksS0FBSixD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LDJCQUFwQjtBQUNJSixRQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxvSEFBWjtBQUNBOztBQUNKO0FBQ0lELFFBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLGtDQUFaO0FBZFI7O0FBZ0JBLFFBQU1JLElBQUksR0FBR3hFLENBQUMsQ0FBQ3NDLENBQUMsQ0FBQ0csTUFBSCxDQUFELENBQVlDLE9BQVosQ0FBb0IsSUFBcEIsQ0FBYjtBQUNBOEIsSUFBQUEsSUFBSSxDQUFDQyxRQUFMLENBQWMsVUFBZDtBQUNBRCxJQUFBQSxJQUFJLENBQUNiLElBQUwsQ0FBVSxXQUFWLEVBQXVCZSxJQUF2QixDQUE0QkMsZUFBZSxDQUFDQyxlQUE1QztBQUNIO0FBcEhjLENBQW5CLEMsQ0F1SEE7O0FBQ0E1RSxDQUFDLENBQUNnQyxRQUFELENBQUQsQ0FBWTZDLEtBQVosQ0FBa0IsWUFBTTtBQUNwQi9FLEVBQUFBLFVBQVUsQ0FBQ0ssVUFBWDtBQUNILENBRkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogTWlrb1BCWCAtIGZyZWUgcGhvbmUgc3lzdGVtIGZvciBzbWFsbCBidXNpbmVzc1xuICogQ29weXJpZ2h0IMKpIDIwMTctMjAyMyBBbGV4ZXkgUG9ydG5vdiBhbmQgTmlrb2xheSBCZWtldG92XG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGZyZWUgc29mdHdhcmU6IHlvdSBjYW4gcmVkaXN0cmlidXRlIGl0IGFuZC9vciBtb2RpZnlcbiAqIGl0IHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgYXMgcHVibGlzaGVkIGJ5XG4gKiB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uOyBlaXRoZXIgdmVyc2lvbiAzIG9mIHRoZSBMaWNlbnNlLCBvclxuICogKGF0IHlvdXIgb3B0aW9uKSBhbnkgbGF0ZXIgdmVyc2lvbi5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCxcbiAqIGJ1dCBXSVRIT1VUIEFOWSBXQVJSQU5UWTsgd2l0aG91dCBldmVuIHRoZSBpbXBsaWVkIHdhcnJhbnR5IG9mXG4gKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlXG4gKiBHTlUgR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLlxuICogSWYgbm90LCBzZWUgPGh0dHBzOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuXG4vKiBnbG9iYWwgZ2xvYmFsVHJhbnNsYXRlLCBTZW1hbnRpY0xvY2FsaXphdGlvbiwgUGJ4QXBpLCBnbG9iYWxSb290VXJsLCBJbmRleFNvdW5kUGxheWVyKi9cblxuXG4vKipcbiAqIE9iamVjdCByZXByZXNlbnRpbmcgc291bmQgZmlsZXMgdGFibGUuXG4gKlxuICogQG1vZHVsZSBzb3VuZEZpbGVzXG4gKi9cbmNvbnN0IHNvdW5kRmlsZXMgPSB7XG4gICAgJGF1ZGlvRmlsZXNMaXN0OiAkKCcjY3VzdG9tLXNvdW5kLWZpbGVzLXRhYmxlLCAjbW9oLXNvdW5kLWZpbGVzLXRhYmxlJyksXG4gICAgJGNvbnRlbnRGcmFtZTogJCgnI2NvbnRlbnQtZnJhbWUnKSxcbiAgICAkdGFiTWVudUl0ZW1zOiAkKCcjc291bmQtZmlsZXMtbWVudSAuaXRlbScpLFxuXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZXMgdGhlIHNvdW5kIGZpbGVzIHRhYmxlLlxuICAgICAqL1xuICAgIGluaXRpYWxpemUoKSB7XG4gICAgICAgIC8vIEluaXRpYWxpemUgdGFiIG1lbnUgd2l0aCBoaXN0b3J5IHRyYWNraW5nXG4gICAgICAgIHNvdW5kRmlsZXMuJHRhYk1lbnVJdGVtcy50YWIoe1xuICAgICAgICAgICAgaGlzdG9yeTogdHJ1ZSxcbiAgICAgICAgICAgIGhpc3RvcnlUeXBlOiAnaGFzaCcsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEluaXRpYWxpemUgRGF0YVRhYmxlIGZvciBhdWRpbyBmaWxlcyBsaXN0XG4gICAgICAgIHNvdW5kRmlsZXMuJGF1ZGlvRmlsZXNMaXN0LkRhdGFUYWJsZSh7XG4gICAgICAgICAgICBsZW5ndGhDaGFuZ2U6IGZhbHNlLFxuICAgICAgICAgICAgcGFnaW5nOiBmYWxzZSxcbiAgICAgICAgICAgIGNvbHVtbnM6IFtcbiAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgIHtvcmRlcmFibGU6IGZhbHNlLCBzZWFyY2hhYmxlOiBmYWxzZX0sXG4gICAgICAgICAgICAgICAge29yZGVyYWJsZTogZmFsc2UsIHNlYXJjaGFibGU6IGZhbHNlfSxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBvcmRlcjogWzAsICdhc2MnXSxcbiAgICAgICAgICAgIGluaXRDb21wbGV0ZSgpIHtcbiAgICAgICAgICAgICAgICAvLyBJbml0aWFsaXplIEluZGV4U291bmRQbGF5ZXIgZm9yIGVhY2ggZmlsZSByb3dcbiAgICAgICAgICAgICAgICAkKCcuZmlsZS1yb3cnKS5lYWNoKChpbmRleCwgcm93KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gJChyb3cpLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSW5kZXhTb3VuZFBsYXllcihpZCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbGFuZ3VhZ2U6IFNlbWFudGljTG9jYWxpemF0aW9uLmRhdGFUYWJsZUxvY2FsaXNhdGlvbixcbiAgICAgICAgfSk7XG5cbiAgICAgICAgc291bmRGaWxlcy5kYXRhVGFibGUgPSBzb3VuZEZpbGVzLiRhdWRpb0ZpbGVzTGlzdC5EYXRhVGFibGUoKTtcblxuICAgICAgICBzb3VuZEZpbGVzLmRhdGFUYWJsZS5vbignZHJhdycsICgpID0+IHtcbiAgICAgICAgICAgIC8vIFJlaW5pdGlhbGl6ZSBJbmRleFNvdW5kUGxheWVyIGZvciBlYWNoIGZpbGUgcm93IGFmdGVyIERhdGFUYWJsZSByZWRyYXdcbiAgICAgICAgICAgICQoJy5maWxlLXJvdycpLmVhY2goKGluZGV4LCByb3cpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZCA9ICQocm93KS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSW5kZXhTb3VuZFBsYXllcihpZCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gTW92ZSB0aGUgXCJBZGQgTmV3XCIgYnV0dG9uIHRvIHRoZSBmaXJzdCBlaWdodC1jb2x1bW4gZGl2XG4gICAgICAgICQoJyNhZGQtbmV3LWN1c3RvbS1idXR0b24nKS5hcHBlbmRUbygkKCcjY3VzdG9tLXNvdW5kLWZpbGVzLXRhYmxlX3dyYXBwZXIgZGl2LmVpZ2h0LmNvbHVtbjplcSgwKScpKTtcbiAgICAgICAgJCgnI2FkZC1uZXctbW9oLWJ1dHRvbicpLmFwcGVuZFRvKCQoJyNtb2gtc291bmQtZmlsZXMtdGFibGVfd3JhcHBlciBkaXYuZWlnaHQuY29sdW1uOmVxKDApJykpO1xuXG5cbiAgICAgICAgLy8gQWRkIGVycm9yIGV2ZW50IGxpc3RlbmVyIHRvIGF1ZGlvIGVsZW1lbnRzXG4gICAgICAgIGNvbnN0IHRvQXJyYXkgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7XG4gICAgICAgIHRvQXJyYXkuYXBwbHkoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2F1ZGlvJykpLmZvckVhY2goKGF1ZGlvKSA9PiB7XG4gICAgICAgICAgICBhdWRpby5hZGRFdmVudExpc3RlbmVyKCdlcnJvcicsIHNvdW5kRmlsZXMuaGFuZGxlTWVkaWFFcnJvcik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIEFkZCBjbGljayBldmVudCBsaXN0ZW5lciB0byBkZWxldGUgbGlua3NcbiAgICAgICAgJCgnYm9keScpLm9uKCdjbGljaycsICdhLmRlbGV0ZScsIChlKSA9PiB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9ICQoZS50YXJnZXQpLmNsb3Nlc3QoJ3RyJykuYXR0cignZGF0YS12YWx1ZScpO1xuICAgICAgICAgICAgY29uc3QgZmlsZUlkID0gJChlLnRhcmdldCkuY2xvc2VzdCgndHInKS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgUGJ4QXBpLkZpbGVzUmVtb3ZlQXVkaW9GaWxlKGZpbGVOYW1lLCBmaWxlSWQsIHNvdW5kRmlsZXMuY2JBZnRlckRlbGV0ZSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBDYWxsYmFjayBhZnRlciBzdWNjZXNzZnVsIGZpbGUgZGVsZXRpb24uXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGlkIC0gVGhlIElEIG9mIHRoZSBkZWxldGVkIGZpbGUuXG4gICAgICogQHJldHVybnMge2Jvb2xlYW59XG4gICAgICovXG4gICAgY2JBZnRlckRlbGV0ZShpZCkge1xuICAgICAgICAkKCcubWVzc2FnZS5hamF4JykucmVtb3ZlKCk7XG4gICAgICAgICQuYXBpKHtcbiAgICAgICAgICAgIHVybDogYCR7Z2xvYmFsUm9vdFVybH1zb3VuZC1maWxlcy9kZWxldGUvJHtpZH1gLFxuICAgICAgICAgICAgb246ICdub3cnLFxuICAgICAgICAgICAgc3VjY2Vzc1Rlc3QocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICAvLyB0ZXN0IHdoZXRoZXIgYSBKU09OIHJlc3BvbnNlIGlzIHZhbGlkXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlICE9PSB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAgICAgJiYgT2JqZWN0LmtleXMocmVzcG9uc2UpLmxlbmd0aCA+IDA7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25TdWNjZXNzKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgc291bmRGaWxlcy4kYXVkaW9GaWxlc0xpc3QuZmluZChgdHJbaWQ9JHtpZH1dYCkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLnJlbW92ZUl0ZW0oYCR7Z2xvYmFsUm9vdFVybH1zb3VuZC1maWxlcy9nZXRTb3VuZEZpbGVzL2N1c3RvbWApO1xuICAgICAgICAgICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGAke2dsb2JhbFJvb3RVcmx9c291bmQtZmlsZXMvZ2V0U291bmRGaWxlcy9tb2hgKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzb3VuZEZpbGVzLiRjb250ZW50RnJhbWUuYmVmb3JlKGA8ZGl2IGNsYXNzPVwidWkgZXJyb3IgbWVzc2FnZSBhamF4XCI+JHtyZXNwb25zZS5tZXNzYWdlLmVycm9yfTwvZGl2PmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBIYW5kbGVzIG1lZGlhIGVycm9ycy5cbiAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gVGhlIGVycm9yIGV2ZW50LlxuICAgICAqL1xuICAgIGhhbmRsZU1lZGlhRXJyb3IoZSkge1xuICAgICAgICBzd2l0Y2ggKGUudGFyZ2V0LmVycm9yLmNvZGUpIHtcbiAgICAgICAgICAgIGNhc2UgZS50YXJnZXQuZXJyb3IuTUVESUFfRVJSX0FCT1JURUQ6XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1lvdSBhYm9ydGVkIHRoZSBtZWRpYSBwbGF5YmFjay4nKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgZS50YXJnZXQuZXJyb3IuTUVESUFfRVJSX05FVFdPUks6XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0EgbmV0d29yayBlcnJvciBjYXVzZWQgdGhlIG1lZGlhIGRvd25sb2FkIHRvIGZhaWwuJyk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIGUudGFyZ2V0LmVycm9yLk1FRElBX0VSUl9ERUNPREU6XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1RoZSBtZWRpYSBwbGF5YmFjayB3YXMgYWJvcnRlZCBkdWUgdG8gYSBjb3JydXB0aW9uIHByb2JsZW0gb3IgYmVjYXVzZSB0aGUgbWVkaWEgdXNlZCBmZWF0dXJlcyB5b3VyIGJyb3dzZXIgZGlkIG5vdCBzdXBwb3J0LicpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBlLnRhcmdldC5lcnJvci5NRURJQV9FUlJfU1JDX05PVF9TVVBQT1JURUQ6XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1RoZSBtZWRpYSBjb3VsZCBub3QgYmUgbG9hZGVkLCBlaXRoZXIgYmVjYXVzZSB0aGUgc2VydmVyIG9yIG5ldHdvcmsgZmFpbGVkIG9yIGJlY2F1c2UgdGhlIGZvcm1hdCBpcyBub3Qgc3VwcG9ydGVkLicpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQW4gdW5rbm93biBtZWRpYSBlcnJvciBvY2N1cnJlZC4nKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCAkcm93ID0gJChlLnRhcmdldCkuY2xvc2VzdCgndHInKTtcbiAgICAgICAgJHJvdy5hZGRDbGFzcygnbmVnYXRpdmUnKTtcbiAgICAgICAgJHJvdy5maW5kKCd0ZC5wbGF5ZXInKS5odG1sKGdsb2JhbFRyYW5zbGF0ZS5zZl9GaWxlTm90Rm91bmQpO1xuICAgIH0sXG59O1xuXG4vLyBXaGVuIHRoZSBkb2N1bWVudCBpcyByZWFkeSwgaW5pdGlhbGl6ZSB0aGUgc291bmQgZmlsZXMgdGFibGVcbiQoZG9jdW1lbnQpLnJlYWR5KCgpID0+IHtcbiAgICBzb3VuZEZpbGVzLmluaXRpYWxpemUoKTtcbn0pO1xuXG4iXX0=